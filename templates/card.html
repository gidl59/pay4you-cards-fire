{% extends "base.html" %}
{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- LOGO HEADER -->
    <div class="card-header-row">
      <img src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
           class="card-logo-big">
    </div>

    <!-- PROFILO -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <img src="{{ ag.photo_url }}" class="card-profile-photo">
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>
        {% if ag.role %}<div class="card-role-main">{{ ag.role }}</div>{% endif %}
        {% if ag.company %}<div class="card-role-sub">{{ ag.company }}</div>{% endif %}
        {% if ag.bio %}<div class="card-bio">{{ ag.bio }}</div>{% endif %}
      </div>
    </div>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        üì± <a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row">
        üü¢ <a href="https://wa.me/{{ ag.whatsapp|replace(' ','')|replace('+','') }}">{{ ag.whatsapp }}</a>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        üìß <a href="mailto:{{ email }}">{{ email }}</a>
      </div>
      {% endfor %}
    </section>

    <!-- SITI INTERNET CON NOME -->
    {% if websites %}
    <section class="card-section">
      <h2>Siti Internet</h2>
      {% for site in websites %}
        {% set hostname = site.replace('https://','').replace('http://','').split('/')[0] %}
        <div class="contact-row">
          üåê {{ hostname }}
          <button onclick="openFrameModal('{{ site }}')">Apri</button>
          <a href="mailto:?body={{ site }}">Email</a>
          <a href="https://wa.me/?text={{ site }}">WhatsApp</a>
        </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- PDF CON NOME VERO -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>
      <div class="pdf-list">
        {% for pdf in pdfs %}
        <div class="pdf-item" onclick="openFrameModal('{{ pdf.url }}')">
          üìÑ {{ pdf.name }}
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- GALLERIA -->
    {% if gallery %}
    <section class="card-section">
      <h2>Galleria</h2>
      <div class="gallery-scroll">
        {% for img in gallery %}
          <img src="{{ img }}" class="gallery-thumb"
               onclick="openGalleryModal('{{ img }}')">
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <div class="card-footer">
      Pay4You ‚Äì Card digitale
    </div>

  </div>
</div>

<!-- MODAL IMMAGINI -->
<div id="img-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <img id="img-modal-src" style="max-width:100%">
    <div class="modal-share">
      <a id="img-mail">Email</a>
      <a id="img-wa" target="_blank">WhatsApp</a>
    </div>
    <button onclick="closeImg()">Chiudi</button>
  </div>
</div>

<!-- MODAL PDF / SITO -->
<div id="frame-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="width:95%;height:90vh;">
    <iframe id="frame-src" style="width:100%;height:80vh;"></iframe>
    <div class="modal-share">
      <a id="frame-mail">Email</a>
      <a id="frame-wa" target="_blank">WhatsApp</a>
    </div>
    <button onclick="closeFrame()">Chiudi</button>
  </div>
</div>

<script>
let currentUrl = "";

function openGalleryModal(url){
  currentUrl = url;
  document.getElementById('img-modal-src').src = url;
  document.getElementById('img-modal').style.display = 'flex';
  document.getElementById('img-mail').href = "mailto:?body=" + encodeURIComponent(url);
  document.getElementById('img-wa').href = "https://wa.me/?text=" + encodeURIComponent(url);
}

function closeImg(){
  document.getElementById('img-modal').style.display = 'none';
}

function openFrameModal(url){
  const isExternal = !(
    url.includes('pay4you.store') ||
    url.includes('onrender.com') ||
    url.startsWith('/')
  );

  if(isExternal){
    window.open(url, '_blank');
    return;
  }

  currentUrl = url;
  document.getElementById('frame-src').src = url;
  document.getElementById('frame-modal').style.display = 'flex';
  document.getElementById('frame-mail').href = "mailto:?body=" + encodeURIComponent(url);
  document.getElementById('frame-wa').href = "https://wa.me/?text=" + encodeURIComponent(url);
}

function closeFrame(){
  document.getElementById('frame-modal').style.display = 'none';
  document.getElementById('frame-src').src = "";
}
</script>

{% endblock %}
