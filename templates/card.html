<!doctype html>
<html lang="{{ lang or 'it' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ ag.name }} | Pay4You Card</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <!-- sfondo blur -->
  <div class="card-glass-bg"></div>

  <div class="page-main">
    <div class="card-fullscreen">
      <div class="card-outer">

        <!-- header row: LOGO in alto a sinistra (solo se caricato) -->
        <div class="card-header-row">
          {% if ag.extra_logo_url %}
            <img class="card-logo-top-left" src="{{ ag.extra_logo_url }}" alt="Logo">
          {% endif %}

          <!-- (lingue: lascio come sono nel tuo progetto, NON tocco nulla)
               Se tu non vuoi bottoni, non inserirli qui.
               Se li hai gi√† in template, lasciali dove stanno. -->
        </div>

        <!-- blocco foto + dati (nome e azienda DEVONO stare sotto la foto, non in alto) -->
        <div class="business-card">
          <div class="card-profile-photo-wrapper">
            {% if ag.extra_logo_url %}
              <!-- avatar flip con retro logo -->
              <div class="avatar-flip">
                <div class="avatar-inner">
                  <div class="avatar-face avatar-front">
                    {% if ag.photo_url %}
                      <img src="{{ ag.photo_url }}" alt="Foto profilo">
                    {% else %}
                      <img src="{{ url_for('static', filename='logo.png') }}" alt="Foto profilo">
                    {% endif %}
                  </div>
                  <div class="avatar-face avatar-back">
                    <img src="{{ ag.extra_logo_url }}" alt="Logo">
                  </div>
                </div>
              </div>
            {% else %}
              <!-- fallback foto classica -->
              {% if ag.photo_url %}
                <img class="card-profile-photo" src="{{ ag.photo_url }}" alt="Foto profilo">
              {% else %}
                <img class="card-profile-photo" src="{{ url_for('static', filename='logo.png') }}" alt="Foto profilo">
              {% endif %}
            {% endif %}
          </div>

          <div class="card-name-block">
            <h1 class="card-name">{{ ag.name }}</h1>

            {% if ag.company %}
              <div class="card-role-sub">{{ ag.company }}</div>
            {% endif %}

            {% if ag.role %}
              <div class="card-role-main">{{ ag.role }}</div>
            {% endif %}

            {% if ag.bio %}
              <div class="card-bio">{{ ag.bio }}</div>
            {% endif %}

            <!-- ‚úÖ tasto multi-utente (Profilo 1/2) sulla card pubblica -->
            {% if profiles and profiles|length > 0 %}
              <div class="profile-switch">
                <a class="profile-pill {% if not p_key %}active{% endif %}" href="/{{ ag.slug }}{% if request.args.get('lang') %}?lang={{ request.args.get('lang') }}{% endif %}">
                  Profilo 1
                </a>

                {% for p in profiles %}
                  {% if p.key == 'p2' %}
                    <a class="profile-pill {% if p_key=='p2' %}active{% endif %}"
                       href="/{{ ag.slug }}?p=p2{% if request.args.get('lang') %}&lang={{ request.args.get('lang') }}{% endif %}">
                      Profilo 2
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- CONTATTI -->
        <div class="card-section">
          <h2>Contatti</h2>

          {% if mobiles and mobiles|length > 0 %}
            {% for m in mobiles %}
              <div class="contact-row">
                <div class="icon">üìû</div>
                <div class="label">Cell</div>
                <div class="value"><a href="tel:{{ m }}">{{ m }}</a></div>
              </div>
            {% endfor %}
          {% endif %}

          {% if ag.phone_office %}
            <div class="contact-row">
              <div class="icon">‚òéÔ∏è</div>
              <div class="label">Ufficio</div>
              <div class="value"><a href="tel:{{ ag.phone_office }}">{{ ag.phone_office }}</a></div>
            </div>
          {% endif %}

          {% if ag.whatsapp %}
            {% set wa = ag.whatsapp %}
            {% if wa.startswith('http') %}
              {% set wa_link = wa %}
            {% else %}
              {% set wa_digits = wa|replace(' ','')|replace('+','') %}
              {% set wa_link = 'https://wa.me/' ~ wa_digits %}
            {% endif %}
            <div class="contact-row whatsapp-row">
              <div class="icon">üí¨</div>
              <div class="label">WhatsApp</div>
              <div class="value"><a href="{{ wa_link }}" target="_blank" rel="noopener">Apri WhatsApp</a></div>
            </div>
          {% endif %}

          {% if emails and emails|length > 0 %}
            {% for e in emails %}
              <div class="contact-row">
                <div class="icon">‚úâÔ∏è</div>
                <div class="label">Email</div>
                <div class="value"><a href="mailto:{{ e }}">{{ e }}</a></div>
              </div>
            {% endfor %}
          {% endif %}

          {% if websites and websites|length > 0 %}
            {% for w in websites %}
              <div class="contact-row">
                <div class="icon">üåê</div>
                <div class="label">Sito</div>
                <div class="value"><a href="{{ w }}" target="_blank" rel="noopener">Apri sito</a></div>
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <!-- SOCIAL: mostra solo nome cliccabile -->
        {% set has_social =
          ag.facebook or ag.instagram or ag.linkedin or ag.tiktok or ag.telegram
        %}
        {% if has_social %}
          <div class="card-section">
            <h2>Social</h2>

            {% if ag.facebook %}
              <div class="contact-row social-row">
                <div class="icon">‚ìï</div>
                <div class="label">Facebook</div>
                <div class="value"><a href="{{ ag.facebook }}" target="_blank" rel="noopener">Facebook</a></div>
              </div>
            {% endif %}

            {% if ag.instagram %}
              <div class="contact-row social-row">
                <div class="icon">‚óé</div>
                <div class="label">Instagram</div>
                <div class="value"><a href="{{ ag.instagram }}" target="_blank" rel="noopener">Instagram</a></div>
              </div>
            {% endif %}

            {% if ag.linkedin %}
              <div class="contact-row social-row">
                <div class="icon">in</div>
                <div class="label">LinkedIn</div>
                <div class="value"><a href="{{ ag.linkedin }}" target="_blank" rel="noopener">LinkedIn</a></div>
              </div>
            {% endif %}

            {% if ag.tiktok %}
              <div class="contact-row social-row">
                <div class="icon">‚ô™</div>
                <div class="label">TikTok</div>
                <div class="value"><a href="{{ ag.tiktok }}" target="_blank" rel="noopener">TikTok</a></div>
              </div>
            {% endif %}

            {% if ag.telegram %}
              <div class="contact-row social-row">
                <div class="icon">‚úàÔ∏è</div>
                <div class="label">Telegram</div>
                <div class="value"><a href="{{ ag.telegram }}" target="_blank" rel="noopener">Telegram</a></div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        <!-- ‚úÖ BOX AZIONI sotto i social (come volevi) -->
        <div class="card-section actions-box">
          <h2>Azioni</h2>
          <div class="actions-row">
            <a class="action-btn" href="/{{ ag.slug }}.vcf">Salva contatto</a>
            <button class="action-btn secondary" type="button" onclick="openQrModal('/{{ ag.slug }}/qr.png{% if p_key %}?p={{ p_key }}{% endif %}{% if request.args.get('lang') %}{% if p_key %}&{% else %}?{% endif %}lang={{ request.args.get('lang') }}{% endif %}')">
              Scansiona QR
            </button>
          </div>
          <div class="actions-hint">
            Consiglio: salva il contatto e poi condividi la card ai tuoi clienti.
          </div>
        </div>

        <!-- AZIENDA / FISCALE -->
        {% if ag.piva or ag.sdi or ag.pec or addresses|length > 0 %}
          <div class="card-section">
            <h2>Dati</h2>

            {% if ag.piva %}
              <div class="contact-row">
                <div class="icon">üè∑Ô∏è</div>
                <div class="label">P.IVA</div>
                <div class="value">{{ ag.piva }}</div>
              </div>
            {% endif %}

            {% if ag.sdi %}
              <div class="contact-row">
                <div class="icon">üßæ</div>
                <div class="label">SDI</div>
                <div class="value">{{ ag.sdi }}</div>
              </div>
            {% endif %}

            {% if ag.pec %}
              <div class="contact-row">
                <div class="icon">üì©</div>
                <div class="label">PEC</div>
                <div class="value">{{ ag.pec }}</div>
              </div>
            {% endif %}

            {% if addresses and addresses|length > 0 %}
              <div class="address-row">
                <div class="address-value">
                  {% for a in addresses %}
                    <div>üìç {{ a }}</div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        <!-- GALLERIA -->
        {% if gallery and gallery|length > 0 %}
          <div class="card-section">
            <h2>Foto</h2>
            <div class="gallery-scroll">
              {% for img in gallery %}
                <button class="gallery-thumb-btn" type="button" onclick="openMediaModal('{{ img }}', 'image')">
                  <img src="{{ img }}" alt="Foto {{ loop.index }}">
                </button>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- VIDEO (‚úÖ piccoli come galleria) -->
        {% if videos and videos|length > 0 %}
          <div class="card-section">
            <h2>Video</h2>
            <div class="gallery-scroll">
              {% for v in videos %}
                <button class="gallery-thumb-btn" type="button" onclick="openMediaModal('{{ v }}', 'video')">
                  <div class="video-thumb">
                    <span class="video-play">‚ñ∂</span>
                    <video class="video-mini" muted playsinline preload="metadata">
                      <source src="{{ v }}">
                    </video>
                  </div>
                </button>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- PDF -->
        {% if pdfs and pdfs|length > 0 %}
          <div class="card-section">
            <h2>Documenti</h2>
            <div class="pdf-list">
              {% for p in pdfs %}
                <a class="pdf-item" href="{{ p.url }}" target="_blank" rel="noopener">
                  <span class="pdf-icon">üìÑ</span> <span>{{ p.name }}</span>
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <div class="card-footer">
          ¬© {{ (ag.company or ag.name) }}
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL (QR / IMMAGINI / VIDEO) con ‚úÖ CHIUDI SEMPRE SOPRA -->
  <div id="media-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box modal-media">
      <button class="modal-x" type="button" onclick="closeMediaModal()">‚úï</button>

      <img id="modal-img" src="" alt="media" style="display:none;">
      <video id="modal-video" controls playsinline style="display:none;">
        <source id="modal-video-src" src="">
      </video>

      <button class="modal-close-btn" type="button" onclick="closeMediaModal()">Chiudi</button>
    </div>
  </div>

  <!-- QR modal (usa lo stesso media-modal) -->
  <script>
    function openQrModal(src){
      openMediaModal(src, 'image');
    }

    function openMediaModal(src, type){
      const modal = document.getElementById('media-modal');
      const img = document.getElementById('modal-img');
      const vid = document.getElementById('modal-video');
      const vidSrc = document.getElementById('modal-video-src');

      img.style.display = 'none';
      vid.style.display = 'none';
      try { vid.pause(); } catch(e){}

      if(type === 'video'){
        vidSrc.src = src;
        vid.load();
        vid.style.display = 'block';
      } else {
        img.src = src;
        img.style.display = 'block';
      }

      modal.style.display = 'flex';
    }

    function closeMediaModal(){
      const modal = document.getElementById('media-modal');
      const vid = document.getElementById('modal-video');
      try { vid.pause(); } catch(e){}
      modal.style.display = 'none';
    }
  </script>

</body>
</html>
