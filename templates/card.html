<!doctype html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ ag.name or ag.slug }} | Pay4You</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/static/card.css">
</head>
<body>
  <div class="card-wrap">

    <div class="hero">
      <div class="hero-overlay"></div>

      <div class="top">
        {% if ag.logo_url %}
          <img class="logo {{ 'spin' if ag.logo_spin==1 else '' }}" src="{{ ag.logo_url }}" alt="logo">
        {% endif %}
      </div>

      <div class="avatar-wrap {{ 'orbit' if ag.orbit_spin==1 else '' }}">
        {% if ag.back_media_url %}
          <div class="backdisc {{ 'spin' if ag.orbit_spin==1 else '' }}" style="background-image:url('{{ ag.back_media_url }}'); background-size:cover; background-position:center;"></div>
        {% else %}
          <div class="backdisc" style="background:rgba(0,0,0,.12)"></div>
        {% endif %}

        <div class="avatar {{ 'spin' if ag.avatar_spin==1 and ag.allow_flip!=1 else '' }} {{ 'flip' if ag.allow_flip==1 else '' }} {{ 'tapflip' if ag.avatar_spin==1 and ag.allow_flip!=1 else '' }}" id="avatarBox">
          {% if ag.allow_flip==1 or (ag.avatar_spin==1 and ag.allow_flip!=1) %}
            <div class="flip-inner">
              <div class="flip-face flip-front">
                {% if ag.photo_url %}
                  <img src="{{ ag.photo_url }}" alt="foto" style="
                    object-position: {{ ag.photo_pos_x }}% {{ ag.photo_pos_y }}%;
                    transform: scale({{ ag.photo_zoom }});
                  ">
                {% else %}
                  <div class="avatar-ph">ðŸ‘¤</div>
                {% endif %}
              </div>

              <div class="flip-face flip-back">
                {% if ag.back_media_url %}
                  <img src="{{ ag.back_media_url }}" alt="dietro">
                {% elif ag.logo_url %}
                  <img src="{{ ag.logo_url }}" alt="logo">
                {% else %}
                  <div class="avatar-ph">â˜…</div>
                {% endif %}
              </div>
            </div>
          {% else %}
            {% if ag.photo_url %}
              <img src="{{ ag.photo_url }}" alt="foto" style="
                object-position: {{ ag.photo_pos_x }}% {{ ag.photo_pos_y }}%;
                transform: scale({{ ag.photo_zoom }});
              ">
            {% else %}
              <div class="avatar-ph">ðŸ‘¤</div>
            {% endif %}
          {% endif %}
        </div>
      </div>

      <div class="title">
        <h1>{{ ag.name }}</h1>
        {% if ag.role %}<div class="sub">{{ ag.role }}</div>{% endif %}
        {% if ag.company %}<div class="sub2">{{ ag.company }}</div>{% endif %}
      </div>
    </div>

    <div class="content">

      {% if ag.bio %}
        <div class="box">
          <h3>Info</h3>
          <p class="bio">{{ ag.bio }}</p>
        </div>
      {% endif %}

      {# Social icons under bio #}
      {% set has_social = false %}
      {% for key, label, abbr in socials %}
        {% set val = (ag|attr(key)) %}
        {% if val and (val.startswith('http://') or val.startswith('https://')) %}
          {% set has_social = true %}
        {% endif %}
      {% endfor %}

      {% if has_social %}
        <div class="social-row" aria-label="Social">
          {% for key, label, abbr in socials %}
            {% set val = (ag|attr(key)) %}
            {% if val and (val.startswith('http://') or val.startswith('https://')) %}
              <a class="sbtn" data-key="{{ key }}" href="{{ val }}" target="_blank" rel="noopener" title="{{ label }}">
                <span class="abbr">{{ abbr }}</span>
              </a>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <div class="box">
        <h3>{{ t_func("actions") }}</h3>
        <div class="actions">
          <button class="btn" type="button" onclick="openShareModal('qr', '{{ qr_url }}', 'QR Code')">{{ t_func("scan_qr") }}</button>
          {% if wa_link %}
            <a class="btn" href="{{ wa_link }}" target="_blank" rel="noopener">{{ t_func("whatsapp") }}</a>
          {% endif %}
        </div>
      </div>

      {% set socials = [
        ('facebook','Facebook','F'),
        ('instagram','Instagram','IG'),
        ('linkedin','LinkedIn','IN'),
        ('tiktok','TikTok','TT'),
        ('telegram','Telegram','TG'),
        ('youtube','YouTube','YT'),
        ('spotify','Spotify','SP')
      ] %}

      {% set has_social = false %}
      {% for key, label, abbr in socials %}
        {% set val = (ag|attr(key)) %}
        {% if val and (val.startswith('http://') or val.startswith('https://')) %}
          {% set has_social = true %}
        {% endif %}
      {% endfor %}

      {# Social icons under bio, not as a separate box #}
      {% if has_social %}
        <div class="social-row" aria-label="{{ t_func('social') }}">
          {% for key, label, abbr in socials %}
            {% set val = (ag|attr(key)) %}
            {% if val and (val.startswith('http://') or val.startswith('https://')) %}
              <a class="sbtn" data-key="{{ key }}" href="{{ val }}" target="_blank" rel="noopener" aria-label="{{ label }}">
                <span class="sico">{{ abbr }}</span>
              </a>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <div class="box">
        <h3>{{ t_func("contacts") }}</h3>

        {% if mobiles %}
          <div class="row">
            <div class="k">{{ t_func("mobile_phone") }}</div>
            <div class="v">
              {% for m in mobiles %}
                <a href="tel:{{ m }}">{{ m }}</a>{% if not loop.last %} Â· {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if office_value %}
          <div class="row">
            <div class="k">{{ t_func("office_phone") }}</div>
            <div class="v"><a href="tel:{{ office_value }}">{{ office_value }}</a></div>
          </div>
        {% endif %}

        {% if emails %}
          <div class="row">
            <div class="k">Email</div>
            <div class="v">
              {% for e in emails %}
                <a href="mailto:{{ e }}">{{ e }}</a>{% if not loop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if websites %}
          <div class="row">
            <div class="k">{{ t_func("open_website") }}</div>
            <div class="v">
              {% for w in websites %}
                <a target="_blank" rel="noopener" href="{{ w }}">{{ w }}</a>{% if not loop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if addresses %}
          <div class="row">
            <div class="k">Indirizzi</div>
            <div class="v">
              {% for a in addresses %}
                <div class="addr">
                  <div>{{ a.text }}</div>
                  <a target="_blank" rel="noopener" href="{{ a.maps }}">{{ t_func("open_maps") }}</a>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      <div class="box">
        <h3>{{ t_func("data") }}</h3>
        {% if ag.piva %}
          <div class="row"><div class="k">{{ t_func("vat") }}</div><div class="v">{{ ag.piva }}</div></div>
        {% endif %}
        {% if ag.sdi %}
          <div class="row"><div class="k">{{ t_func("sdi") }}</div><div class="v">{{ ag.sdi }}</div></div>
        {% endif %}
      </div>

      {% if socials and socials|length %}
        <div class="box">
          <h3>Social</h3>
          <div class="actions">
            {% for s in socials %}
              <a class="btn ghost" target="_blank" rel="noopener" href="{{ s.url }}">{{ s.label }}</a>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- âœ… profili + tema DOPO i dati aziendali -->
      <div class="box">
        <h3>Profili</h3>

        <div class="profile-switch">
          <a class="ps-btn {{ 'active' if profile=='p1' else '' }}" href="/{{ ag.slug }}">P1</a>
          {% if p2_enabled == 1 %}
            <a class="ps-btn {{ 'active' if profile=='p2' else '' }}" href="/{{ ag.slug }}?p=p2">P2</a>
          {% endif %}
          {% if p3_enabled == 1 %}
            <a class="ps-btn {{ 'active' if profile=='p3' else '' }}" href="/{{ ag.slug }}?p=p3">P3</a>
          {% endif %}
        </div>

        <div class="profile-switch" style="margin-top:10px">
          <button class="ps-btn" type="button" onclick="setTheme('auto')">Auto</button>
          <button class="ps-btn" type="button" onclick="setTheme('light')">Chiaro</button>
          <button class="ps-btn" type="button" onclick="setTheme('dark')">Scuro</button>
        </div>
      </div>

      {% if gallery %}
        <div class="box">
          <h3>{{ t_func("gallery") }}</h3>
          <div class="media-grid">
            {% for g in gallery %}
              <button class="thumb" type="button" onclick="openShareModal('img','{{ g }}','Foto')">
                <img src="{{ g }}" alt="">
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if videos %}
        <div class="box">
          <h3>{{ t_func("videos") }}</h3>
          <div class="media-grid">
            {% for v in videos %}
              <button class="vthumb" type="button" onclick="openShareModal('vid','{{ v }}','Video')">
                <video muted playsinline preload="metadata" src="{{ v }}#t=0.1"></video>
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if pdfs %}
        <div class="box">
          <h3>{{ t_func("documents") }}</h3>
          <ul class="docs">
            {% for p in pdfs %}
              <li><button class="docbtn" type="button" onclick="openShareModal('pdf','{{ p.url }}','{{ p.name|e }}')">ðŸ“„ {{ p.name }}</button></li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

    </div>

    <footer class="foot">
      <small>Pay4You Card 2026 Â· realizzato da Giuseppe Di Lisio</small>
    </footer>

  </div>

  <div id="shareModal" class="modal-overlay" style="display:none" onclick="overlayClose(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-title" id="mTitle">Anteprima</div>
      <div id="mBody" style="margin-top:12px;"></div>

      <div class="modal-actions">
        <button class="btn" type="button" onclick="share('whatsapp')">Invia WhatsApp</button>
        <button class="btn" type="button" onclick="share('email')">Invia Email</button>
        <button class="btn ghost" type="button" onclick="closeModal()">Chiudi</button>
      </div>

      <input type="hidden" id="mKind" value="">
      <input type="hidden" id="mUrl" value="">
    </div>
  </div>

<script>
  function absUrl(u){
    if(!u) return '';
    u = (u + '').trim();
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }
  function outlookCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://outlook.office.com/mail/deeplink/compose?subject=${su}&body=${bd}`;
  }

  function overlayClose(e){
    if(e.target && e.target.id === "shareModal") closeModal();
  }
  function closeModal(){
    const m = document.getElementById('shareModal');
    if(m) m.style.display = 'none';
    const b = document.getElementById('mBody');
    if(b) b.innerHTML = '';
  }

  function openShareModal(kind, url, title){
    document.getElementById('mKind').value = kind;
    document.getElementById('mUrl').value = url;

    document.getElementById('mTitle').textContent = title || 'Anteprima';

    const abs = absUrl(url);
    const body = document.getElementById('mBody');

    if(kind === 'img'){
      body.innerHTML = `<img src="${abs}" style="width:100%; max-height:70vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);" alt="">`;
    } else if(kind === 'vid'){
      body.innerHTML = `<video src="${abs}" controls playsinline style="width:100%; max-height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:black;"></video>`;
    } else if(kind === 'pdf'){
      body.innerHTML = `<iframe src="${abs}" style="width:100%; height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:white;"></iframe>`;
    } else {
      body.innerHTML = `<img src="${abs}" style="width:100%; max-height:70vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);" alt="">`;
    }

    document.getElementById('shareModal').style.display = 'flex';
  }

  function share(channel){
    const kind = document.getElementById('mKind').value;
    const url = document.getElementById('mUrl').value;
    const media = absUrl(url);

    const msg = [
      `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : (kind === 'pdf' ? 'PDF' : 'QR'))}`,
      `Link: ${media}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : (kind === 'pdf' ? 'PDF' : 'QR'))}`;
    const g = gmailCompose(subject, msg);
    const w = window.open(g, '_blank');
    if(!w){
      window.open(outlookCompose(subject, msg), '_blank');
    }
  }

  // THEME (auto/light/dark)
  function applyTheme(mode){
    document.body.classList.remove('light');
    if(mode === 'light') document.body.classList.add('light');
    if(mode === 'dark') document.body.classList.remove('light'); // default is dark
  }
  function setTheme(mode){
    localStorage.setItem('p4y_theme', mode);
    if(mode === 'auto'){
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      applyTheme(prefersLight ? 'light' : 'dark');
    } else {
      applyTheme(mode);
    }
  }
  (function(){
    const mode = localStorage.getItem('p4y_theme') || 'auto';
    setTheme(mode);
    if(window.matchMedia){
      window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
        const m = localStorage.getItem('p4y_theme') || 'auto';
        if(m === 'auto') setTheme('auto');
      });
    }
  })();

  // TAP SU FOTO: flip orizzontale (mostra "retro")
  (function(){
    const box = document.getElementById('avatarBox');
    if(!box) return;
    if(box.classList.contains('tapflip')){
      box.addEventListener('click', () => box.classList.toggle('is-flipped'));
      return;
    }
    // Flip automatico (se attivo)
    if(box.classList.contains('flip')){
      // niente click: Ã¨ un effetto continuo
      return;
    }
  })();
</script>

</body>
</html>
