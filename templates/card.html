<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ ag.name }}</title>
  <link rel="stylesheet" href="/static/card.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-theme="auto">

  <div class="card-wrap">

    <!-- LOGO TOP-LEFT (60% della foto) -->
    {% if ag.logo_url %}
      <div class="top-left-logo {% if ag.fx_rotate_logo=='on' %}spin-cw{% endif %}">
        <img src="{{ ag.logo_url }}" alt="logo">
      </div>
    {% endif %}

    {# ===== LOGICA EFFETTI =====
       - Se gira agente ON -> NO effetto moneta (tap/specchio ignorati)
       - Se mirror -> gira sempre
       - Altrimenti tap (click per girare)
    #}
    {% set flip_class = 'tap-flip' %}
    {% if ag.fx_rotate_agent == 'on' %}
      {% set flip_class = 'spin-agent' %}
    {% elif ag.fx_interaction == 'mirror' %}
      {% set flip_class = 'mirror-flip' %}
    {% endif %}

    <div class="flip-container {{ flip_class }}" id="flipBox">
      <div class="flipper">

        <div class="front">
          {% if ag.photo_url %}
            <img src="{{ ag.photo_url }}"
                 class="avatar-img"
                 alt="foto"
                 style="--ox:{{ ag.photo_pos_x }}%; --oy:{{ ag.photo_pos_y }}%; --z:{{ ag.photo_zoom }};">
          {% else %}
            <div class="avatar-img" style="background:#555;"></div>
          {% endif %}
        </div>

        <div class="back">
          {% if ag.fx_back == 'personal' and ag.personal_url %}
            <img src="{{ ag.personal_url }}" class="avatar-img" alt="retro">
          {% elif ag.logo_url %}
            <img src="{{ ag.logo_url }}" class="avatar-img" style="--ox:50%;--oy:50%;--z:1;" alt="logo retro">
          {% else %}
            <div style="font-weight:900;">LOGO</div>
          {% endif %}
        </div>

      </div>
    </div>

    <div class="info-section">
      <div class="name">{{ ag.name }}</div>
      <div class="role">{{ ag.role }}</div>
      {% if ag.company %}<div class="box-company">{{ ag.company }}</div>{% endif %}
      {% if ag.bio %}<div class="box-bio">{{ ag.bio }}</div>{% endif %}
    </div>

    <div class="actions-row">
      <a href="/vcf/{{ ag.slug }}?p={{ profile }}" class="btn-save" download>
        <i class="fas fa-user-plus"></i> SALVA CONTATTO
      </a>

      <div class="btn-qr" onclick="openShare('qr', '')">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data={{ request.url }}" alt="qr">
      </div>
    </div>

    {% if socials and socials|length > 0 %}
    <div class="social-grid">
      {% for s in socials %}
      <a href="{{ s.url }}" target="_blank" class="soc-btn
        {% if 'Facebook' in s.label %}soc-fb{% elif 'Instagram' in s.label %}soc-ig{% elif 'Linkedin' in s.label %}soc-li{% elif 'TikTok' in s.label %}soc-tk{% elif 'Spotify' in s.label %}soc-sp{% elif 'Telegram' in s.label %}soc-tg{% elif 'YouTube' in s.label %}soc-yt{% endif %}">
        <i class="fab fa-{{ s.label|lower if s.label!='TikTok' else 'tiktok' }}"></i>
      </a>
      {% endfor %}
    </div>
    {% endif %}

    <div class="switcher-bar">
      <div class="sw-left">
        {% if profile!='p1' %}<a href="?p=p1" class="circle-p p1-btn">P1</a>{% endif %}
        {% if p2_enabled and profile!='p2' %}<a href="?p=p2" class="circle-p p2-btn">P2</a>{% endif %}
        {% if p3_enabled and profile!='p3' %}<a href="?p=p3" class="circle-p p3-btn">P3</a>{% endif %}
      </div>
      <div class="sw-right">
        <span onclick="setT('light')" class="theme-btn t-light">CHIARO</span>
        <span onclick="setT('dark')" class="theme-btn t-dark">SCURO</span>
        <span onclick="setT('auto')" class="theme-btn t-auto">AUTO</span>
      </div>
    </div>

    <!-- CONTATTI -->
    <div class="scene-box">
      <div class="scene-label">CONTATTI</div>

      {% for m in mobiles %}
        <div class="d-row"><span class="d-icon">üì±</span> <a href="tel:{{m}}" class="d-link">{{m}}</a></div>
      {% endfor %}

      {% if ag.office_phone %}
        <div class="d-row"><span class="d-icon">‚òéÔ∏è</span> <a href="tel:{{ag.office_phone}}" class="d-link">{{ag.office_phone}}</a></div>
      {% endif %}

      {% for e_str in emails %}
        {% for e in e_str.split(',') %}
          {% if e.strip() %}
            <div class="d-row"><span class="d-icon">‚úâÔ∏è</span> <a href="mailto:{{e.strip()}}" class="d-link">{{e.strip()}}</a></div>
          {% endif %}
        {% endfor %}
      {% endfor %}

      {% if ag.pec %}
        <div class="d-row"><span class="d-icon">‚öñÔ∏è</span> <a href="mailto:{{ag.pec}}" class="d-link">{{ag.pec}}</a></div>
      {% endif %}

      <div class="fiscal-row">
        {% if ag.piva %}<span>P.IVA: {{ag.piva}}</span>{% endif %}
        {% if ag.cod_sdi %}<span>SDI: {{ag.cod_sdi}}</span>{% endif %}
      </div>
    </div>

    <!-- SITI WEB (APRILI IN MODAL TRASPARENTE) -->
    {% if websites and websites|length > 0 %}
    <div class="scene-box">
      <div class="scene-label">SITI WEB</div>
      {% for w_str in websites %}
        {% for w in w_str.split(',') %}
          {% if w.strip() %}
            {% set ww = w.strip() %}
            {% if not ww.startswith('http://') and not ww.startswith('https://') %}
              {% set ww = 'https://' ~ ww %}
            {% endif %}
            <div class="d-row">
              <span class="d-icon">üåê</span>
              <a href="javascript:void(0)" onclick="openSite('{{ ww }}')" class="d-link">{{ ww }}</a>
            </div>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>
    {% endif %}

    <!-- MAPPE -->
    {% if ag.address %}
    <div class="scene-box">
      <div class="scene-label">MAPPE</div>
      <div class="d-row">
        <span class="d-icon">üìç</span>
        <a href="javascript:void(0)" onclick="openSite('https://www.google.com/maps/search/?api=1&query={{ ag.address|urlencode }}')" class="d-link">
          {{ ag.address }}
        </a>
      </div>
    </div>
    {% endif %}

    <!-- FOTO -->
    {% if p_data.gallery_img and p_data.gallery_img|length > 0 %}
    <div class="scene-box">
      <div class="scene-label">FOTO</div>
      <div class="gal-grid-5">
        {% for img in p_data.gallery_img %}
          <img src="{{ img }}" class="thumb" alt="foto" onclick="openShare('img','{{ img }}')">
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- VIDEO -->
    {% if p_data.gallery_vid and p_data.gallery_vid|length > 0 %}
    <div class="scene-box">
      <div class="scene-label">VIDEO</div>
      <div class="gal-grid-5">
        {% for vid in p_data.gallery_vid %}
          <div class="vid-box" onclick="openShare('vid','{{ vid }}')">
            <video src="{{ vid }}#t=2.0" preload="metadata" muted playsinline></video>
            <div class="vid-icon"><i class="fas fa-play"></i></div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- PDF -->
    {% if p_data.gallery_pdf and p_data.gallery_pdf|length > 0 %}
    <div class="scene-box">
      <div class="scene-label">PDF</div>
      <div class="pdf-grid">
        {% for pdf in p_data.gallery_pdf %}
          <div class="pdf-item" onclick="openShare('pdf','{{ pdf.path }}','{{ pdf.name|e }}')">
            <span><i class="fas fa-file-pdf" style="color:#ff4444;"></i> {{ pdf.name }}</span>
            <span style="opacity:.8;"><i class="fas fa-share-nodes"></i></span>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="footer" onclick="openShare('qr','')">
      Card Digitale Pay4You ‚Ä¢ Tocca qui per condividere il QR
    </div>

    <!-- SHARE MODAL -->
    <div id="shareModal" class="modal-overlay">
      <div id="mediaBox"></div>
      <div class="modal-actions">
        <a id="waLink" href="#" class="act-btn bg-wa" target="_blank"><i class="fab fa-whatsapp"></i></a>
        <div id="emBtn" class="act-btn bg-em" onclick="sendEmailFromModal()"><i class="fas fa-envelope"></i></div>
        <div onclick="closeModal()" class="act-btn bg-cl"><i class="fas fa-times"></i></div>
      </div>
    </div>

    <!-- WEB MODAL TRASPARENTE -->
    <div id="webModal" class="modal-overlay modal-web">
      <div onclick="closeWeb()" class="btn-back-card">üîô CHIUDI E TORNA ALLA CARD</div>
      <iframe id="webFrame" class="web-frame"></iframe>
    </div>

  </div>

  <script>
    // TAP SOLO SE tap-flip
    (function(){
      const box = document.getElementById('flipBox');
      if(!box) return;
      box.addEventListener('click', function(){
        if(box.classList.contains('tap-flip')){
          box.classList.toggle('flipped');
        }
      });
    })();

    let LAST_SHARE_URL = "";
    let LAST_SHARE_TYPE = "";
    let LAST_SHARE_NAME = "";

    function makeMailto(subject, body){
      const b = (body || "").replace(/\n/g, "\r\n");
      return "mailto:?subject=" + encodeURIComponent(subject) +
             "&body=" + encodeURIComponent(b);
    }

    function buildEmailText(type, url, name){
      const who = "{{ ag.name|e }}";
      const company = "{{ (ag.company or '')|e }}";
      const head = company ? (who + " ‚Ä¢ " + company) : who;

      if(type === "qr"){
        return {
          subject: "Pay4You - Card Digitale",
          body:
            "Ciao!\n\n" +
            "Ti condivido la mia Card Digitale Pay4You.\n" +
            "Apri questo link:\n" + url + "\n\n" +
            "Da l√¨ puoi:\n" +
            "‚Ä¢ salvare il contatto\n" +
            "‚Ä¢ vedere foto/video/PDF\n" +
            "‚Ä¢ contattarmi subito\n\n" +
            head + "\n" +
            "‚Äî Inviato da Pay4You"
        };
      }

      if(type === "img"){
        return {
          subject: "Pay4You - Foto dalla Card",
          body:
            "Ciao!\n\n" +
            "Ti condivido una FOTO dalla mia Card Pay4You.\n" +
            "Link diretto:\n" + url + "\n\n" +
            "Se non si apre, copia e incolla il link nel browser.\n\n" +
            head + "\n" +
            "‚Äî Inviato da Pay4You"
        };
      }

      if(type === "vid"){
        return {
          subject: "Pay4You - Video dalla Card",
          body:
            "Ciao!\n\n" +
            "Ti condivido un VIDEO dalla mia Card Pay4You.\n" +
            "Link diretto:\n" + url + "\n\n" +
            "Se non si apre, copia e incolla il link nel browser.\n\n" +
            head + "\n" +
            "‚Äî Inviato da Pay4You"
        };
      }

      if(type === "pdf"){
        const n = name ? ("\"" + name + "\"") : "un PDF";
        return {
          subject: "Pay4You - PDF dalla Card",
          body:
            "Ciao!\n\n" +
            "Ti condivido " + n + " dalla mia Card Pay4You.\n" +
            "Link diretto:\n" + url + "\n\n" +
            "Se non si apre, copia e incolla il link nel browser.\n\n" +
            head + "\n" +
            "‚Äî Inviato da Pay4You"
        };
      }

      // fallback
      return {
        subject: "Pay4You - Condivisione",
        body:
          "Ciao!\n\n" +
          "Ti condivido questo link dalla Card Pay4You:\n" + url + "\n\n" +
          head + "\n" +
          "‚Äî Inviato da Pay4You"
      };
    }

    function openShare(type, url, name) {
      const box = document.getElementById('mediaBox');
      const fullUrl = (type === 'qr') ? window.location.href : (window.location.origin + url);

      LAST_SHARE_URL = fullUrl;
      LAST_SHARE_TYPE = type || "";
      LAST_SHARE_NAME = name || "";

      document.getElementById('waLink').href =
        "https://wa.me/?text=" + encodeURIComponent("Pay4You: " + fullUrl);

      if(type==='qr'){
        box.innerHTML = '<img class="modal-content" src="https://api.qrserver.com/v1/create-qr-code/?size=320x320&data='
          + encodeURIComponent(fullUrl)
          + '" style="background:white; padding:14px; border-radius:18px;">';
      } else if(type==='img'){
        box.innerHTML = '<img class="modal-content" src="'+fullUrl+'">';
      } else if(type==='vid'){
        box.innerHTML = '<video class="modal-content" src="'+fullUrl+'" controls autoplay playsinline style="background:#000;"></video>';
      } else if(type==='pdf'){
        box.innerHTML = '<iframe class="modal-content" src="'+fullUrl+'" style="width:92vw; height:70vh; background:white;"></iframe>';
      }

      document.getElementById('shareModal').style.display = 'flex';
    }

    // EMAIL: testo sempre presente e completo
    function sendEmailFromModal(){
      const pack = buildEmailText(LAST_SHARE_TYPE, (LAST_SHARE_URL || window.location.href), LAST_SHARE_NAME);
      window.location.href = makeMailto(pack.subject, pack.body);
    }

    function closeModal(){
      document.getElementById('shareModal').style.display='none';
      document.getElementById('mediaBox').innerHTML="";
      LAST_SHARE_URL = "";
      LAST_SHARE_TYPE = "";
      LAST_SHARE_NAME = "";
    }

    // WEB MODAL (finestra trasparente con chiudi)
    function openSite(url){
      document.getElementById('webFrame').src = url;
      document.getElementById('webModal').style.display = 'flex';
    }
    function closeWeb(){
      document.getElementById('webModal').style.display = 'none';
      document.getElementById('webFrame').src = "";
    }

    function setT(t){
      if(t==='auto') document.body.removeAttribute('data-theme');
      else document.body.setAttribute('data-theme', t);
    }
  </script>
</body>
</html>
