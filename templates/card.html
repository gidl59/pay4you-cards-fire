{% extends "base.html" %}
{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- HEADER LOGO -->
    <div class="card-header-row">
      <img
        src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
        alt="Logo"
        class="card-logo-big"
      >
    </div>

    <!-- PROFILO -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img src="{{ ag.photo_url }}" alt="{{ ag.name }}">
            </div>
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>

        {% if ag.role %}
          <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}

        {% if ag.company %}
          <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}

        {% if ag.bio %}
          <div class="card-bio">{{ ag.bio }}</div>
        {% endif %}
      </div>
    </div>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">üì±</div>
        <div class="label">Chiama mobile</div>
        <div class="value"><a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a></div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row">
        <div class="icon">üü¢</div>
        <div class="label">WhatsApp</div>
        <div class="value">
          <a href="https://wa.me/{{ ag.whatsapp|replace(' ', '')|replace('+', '') }}" target="_blank" rel="noopener noreferrer">
            Scrivi su WhatsApp
          </a>
        </div>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        <div class="icon">üìß</div>
        <div class="label">Email</div>
        <div class="value"><a href="mailto:{{ email }}">{{ email }}</a></div>
      </div>
      {% endfor %}

      {% for site in websites %}
      <div class="contact-row">
        <div class="icon">üåê</div>
        <div class="label">Sito internet</div>
        <div class="value">
          <a href="{{ site }}" target="_blank" rel="noopener noreferrer">
            {{ site }}
          </a>
        </div>
      </div>
      {% endfor %}

      {# Facebook #}
      {% if ag.facebook %}
      {% set _fb_url = ag.facebook if ag.facebook.startswith('http') else 'https://facebook.com/' ~ ag.facebook %}
      <div class="contact-row">
        <div class="icon">üìò</div>
        <div class="label">Facebook</div>
        <div class="value"><a href="{{ _fb_url }}" target="_blank" rel="noopener noreferrer">Apri Facebook</a></div>
      </div>
      {% endif %}

      {# Instagram #}
      {% if ag.instagram %}
      {% set _ig_clean = ag.instagram|replace('@','') %}
      {% set _ig_url = ag.instagram if ag.instagram.startswith('http') else 'https://instagram.com/' ~ _ig_clean %}
      <div class="contact-row">
        <div class="icon">üì∏</div>
        <div class="label">Instagram</div>
        <div class="value"><a href="{{ _ig_url }}" target="_blank" rel="noopener noreferrer">Apri Instagram</a></div>
      </div>
      {% endif %}

      {# LinkedIn #}
      {% if ag.linkedin %}
      {% set _li_clean = ag.linkedin|replace('@','') %}
      {% set _li_url = ag.linkedin if ag.linkedin.startswith('http') else 'https://www.linkedin.com/in/' ~ _li_clean %}
      <div class="contact-row">
        <div class="icon">üíº</div>
        <div class="label">LinkedIn</div>
        <div class="value"><a href="{{ _li_url }}" target="_blank" rel="noopener noreferrer">Apri LinkedIn</a></div>
      </div>
      {% endif %}

      {# TikTok #}
      {% if ag.tiktok %}
      {% set _tt_clean = ag.tiktok|replace('@','') %}
      {% set _tt_url = ag.tiktok if ag.tiktok.startswith('http') else 'https://www.tiktok.com/@' ~ _tt_clean %}
      <div class="contact-row">
        <div class="icon">üéµ</div>
        <div class="label">TikTok</div>
        <div class="value"><a href="{{ _tt_url }}" target="_blank" rel="noopener noreferrer">Apri TikTok</a></div>
      </div>
      {% endif %}

      {# Telegram #}
      {% if ag.telegram %}
      {% set _tg_clean = ag.telegram|replace('@','') %}
      {% set _tg_url = ag.telegram if ag.telegram.startswith('http') else 'https://t.me/' ~ _tg_clean %}
      <div class="contact-row">
        <div class="icon">‚úàÔ∏è</div>
        <div class="label">Telegram</div>
        <div class="value"><a href="{{ _tg_url }}" target="_blank" rel="noopener noreferrer">Apri Telegram</a></div>
      </div>
      {% endif %}

      {# PEC #}
      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">üèõÔ∏è</div>
        <div class="label">PEC</div>
        <div class="value"><a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a></div>
      </div>
      {% endif %}

      {# PIVA #}
      {% if ag.piva %}
      <div class="contact-row">
        <div class="icon">üßæ</div>
        <div class="label">Partita IVA</div>
        <div class="value">{{ ag.piva }}</div>
      </div>
      {% endif %}

      {# SDI #}
      {% if ag.sdi %}
      <div class="contact-row">
        <div class="icon">üè∑Ô∏è</div>
        <div class="label">Codice SDI</div>
        <div class="value">{{ ag.sdi }}</div>
      </div>
      {% endif %}

      {# Indirizzi (gi√† passati come lista) #}
      {% for a in addresses %}
      <div class="contact-row">
        <div class="icon">üìç</div>
        <div class="label">Indirizzo{% if addresses|length > 1 %} {{ loop.index }}{% endif %}</div>
        <div class="value">
          <a href="https://www.google.com/maps?q={{ a|trim|urlencode }}"
             target="_blank" rel="noopener noreferrer">
            {{ a }}
          </a>
        </div>
      </div>
      {% endfor %}

      <div class="contact-row">
        <div class="icon">üíæ</div>
        <div class="label">Salva contatto</div>
        <div class="value"><a href="{{ url_for('vcard', slug=ag.slug) }}">Salva</a></div>
      </div>
    </section>

    <!-- DOCUMENTI PDF -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>
      <div class="pdf-list">
        {% for pdf in pdfs %}
        <div class="pdf-item">
          <div class="pdf-title">{{ pdf.name }}</div>
          <div class="pdf-actions">
            <a class="primary" href="{{ pdf.url }}" target="_blank" rel="noopener">Apri / Scarica</a>
            <a href="mailto:?subject={{ pdf.name }}&body=Ti invio questo documento:%0A{{ pdf.url }}">Invia Email</a>
            <a href="https://wa.me/?text=Ti invio questo documento: {{ pdf.url }}" target="_blank" rel="noopener">Invia WhatsApp</a>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {# =========================
       GALLERIA FOTO + VIDEO
       ========================= #}
    {% set vids = (videos if videos is defined else []) %}
    {% if gallery or vids %}
    <section class="card-section">
      <h2>Galleria</h2>

      <div class="gallery-scroll">
        {# FOTO #}
        {% for img in (gallery if gallery else []) %}
        <button type="button" class="gallery-thumb-btn" onclick="openMediaModal('{{ img }}','image')">
          <img src="{{ img }}" alt="Foto">
        </button>
        {% endfor %}

        {# VIDEO #}
        {% for v in vids %}
        <button type="button" class="gallery-thumb-btn is-video" onclick="openMediaModal('{{ v }}','video')">
          <div class="video-thumb">
            <video src="{{ v }}" muted playsinline preload="metadata"></video>
            <span class="video-play-badge">‚ñ∂</span>
          </div>
        </button>
        {% endfor %}
      </div>

      <div class="gallery-hint">Suggerimento: swipe a sinistra/destra nel popup per cambiare.</div>
    </section>
    {% endif %}

    <div class="card-footer">Pay4You ‚Äì Card digitale personale</div>
  </div>
</div>

<!-- MODAL MEDIA (foto/video) + frecce + miniature -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box modal-gallery">

    <button type="button" class="modal-nav-btn prev" onclick="prevMedia()" aria-label="Precedente">‚Äπ</button>

    <img id="qr-modal-img" src="" alt="Foto" style="display:none;">
    <video id="qr-modal-video" controls playsinline style="display:none;"></video>

    <button type="button" class="modal-nav-btn next" onclick="nextMedia()" aria-label="Successivo">‚Ä∫</button>

    <div id="modal-filmstrip" class="modal-filmstrip"></div>

    <div class="modal-controls">
      <div id="modal-counter" class="modal-counter"></div>
      <button type="button" class="modal-close-btn" onclick="closeQrModal()">Chiudi</button>
    </div>
  </div>
</div>

<script>
  const galleryImages = {{ (gallery if gallery else [])|tojson }};
  const galleryVideos = {{ (vids if vids else [])|tojson }};

  const mediaItems = [
    ...galleryImages.map(u => ({type:'image', url:u})),
    ...galleryVideos.map(u => ({type:'video', url:u}))
  ];

  let currentIndex = -1;
  let touchStartX = null;

  function updateCounter(){
    const el = document.getElementById('modal-counter');
    if (!el) return;
    el.textContent = (currentIndex >= 0 && mediaItems.length) ? ((currentIndex+1) + " / " + mediaItems.length) : "";
  }

  function renderFilmstrip(){
    const strip = document.getElementById('modal-filmstrip');
    if (!strip) return;
    strip.innerHTML = "";

    mediaItems.forEach((it, idx) => {
      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = "filmstrip-thumb" + (idx === currentIndex ? " active" : "");
      btn.onclick = () => showIndex(idx);

      if (it.type === 'image'){
        const img = document.createElement('img');
        img.src = it.url;
        img.alt = "thumb";
        btn.appendChild(img);
      } else {
        const wrap = document.createElement('div');
        wrap.className = "filmstrip-video";
        const v = document.createElement('video');
        v.src = it.url;
        v.muted = true;
        v.playsInline = true;
        v.preload = "metadata";
        wrap.appendChild(v);

        const badge = document.createElement('span');
        badge.className = "filmstrip-play";
        badge.textContent = "‚ñ∂";
        wrap.appendChild(badge);

        btn.appendChild(wrap);
      }

      strip.appendChild(btn);
    });

    const active = strip.querySelector('.filmstrip-thumb.active');
    if (active) active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  }

  function showCurrent(){
    const imgEl = document.getElementById('qr-modal-img');
    const vidEl = document.getElementById('qr-modal-video');

    const it = mediaItems[currentIndex];
    if (!it) return;

    imgEl.style.display = "none";
    vidEl.style.display = "none";
    vidEl.pause();
    vidEl.removeAttribute("src");
    vidEl.load();

    if (it.type === 'image'){
      imgEl.src = it.url;
      imgEl.style.display = "block";
    } else {
      vidEl.src = it.url;
      vidEl.style.display = "block";
      try { vidEl.play(); } catch(e){}
    }

    updateCounter();
    renderFilmstrip();
  }

  function openMediaModal(url, type){
    const idx = mediaItems.findIndex(x => x.url === url && x.type === type);
    currentIndex = (idx >= 0) ? idx : 0;
    document.getElementById('qr-modal').style.display = 'flex';
    showCurrent();
  }

  function closeQrModal(){
    document.getElementById('qr-modal').style.display = 'none';
    const vidEl = document.getElementById('qr-modal-video');
    vidEl.pause();
    vidEl.removeAttribute("src");
    vidEl.load();
    currentIndex = -1;
    updateCounter();
    const strip = document.getElementById('modal-filmstrip');
    if (strip) strip.innerHTML = "";
  }

  function showIndex(i){
    if (!mediaItems.length) return;
    currentIndex = (i + mediaItems.length) % mediaItems.length;
    showCurrent();
  }
  function nextMedia(){ if (currentIndex >= 0) showIndex(currentIndex + 1); }
  function prevMedia(){ if (currentIndex >= 0) showIndex(currentIndex - 1); }

  document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (e.key === 'ArrowRight') nextMedia();
    if (e.key === 'ArrowLeft') prevMedia();
    if (e.key === 'Escape') closeQrModal();
  });

  document.addEventListener('click', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (e.target === modal) closeQrModal();
  });

  document.addEventListener('touchstart', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    touchStartX = e.changedTouches[0].clientX;
  }, {passive:true});

  document.addEventListener('touchend', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (touchStartX === null) return;
    const endX = e.changedTouches[0].clientX;
    const delta = endX - touchStartX;
    touchStartX = null;
    if (Math.abs(delta) > 40) {
      if (delta < 0) nextMedia();
      else prevMedia();
    }
  }, {passive:true});
</script>

<style>
/* video thumbs */
.video-thumb{
  width:185px; height:185px;
  border-radius:18px;
  overflow:hidden;
  position:relative;
  border: 1px solid rgba(148,163,184,0.35);
  background: rgba(2,6,23,0.35);
}
.video-thumb video{ width:100%; height:100%; object-fit:cover; display:block; }
.video-play-badge{
  position:absolute; left:10px; bottom:10px;
  width:34px; height:34px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(2,6,23,0.65);
  border:1px solid rgba(148,163,184,0.45);
  color:#fff; font-weight:700;
}

/* modal grande */
.modal-gallery{ position:relative; width:min(1100px, 96vw); max-width:1100px; }
#qr-modal-img{ width:100%; max-height:72vh; object-fit:contain; border-radius:14px; }
#qr-modal-video{ width:100%; max-height:72vh; border-radius:14px; background:#000; }

/* frecce */
.modal-nav-btn{
  position:absolute; top:50%; transform: translateY(-50%);
  width:48px; height:48px; border-radius:999px;
  border:1px solid rgba(148,163,184,0.5);
  background: rgba(2,6,23,0.65);
  color:#fff; font-size:28px; cursor:pointer;
}
.modal-nav-btn.prev{ left:10px; }
.modal-nav-btn.next{ right:10px; }

/* filmstrip */
.modal-filmstrip{
  margin-top:10px;
  display:flex; gap:8px; overflow-x:auto;
  padding:6px 4px;
}
.filmstrip-thumb{
  border:none; padding:0; background:none; cursor:pointer;
  flex:0 0 auto; border-radius:12px; overflow:hidden;
}
.filmstrip-thumb img{
  width:86px; height:60px; object-fit:cover; display:block;
  border-radius:12px;
  border:1px solid rgba(148,163,184,0.35);
  opacity:0.85;
}
.filmstrip-thumb.active img{
  opacity:1;
  border-color: rgba(250,204,21,0.8);
  box-shadow: 0 10px 24px rgba(0,0,0,0.65);
}
.filmstrip-video{
  width:86px; height:60px;
  border-radius:12px; overflow:hidden; position:relative;
  border:1px solid rgba(148,163,184,0.35);
  background: rgba(2,6,23,0.35);
}
.filmstrip-video video{ width:100%; height:100%; object-fit:cover; display:block; opacity:0.9; }
.filmstrip-play{
  position:absolute; left:6px; bottom:6px;
  width:20px; height:20px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(2,6,23,0.65);
  border:1px solid rgba(148,163,184,0.45);
  color:#fff; font-size:11px; font-weight:700;
}

/* hint */
.gallery-hint{ margin-top:10px; font-size:12px; color: rgba(229,231,235,0.70); }
</style>
{% endblock %}
