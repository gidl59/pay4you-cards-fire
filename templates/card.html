{% extends "base.html" %}
{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- HEADER LOGO -->
    <div class="card-header-row">
      <img
        src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
        alt="Logo"
        class="card-logo-big"
      >
    </div>

    <!-- PROFILO -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img src="{{ ag.photo_url }}" alt="{{ ag.name }}">
            </div>
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>

        {% if ag.role %}
          <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}

        {% if ag.company %}
          <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}

        {% if ag.bio %}
          <div class="card-bio">{{ ag.bio }}</div>
        {% endif %}
      </div>
    </div>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">üì±</div>
        <div class="label">Chiama mobile</div>
        <div class="value"><a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a></div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row">
        <div class="icon">üü¢</div>
        <div class="label">WhatsApp</div>
        <div class="value">
          <a href="https://wa.me/{{ ag.whatsapp|replace(' ', '')|replace('+', '') }}" target="_blank" rel="noopener noreferrer">
            Scrivi su WhatsApp
          </a>
        </div>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        <div class="icon">üìß</div>
        <div class="label">Email</div>
        <div class="value"><a href="mailto:{{ email }}">{{ email }}</a></div>
      </div>
      {% endfor %}

      {# ‚úÖ SITI: normalizza (se manca http/https aggiunge https://) #}
      {% for site in websites %}
        {% set _site = site|trim %}
        {% if _site %}
          {% if _site.startswith('http://') or _site.startswith('https://') or _site.startswith('/') %}
            {% set site_href = _site %}
          {% else %}
            {% set site_href = 'https://' ~ _site %}
          {% endif %}

          <div class="contact-row">
            <div class="icon">üåê</div>
            <div class="label">Sito internet</div>
            <div class="value">
              <a href="{{ site_href }}" target="_blank" rel="noopener noreferrer">
                {{ _site }}
              </a>
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {% if ag.facebook %}
      {% set _fb_url = ag.facebook if ag.facebook.startswith('http') else 'https://facebook.com/' ~ ag.facebook %}
      <div class="contact-row">
        <div class="icon">üìò</div>
        <div class="label">Facebook</div>
        <div class="value"><a href="{{ _fb_url }}" target="_blank" rel="noopener noreferrer">Apri Facebook</a></div>
      </div>
      {% endif %}

      {% if ag.instagram %}
      {% set _ig_clean = ag.instagram|replace('@','') %}
      {% set _ig_url = ag.instagram if ag.instagram.startswith('http') else 'https://instagram.com/' ~ _ig_clean %}
      <div class="contact-row">
        <div class="icon">üì∏</div>
        <div class="label">Instagram</div>
        <div class="value"><a href="{{ _ig_url }}" target="_blank" rel="noopener noreferrer">Apri Instagram</a></div>
      </div>
      {% endif %}

      {% if ag.linkedin %}
      {% set _li_clean = ag.linkedin|replace('@','') %}
      {% set _li_url = ag.linkedin if ag.linkedin.startswith('http') else 'https://www.linkedin.com/in/' ~ _li_clean %}
      <div class="contact-row">
        <div class="icon">üíº</div>
        <div class="label">LinkedIn</div>
        <div class="value"><a href="{{ _li_url }}" target="_blank" rel="noopener noreferrer">Apri LinkedIn</a></div>
      </div>
      {% endif %}

      {% if ag.tiktok %}
      {% set _tt_clean = ag.tiktok|replace('@','') %}
      {% set _tt_url = ag.tiktok if ag.tiktok.startswith('http') else 'https://www.tiktok.com/@' ~ _tt_clean %}
      <div class="contact-row">
        <div class="icon">üéµ</div>
        <div class="label">TikTok</div>
        <div class="value"><a href="{{ _tt_url }}" target="_blank" rel="noopener noreferrer">Apri TikTok</a></div>
      </div>
      {% endif %}

      {% if ag.telegram %}
      {% set _tg_clean = ag.telegram|replace('@','') %}
      {% set _tg_url = ag.telegram if ag.telegram.startswith('http') else 'https://t.me/' ~ _tg_clean %}
      <div class="contact-row">
        <div class="icon">‚úàÔ∏è</div>
        <div class="label">Telegram</div>
        <div class="value"><a href="{{ _tg_url }}" target="_blank" rel="noopener noreferrer">Apri Telegram</a></div>
      </div>
      {% endif %}

      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">üèõÔ∏è</div>
        <div class="label">PEC</div>
        <div class="value"><a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a></div>
      </div>
      {% endif %}

      {% if ag.piva %}
      <div class="contact-row">
        <div class="icon">üßæ</div>
        <div class="label">Partita IVA</div>
        <div class="value">{{ ag.piva }}</div>
      </div>
      {% endif %}

      {% if ag.sdi %}
      <div class="contact-row">
        <div class="icon">üè∑Ô∏è</div>
        <div class="label">Codice SDI</div>
        <div class="value">{{ ag.sdi }}</div>
      </div>
      {% endif %}

      {% for a in addresses %}
      <div class="contact-row">
        <div class="icon">üìç</div>
        <div class="label">Indirizzo{% if addresses|length > 1 %} {{ loop.index }}{% endif %}</div>
        <div class="value">
          <a href="https://www.google.com/maps?q={{ a|trim|urlencode }}"
             target="_blank" rel="noopener noreferrer">
            {{ a }}
          </a>
        </div>
      </div>
      {% endfor %}

      <div class="contact-row">
        <div class="icon">üíæ</div>
        <div class="label">Salva contatto</div>
        <div class="value"><a href="{{ url_for('vcard', slug=ag.slug) }}">Salva</a></div>
      </div>
    </section>

    <!-- DOCUMENTI PDF -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>

      <div class="pdf-list">
        {% for pdf in pdfs %}
          {# ‚úÖ PDF: normalizza URL (assoluto se serve) #}
          {% set _u = (pdf.url or '')|trim %}
          {% if _u.startswith('http://') or _u.startswith('https://') %}
            {% set pdf_href = _u %}
          {% elif _u.startswith('/') %}
            {% set pdf_href = base_url ~ _u %}
          {% else %}
            {% set pdf_href = base_url ~ '/' ~ _u %}
          {% endif %}

          <div class="pdf-item">
            <div class="pdf-title">{{ pdf.name }}</div>

            <div class="pdf-actions">
              <a class="primary" href="{{ pdf_href }}" target="_blank" rel="noopener">
                Apri / Scarica
              </a>

              <a href="mailto:?subject={{ pdf.name }}&body=Ti invio questo documento:%0A{{ pdf_href }}">
                Invia Email
              </a>

              <a href="https://wa.me/?text=Ti invio questo documento: {{ pdf_href }}"
                 target="_blank" rel="noopener">
                Invia WhatsApp
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {# =========================
       GALLERIE SEPARATE: FOTO + VIDEO
       ========================= #}
    {% set vids = (videos if videos is defined else []) %}

    {% if gallery %}
    <section class="card-section">
      <h2>Galleria foto</h2>
      <div class="gallery-scroll">
        {% for img in gallery %}
        <button type="button" class="gallery-thumb-btn" onclick="openMediaModal('{{ img }}','image')">
          <img src="{{ img }}" alt="Foto">
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {% if vids %}
    <section class="card-section">
      <h2>Galleria video</h2>
      <div class="gallery-scroll">
        {% for v in vids %}
        <button type="button" class="gallery-thumb-btn is-video" onclick="openMediaModal('{{ v }}','video')">
          <div class="video-thumb">
            <video class="thumb-video" src="{{ v }}" muted playsinline preload="metadata"></video>
            <img class="thumb-video-img" alt="Anteprima video" />
            <span class="video-play-badge">‚ñ∂</span>
          </div>
        </button>
        {% endfor %}
      </div>
      <div class="gallery-hint">Suggerimento: swipe a sinistra/destra nel popup per cambiare.</div>
    </section>
    {% endif %}

    <div class="card-footer">Pay4You ‚Äì Card digitale personale</div>
    <div class="made-by">Realizzato da Giuseppe Di Lisio ¬© 2026</div>
  </div>
</div>

<!-- MODAL MEDIA -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box modal-gallery" id="modalBox">
    <button type="button" class="modal-nav-btn prev" onclick="prevMedia()" aria-label="Precedente">‚Äπ</button>

    <div class="modal-stage">
      <img id="qr-modal-img" src="" alt="Foto" style="display:none;">
      <video id="qr-modal-video" controls playsinline style="display:none;"></video>
    </div>

    <!-- filmstrip separato -->
    <div class="modal-filmstrip-wrap">
      <div class="filmstrip-title">Foto</div>
      <div id="filmstrip-photos" class="modal-filmstrip"></div>

      <div class="filmstrip-title" style="margin-top:10px;">Video</div>
      <div id="filmstrip-videos" class="modal-filmstrip"></div>
    </div>

    <div class="modal-controls">
      <div id="modal-counter" class="modal-counter"></div>
      <button type="button" class="modal-close-btn" onclick="closeQrModal()">Chiudi</button>
    </div>

    <button type="button" class="modal-nav-btn next" onclick="nextMedia()" aria-label="Successivo">‚Ä∫</button>
  </div>
</div>

<script>
  const galleryImages = {{ (gallery if gallery else [])|tojson }};
  const galleryVideos = {{ (vids if vids else [])|tojson }};

  const mediaItems = [
    ...galleryImages.map(u => ({type:'image', url:u})),
    ...galleryVideos.map(u => ({type:'video', url:u}))
  ];

  let currentIndex = -1;
  let touchStartX = null;

  function updateCounter(){
    const el = document.getElementById('modal-counter');
    if (!el) return;
    el.textContent = (currentIndex >= 0 && mediaItems.length) ? ((currentIndex+1) + " / " + mediaItems.length) : "";
  }

  async function makeVideoThumb(videoEl, imgEl){
    try{
      videoEl.muted = true;
      videoEl.playsInline = true;

      if (videoEl.readyState < 1){
        await new Promise(res => videoEl.addEventListener('loadedmetadata', res, {once:true}));
      }

      const t = Math.min(0.1, Math.max(0, (videoEl.duration || 1) - 0.2));
      if (!isNaN(t)){
        videoEl.currentTime = t;
        await new Promise(res => videoEl.addEventListener('seeked', res, {once:true}));
      }

      if (videoEl.readyState < 2){
        await new Promise(res => videoEl.addEventListener('loadeddata', res, {once:true}));
      }

      const canvas = document.createElement('canvas');
      const w = videoEl.videoWidth || 300;
      const h = videoEl.videoHeight || 300;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoEl, 0, 0, w, h);

      imgEl.src = canvas.toDataURL('image/jpeg', 0.82);
      imgEl.style.display = 'block';
      videoEl.style.display = 'none';
    } catch(e){
      imgEl.style.display = 'none';
      videoEl.style.display = 'block';
    }
  }

  function buildInlineVideoThumbs(){
    document.querySelectorAll('.video-thumb').forEach(box => {
      const v = box.querySelector('video.thumb-video');
      const img = box.querySelector('img.thumb-video-img');
      if (!v || !img) return;
      makeVideoThumb(v, img);
    });
  }

  function renderFilmstrips(){
    const stripPhotos = document.getElementById('filmstrip-photos');
    const stripVideos = document.getElementById('filmstrip-videos');
    if (!stripPhotos || !stripVideos) return;

    stripPhotos.innerHTML = "";
    stripVideos.innerHTML = "";

    galleryImages.forEach((url) => {
      const idx = mediaItems.findIndex(x => x.type==='image' && x.url===url);

      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = "filmstrip-thumb" + (idx === currentIndex ? " active" : "");
      btn.onclick = () => showIndex(idx);

      const img = document.createElement('img');
      img.src = url;
      img.alt = "thumb foto";
      btn.appendChild(img);

      stripPhotos.appendChild(btn);
    });

    galleryVideos.forEach((url) => {
      const idx = mediaItems.findIndex(x => x.type==='video' && x.url===url);

      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = "filmstrip-thumb" + (idx === currentIndex ? " active" : "");
      btn.onclick = () => showIndex(idx);

      const wrap = document.createElement('div');
      wrap.className = "filmstrip-video";

      const v = document.createElement('video');
      v.src = url;
      v.muted = true;
      v.playsInline = true;
      v.preload = "metadata";
      v.style.display = "none";
      wrap.appendChild(v);

      const img = document.createElement('img');
      img.alt = "thumb video";
      img.style.display = "block";
      wrap.appendChild(img);

      const badge = document.createElement('span');
      badge.className = "filmstrip-play";
      badge.textContent = "‚ñ∂";
      wrap.appendChild(badge);

      btn.appendChild(wrap);
      stripVideos.appendChild(btn);

      makeVideoThumb(v, img);
    });

    const active = document.querySelector('.filmstrip-thumb.active');
    if (active) active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  }

  function showCurrent(){
    const imgEl = document.getElementById('qr-modal-img');
    const vidEl = document.getElementById('qr-modal-video');
    const modalBox = document.getElementById('modalBox');

    const it = mediaItems[currentIndex];
    if (!it) return;

    imgEl.style.display = "none";
    vidEl.style.display = "none";
    vidEl.pause();
    vidEl.removeAttribute("src");
    vidEl.load();

    if (it.type === 'video'){
      modalBox.classList.add('is-video');
    } else {
      modalBox.classList.remove('is-video');
    }

    if (it.type === 'image'){
      imgEl.src = it.url;
      imgEl.style.display = "block";
    } else {
      vidEl.src = it.url;
      vidEl.style.display = "block";
      try { vidEl.play(); } catch(e){}
    }

    updateCounter();
    renderFilmstrips();
  }

  function openMediaModal(url, type){
    const idx = mediaItems.findIndex(x => x.url === url && x.type === type);
    currentIndex = (idx >= 0) ? idx : 0;
    document.getElementById('qr-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden'; /* ‚úÖ blocca scroll dietro */
    showCurrent();
  }

  function closeQrModal(){
    document.getElementById('qr-modal').style.display = 'none';
    document.body.style.overflow = '';       /* ‚úÖ riabilita scroll */

    const vidEl = document.getElementById('qr-modal-video');
    vidEl.pause();
    vidEl.removeAttribute("src");
    vidEl.load();
    currentIndex = -1;
    updateCounter();
    const p = document.getElementById('filmstrip-photos');
    const v = document.getElementById('filmstrip-videos');
    if (p) p.innerHTML = "";
    if (v) v.innerHTML = "";
  }

  function showIndex(i){
    if (!mediaItems.length) return;
    currentIndex = (i + mediaItems.length) % mediaItems.length;
    showCurrent();
  }
  function nextMedia(){ if (currentIndex >= 0) showIndex(currentIndex + 1); }
  function prevMedia(){ if (currentIndex >= 0) showIndex(currentIndex - 1); }

  document.addEventListener('click', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (e.target === modal) closeQrModal();
  });

  document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (e.key === 'Escape') closeQrModal();
  });

  document.addEventListener('touchstart', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    touchStartX = e.changedTouches[0].clientX;
  }, {passive:true});

  document.addEventListener('touchend', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (touchStartX === null) return;
    const endX = e.changedTouches[0].clientX;
    const delta = endX - touchStartX;
    touchStartX = null;
    if (Math.abs(delta) > 40) {
      if (delta < 0) nextMedia();
      else prevMedia();
    }
  }, {passive:true});

  document.addEventListener('DOMContentLoaded', buildInlineVideoThumbs);
</script>

<style>
/* thumbs */
.gallery-thumb-btn{
  border: none;
  padding: 0;
  background: none;
  cursor: pointer;
  flex: 0 0 auto;
  width: 185px;
  height: 185px;
  border-radius: 18px;
  overflow: hidden;
}
.gallery-thumb-btn img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.video-thumb{ width: 100%; height: 100%; position: relative; background: rgba(2,6,23,0.35); }
.thumb-video{ display:none; }
.thumb-video-img{ width:100%; height:100%; object-fit:cover; display:block; }
.video-play-badge{
  position:absolute; left:10px; bottom:10px;
  width:34px; height:34px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(2,6,23,0.65);
  border:1px solid rgba(148,163,184,0.45);
  color:#fff; font-weight:700;
}

/* ===== MODAL FIX (Chiudi sempre visibile) ===== */
.modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 14px;
}

.modal-box.modal-gallery{
  position: relative;
  width: min(1100px, 96vw);
  max-width: 1100px;

  max-height: 92vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;

  padding: 10px 10px 0;
  background: #020617;
  border-radius: 18px;
  border: 1px solid rgba(148,163,184,0.7);
}

.modal-box.modal-gallery.is-video{
  width: min(860px, 96vw);
  max-width: 860px;
}

/* stage scrollabile */
.modal-stage{
  flex: 1;
  min-height: 0;
  display:flex;
  justify-content:center;
  align-items:center;
  padding: 8px 6px 10px;
  overflow: auto;
}

#qr-modal-img{
  max-height: 74vh;
  max-width: 96vw;
  width: auto;
  height: auto;
  object-fit: contain;
  border-radius: 14px;
}

#qr-modal-video{
  max-height: 74vh;
  max-width: 96vw;
  width: 100%;
  height: auto;
  border-radius: 14px;
  background:#000;
}

/* frecce */
.modal-nav-btn{
  position:absolute;
  top: 42%;
  transform: translateY(-50%);
  width:48px; height:48px; border-radius:999px;
  border:1px solid rgba(148,163,184,0.5);
  background: rgba(2,6,23,0.65);
  color:#fff; font-size:28px; cursor:pointer;
  z-index: 5;
}
.modal-nav-btn.prev{ left:10px; }
.modal-nav-btn.next{ right:10px; }

/* filmstrip */
.modal-filmstrip-wrap{
  padding: 10px 6px 10px;
  border-top: 1px solid rgba(148,163,184,0.14);
  background: rgba(2,6,23,0.35);
  max-height: 22vh;
  overflow: auto;
}
.filmstrip-title{ font-size: 12px; color: rgba(229,231,235,0.75); margin: 2px 0 6px; }
.modal-filmstrip{ display:flex; gap:8px; overflow-x:auto; padding: 6px 4px; }
.filmstrip-thumb{ border:none; padding:0; background:none; cursor:pointer; flex:0 0 auto; border-radius:12px; overflow:hidden; }
.filmstrip-thumb img{
  width:86px; height:60px; object-fit:cover; display:block;
  border-radius:12px;
  border:1px solid rgba(148,163,184,0.35);
  opacity:0.85;
}
.filmstrip-thumb.active img{
  opacity:1;
  border-color: rgba(250,204,21,0.8);
  box-shadow: 0 10px 24px rgba(0,0,0,0.65);
}
.filmstrip-video{
  width:86px; height:60px; border-radius:12px; overflow:hidden;
  position:relative;
  border:1px solid rgba(148,163,184,0.35);
  background: rgba(2,6,23,0.35);
}
.filmstrip-video img{ width:100%; height:100%; object-fit:cover; display:block; opacity: 0.92; }
.filmstrip-play{
  position:absolute; left:6px; bottom:6px;
  width:20px; height:20px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(2,6,23,0.65);
  border:1px solid rgba(148,163,184,0.45);
  color:#fff; font-size:11px; font-weight:700;
}

/* controls sticky */
.modal-controls{
  position: sticky;
  bottom: 0;
  z-index: 10;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px 12px;
  background: rgba(2,6,23,0.92);
  border-top: 1px solid rgba(148,163,184,0.22);
}
.modal-counter{ font-size: 12px; color: rgba(229,231,235,0.7); }
.modal-close-btn{
  padding: 10px 16px;
  border-radius: 999px;
  border: none;
  background: #facc15;
  color: #111827;
  font-weight: 800;
  cursor: pointer;
}

.gallery-hint{ margin-top:10px; font-size:12px; color: rgba(229,231,235,0.70); }
.made-by{ margin-top: 12px; text-align: center; font-size: 12px; color: rgba(229,231,235,0.55); }
</style>
{% endblock %}
