{% extends "base.html" %}

{% block content %}
<div class="card-wrapper">

  <div class="p4y-card">
    <header class="p4y-header">
      <div class="p4y-logo">
        <div class="p4y-logo-circle">P4Y</div>
        <div class="p4y-logo-text">
          <span class="p4y-logo-main">Pay4You</span>
          <span class="p4y-logo-sub">Digital Business Card</span>
        </div>
      </div>
    </header>

    <section class="p4y-main">
      <div class="p4y-top">
        <div class="p4y-photo">
          {% if agent.photo_url %}
            <img src="{{ agent.photo_url }}" alt="Foto profilo" />
          {% else %}
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Foto profilo" />
          {% endif %}
        </div>
        <div class="p4y-info">
          <h1>{{ agent.name }}</h1>
          {% if agent.role %}
            <h2>{{ agent.role }}</h2>
          {% endif %}
          {% if agent.company %}
            <p class="p4y-company">{{ agent.company }}</p>
          {% endif %}
        </div>
      </div>

      <ul class="p4y-contact-list">
        {% if agent.phone %}
        <li>
          <i class="fa-solid fa-phone"></i>
          <a href="tel:{{ agent.phone | replace(' ', '') }}">{{ agent.phone }}</a>
        </li>
        {% endif %}

        {% if agent.email %}
        <li>
          <i class="fa-solid fa-envelope"></i>
          <a href="mailto:{{ agent.email }}">{{ agent.email }}</a>
        </li>
        {% endif %}

        {% if agent.website %}
        <li>
          <i class="fa-solid fa-globe"></i>
          <a href="{{ agent.website }}" target="_blank" rel="noopener">
            {{ agent.website }}
          </a>
        </li>
        {% endif %}

        {% if agent.address %}
        <li>
          <i class="fa-solid fa-location-dot"></i>
          <span>{{ agent.address }}</span>
        </li>
        {% endif %}
      </ul>
    </section>

    <!-- SOCIAL -->
    <section class="p4y-section">
      <h3><i class="fa-solid fa-share-nodes"></i> Contatti rapidi</h3>
      <div class="p4y-social-buttons">
        {% if agent.whatsapp %}
          <a class="p4y-social-btn"
             href="https://wa.me/{{ agent.whatsapp|replace(' ', '') }}"
             target="_blank" rel="noopener">
            <i class="fa-brands fa-whatsapp"></i> WhatsApp
          </a>
        {% endif %}
        {% if agent.facebook %}
          <a class="p4y-social-btn"
             href="{{ agent.facebook }}"
             target="_blank" rel="noopener">
            <i class="fa-brands fa-facebook"></i> Facebook
          </a>
        {% endif %}
        {% if agent.instagram %}
          <a class="p4y-social-btn"
             href="{{ agent.instagram }}"
             target="_blank" rel="noopener">
            <i class="fa-brands fa-instagram"></i> Instagram
          </a>
        {% endif %}
      </div>
    </section>

    <!-- DATI FISCALI -->
    {% if agent.company or agent.piva or agent.tax_code or agent.iban %}
    <section class="p4y-section">
      <h3><i class="fa-solid fa-file-invoice"></i> Dati fiscali</h3>
      <ul class="p4y-fiscal-list">
        {% if agent.company %}
        <li>
          <span class="label">Ragione sociale</span>
          <span>{{ agent.company }}</span>
        </li>
        {% endif %}

        {% if agent.piva %}
        <li>
          <span class="label">
            <i class="fa-solid fa-house"></i> Partita IVA
          </span>
          <span>{{ agent.piva }}</span>
        </li>
        {% endif %}

        {% if agent.tax_code %}
        <li>
          <span class="label">Cod. fiscale</span>
          <span>{{ agent.tax_code }}</span>
        </li>
        {% endif %}

        {% if agent.iban %}
        <li class="iban-row">
          <span class="label">
            <i class="fa-solid fa-building-columns"></i> IBAN
          </span>
          <span class="iban-value" id="ibanText">
            {{ agent.iban }}
          </span>
        </li>
        <li class="iban-row">
          <span class="label"></span>
          <button type="button"
                  class="btn btn-sm btn-outline-light copy-iban-btn"
                  data-iban="{{ agent.iban }}"
                  id="copyIbanBtn">
            <i class="fa-regular fa-copy"></i> Copia IBAN
          </button>
        </li>
        {% endif %}
      </ul>
    </section>
    {% endif %}

    {% if agent.bio %}
    <section class="p4y-section">
      <h3><i class="fa-solid fa-circle-info"></i> Chi sono</h3>
      <p>{{ agent.bio }}</p>
    </section>
    {% endif %}

    <footer class="p4y-footer">
      <a href="{{ url_for('download_vcf', agent_id=agent.id) }}"
         class="btn btn-primary btn-sm">
        <i class="fa-solid fa-address-card"></i> Salva contatto
      </a>
      <a href="{{ url_for('login') }}" class="btn btn-secondary btn-sm">
        Torna all'area admin
      </a>
    </footer>

  </div>
</div>

<script>
  // bottone "Copia IBAN"
  (function () {
    const btn = document.getElementById('copyIbanBtn');
    if (!btn) return;
    btn.addEventListener('click', function () {
      const iban = this.getAttribute('data-iban');
      if (!iban) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(iban.trim())
          .then(() => {
            this.innerHTML = '<i class="fa-solid fa-check"></i> Copiato!';
            setTimeout(() => {
              this.innerHTML = '<i class="fa-regular fa-copy"></i> Copia IBAN';
            }, 1500);
          })
          .catch(() => {
            alert('Non riesco a copiare in automatico. Copia manualmente: ' + iban);
          });
      } else {
        // fallback
        alert('Copiatura automatica non supportata. Copia manualmente: ' + iban);
      }
    });
  })();
</script>
{% endblock %}
