{% extends "base.html" %}

{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <article class="card-outer">
    <!-- HEADER LOGO -->
    <header class="card-header-row">
      <img
        src="{{ url_for('static', filename='logo.png') }}"
        alt="Pay4You"
        class="card-logo-big"
      >
    </header>

    <!-- BLOCCO FOTO + DATI BASE -->
    <section class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
          <img src="{{ ag.photo_url }}" alt="{{ ag.name }}" class="card-profile-photo">
        {% else %}
          <div class="card-profile-photo card-profile-photo--placeholder"></div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>
        {% if ag.role %}
          <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}
        {% if ag.company %}
          <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}
        {% if ag.bio %}
          <p class="card-bio">{{ ag.bio }}</p>
        {% endif %}
      </div>
    </section>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">üì±</div>
        <div class="label">Chiama mobile</div>
        <div class="value">
          <a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a>
        </div>
      </div>
      {% endif %}

      {% if ag.phone_office %}
      <div class="contact-row">
        <div class="icon">‚òéÔ∏è</div>
        <div class="label">Chiama ufficio</div>
        <div class="value">
          <a href="tel:{{ ag.phone_office }}">{{ ag.phone_office }}</a>
        </div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row whatsapp-row">
        <div class="icon">üü¢</div>
        <div class="label">WhatsApp</div>
        <div class="value">
          <a href="https://wa.me/{{ ag.whatsapp | replace('+','') }}">{{ ag.whatsapp }}</a>
        </div>
      </div>
      {% endif %}

      {# Email lavoro / personali #}
      {% for e in emails %}
      <div class="contact-row">
        <div class="icon">üìß</div>
        <div class="label">Email</div>
        <div class="value">
          <a href="mailto:{{ e }}">{{ e }}</a>
        </div>
      </div>
      {% endfor %}

      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">üìÆ</div>
        <div class="label">PEC</div>
        <div class="value">
          <a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a>
        </div>
      </div>
      {% endif %}

      {# SITO INTERNET ‚Üí APRE NELL‚ÄôOVERLAY CON TORNA INDIETRO #}
      {% if websites %}
      {% for w in websites %}
      <div class="contact-row">
        <div class="icon">üåê</div>
        <div class="label">Sito internet</div>
        <div class="value">
          <a href="#" onclick="openOverlay('{{ w }}'); return false;">{{ w }}</a>
        </div>
      </div>
      {% endfor %}
      {% endif %}

      {% if ag.facebook %}
      <div class="contact-row social-row">
        <div class="icon">üìò</div>
        <div class="label">Facebook</div>
        <div class="value">
          <a href="{{ ag.facebook }}" target="_blank">Profilo</a>
        </div>
      </div>
      {% endif %}

      {% if ag.instagram %}
      <div class="contact-row social-row">
        <div class="icon">üì∏</div>
        <div class="label">Instagram</div>
        <div class="value">
          <a href="{{ ag.instagram }}" target="_blank">Profilo</a>
        </div>
      </div>
      {% endif %}

      {% if ag.linkedin %}
      <div class="contact-row social-row">
        <div class="icon">üíº</div>
        <div class="label">LinkedIn</div>
        <div class="value">
          <a href="{{ ag.linkedin }}" target="_blank">Profilo</a>
        </div>
      </div>
      {% endif %}

      <!-- SALVA CONTATTO (vCard) -->
      <div class="contact-row">
        <div class="icon">üíæ</div>
        <div class="label">Salva contatto</div>
        <div class="value">
          <a href="{{ url_for('vcard', slug=ag.slug) }}?download=1">Scarica vCard</a>
        </div>
      </div>

      <!-- QR (gi√† perfetto, non tocchiamo logica) -->
      <div class="contact-row">
        <div class="icon">üî≥</div>
        <div class="label">QR code</div>
        <div class="value">
          <a href="{{ url_for('qr', slug=ag.slug) }}" target="_blank">Apri QR</a>
        </div>
      </div>
    </section>

    <!-- DATI FISCALI -->
    {% if ag.piva or ag.sdi %}
    <section class="card-section">
      <h2>Dati fiscali</h2>

      {% if ag.piva %}
      <div class="contact-row">
        <div class="icon">üèõÔ∏è</div>
        <div class="label">Partita IVA</div>
        <div class="value">{{ ag.piva }}</div>
      </div>
      {% endif %}

      {% if ag.sdi %}
      <div class="contact-row">
        <div class="icon">üìë</div>
        <div class="label">Codice SDI</div>
        <div class="value">{{ ag.sdi }}</div>
      </div>
      {% endif %}
    </section>
    {% endif %}

    <!-- INDIRIZZI -->
    {% if addresses %}
    <section class="card-section">
      <h2>Indirizzi</h2>
      {% for addr in addresses %}
      <div class="address-row">
        <div class="address-value">{{ addr }}</div>
      </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- DOCUMENTI PDF (max 6) ‚Äì APRONO IN OVERLAY -->
    {% set pdfs = [] %}
    {% if ag.pdf1_url %}{% set _ = pdfs.append(('Documento 1', ag.pdf1_url)) %}{% endif %}
    {% if ag.pdf2_url %}{% set _ = pdfs.append(('Documento 2', ag.pdf2_url)) %}{% endif %}
    {% if ag.pdf3_url %}{% set _ = pdfs.append(('Documento 3', ag.pdf3_url)) %}{% endif %}
    {% if ag.pdf4_url %}{% set _ = pdfs.append(('Documento 4', ag.pdf4_url)) %}{% endif %}
    {% if ag.pdf5_url %}{% set _ = pdfs.append(('Documento 5', ag.pdf5_url)) %}{% endif %}
    {% if ag.pdf6_url %}{% set _ = pdfs.append(('Documento 6', ag.pdf6_url)) %}{% endif %}

    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>
      <div class="pdf-list">
        {% for label, url in pdfs %}
        <a href="#"
           class="pdf-item"
           onclick="openOverlay('{{ url }}'); return false;">
          <span class="pdf-icon">üìÑ</span>
          <span>{{ label }}</span>
        </a>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- GALLERIA FOTO (gi√† perfetta, non tocchiamo JS: solo visuale) -->
    {% if gallery %}
    <section class="card-section">
      <h2>Galleria foto</h2>
      <div class="gallery-scroll">
        {% for img in gallery %}
        <a href="{{ img }}" target="_blank">
          <img src="{{ img }}" alt="Foto Pay4You">
        </a>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <footer class="card-footer">
      Pay4You Digital Card
    </footer>
  </article>
</div>

<!-- OVERLAY VISUALIZZAZIONE (PDF + SITO) CON BOTTONE TORNA ALLA CARD -->
<div id="viewer-overlay" class="viewer-overlay hidden">
  <div class="viewer-topbar">
    <button type="button" class="viewer-back-btn" onclick="closeOverlay()">
      ‚Üê Torna alla card
    </button>
  </div>
  <iframe id="viewer-frame" class="viewer-frame" src="" frameborder="0"></iframe>
</div>

<script>
  function openOverlay(url) {
    const overlay = document.getElementById('viewer-overlay');
    const frame   = document.getElementById('viewer-frame');
    if (!overlay || !frame) return;
    frame.src = url;
    overlay.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function closeOverlay() {
    const overlay = document.getElementById('viewer-overlay');
    const frame   = document.getElementById('viewer-frame');
    if (!overlay || !frame) return;
    frame.src = 'about:blank';
    overlay.classList.add('hidden');
  }
</script>
{% endblock %}
