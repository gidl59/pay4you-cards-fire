<!doctype html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ ag.name }} | Card</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="format-detection" content="telephone=no">
</head>
<body>

<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- LINGUA -->
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:10px;">
      <a class="header-link" href="/{{ ag.slug }}{% if p_key %}?p={{ p_key }}&lang=it{% else %}?lang=it{% endif %}">IT</a>
      <a class="header-link" href="/{{ ag.slug }}{% if p_key %}?p={{ p_key }}&lang=en{% else %}?lang=en{% endif %}">EN</a>
    </div>

    <!-- HEADER -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
          <img class="card-profile-photo" src="{{ ag.photo_url }}" alt="photo">
        {% else %}
          <div class="card-profile-photo" style="display:flex;align-items:center;justify-content:center;font-weight:700;">
            {{ ag.name[:1] }}
          </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>
        {% if ag.role %}<div class="card-role-main">{{ ag.role }}</div>{% endif %}
        {% if ag.company %}<div class="card-role-sub">{{ ag.company }}</div>{% endif %}
        {% if ag.bio %}<div class="card-bio">{{ ag.bio }}</div>{% endif %}
      </div>
    </div>

    <!-- AZIONI (box come social) -->
    <div class="card-section">
      <h2>{{ t_func('actions') }}</h2>

      <div class="contact-row">
        <div class="icon">üìá</div>
        <div class="label">{{ t_func('save_contact') }}</div>
        <div class="value"><a href="/{{ ag.slug }}.vcf">{{ t_func('open') }}</a></div>
      </div>

      <div class="contact-row">
        <div class="icon">üì∑</div>
        <div class="label">{{ t_func('scan_qr') }}</div>
        <div class="value">
          <button class="link-button" onclick="openQrModal('/{{ ag.slug }}/qr.png{% if p_key %}?p={{ p_key }}&lang={{ lang }}{% else %}?lang={{ lang }}{% endif %}')">
            {{ t_func('open') }}
          </button>
        </div>
      </div>

      <div class="contact-row">
        <div class="icon">üîó</div>
        <div class="label">{{ t_func('direct_nfc') }}</div>
        <div class="value">
          <button class="link-button" onclick="copyText('{{ nfc_direct_url }}')">Copy</button>
        </div>
      </div>
    </div>

    <!-- CONTATTI -->
    <div class="card-section">
      <h2>{{ t_func('contacts') }}</h2>

      {% if mobiles and mobiles|length > 0 %}
        {% for m in mobiles %}
          <div class="contact-row">
            <div class="icon">üìû</div>
            <div class="label">{{ t_func('phone_mobile') }}</div>
            <div class="value"><a href="tel:{{ m }}">{{ m }}</a></div>
          </div>
        {% endfor %}
      {% endif %}

      {% if ag.phone_office %}
      <div class="contact-row">
        <div class="icon">‚òéÔ∏è</div>
        <div class="label">{{ t_func('phone_office') }}</div>
        <div class="value"><a href="tel:{{ ag.phone_office }}">{{ ag.phone_office }}</a></div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row whatsapp-row">
        <div class="icon">üí¨</div>
        <div class="label">{{ t_func('whatsapp') }}</div>
        <div class="value">
          <a href="{{ ag.whatsapp }}" target="_blank" rel="noopener">{{ t_func('whatsapp') }}</a>
        </div>
      </div>
      {% endif %}

      {% if emails and emails|length > 0 %}
        {% for e in emails %}
          <div class="contact-row">
            <div class="icon">‚úâÔ∏è</div>
            <div class="label">{{ t_func('email') }}</div>
            <div class="value"><a href="mailto:{{ e }}">{{ e }}</a></div>
          </div>
        {% endfor %}
      {% endif %}

      {% if websites and websites|length > 0 %}
        {% for w in websites %}
          <div class="contact-row">
            <div class="icon">üåê</div>
            <div class="label">{{ t_func('website') }}</div>
            <div class="value"><a href="{{ w }}" target="_blank" rel="noopener">{{ t_func('website') }}</a></div>
          </div>
        {% endfor %}
      {% endif %}

      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">üì®</div>
        <div class="label">{{ t_func('pec') }}</div>
        <div class="value">{{ ag.pec }}</div>
      </div>
      {% endif %}

      {% if ag.piva %}
      <div class="contact-row">
        <div class="icon">üßæ</div>
        <div class="label">{{ t_func('piva') }}</div>
        <div class="value">{{ ag.piva }}</div>
      </div>
      {% endif %}

      {% if ag.sdi %}
      <div class="contact-row">
        <div class="icon">üè∑Ô∏è</div>
        <div class="label">{{ t_func('sdi') }}</div>
        <div class="value">{{ ag.sdi }}</div>
      </div>
      {% endif %}
    </div>

    <!-- SOCIAL (solo nome cliccabile, non url lungo) -->
    {% set has_social = (ag.facebook or ag.instagram or ag.linkedin or ag.tiktok or ag.telegram) %}
    {% if has_social %}
    <div class="card-section">
      <h2>{{ t_func('social') }}</h2>

      {% if ag.facebook %}
      <div class="contact-row social-row">
        <div class="icon">üìò</div>
        <div class="label">{{ t_func('facebook') }}</div>
        <div class="value"><a href="{{ ag.facebook }}" target="_blank" rel="noopener">{{ t_func('facebook') }}</a></div>
      </div>
      {% endif %}

      {% if ag.instagram %}
      <div class="contact-row social-row">
        <div class="icon">üì∏</div>
        <div class="label">{{ t_func('instagram') }}</div>
        <div class="value"><a href="{{ ag.instagram }}" target="_blank" rel="noopener">{{ t_func('instagram') }}</a></div>
      </div>
      {% endif %}

      {% if ag.linkedin %}
      <div class="contact-row social-row">
        <div class="icon">üíº</div>
        <div class="label">{{ t_func('linkedin') }}</div>
        <div class="value"><a href="{{ ag.linkedin }}" target="_blank" rel="noopener">{{ t_func('linkedin') }}</a></div>
      </div>
      {% endif %}

      {% if ag.tiktok %}
      <div class="contact-row social-row">
        <div class="icon">üéµ</div>
        <div class="label">{{ t_func('tiktok') }}</div>
        <div class="value"><a href="{{ ag.tiktok }}" target="_blank" rel="noopener">{{ t_func('tiktok') }}</a></div>
      </div>
      {% endif %}

      {% if ag.telegram %}
      <div class="contact-row social-row">
        <div class="icon">‚úàÔ∏è</div>
        <div class="label">{{ t_func('telegram') }}</div>
        <div class="value"><a href="{{ ag.telegram }}" target="_blank" rel="noopener">{{ t_func('telegram') }}</a></div>
      </div>
      {% endif %}

    </div>
    {% endif %}

    <!-- INDIRIZZI -->
    {% if addresses and addresses|length > 0 %}
    <div class="card-section">
      <h2>{{ t_func('addresses') }}</h2>
      {% for a in addresses %}
        <div class="address-row"><div class="address-value">{{ a }}</div></div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- PDF -->
    {% if pdfs and pdfs|length > 0 %}
    <div class="card-section">
      <h2>{{ t_func('documents') }}</h2>
      <div class="pdf-list">
        {% for p in pdfs %}
          <a class="pdf-item" href="{{ p.url }}" target="_blank" rel="noopener">
            <span class="pdf-icon">üìÑ</span> {{ p.name }}
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- GALLERIA -->
    {% if gallery and gallery|length > 0 %}
    <div class="card-section">
      <h2>{{ t_func('gallery') }}</h2>
      <div class="gallery-scroll">
        {% for img in gallery %}
          <button class="gallery-thumb-btn" type="button" onclick="openMediaModal('img','{{ img }}')">
            <img src="{{ img }}" alt="gallery">
          </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- VIDEO -->
    {% if videos and videos|length > 0 %}
    <div class="card-section">
      <h2>{{ t_func('videos') }}</h2>
      <div class="gallery-scroll">
        {% for v in videos %}
          <button class="gallery-thumb-btn" type="button" onclick="openMediaModal('video','{{ v }}')">
            <img src="https://dummyimage.com/185x185/111827/ffffff&text=VIDEO" alt="video">
          </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- OPT-IN SOLO CLIENTI (testo chiaro) -->
    {% if wa_optin_link %}
    <div class="card-section">
      <h2>{{ t_func('subscribe_title') }}</h2>
      <div style="font-size:13px; color:#cbd5e1; margin-bottom:10px;">
        {{ t_func('subscribe_desc') }}
      </div>
      <a class="header-link" href="{{ wa_optin_link }}" target="_blank" rel="noopener">
        {{ t_func('subscribe_btn') }}
      </a>
    </div>
    {% endif %}

    <div class="card-footer">¬© Card digitale</div>
  </div>
</div>

<!-- MODAL (QR / IMG / VIDEO) -->
<div id="media-modal" style="display:none;" class="modal-overlay" onclick="closeMediaModal(event)">
  <div class="modal-box">
    <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
      <button class="modal-close-btn" type="button" onclick="forceCloseMedia()">{{ t_func('close') }}</button>
    </div>
    <div id="media-modal-body"></div>
  </div>
</div>

<script>
  function copyText(t){
    if(navigator.clipboard){
      navigator.clipboard.writeText(t).then(()=>alert("Copiato ‚úÖ"));
    }else{
      window.prompt("Copia:", t);
    }
  }

  function openQrModal(url){
    openMediaModal('img', url);
  }

  function openMediaModal(type, url){
    const modal = document.getElementById('media-modal');
    const body = document.getElementById('media-modal-body');
    body.innerHTML = "";

    if(type === 'img'){
      const img = document.createElement('img');
      img.id = "qr-modal-img";
      img.src = url;
      img.alt = "media";
      body.appendChild(img);
    } else {
      const video = document.createElement('video');
      video.src = url;
      video.controls = true;
      video.style.width = "100%";
      video.style.maxHeight = "78vh";
      body.appendChild(video);
    }

    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function forceCloseMedia(){
    const modal = document.getElementById('media-modal');
    const body = document.getElementById('media-modal-body');
    body.innerHTML = "";
    modal.style.display = "none";
    document.body.style.overflow = "auto";
  }

  function closeMediaModal(e){
    if(e.target && e.target.id === "media-modal"){
      forceCloseMedia();
    }
  }
</script>

</body>
</html>
