{% extends "base.html" %}
{% block title %}{{ ag.name }} | Pay4You Card{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- HEADER TOP: lingua + profili -->
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
      <div style="font-size:12px; opacity:.85;">
        <b>{{ t('language') }}:</b>
        <a class="header-link" href="/{{ ag.slug }}{% if p_key %}?p={{ p_key }}&lang=it{% else %}?lang=it{% endif %}">IT</a>
        <a class="header-link" href="/{{ ag.slug }}{% if p_key %}?p={{ p_key }}&lang=en{% else %}?lang=en{% endif %}">EN</a>
      </div>

      {% if profiles and profiles|length > 0 %}
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span style="font-size:12px; opacity:.85;"><b>{{ t('profile') }}:</b></span>
        <a class="header-link" href="/{{ ag.slug }}{% if lang %}?lang={{ lang }}{% endif %}">{{ t('profile_main') }}</a>
        {% for p in profiles %}
          {% if p.key %}
            <a class="header-link" href="/{{ ag.slug }}?p={{ p.key }}&lang={{ lang }}">
              {% if lang == 'en' %}{{ p.label_en or 'Profile' }}{% else %}{{ p.label_it or 'Profilo' }}{% endif %}
            </a>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- LOGO grande (solo se caricato dal cliente) -->
    <div class="card-header-row">
      {% if ag.extra_logo_url %}
        <img class="card-logo-big" src="{{ ag.extra_logo_url }}" alt="Logo">
      {% endif %}
    </div>

    <!-- BUSINESS BLOCK -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
          <img class="card-profile-photo" src="{{ ag.photo_url }}" alt="{{ ag.name }}">
        {% else %}
          <!-- niente foto: niente logo Pay4You, lasciamo vuoto pulito -->
          <div style="width:160px;height:160px;border-radius:999px;border:1px solid rgba(148,163,184,0.35); background:rgba(15,23,42,0.25);"></div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>
        {% if ag.role %}<div class="card-role-main">{{ ag.role }}</div>{% endif %}
        {% if ag.company %}<div class="card-role-sub">{{ ag.company }}</div>{% endif %}
        {% if ag.bio %}<div class="card-bio">{{ ag.bio }}</div>{% endif %}

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <a class="header-link" href="/{{ ag.slug }}.vcf">{{ t('download_vcard') }}</a>
          <button class="header-link" type="button" onclick="openQR()">{{ t('open_qr') }}</button>
        </div>
      </div>
    </div>

    <!-- CONTATTI -->
    <div class="card-section">
      <h2>{{ t('contacts') }}</h2>

      {% if mobiles or office_phone %}
      <div class="contact-row">
        <div class="icon">üìû</div>
        <div class="label">{{ t('phones') }}</div>
        <div class="value"></div>
      </div>

      {% if mobiles %}
        {% for m in mobiles %}
        <div class="contact-row">
          <div class="icon"></div>
          <div class="label">{{ t('mobile_phone') }}</div>
          <div class="value"><a href="tel:+{{ m }}">{{ m }}</a></div>
        </div>
        {% endfor %}
      {% endif %}

      {% if office_phone %}
        <div class="contact-row">
          <div class="icon"></div>
          <div class="label">{{ t('office_phone') }}</div>
          <div class="value"><a href="tel:+{{ office_phone }}">{{ office_phone }}</a></div>
        </div>
      {% endif %}
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row whatsapp-row">
        <div class="icon">üí¨</div>
        <div class="label">{{ t('whatsapp') }}</div>
        <div class="value">
          {% set wa = ag.whatsapp %}
          {% if wa.startswith('http') %}
            <a href="{{ wa }}" target="_blank" rel="noopener">{{ t('whatsapp') }}</a>
          {% else %}
            <a href="https://wa.me/{{ wa|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">{{ wa }}</a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% if emails %}
        {% for e in emails %}
        <div class="contact-row">
          <div class="icon">‚úâÔ∏è</div>
          <div class="label">{{ t('email') }}</div>
          <div class="value"><a href="mailto:{{ e }}">{{ e }}</a></div>
        </div>
        {% endfor %}
      {% endif %}

      {% if websites %}
        {% for w in websites %}
        <div class="contact-row">
          <div class="icon">üåê</div>
          <div class="label">{{ t('website') }}</div>
          <div class="value"><a href="{{ w }}" target="_blank" rel="noopener">{{ w }}</a></div>
        </div>
        {% endfor %}
      {% endif %}

      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">üì®</div>
        <div class="label">PEC</div>
        <div class="value"><a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a></div>
      </div>
      {% endif %}

      {% if ag.piva %}
      <div class="contact-row">
        <div class="icon">üè∑Ô∏è</div>
        <div class="label">P.IVA</div>
        <div class="value">{{ ag.piva }}</div>
      </div>
      {% endif %}

      {% if ag.sdi %}
      <div class="contact-row">
        <div class="icon">üßæ</div>
        <div class="label">SDI</div>
        <div class="value">{{ ag.sdi }}</div>
      </div>
      {% endif %}
    </div>

    <!-- SOCIAL (solo nome, non URL lungo) -->
    <div class="card-section">
      <h2>{{ t('social') }}</h2>

      {% macro social_row(label, url) -%}
        {% if url %}
        <div class="contact-row social-row">
          <div class="icon">üîó</div>
          <div class="label">{{ label }}</div>
          <div class="value"><a href="{{ url }}" target="_blank" rel="noopener">{{ label }}</a></div>
        </div>
        {% endif %}
      {%- endmacro %}

      {{ social_row('Facebook', ag.facebook) }}
      {{ social_row('Instagram', ag.instagram) }}
      {{ social_row('LinkedIn', ag.linkedin) }}
      {{ social_row('TikTok', ag.tiktok) }}
      {{ social_row('Telegram', ag.telegram) }}
    </div>

    <!-- ‚úÖ BOX AZIONI EVIDENZIATO (dopo social) -->
    <div class="card-section">
      <h2>{{ t('how_it_works') }}</h2>

      <div class="contact-row">
        <div class="icon">‚úÖ</div>
        <div class="label">{{ t('save_contact') }}</div>
        <div class="value"><a href="/{{ ag.slug }}.vcf">{{ t('save_contact') }}</a></div>
      </div>

      <div class="contact-row">
        <div class="icon">üì∑</div>
        <div class="label">{{ t('scan_qr') }}</div>
        <div class="value"><button class="link-button" onclick="openQR()">{{ t('scan_qr') }}</button></div>
      </div>

      <div class="contact-row">
        <div class="icon">üì≤</div>
        <div class="label">{{ t('nfc_direct') }}</div>
        <div class="value"><a href="{{ nfc_direct_url }}" target="_blank" rel="noopener">{{ nfc_direct_url }}</a></div>
      </div>
    </div>

    <!-- INDIRIZZI -->
    {% if addresses %}
    <div class="card-section">
      <h2>{{ t('address') }}</h2>
      {% for a in addresses %}
      <div class="address-row">
        <div class="address-value">{{ a }}</div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- PDF -->
    {% if pdfs %}
    <div class="card-section">
      <h2>{{ t('docs') }}</h2>
      <div class="pdf-list">
        {% for p in pdfs %}
          <a class="pdf-item" href="{{ p.url }}" target="_blank" rel="noopener">
            <span class="pdf-icon">üìÑ</span> {{ p.name }}
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- GALLERIA -->
    {% if gallery %}
    <div class="card-section">
      <h2>{{ t('gallery') }}</h2>
      <div class="gallery-scroll">
        {% for u in gallery %}
          <button class="gallery-thumb-btn" type="button" onclick="openMedia('{{ u }}','img')">
            <img src="{{ u }}" alt="Foto">
          </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- VIDEO -->
    {% if videos %}
    <div class="card-section">
      <h2>{{ t('videos') }}</h2>
      <div class="gallery-scroll">
        {% for u in videos %}
          <button class="gallery-thumb-btn" type="button" onclick="openMedia('{{ u }}','video')">
            <img src="https://dummyimage.com/320x320/0b1220/ffffff&text=VIDEO" alt="Video">
          </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- ‚úÖ BOX PRO: qui NON ti iscrivi, ma spieghiamo che il PRO invia promo (per ora solo descrizione) -->
    {% if plan == 'pro' %}
    <div class="card-section">
      <h2>{{ t('promo_box_title') }}</h2>
      <p style="margin:6px 0 0; color:#cbd5f5; font-size:13px;">
        {{ t('promo_box_desc') }}
      </p>
      <p style="margin:10px 0 0; font-size:12px; opacity:.85;">
        (Nella prossima fase collegiamo WhatsApp Business: invio foto + testo direttamente dalla piattaforma.)
      </p>
    </div>
    {% endif %}

    <div class="card-footer">¬© Pay4You</div>
  </div>
</div>

<!-- MODAL (QR + media) -->
<div id="modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <div style="display:flex; justify-content:flex-end;">
      <button class="modal-close-btn" onclick="closeModal()">{{ t('close') }}</button>
    </div>

    <div id="modal-content" style="margin-top:10px;">
      <!-- contenuto dinamico -->
    </div>
  </div>
</div>

<script>
  function openQR(){
    const url = "/{{ ag.slug }}/qr.png{% if p_key %}?p={{ p_key }}&lang={{ lang }}{% else %}?lang={{ lang }}{% endif %}";
    const html = `
      <img id="qr-modal-img" src="${url}" alt="QR Code">
      <div style="margin-top:10px; font-size:12px; color:#94a3b8;">
        {{ t('scan_qr') }} ‚Ä¢ {{ t('nfc_direct') }}
      </div>
    `;
    document.getElementById("modal-content").innerHTML = html;
    document.getElementById("modal").style.display = "flex";
  }

  function openMedia(url, type){
    if(type === "video"){
      document.getElementById("modal-content").innerHTML = `
        <video controls style="width:100%; max-height:78vh; border-radius:14px; background:#000;">
          <source src="${url}" type="video/mp4">
        </video>
      `;
    } else {
      document.getElementById("modal-content").innerHTML = `
        <img id="qr-modal-img" src="${url}" alt="media">
      `;
    }
    document.getElementById("modal").style.display = "flex";
  }

  function closeModal(){
    document.getElementById("modal").style.display = "none";
    document.getElementById("modal-content").innerHTML = "";
  }

  // chiudi cliccando fuori
  document.getElementById("modal").addEventListener("click", function(e){
    if(e.target.id === "modal") closeModal();
  });
</script>
{% endblock %}
