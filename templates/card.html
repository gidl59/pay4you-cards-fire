<!doctype html>
<html lang="{{ lang|default('it') }}">
<head>
  <meta charset="utf-8">
  <title>{{ ag.name }} | Pay4You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body data-theme="">
  <div class="page-main">
    <div class="card-outer">

      {# Top-left logo (se presente) #}
      {% if ag.logo_url %}
      <div class="top-left-logo">
        <img src="{{ ag.logo_url }}" alt="logo">
      </div>
      {% endif %}

      {# HERO center style #}
      <div class="hero hero-center">
        <div class="avatar-wrap">

          {# ORBIT logo dietro (se presente) #}
          {% if ag.logo_url %}
            <div class="orbit {% if (ag.orbit_spin or 0)|int == 1 %}spin{% endif %}">
              <img src="{{ ag.logo_url }}" alt="orbit">
            </div>
          {% endif %}

          {# Flip: foto <-> logo (se allow_flip=1 e logo esiste) #}
          {% set can_flip = ((ag.allow_flip or 0)|int == 1) and ag.logo_url %}
          {% if can_flip %}
            <div class="flip is-flippable" id="flipBox" aria-label="flip">
              <div class="flip-inner" id="flipInner">
                <div class="flip-front">
                  <div class="avatar {% if (ag.avatar_spin or 0)|int == 1 %}spin-self{% endif %}">
                    {% if ag.photo_url %}
                      <img class="avatar-img" src="{{ ag.photo_url }}" alt="photo">
                    {% else %}
                      <div class="avatar-placeholder">üë§</div>
                    {% endif %}
                  </div>
                </div>
                <div class="flip-back">
                  <div class="avatar">
                    <img class="avatar-img {% if (ag.logo_spin or 0)|int == 1 %}spin-self{% endif %}" src="{{ ag.logo_url }}" alt="logo">
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <div class="avatar {% if (ag.avatar_spin or 0)|int == 1 %}spin-self{% endif %}">
              {% if ag.photo_url %}
                <img class="avatar-img" src="{{ ag.photo_url }}" alt="photo">
              {% else %}
                <div class="avatar-placeholder">üë§</div>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <div class="hero-text hero-text-center">
          <div class="name name-center">{{ ag.name }}</div>

          {% if ag.company %}
            <div class="company company-center">{{ ag.company }}</div>
          {% endif %}
          {% if ag.role %}
            <div class="role role-center">{{ ag.role }}</div>
          {% endif %}
          {% if ag.bio %}
            <div class="bio bio-center">{{ ag.bio }}</div>
          {% endif %}

          {# Switch profili P1/P2 #}
          {% if p2_enabled %}
            <div class="profile-switch profile-switch-center">
              <a class="profile-pill {% if p_key != 'p2' %}active{% endif %}" href="/{{ ag.slug }}?lang={{ lang|e }}">{{ t_func('profile_1') }}</a>
              <a class="profile-pill {% if p_key == 'p2' %}active{% endif %}" href="/{{ ag.slug }}?p=p2&lang={{ lang|e }}">{{ t_func('profile_2') }}</a>
            </div>
          {% endif %}

          {# Theme toggle #}
          <div class="theme-toggle theme-toggle-compact">
            <span class="theme-label">{{ t_func('theme') }}:</span>
            <button class="theme-pill" type="button" data-theme="auto">{{ t_func('theme_auto') }}</button>
            <button class="theme-pill" type="button" data-theme="light">{{ t_func('theme_light') }}</button>
            <button class="theme-pill" type="button" data-theme="dark">{{ t_func('theme_dark') }}</button>
          </div>

          {# Social icons row #}
          <div class="social-icons social-icons-center">
            {% if ag.facebook %}
              <a class="soc" href="{{ ag.facebook }}" target="_blank" rel="noopener" aria-label="facebook">
                <svg viewBox="0 0 24 24"><path d="M22 12a10 10 0 1 0-11.5 9.9v-7H8v-3h2.5V9.8c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.4h-1.2c-1.2 0-1.6.7-1.6 1.5V12H18l-.5 3h-2.6v7A10 10 0 0 0 22 12z"/></svg>
              </a>
            {% endif %}
            {% if ag.instagram %}
              <a class="soc" href="{{ ag.instagram }}" target="_blank" rel="noopener" aria-label="instagram">
                <svg viewBox="0 0 24 24"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 2a3 3 0 1 0 0 6 3 3 0 0 0 0-6zm5.2-2.3a1.1 1.1 0 1 1 0 2.2 1.1 1.1 0 0 1 0-2.2z"/></svg>
              </a>
            {% endif %}
            {% if ag.linkedin %}
              <a class="soc" href="{{ ag.linkedin }}" target="_blank" rel="noopener" aria-label="linkedin">
                <svg viewBox="0 0 24 24"><path d="M4 3a2 2 0 1 1 0 4 2 2 0 0 1 0-4zm0 6h4v12H4V9zm6 0h4v2c.6-1.2 2-2.3 4.2-2.3 4.5 0 5.3 3 5.3 6.8V21h-4v-5.5c0-1.3 0-3-1.8-3s-2.1 1.4-2.1 2.9V21h-4V9z"/></svg>
              </a>
            {% endif %}
            {% if ag.tiktok %}
              <a class="soc" href="{{ ag.tiktok }}" target="_blank" rel="noopener" aria-label="tiktok">
                <svg viewBox="0 0 24 24"><path d="M16.5 3c.7 2.6 2.7 4.6 5.5 5v3.2c-2-.1-3.9-.8-5.5-2v7.8c0 3.9-3.1 7-7 7s-7-3.1-7-7 3.1-7 7-7c.4 0 .8 0 1.2.1V11c-.4-.2-.8-.3-1.2-.3-1.8 0-3.3 1.5-3.3 3.3s1.5 3.3 3.3 3.3 3.3-1.5 3.3-3.3V3h3.7z"/></svg>
              </a>
            {% endif %}
            {% if ag.telegram %}
              <a class="soc" href="{{ ag.telegram }}" target="_blank" rel="noopener" aria-label="telegram">
                <svg viewBox="0 0 24 24"><path d="M21.8 4.6 19 20.6c-.2 1.1-.9 1.4-1.8.9l-5-3.7-2.4 2.3c-.3.3-.5.5-1 .5l.4-5.5 10-9c.4-.4-.1-.6-.7-.2l-12.4 7.8-5.3-1.7c-1.1-.3-1.1-1.1.2-1.6L20.7 3c1-.4 1.8.2 1.1 1.6z"/></svg>
              </a>
            {% endif %}
            {% if ag.youtube %}
              <a class="soc" href="{{ ag.youtube }}" target="_blank" rel="noopener" aria-label="youtube">
                <svg viewBox="0 0 24 24"><path d="M21.6 7.2a3 3 0 0 0-2.1-2.1C17.8 4.6 12 4.6 12 4.6s-5.8 0-7.5.5A3 3 0 0 0 2.4 7.2 31 31 0 0 0 2 12c0 1.6.1 3.2.4 4.8a3 3 0 0 0 2.1 2.1c1.7.5 7.5.5 7.5.5s5.8 0 7.5-.5a3 3 0 0 0 2.1-2.1c.3-1.6.4-3.2.4-4.8 0-1.6-.1-3.2-.4-4.8zM10 15.4V8.6L16 12l-6 3.4z"/></svg>
              </a>
            {% endif %}
          </div>

        </div>
      </div>

      {# ACTIONS #}
      <div class="section actions-box">
        <div class="section-title">{{ t_func('actions') }}</div>
        <div class="actions-row">
          <a class="action-btn" href="/{{ ag.slug }}.vcf" download>{{ t_func('save_contact') }}</a>
          {% if wa_link %}
            <a class="action-btn secondary" href="{{ wa_link }}" target="_blank" rel="noopener">{{ t_func('whatsapp') }}</a>
          {% endif %}
          <button class="action-btn" type="button" onclick="openModal('qr')">{{ t_func('scan_qr') }}</button>
        </div>
        <div class="actions-hint">Suggerimento: premi ‚ÄúSalva contatto‚Äù per aggiungere i dati in rubrica.</div>
      </div>

      {# CONTACTS #}
      <div class="section">
        <div class="section-title">{{ t_func('contacts') }}</div>

        {% if mobiles and mobiles|length > 0 %}
          <div class="row"><span>{{ t_func('mobile_phone') }}</span>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              {% for m in mobiles %}
                <a href="tel:{{ m|replace(' ','') }}">{{ m }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if ag.phone_office %}
          <div class="row"><span>{{ t_func('office_phone') }}</span><a href="tel:{{ ag.phone_office|replace(' ','') }}">{{ ag.phone_office }}</a></div>
        {% endif %}

        {% if emails and emails|length > 0 %}
          <div class="row"><span>Email</span>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              {% for e in emails %}
                <a href="mailto:{{ e }}">{{ e }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if pec_email %}
          <div class="row"><span>PEC</span><a href="mailto:{{ pec_email }}">{{ pec_email }}</a></div>
        {% endif %}

        {% if websites and websites|length > 0 %}
          <div class="row"><span>{{ t_func('open_website') }}</span>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              {% for w in websites %}
                <a href="{{ w }}" target="_blank" rel="noopener">{{ w|replace('https://','')|replace('http://','') }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      {# COMPANY DATA #}
      {% if ag.piva or ag.sdi %}
      <div class="section">
        <div class="section-title">{{ t_func('data') }}</div>
        {% if ag.piva %}
          <div class="row"><span>{{ t_func('vat') }}</span><span class="mono">{{ ag.piva }}</span></div>
        {% endif %}
        {% if ag.sdi %}
          <div class="row"><span>{{ t_func('sdi') }}</span><span class="mono">{{ ag.sdi }}</span></div>
        {% endif %}
      </div>
      {% endif %}

      {# ADDRESSES #}
      {% if addresses and addresses|length > 0 %}
      <div class="section">
        <div class="section-title">{{ t_func('open_maps') }}</div>
        <div class="addr-list">
          {% for a in addresses %}
            <a class="addr-item" href="{{ a.maps }}" target="_blank" rel="noopener">
              {{ a.text }}
              <div class="addr-mini">Apri su Google Maps</div>
            </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {# GALLERY #}
      {% if gallery and gallery|length > 0 %}
      <div class="section">
        <div class="section-title">{{ t_func('gallery') }}</div>
        <div class="gallery-scroll">
          {% for img in gallery %}
            <button class="thumb" type="button" onclick="openModal('img','{{ img }}')">
              <img src="{{ img }}" alt="img">
            </button>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {# VIDEOS #}
      {% if videos and videos|length > 0 %}
      <div class="section">
        <div class="section-title">{{ t_func('videos') }}</div>
        <div class="gallery-scroll">
          {% for v in videos %}
            <button class="thumb" type="button" onclick="openModal('video','{{ v }}')">
              <div class="video-thumb">
                <video class="video-mini" src="{{ v }}" muted playsinline preload="metadata"></video>
                <div class="video-play">‚ñ∂ Video</div>
              </div>
            </button>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {# PDF #}
      {% if pdfs and pdfs|length > 0 %}
      <div class="section">
        <div class="section-title">{{ t_func('documents') }}</div>
        <div class="pdf-list">
          {% for p in pdfs %}
            <button class="pdf-btn" type="button" onclick="openModal('pdf','{{ p.url }}')">{{ p.name }}</button>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="footer">
        Pay4You ‚Ä¢ {{ ag.slug }}
      </div>

    </div>
  </div>

  {# MODAL UNIVERSALE #}
  <div id="modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <button class="modal-x" type="button" onclick="closeModal()">‚úï</button>

      <img id="mImg" src="" alt="" style="display:none;">
      <video id="mVideo" controls playsinline style="display:none;"></video>
      <iframe id="mPdf" src="" style="display:none;" title="pdf"></iframe>

      <div id="mQrWrap" style="display:none; padding:8px;">
        <img src="{{ qr_url }}" alt="qr" style="width:100%;max-width:520px;display:block;margin:8px auto;border-radius:14px;">
      </div>

      <button class="modal-close" type="button" onclick="closeModal()">{{ t_func('close') }}</button>
    </div>
  </div>

  <script>
    // ---- Flip (se abilitato) ----
    (function(){
      const flip = document.getElementById('flipBox');
      const inner = document.getElementById('flipInner');
      if(flip && inner){
        flip.addEventListener('click', () => {
          flip.classList.toggle('flipped');
        });
      }
    })();

    // ---- Modal ----
    function openModal(type, src){
      const m = document.getElementById('modal');
      const img = document.getElementById('mImg');
      const vid = document.getElementById('mVideo');
      const pdf = document.getElementById('mPdf');
      const qr  = document.getElementById('mQrWrap');

      img.style.display = 'none';
      vid.style.display = 'none';
      pdf.style.display = 'none';
      qr.style.display  = 'none';

      img.src = '';
      vid.src = '';
      pdf.src = '';

      if(type === 'img'){
        img.src = src;
        img.style.display = 'block';
      } else if(type === 'video'){
        vid.src = src;
        vid.style.display = 'block';
      } else if(type === 'pdf'){
        pdf.src = src;
        pdf.style.display = 'block';
      } else if(type === 'qr'){
        qr.style.display = 'block';
      }

      m.style.display = 'flex';
    }
    function closeModal(){
      const m = document.getElementById('modal');
      const img = document.getElementById('mImg');
      const vid = document.getElementById('mVideo');
      const pdf = document.getElementById('mPdf');

      img.src = '';
      if(vid){
        vid.pause();
        vid.src = '';
      }
      pdf.src = '';
      m.style.display = 'none';
    }

    // ---- Theme toggle (auto/light/dark) ----
    (function(){
      const key = "p4y_theme";
      const pills = document.querySelectorAll('.theme-pill');
      const body = document.body;

      function applyTheme(v){
        // v: auto|light|dark
        if(v === 'auto'){
          body.removeAttribute('data-theme');
        }else{
          body.setAttribute('data-theme', v);
        }
        pills.forEach(p => p.classList.toggle('active', p.dataset.theme === v));
      }

      const saved = localStorage.getItem(key) || 'auto';
      applyTheme(saved);

      pills.forEach(p => {
        p.addEventListener('click', () => {
          const v = p.dataset.theme;
          localStorage.setItem(key, v);
          applyTheme(v);
        });
      });
    })();
  </script>
</body>
</html>
