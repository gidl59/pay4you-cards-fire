<!-- templates/card.html (COMPLETO) -->
<!doctype html>
<html lang="{{ lang|default('it') }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">
  <title>{{ ag.name }} | Pay4You</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body data-theme="">
  <!-- ‚úÖ Freccia "Torna" sempre visibile -->
  <button class="floating-back" type="button" onclick="goBackSafe()" aria-label="Torna indietro">‚Üê</button>

  <div class="page-main">
    <div class="card-outer">

      {% if ag.logo_url %}
      <a class="top-left-logo" href="{{ base_url }}" aria-label="Pay4You">
        <img src="{{ ag.logo_url }}" alt="Logo Pay4You">
      </a>
      {% endif %}

      <div class="hero hero-center">
        <div class="avatar-wrap">

          {% if ag.logo_url %}
          <div class="orbit {% if (ag.orbit_spin or 0)|int == 1 %}spin{% endif %}">
            <img src="{{ ag.logo_url }}" alt="Logo orbit">
          </div>
          {% endif %}

          {% set auto_flip = (ag.avatar_spin or 0)|int == 1 %}
          {% set can_flip  = ((ag.allow_flip or 0)|int == 1) and (not auto_flip) %}

          {% set back_mode = ag.back_media_mode if ag.back_media_mode else 'company' %}
          {% set back_url = '' %}
          {% if back_mode == 'personal' and ag.back_media_url %}
            {% set back_url = ag.back_media_url %}
          {% elif ag.logo_url %}
            {% set back_url = ag.logo_url %}
          {% endif %}

          <div class="flip {% if can_flip %}is-flippable{% endif %} {% if auto_flip %}auto-flip{% endif %}" id="flipBox">
            <div class="flip-inner">

              <div class="flip-front">
                <button class="avatar avatar-btn" type="button"
                        onclick="event.stopPropagation(); openImg({{ (ag.photo_url or '')|tojson }})"
                        aria-label="Apri foto">
                  {% if ag.photo_url %}
                    <img class="avatar-img" src="{{ ag.photo_url }}" alt="Foto"
                         style="object-position: {{ (ag.photo_pos_x or 50)|int }}% {{ (ag.photo_pos_y or 35)|int }}%;">
                  {% else %}
                    <div class="avatar-placeholder">üë§</div>
                  {% endif %}
                </button>
              </div>

              <div class="flip-back">
                <button class="avatar avatar-btn" type="button"
                        onclick="event.stopPropagation(); openImg({{ (back_url or '')|tojson }})"
                        aria-label="Apri immagine retro">
                  {% if back_url %}
                    <img class="avatar-img back-img {% if (ag.logo_spin or 0)|int == 1 %}spin-logo{% endif %}"
                         src="{{ back_url }}" alt="Retro">
                  {% else %}
                    <div class="avatar-placeholder">‚òÖ</div>
                  {% endif %}
                </button>
              </div>

            </div>
          </div>

        </div>

        <div class="hero-text hero-text-center">
          {% if ag.name %}<div class="name name-center">{{ ag.name }}</div>{% endif %}

          {% if ag.company %}
            <div class="company-badge">{{ ag.company }}</div>
          {% endif %}

          {% if ag.role %}<div class="role role-center">{{ ag.role }}</div>{% endif %}
          {% if ag.bio %}<div class="bio bio-center">{{ ag.bio }}</div>{% endif %}

          {% if p2_enabled %}
          <div class="profile-switch profile-switch-center">
            <a class="profile-pill {% if not p_key %}active{% endif %}" href="/{{ ag.slug }}?lang={{ lang }}">{{ t_func('profile_1') }}</a>
            <a class="profile-pill {% if p_key == 'p2' %}active{% endif %}" href="/{{ ag.slug }}?p=p2&lang={{ lang }}">{{ t_func('profile_2') }}</a>
          </div>
          {% endif %}

          <div class="social-icons social-icons-center">
            {% if ag.facebook %}<a class="soc" href="{{ ag.facebook }}" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">F</a>{% endif %}
            {% if ag.instagram %}<a class="soc" href="{{ ag.instagram }}" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">I</a>{% endif %}
            {% if ag.linkedin %}<a class="soc" href="{{ ag.linkedin }}" target="_blank" rel="noopener" aria-label="LinkedIn" title="LinkedIn">in</a>{% endif %}
            {% if ag.tiktok %}<a class="soc" href="{{ ag.tiktok }}" target="_blank" rel="noopener" aria-label="TikTok" title="TikTok">TT</a>{% endif %}
            {% if ag.telegram %}<a class="soc" href="{{ ag.telegram }}" target="_blank" rel="noopener" aria-label="Telegram" title="Telegram">TG</a>{% endif %}
            {% if ag.youtube %}<a class="soc" href="{{ ag.youtube }}" target="_blank" rel="noopener" aria-label="YouTube" title="YouTube">YT</a>{% endif %}
          </div>

        </div>
      </div>

      <div class="section actions-box">
        <div class="section-title">{{ t_func('actions') }}</div>
        <div class="actions-row">
          <a class="action-btn action-vcf" href="/{{ ag.slug }}.vcf{% if p_key %}?p={{ p_key }}{% endif %}">{{ t_func('save_contact') }}</a>
          {% if wa_link %}
            <a class="action-btn action-wa" href="{{ wa_link }}" target="_blank" rel="noopener">{{ t_func('whatsapp') }}</a>
          {% endif %}
          <button class="action-btn action-qr" type="button" onclick="openQrModal({{ qr_url|tojson }})">{{ t_func('scan_qr') }}</button>
        </div>
        <div class="actions-hint">{{ t_func('save_contact') }}: aggiunge i dati in rubrica.</div>
      </div>

      {% if mobiles or phone_office or emails or pec_email or websites %}
      <div class="section">
        <div class="section-title">{{ t_func('contacts') }}</div>

        {% if mobiles %}
          <div class="row row-phone">
            <span class="row-tag tag-phone">{{ t_func('mobile_phone') }}</span>
            <div class="right-stack">
              {% for m in mobiles %}
                <div class="stack-item"><a href="tel:{{ m|replace(' ','') }}">{{ m }}</a></div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if phone_office %}
          <div class="row row-phone">
            <span class="row-tag tag-phone">{{ t_func('office_phone') }}</span>
            <a href="tel:{{ phone_office|replace(' ','') }}">{{ phone_office }}</a>
          </div>
        {% endif %}

        {% if emails %}
          <div class="row row-email">
            <span class="row-tag tag-email">Email</span>
            <div class="right-stack">
              {% for e in emails %}
                <div class="stack-item"><a href="mailto:{{ e }}">{{ e }}</a></div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if pec_email %}
          <div class="row row-email">
            <span class="row-tag tag-email">PEC</span>
            <a href="mailto:{{ pec_email }}">{{ pec_email }}</a>
          </div>
        {% endif %}

        {% if websites %}
          <div class="row row-web">
            <span class="row-tag tag-web">{{ t_func('open_website') }}</span>
            <div class="right-stack">
              {% for w in websites %}
                <div class="stack-item">
                  <a href="{{ w }}" target="_blank" rel="noopener">{{ w|replace('https://','')|replace('http://','') }}</a>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
      {% endif %}

      {% if ag.piva or ag.sdi %}
      <div class="section">
        <div class="section-title">{{ t_func('data') }}</div>
        {% if ag.piva %}
          <div class="row"><span class="row-tag tag-data">{{ t_func('vat') }}</span><span class="mono">{{ ag.piva }}</span></div>
        {% endif %}
        {% if ag.sdi %}
          <div class="row"><span class="row-tag tag-data">{{ t_func('sdi') }}</span><span class="mono">{{ ag.sdi }}</span></div>
        {% endif %}
      </div>
      {% endif %}

      {% if addresses %}
      <div class="section">
        <div class="section-title">{{ t_func('open_maps') }}</div>
        <div class="addr-list">
          {% for a in addresses %}
            <a class="addr-item" href="{{ a.maps }}" target="_blank" rel="noopener">
              <div>{{ a.text }}</div>
              <div class="addr-mini">{{ t_func('open_maps') }}</div>
            </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="section">
        <div class="section-title">{{ t_func('theme') }}</div>
        <div class="theme-toggle theme-toggle-compact">
          <span class="theme-label">{{ t_func('theme') }}:</span>
          <button class="theme-pill" type="button" data-theme="auto">{{ t_func('theme_auto') }}</button>
          <button class="theme-pill" type="button" data-theme="light">{{ t_func('theme_light') }}</button>
          <button class="theme-pill" type="button" data-theme="dark">{{ t_func('theme_dark') }}</button>
        </div>
      </div>

      {% if gallery %}
      <div class="section">
        <div class="section-title">{{ t_func('gallery') }}</div>
        <div class="gallery-scroll">
          {% for g in gallery %}
            <button class="thumb" type="button" onclick="openImg({{ g|tojson }})">
              <img src="{{ g }}" alt="Foto">
            </button>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if videos %}
      <div class="section">
        <div class="section-title">{{ t_func('videos') }}</div>
        <div class="gallery-scroll">
          {% for v in videos %}
            <div class="video-thumb">
              <video class="video-mini" src="{{ v }}" muted playsinline preload="metadata" aria-label="Video"></video>
              <div class="video-play">PLAY</div>
              <button class="thumb" type="button" style="position:absolute; inset:0;" onclick="openVideo({{ v|tojson }})"></button>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if pdfs %}
      <div class="section">
        <div class="section-title">{{ t_func('documents') }}</div>
        <div class="pdf-list">
          {% for p in pdfs %}
            <button class="pdf-btn" type="button"
                    onclick="openPdf({{ p.url|tojson }}, {{ p.name|tojson }})">{{ p.name }}</button>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="footer">¬© 2026 Realizzato Pay4You ‚Äî Giuseppe Di Lisio</div>

    </div>
  </div>

  <!-- ===== MODAL MEDIA ===== -->
  <div id="modal" class="modal-overlay" style="display:none;">
    <div class="modal-box modal-big">
      <button class="modal-back" type="button" onclick="closeModal()" aria-label="Torna alla card">‚Üê</button>
      <button class="modal-x" type="button" onclick="closeModal()">‚úï</button>

      <img id="mImg" src="" alt="" style="display:none;">
      <video id="mVideo" controls playsinline style="display:none;"></video>
      <iframe id="mPdf" src="" style="display:none;"></iframe>

      <div class="modal-actions">
        <button class="btn ghost" type="button" onclick="shareCurrent('native')">Condividi</button>
        <button class="btn ghost" type="button" onclick="shareCurrent('wa')">Invia WhatsApp</button>
        <button class="btn ghost" type="button" onclick="shareCurrent('email')">Invia Email</button>

        {% if websites and websites|length > 0 %}
          <a class="btn ghost" href="{{ websites[0] }}" target="_blank" rel="noopener">{{ t_func('open_website') }}</a>
        {% endif %}
        <button class="btn primary" type="button" onclick="closeModal()">{{ t_func('close') }}</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL QR ===== -->
  <div id="qr-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <button class="modal-back" type="button" onclick="closeQrModal()" aria-label="Torna alla card">‚Üê</button>
      <button class="modal-x" type="button" onclick="closeQrModal()">‚úï</button>

      <img id="qr-img" src="" alt="QR" style="width:100%;max-width:520px;display:block;margin:8px auto;border-radius:14px;">

      <div class="modal-actions">
        <button class="btn ghost" type="button" onclick="shareQr('native')">Condividi</button>
        <button class="btn ghost" type="button" onclick="shareQr('wa')">Invia WhatsApp</button>
        <button class="btn ghost" type="button" onclick="shareQr('email')">Invia Email</button>
        <button class="btn primary" type="button" onclick="closeQrModal()">{{ t_func('close') }}</button>
      </div>
    </div>
  </div>

<script>
  // ‚úÖ questi due sono "safe" (niente apostrofi che rompono JS)
  const CARD_PUBLIC_URL = {{ (base_url ~ '/' ~ ag.slug ~ (('?p=' ~ p_key ~ '&lang=' ~ lang) if p_key else ('?lang=' ~ lang)))|tojson }};
  const CARD_TITLE = {{ ("Card digitale Pay4You - " ~ (ag.name or ""))|tojson }};

  let CURRENT_SHARE = { url: CARD_PUBLIC_URL, title: CARD_TITLE };

  // ‚úÖ back "intelligente": se non c‚Äô√® history, resta sulla card P1
  function goBackSafe(){
    try{
      if (window.history.length > 1) { window.history.back(); return; }
    }catch(e){}
    window.location.href = {{ (base_url ~ '/' ~ ag.slug)|tojson }};
  }

  // flip tap
  (function(){
    const canFlip = {{ 1 if can_flip else 0 }};
    if(!canFlip) return;
    const box = document.getElementById('flipBox');
    if(!box) return;
    box.addEventListener('click', ()=> box.classList.toggle('flipped'));
  })();

  // theme
  (function(){
    const KEY = "p4y_theme";
    const buttons = document.querySelectorAll(".theme-pill");
    function apply(theme){
      document.body.setAttribute("data-theme", theme === "auto" ? "" : theme);
      buttons.forEach(b => b.classList.toggle("active", b.dataset.theme === theme));
    }
    const saved = localStorage.getItem(KEY) || "auto";
    apply(saved);
    buttons.forEach(b => b.addEventListener("click", () => {
      localStorage.setItem(KEY, b.dataset.theme);
      apply(b.dataset.theme);
    }));
  })();

  function shareNative(title, url){
    const text = title + "\n" + url;
    if (navigator.share){
      navigator.share({ title, text, url }).catch(()=>{});
      return true;
    }
    return false;
  }
  function shareWA(title, url){
    const text = title + "\n" + url;
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  }
  function shareEmail(title, url){
    const subject = title;
    const body = title + "\n" + url;
    window.location.href = "mailto:?subject=" + encodeURIComponent(subject) + "&body=" + encodeURIComponent(body);
  }

  function shareCurrent(mode){
    const title = CURRENT_SHARE?.title || CARD_TITLE;
    const url = CURRENT_SHARE?.url || CARD_PUBLIC_URL;
    if(mode === 'native'){ if(!shareNative(title, url)) shareWA(title, url); return; }
    if(mode === 'wa'){ shareWA(title, url); return; }
    if(mode === 'email'){ shareEmail(title, url); return; }
  }

  function shareQr(mode){
    const title = CARD_TITLE;
    const url = CARD_PUBLIC_URL;
    if(mode === 'native'){ if(!shareNative(title, url)) shareWA(title, url); return; }
    if(mode === 'wa'){ shareWA(title, url); return; }
    if(mode === 'email'){ shareEmail(title, url); return; }
  }

  function openModal(type){
    const modal = document.getElementById('modal');
    modal.style.display='flex';
    document.getElementById('mImg').style.display = (type==='img') ? 'block' : 'none';
    document.getElementById('mVideo').style.display = (type==='video') ? 'block' : 'none';
    document.getElementById('mPdf').style.display = (type==='pdf') ? 'block' : 'none';
  }

  function closeModal(){
    const modal = document.getElementById('modal');
    if(!modal) return;
    modal.style.display='none';

    const img = document.getElementById('mImg');
    const vid = document.getElementById('mVideo');
    const pdf = document.getElementById('mPdf');

    if(img) img.src = '';
    if(vid){
      try{ vid.pause(); }catch(e){}
      vid.removeAttribute('src');
      try{ vid.load(); }catch(e){}
    }
    if(pdf) pdf.src = '';

    CURRENT_SHARE = { url: CARD_PUBLIC_URL, title: CARD_TITLE };
  }

  function openImg(src){
    if(!src) return;
    const img = document.getElementById('mImg');
    img.src = src;
    CURRENT_SHARE = { url: src, title: CARD_TITLE + " (Foto)" };
    openModal('img');
  }

  function openVideo(src){
    if(!src) return;
    const v = document.getElementById('mVideo');
    v.src = src;
    CURRENT_SHARE = { url: src, title: CARD_TITLE + " (Video)" };
    openModal('video');
    v.play().catch(()=>{});
  }

  function openPdf(src, name){
    if(!src) return;
    const f = document.getElementById('mPdf');
    f.src = src;
    const t = (name && String(name).trim()) ? (CARD_TITLE + " - " + name) : (CARD_TITLE + " (Documento)");
    CURRENT_SHARE = { url: src, title: t };
    openModal('pdf');
  }

  document.getElementById('modal')?.addEventListener('click', function(e){
    if(e.target === this) closeModal();
  });
  document.getElementById('qr-modal')?.addEventListener('click', function(e){
    if(e.target === this) closeQrModal();
  });

  function openQrModal(src){
    const m = document.getElementById('qr-modal');
    const img = document.getElementById('qr-img');
    img.src = src;
    m.style.display = 'flex';
  }
  function closeQrModal(){
    const m = document.getElementById('qr-modal');
    const img = document.getElementById('qr-img');
    img.src = '';
    m.style.display = 'none';
  }

  // anteprima mini frame video (aiuta su mobile)
  (function(){
    const vids = document.querySelectorAll('.video-mini');
    vids.forEach(v=>{
      v.addEventListener('loadedmetadata', ()=>{
        try{
          if(v.duration && v.duration > 0.2){
            v.currentTime = 0.05;
          }
        }catch(e){}
      });
      v.addEventListener('seeked', ()=>{
        try{ v.pause(); }catch(e){}
      });
    });
  })();
</script>
</body>
</html>
