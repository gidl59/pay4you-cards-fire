<!doctype html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ ag.name or ag.slug }} | Pay4You</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/static/card.css">
</head>

<body>
  <div class="card-wrap">

    <!-- HERO -->
    <div class="hero">
      <div class="hero-bg">
        {% if ag.back_media_url %}
          <img class="hero-back" src="{{ ag.back_media_url }}" alt="">
        {% endif %}
      </div>

      <div class="hero-top">
        {% if ag.logo_url %}
          <div class="logo-pill">
            <img class="logo {{ 'spin' if ag.logo_spin==1 else '' }}" src="{{ ag.logo_url }}" alt="logo">
          </div>
        {% endif %}
      </div>

      <div class="hero-center">
        <div class="avatar-wrap {{ 'orbit' if ag.orbit_spin==1 else '' }}">
          <div class="avatar {{ 'spin' if ag.avatar_spin==1 else '' }} {{ 'flip' if ag.allow_flip==1 else '' }}" id="avatarBox">
            {% if ag.photo_url %}
              <img id="avatarImg" src="{{ ag.photo_url }}" alt="foto" style="
                object-position: {{ ag.photo_pos_x }}% {{ ag.photo_pos_y }}%;
                transform: scale({{ ag.photo_zoom }});
              ">
            {% else %}
              <div class="avatar-ph">ðŸ‘¤</div>
            {% endif %}

            <!-- â€œSotto fotoâ€ (logo o back) â€“ viene mostrata al flip/tap -->
            {% if ag.back_media_url or ag.logo_url %}
              <div class="avatar-back" id="avatarBack" aria-hidden="true">
                {% if ag.back_media_url %}
                  <img src="{{ ag.back_media_url }}" alt="">
                {% elif ag.logo_url %}
                  <img src="{{ ag.logo_url }}" alt="">
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="title">
          <h1>{{ ag.name }}</h1>
          {% if ag.role %}<div class="sub">{{ ag.role }}</div>{% endif %}
          {% if ag.company %}<div class="sub2">{{ ag.company }}</div>{% endif %}
        </div>
      </div>
    </div>

    <div class="content">

      {% if ag.bio %}
        <div class="box accent">
          <h3>Info</h3>
          <p class="bio">{{ ag.bio }}</p>

          <!-- SOCIAL ICONS sotto BIO -->
          <div class="social-row">
            {% set any_social = false %}
            {% for key,label,color,icon in [
              ('facebook','Facebook','#1877F2','fb'),
              ('instagram','Instagram','#E1306C','ig'),
              ('linkedin','LinkedIn','#0A66C2','in'),
              ('tiktok','TikTok','#111111','tt'),
              ('telegram','Telegram','#2AABEE','tg'),
              ('youtube','YouTube','#FF0000','yt'),
              ('spotify','Spotify','#1DB954','sp')
            ] %}
              {% set url = (ag[key] if ag is mapping else (ag|attr(key)|default(''))) %}
              {% if url and url.startswith('http') %}
                {% set any_social = true %}
                <a class="soc" href="{{ url }}" target="_blank" rel="noopener" aria-label="{{ label }}" style="--soc:{{ color }};">
                  {% if icon == 'fb' %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13.5 22v-8h2.7l.5-3h-3.2V9.1c0-.9.3-1.6 1.7-1.6H17V5a22 22 0 0 0-2.5-.1c-2.5 0-4.2 1.5-4.2 4.3V11H7.5v3h2.8v8h3.2z"/></svg>
                  {% elif icon == 'ig' %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4.2A3.8 3.8 0 1 1 8.2 12 3.8 3.8 0 0 1 12 8.2zm0 2A1.8 1.8 0 1 0 13.8 12 1.8 1.8 0 0 0 12 10.2zM17.6 6.9a.9.9 0 1 1-.9-.9.9.9 0 0 1 .9.9z"/></svg>
                  {% elif icon == 'in' %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6.5 6.8a1.9 1.9 0 1 1 0-3.8 1.9 1.9 0 0 1 0 3.8zM5 21V9h3v12H5zm6 0V9h2.9v1.7h.1c.4-.8 1.5-1.9 3.2-1.9 3.4 0 4 2.2 4 5V21h-3v-5.3c0-1.3 0-2.9-1.8-2.9s-2 1.4-2 2.8V21h-3z"/></svg>
                  {% elif icon == 'tt' %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17 3c.3 2.2 1.7 3.7 4 4v3c-1.8.1-3.3-.5-4.6-1.5v6.4c0 4-3 6.6-6.7 6.1A6 6 0 0 1 4 15.4c.5-3 3.2-5.2 6.3-4.9v3.2a3 3 0 0 0-3.1 2.4 3 3 0 0 0 4 3.3c1.6-.5 2-1.9 2-3.4V3h3.8z"/></svg>
                  {% elif icon == 'tg' %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21.8 4.6 19 20.3c-.2 1.1-.8 1.3-1.6.8l-4.4-3.2-2.1 2c-.2.2-.4.4-.8.4l.3-4.7 8.5-7.7c.4-.3-.1-.5-.6-.2l-10.5 6.6-4.5-1.4c-1-.3-1-1 .2-1.5L20 3.7c.9-.4 1.7.2 1.8.9z"/></svg>
                  {% elif icon == 'yt' %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21.6 7.2s-.2-1.5-.9-2.2c-.9-.9-1.9-.9-2.3-1C15.1 3.7 12 3.7 12 3.7h0s-3.1 0-6.4.3c-.4.1-1.4.1-2.3 1-.7.7-.9 2.2-.9 2.2S2 9 2 10.8v2.4c0 1.8.4 3.6.4 3.6s.2 1.5.9 2.2c.9.9 2.1.9 2.6 1 1.9.2 8.1.3 8.1.3s3.1 0 6.4-.3c.4-.1 1.4-.1 2.3-1 .7-.7.9-2.2.9-2.2s.4-1.8.4-3.6v-2.4c0-1.8-.4-3.6-.4-3.6zM10 15.3V8.7l6 3.3-6 3.3z"/></svg>
                  {% else %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm4.6 14.5c-.2.4-.5.5-.9.4-3.5-1.4-7.8-1.7-13-.8-.4.1-.7-.1-.8-.5-.1-.4.1-.7.5-.8 5.6-1 10.2-.6 14 1 .4.2.5.5.2.7zM18 13c-.2.4-.6.6-1 .4-4-1.6-10-2.1-14.5-.9-.4.1-.8-.1-.9-.5-.1-.4.1-.8.5-.9 5.1-1.3 11.4-.7 15.9 1.1.4.2.6.6.4.8zm.1-3.6c-4.7-2.8-12.4-3.1-16.8-1.8-.5.1-.9-.1-1-.6-.1-.5.1-.9.6-1 5.1-1.5 13.5-1.2 18.9 2 .4.2.5.7.3 1.1-.2.4-.7.5-1.1.3z"/></svg>
                  {% endif %}
                </a>
              {% endif %}
            {% endfor %}
            {% if not any_social %}
              <div class="social-empty"> </div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <!-- CONTATTI + SALVA -->
      <div class="box">
        <div class="box-head">
          <h3>{{ t_func("contacts") }}</h3>

          <div class="box-head-actions">
            <!-- âœ… Salva contatto (usa la tua route VCF) -->
            <a class="btn primary"
               href="/vcf/{{ ag.slug }}{% if profile and profile!='p1' %}?p={{ profile }}{% endif %}">
              Salva contatto
            </a>
          </div>
        </div>

        {% if mobiles %}
          <div class="row">
            <div class="k">{{ t_func("mobile_phone") }}</div>
            <div class="v">
              {% for m in mobiles %}
                <a href="tel:{{ m }}">{{ m }}</a>{% if not loop.last %} Â· {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if office_value %}
          <div class="row">
            <div class="k">{{ t_func("office_phone") }}</div>
            <div class="v"><a href="tel:{{ office_value }}">{{ office_value }}</a></div>
          </div>
        {% endif %}

        {% if emails %}
          <div class="row">
            <div class="k">Email</div>
            <div class="v">
              {% for e in emails %}
                <a href="mailto:{{ e }}">{{ e }}</a>{% if not loop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if websites %}
          <div class="row">
            <div class="k">{{ t_func("open_website") }}</div>
            <div class="v">
              {% for w in websites %}
                <a target="_blank" rel="noopener" href="{{ w }}">{{ w }}</a>{% if not loop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if addresses %}
          <div class="row">
            <div class="k">Indirizzi</div>
            <div class="v">
              {% for a in addresses %}
                <div class="addr">
                  <div>{{ a.text }}</div>
                  <a target="_blank" rel="noopener" href="{{ a.maps }}">{{ t_func("open_maps") }}</a>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      <!-- DATI AZIENDALI -->
      <div class="box">
        <h3>{{ t_func("data") }}</h3>
        {% if ag.piva %}
          <div class="row"><div class="k">{{ t_func("vat") }}</div><div class="v">{{ ag.piva }}</div></div>
        {% endif %}
        {% if ag.sdi %}
          <div class="row"><div class="k">{{ t_func("sdi") }}</div><div class="v">{{ ag.sdi }}</div></div>
        {% endif %}

        <!-- âœ… Riga unica: P-switch + Tema (sotto dati aziendali) -->
        <div class="switch-row">
          <div class="profile-switch">
            {% if profile == 'p1' %}
              {% if p2_enabled == 1 %}<a class="ps-btn" href="/{{ ag.slug }}?p=p2">P2</a>{% endif %}
              {% if p3_enabled == 1 %}<a class="ps-btn" href="/{{ ag.slug }}?p=p3">P3</a>{% endif %}
            {% elif profile == 'p2' %}
              <a class="ps-btn" href="/{{ ag.slug }}">P1</a>
              {% if p3_enabled == 1 %}<a class="ps-btn" href="/{{ ag.slug }}?p=p3">P3</a>{% endif %}
            {% else %}
              <a class="ps-btn" href="/{{ ag.slug }}">P1</a>
              {% if p2_enabled == 1 %}<a class="ps-btn" href="/{{ ag.slug }}?p=p2">P2</a>{% endif %}
            {% endif %}
          </div>

          <div class="theme-switch" role="group" aria-label="Tema">
            <button class="ts-btn" type="button" data-theme="auto">Auto</button>
            <button class="ts-btn" type="button" data-theme="light">Chiaro</button>
            <button class="ts-btn" type="button" data-theme="dark">Scuro</button>
          </div>
        </div>
      </div>

      <!-- AZIONI (spostate dopo dati) -->
      <div class="box accent2">
        <h3>{{ t_func("actions") }}</h3>
        <div class="actions">
          <button class="btn" type="button" onclick="openShareModal('qr', '{{ qr_url }}', 'QR Code')">
            {{ t_func("scan_qr") }}
          </button>
          {% if wa_link %}
            <a class="btn" href="{{ wa_link }}" target="_blank" rel="noopener">{{ t_func("whatsapp") }}</a>
          {% endif %}
        </div>
      </div>

      {% if gallery %}
        <div class="box">
          <h3>{{ t_func("gallery") }}</h3>
          <div class="media-grid small">
            {% for g in gallery %}
              <button class="thumb" type="button" onclick="openShareModal('img','{{ g }}','Foto')">
                <img src="{{ g }}" alt="">
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if videos %}
        <div class="box">
          <h3>{{ t_func("videos") }}</h3>
          <div class="media-grid small">
            {% for v in videos %}
              <button class="thumb" type="button" onclick="openShareModal('vid','{{ v }}','Video')">
                <video muted playsinline preload="metadata" src="{{ v }}#t=0.1"></video>
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if pdfs %}
        <div class="box">
          <h3>{{ t_func("documents") }}</h3>
          <ul class="docs">
            {% for p in pdfs %}
              <li>
                <button class="docbtn" type="button" onclick="openShareModal('pdf','{{ p.url }}','{{ p.name|e }}')">
                  ðŸ“„ {{ p.name }}
                </button>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

    </div>

    <footer class="foot">
      <small>Pay4You Card 2026 Â· realizzato da Giuseppe Di Lisio</small>
    </footer>

  </div>

  <!-- MODAL -->
  <div id="shareModal" class="modal-overlay" style="display:none" onclick="overlayClose(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-title" id="mTitle">Anteprima</div>
      <div id="mBody" style="margin-top:12px;"></div>

      <div class="modal-actions">
        <button class="btn" type="button" onclick="share('whatsapp')">Invia WhatsApp</button>
        <button class="btn" type="button" onclick="share('email')">Invia Email</button>
        <button class="btn ghost" type="button" onclick="closeModal()">Chiudi</button>
      </div>

      <input type="hidden" id="mKind" value="">
      <input type="hidden" id="mUrl" value="">
    </div>
  </div>

<script>
  // ===== THEME (Auto/Chiaro/Scuro) =====
  (function(){
    const root = document.documentElement;
    const KEY = "pay4you_theme";
    const btns = Array.from(document.querySelectorAll(".ts-btn"));

    function apply(theme){
      let t = theme;
      if(!t || t === "auto"){
        t = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        root.dataset.theme = "auto";
        document.body.dataset.themeApplied = t;
      } else {
        root.dataset.theme = t;
        document.body.dataset.themeApplied = t;
      }
      btns.forEach(b => b.classList.toggle("active", b.dataset.theme === theme));
    }

    const saved = localStorage.getItem(KEY) || "auto";
    apply(saved);

    btns.forEach(b=>{
      b.addEventListener("click", ()=>{
        const t = b.dataset.theme || "auto";
        localStorage.setItem(KEY, t);
        apply(t);
      });
    });

    if(window.matchMedia){
      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ()=>{
        const cur = localStorage.getItem(KEY) || "auto";
        if(cur === "auto") apply("auto");
      });
    }
  })();

  // ===== Avatar TAP (rotazione orizzontale) =====
  (function(){
    const box = document.getElementById("avatarBox");
    if(!box) return;

    const tapEnabled = {{ 1 if ag.avatar_spin==1 else 0 }};
    const flipEnabled = {{ 1 if ag.allow_flip==1 else 0 }};

    // Tap = giro orizzontale â€œuna voltaâ€
    if(tapEnabled && !flipEnabled){
      box.addEventListener("click", ()=>{
        box.classList.toggle("tapflip");
      });
    }
  })();

  function absUrl(u){
    if(!u) return '';
    u = (u + '').trim();
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }
  function outlookCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://outlook.office.com/mail/deeplink/compose?subject=${su}&body=${bd}`;
  }

  function overlayClose(e){
    if(e.target && e.target.id === "shareModal") closeModal();
  }
  function closeModal(){
    const m = document.getElementById('shareModal');
    if(m) m.style.display = 'none';
    const b = document.getElementById('mBody');
    if(b) b.innerHTML = '';
  }

  function openShareModal(kind, url, title){
    document.getElementById('mKind').value = kind;
    document.getElementById('mUrl').value = url;
    document.getElementById('mTitle').textContent = title || 'Anteprima';

    const abs = absUrl(url);
    const body = document.getElementById('mBody');

    if(kind === 'img'){
      body.innerHTML = `<img src="${abs}" style="width:100%; max-height:70vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);" alt="">`;
    } else if(kind === 'vid'){
      body.innerHTML = `<video src="${abs}" controls playsinline style="width:100%; max-height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:black;"></video>`;
    } else if(kind === 'pdf'){
      body.innerHTML = `<iframe src="${abs}" style="width:100%; height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:white;"></iframe>`;
    } else {
      body.innerHTML = `<img src="${abs}" style="width:100%; max-height:70vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);" alt="">`;
    }

    document.getElementById('shareModal').style.display = 'flex';
  }

  function share(channel){
    const kind = document.getElementById('mKind').value;
    const url = document.getElementById('mUrl').value;
    const media = absUrl(url);

    const msg = [
      `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : (kind === 'pdf' ? 'PDF' : 'QR'))}`,
      `Link: ${media}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : (kind === 'pdf' ? 'PDF' : 'QR'))}`;
    const g = gmailCompose(subject, msg);
    const w = window.open(g, '_blank');
    if(!w){
      window.open(outlookCompose(subject, msg), '_blank');
    }
  }
</script>

</body>
</html>
