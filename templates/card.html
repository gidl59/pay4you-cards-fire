{% extends "base.html" %}
{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">
    <!-- Header con logo -->
    <div class="card-header-row">
      <img
        src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
        alt="Logo"
        class="card-logo-big"
      >
    </div>

    <!-- Blocco principale -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img src="{{ ag.photo_url }}" alt="{{ ag.name }}">
            </div>
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% else %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>
        {% if ag.role %}<div class="card-role-main">{{ ag.role }}</div>{% endif %}
        {% if ag.company %}<div class="card-role-sub">{{ ag.company }}</div>{% endif %}
        {% if ag.bio %}<div class="card-bio">{{ ag.bio }}</div>{% endif %}
      </div>
    </div>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">üì±</div>
        <div class="label">Mobile</div>
        <div class="value"><a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a></div>
      </div>
      {% endif %}

      {% if ag.phone_office %}
      <div class="contact-row">
        <div class="icon">‚òéÔ∏è</div>
        <div class="label">Ufficio</div>
        <div class="value"><a href="tel:{{ ag.phone_office }}">{{ ag.phone_office }}</a></div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row whatsapp-row">
        <div class="icon">üü¢</div>
        <div class="label">WhatsApp</div>
        <div class="value">
          <a href="https://wa.me/{{ ag.whatsapp|replace(' ', '')|replace('+', '') }}">
            {{ ag.whatsapp }}
          </a>
        </div>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        <div class="icon">üìß</div>
        <div class="label">Email</div>
        <div class="value"><a href="mailto:{{ email }}">{{ email }}</a></div>
      </div>
      {% endfor %}

      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">üìÆ</div>
        <div class="label">PEC</div>
        <div class="value"><a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a></div>
      </div>
      {% endif %}

      <!-- SITI INTERNET con nome + invio -->
      {% for site in websites %}
        {% set hostname = site.replace('https://','').replace('http://','').split('/')[0] %}
        {% set encoded = site|urlencode %}
        <div class="contact-row">
          <div class="icon">üåê</div>
          <div class="label">{{ hostname }}</div>
          <div class="value">
            <button type="button" class="link-button"
                    onclick="openFrameModal('{{ site }}')">
              Apri
            </button>
            <a class="link-button"
               href="mailto:?subject=Link&body={{ encoded }}"
               target="_blank" rel="noopener">
              ‚úâÔ∏è Email
            </a>
            <a class="link-button"
               href="https://wa.me/?text={{ encoded }}"
               target="_blank" rel="noopener">
              üü¢ WhatsApp
            </a>
          </div>
        </div>
      {% endfor %}

      <!-- vCard -->
      <div class="contact-row">
        <div class="icon">üíæ</div>
        <div class="label">Salva contatto</div>
        <div class="value">
          <a href="{{ url_for('vcard', slug=ag.slug) }}">Scarica vCard</a>
        </div>
      </div>

      <!-- QR -->
      <div class="contact-row">
        <div class="icon">üî≥</div>
        <div class="label">QR card</div>
        <div class="value">
          <button type="button" class="link-button"
                  onclick="openQrModal('{{ url_for('qr', slug=ag.slug) }}')">
            Mostra QR
          </button>
        </div>
      </div>
    </section>

    <!-- DATI FISCALI -->
    {% if ag.piva or ag.sdi %}
    <section class="card-section">
      <h2>Dati fiscali</h2>
      {% if ag.piva %}
      <div class="address-row">
        <div class="icon">üèõÔ∏è</div>
        <span class="address-value">Partita IVA {{ ag.piva }}</span>
      </div>
      {% endif %}
      {% if ag.sdi %}
      <div class="address-row">
        <div class="icon">üì®</div>
        <span class="address-value">Codice SDI {{ ag.sdi }}</span>
      </div>
      {% endif %}
    </section>
    {% endif %}

    <!-- INDIRIZZI -->
    {% if addresses %}
    <section class="card-section">
      <h2>Indirizzi</h2>
      {% for addr in addresses %}
      <div class="address-row">
        <span class="address-value">{{ addr }}</span>
      </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- DOCUMENTI PDF -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>
      <div class="pdf-list">
        {% for pdf in pdfs %}
        <button type="button"
                class="pdf-item"
                onclick="openFrameModal('{{ pdf.url }}')">
          <span class="pdf-icon">üìÑ</span>
          <span>{{ pdf.name }}</span>
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- GALLERIA -->
    {% if gallery %}
    <section class="card-section">
      <h2>Galleria foto</h2>
      <div class="gallery-scroll">
        {% for img in gallery %}
        <button type="button"
                class="gallery-thumb-btn"
                onclick="openGalleryModal('{{ img }}')">
          <img src="{{ img }}" alt="Foto">
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <div class="card-footer">
      Pay4You ‚Äì Card digitale personale
    </div>
  </div>
</div>

<!-- MODAL IMMAGINI -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h2>Immagine</h2>
    <img id="qr-modal-img" src="" alt="Immagine" style="max-width:260px;width:100%;height:auto;">
    <div class="modal-share-row">
      <a id="img-mail-link" class="link-button">‚úâÔ∏è Email</a>
      <a id="img-wa-link" class="link-button" target="_blank" rel="noopener">üü¢ WhatsApp</a>
    </div>
    <button type="button" class="modal-close-btn" onclick="closeQrModal()">
      Chiudi e torna alla card
    </button>
  </div>
</div>

<!-- MODAL PDF / SITI -->
<div id="frame-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:96%;width:96%;height:90vh;">
    <h2>Visualizzazione</h2>
    <iframe id="frame-modal-iframe"
            src=""
            style="width:100%;height:calc(90vh - 80px);border:none;border-radius:12px;background:#000;"></iframe>
    <div class="modal-share-row">
      <a id="frame-mail-link" class="link-button">‚úâÔ∏è Email</a>
      <a id="frame-wa-link" class="link-button" target="_blank" rel="noopener">üü¢ WhatsApp</a>
    </div>
    <button type="button" class="modal-close-btn" onclick="closeFrameModal()">
      Chiudi e torna alla card
    </button>
  </div>
</div>

<script>
  let currentImageUrl = "";
  let currentFrameUrl = "";

  function updateImageShareLinks() {
    const e = encodeURIComponent(currentImageUrl);
    const mail = document.getElementById('img-mail-link');
    const wa   = document.getElementById('img-wa-link');
    if (!mail || !wa) return;
    mail.href = "mailto:?body=" + e;
    wa.href   = "https://wa.me/?text=" + e;
  }

  function updateFrameShareLinks() {
    const e = encodeURIComponent(currentFrameUrl);
    const mail = document.getElementById('frame-mail-link');
    const wa   = document.getElementById('frame-wa-link');
    if (!mail || !wa) return;
    mail.href = "mailto:?body=" + e;
    wa.href   = "https://wa.me/?text=" + e;
  }

  function openQrModal(url) {
    currentImageUrl = url;
    const img = document.getElementById('qr-modal-img');
    img.src = url;
    document.getElementById('qr-modal').style.display = 'flex';
    updateImageShareLinks();
  }

  function openGalleryModal(url) {
    openQrModal(url);
  }

  function closeQrModal() {
    document.getElementById('qr-modal').style.display = 'none';
    document.getElementById('qr-modal-img').src = "";
    currentImageUrl = "";
  }

  function openFrameModal(url) {
    const isOur =
      url.indexOf('pay4you.store') !== -1 ||
      url.indexOf('pay4you-cards-fire.onrender.com') !== -1 ||
      url.startsWith('/');

    if (!isOur) {
      window.open(url, '_blank');
      return;
    }

    currentFrameUrl = url;
    const iframe = document.getElementById('frame-modal-iframe');
    iframe.src = url;
    document.getElementById('frame-modal').style.display = 'flex';
    updateFrameShareLinks();
  }

  function closeFrameModal() {
    const iframe = document.getElementById('frame-modal-iframe');
    iframe.src = "";
    document.getElementById('frame-modal').style.display = 'none';
    currentFrameUrl = "";
  }
</script>
{% endblock %}
