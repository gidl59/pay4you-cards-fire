{% extends "base.html" %}
{% block title %}{{ ag.name }} | Pay4You{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- HEADER -->
    <div class="card-header-row" style="justify-content:space-between; align-items:center; gap:12px;">
      <div>
        {# ‚úÖ NIENTE LOGO PAY4YOU DI DEFAULT: mostra solo se caricato #}
        {% if ag.extra_logo_url %}
          <img src="{{ ag.extra_logo_url }}" alt="Logo" class="card-logo-big" style="height:72px; animation:none;">
        {% endif %}
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        {# ‚úÖ Switch lingua (solo card pubblica) #}
        <a class="pdf-item" href="?lang=it{% if p_key %}&p={{ p_key }}{% endif %}{% if request.args.get('owner')=='1' %}&owner=1{% endif %}">IT</a>
        <a class="pdf-item" href="?lang=en{% if p_key %}&p={{ p_key }}{% endif %}{% if request.args.get('owner')=='1' %}&owner=1{% endif %}">EN</a>

        {# ‚úÖ Se hai profili #}
        {% if profiles and profiles|length > 0 %}
          <a class="pdf-item" href="/{{ ag.slug }}{% if request.args.get('owner')=='1' %}?owner=1{% endif %}">{{ t['profile_main'] }}</a>
          {% for pr in profiles %}
            <a class="pdf-item" href="/{{ ag.slug }}?p={{ pr.key }}{% if request.args.get('owner')=='1' %}&owner=1{% endif %}">
              {{ pr.label }}
            </a>
          {% endfor %}
        {% endif %}
      </div>
    </div>

    <!-- BLOCCO BUSINESS -->
    <div class="business-card">

      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
          <img class="card-profile-photo" src="{{ ag.photo_url }}" alt="{{ ag.name }}">
        {% else %}
          <div class="card-profile-photo" style="display:flex; align-items:center; justify-content:center; font-weight:800; color:#0b1220; background:rgba(250,204,21,0.85);">
            {{ t['no_photo'] }}
          </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>

        {% if ag.role %}
          <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}

        {% if ag.company %}
          <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}

        {% if ag.bio %}
          <div class="card-bio">{{ ag.bio }}</div>
        {% endif %}
      </div>
    </div>

    <!-- ‚úÖ CONTATTI (WhatsApp + Telefono ufficio + ecc.) -->
    <div class="card-section">
      <h2>{{ t['contacts'] }}</h2>

      {% if mobiles and mobiles|length > 0 %}
        {% for m in mobiles %}
          <div class="contact-row whatsapp-row">
            <div class="icon">üì±</div>
            <div class="label">{{ t['mobile'] }}</div>
            <div class="value">
              <a href="tel:+{{ m|replace(' ','')|replace('-','') }}">{{ m }}</a>
            </div>
          </div>
        {% endfor %}
      {% endif %}

      {% if ag.phone_office %}
        <div class="contact-row">
          <div class="icon">‚òéÔ∏è</div>
          <div class="label">{{ t['office_phone'] }}</div>
          <div class="value"><a href="tel:{{ ag.phone_office }}">{{ ag.phone_office }}</a></div>
        </div>
      {% endif %}

      {# ‚úÖ WhatsApp ‚Äúimportantissimo‚Äù #}
      {% if ag.whatsapp %}
        <div class="contact-row whatsapp-row" style="border:1px solid rgba(34,197,94,0.35); border-radius:12px; margin-top:8px; padding:10px 8px;">
          <div class="icon">üí¨</div>
          <div class="label" style="color:#bbf7d0;">WhatsApp</div>
          <div class="value">
            {% if ag.whatsapp.startswith('http') %}
              <a href="{{ ag.whatsapp }}" target="_blank" rel="noopener">{{ t['open_whatsapp'] }}</a>
            {% else %}
              <a href="https://wa.me/{{ ag.whatsapp|replace('+','')|replace(' ','') }}" target="_blank" rel="noopener">{{ t['open_whatsapp'] }}</a>
            {% endif %}
          </div>
        </div>
      {% endif %}

      {% if emails and emails|length > 0 %}
        {% for e in emails %}
          <div class="contact-row">
            <div class="icon">‚úâÔ∏è</div>
            <div class="label">{{ t['email'] }}</div>
            <div class="value"><a href="mailto:{{ e }}">{{ e }}</a></div>
          </div>
        {% endfor %}
      {% endif %}

      {% if ag.pec %}
        <div class="contact-row">
          <div class="icon">üì©</div>
          <div class="label">PEC</div>
          <div class="value"><a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a></div>
        </div>
      {% endif %}

      {% if websites and websites|length > 0 %}
        {% for w in websites %}
          <div class="contact-row">
            <div class="icon">üåê</div>
            <div class="label">{{ t['website'] }}</div>
            <div class="value"><a href="{{ w if w.startswith('http') else 'https://' ~ w }}" target="_blank" rel="noopener">{{ t['open_site'] }}</a></div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- ‚úÖ SOCIAL: niente link lunghi -->
    <div class="card-section">
      <h2>{{ t['social'] }}</h2>

      {% set socials = [
        ('Facebook', ag.facebook),
        ('Instagram', ag.instagram),
        ('LinkedIn', ag.linkedin),
        ('TikTok', ag.tiktok),
        ('Telegram', ag.telegram)
      ] %}

      {% for label, url in socials %}
        {% if url %}
          <div class="contact-row social-row">
            <div class="icon">üîó</div>
            <div class="label">{{ label }}</div>
            <div class="value">
              <a href="{{ url }}" target="_blank" rel="noopener">{{ t['open'] }}</a>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- ‚úÖ BOX AZIONI RAPIDE (DOPO I SOCIAL) -->
    <div class="card-section" style="border-color: rgba(96,165,250,0.28);">
      <h2>{{ t['quick_actions'] }}</h2>

      <div class="contact-row">
        <div class="icon">‚úÖ</div>
        <div class="label">{{ t['save_contact'] }}</div>
        <div class="value">
          <a href="/{{ ag.slug }}.vcf{% if p_key %}?p={{ p_key }}{% endif %}">{{ t['download'] }}</a>
        </div>
      </div>

      <div class="contact-row">
        <div class="icon">üì∑</div>
        <div class="label">{{ t['scan_qr'] }}</div>
        <div class="value">
          <button class="link-button" type="button" onclick="openQrModal()">{{ t['open'] }}</button>
        </div>
      </div>

      <div class="contact-row">
        <div class="icon">üìé</div>
        <div class="label">{{ t['nfc_direct_link'] }}</div>
        <div class="value">
          <button class="link-button" type="button" onclick="copyText('{{ nfc_direct_url }}')">{{ t['copy'] }}</button>
        </div>
      </div>
    </div>

    <!-- ‚úÖ BUSINESS DATI (PIVA + SDI + INDIRIZZI) -->
    {% if ag.piva or ag.sdi or addresses %}
      <div class="card-section">
        <h2>{{ t['business_data'] }}</h2>

        {% if ag.piva %}
          <div class="contact-row">
            <div class="icon">üßæ</div>
            <div class="label">P.IVA</div>
            <div class="value">{{ ag.piva }}</div>
          </div>
        {% endif %}

        {% if ag.sdi %}
          <div class="contact-row">
            <div class="icon">üè∑Ô∏è</div>
            <div class="label">SDI</div>
            <div class="value">{{ ag.sdi }}</div>
          </div>
        {% endif %}

        {% if addresses and addresses|length > 0 %}
          <div class="address-row" style="margin-top:6px;">
            <div style="font-size:13px; color:#9ca3af; margin-bottom:6px;">{{ t['addresses'] }}</div>
            {% for a in addresses %}
              <div class="address-value">üìç {{ a }}</div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <!-- ‚úÖ PDF -->
    {% if pdfs and pdfs|length > 0 %}
      <div class="card-section">
        <h2>{{ t['documents'] }}</h2>
        <div class="pdf-list">
          {% for p in pdfs %}
            <a class="pdf-item" href="{{ p.url }}" target="_blank" rel="noopener">
              <span class="pdf-icon">üìÑ</span> {{ p.name }}
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- ‚úÖ GALLERIA -->
    {% if gallery and gallery|length > 0 %}
      <div class="card-section">
        <h2>{{ t['gallery'] }}</h2>
        <div class="gallery-scroll">
          {% for g in gallery %}
            <button class="gallery-thumb-btn" type="button" onclick="openMediaModal('{{ g }}', 'image')">
              <img src="{{ g }}" alt="Gallery">
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- ‚úÖ VIDEO -->
    {% if videos and videos|length > 0 %}
      <div class="card-section">
        <h2>{{ t['videos'] }}</h2>
        <div class="gallery-scroll">
          {% for v in videos %}
            <button class="gallery-thumb-btn" type="button" onclick="openMediaModal('{{ v }}', 'video')">
              <img src="/static/video-thumb.png" alt="Video" onerror="this.style.display='none'">
              <div style="position:relative; margin-top:-26px; margin-left:10px; font-weight:900; color:#facc15;">‚ñ∂</div>
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {# ‚úÖ BOX PROMO: solo per clienti finali.
       Se tu apri la card dal pannello useremo ?owner=1 e lo nascondiamo #}
    {% if wa_optin_link and request.args.get('owner') != '1' %}
      <div class="card-section" style="border-color: rgba(34,197,94,0.25);">
        <h2>{{ t['promos'] }}</h2>
        <div class="contact-row whatsapp-row" style="border-bottom:none;">
          <div class="icon">‚úÖ</div>
          <div class="label">{{ t['subscribe_promos'] }}</div>
          <div class="value">
            <a href="{{ wa_optin_link }}" target="_blank" rel="noopener">{{ t['open_whatsapp'] }}</a>
          </div>
        </div>
        <div style="margin-top:8px; font-size:12px; color:#9ca3af;">
          {{ t['unsubscribe_hint'] }}
        </div>
      </div>
    {% endif %}

    <div class="card-footer">
      {{ t['footer_note'] }}
    </div>

  </div>
</div>

<!-- ‚úÖ MODAL QR + MEDIA (CHIUDI SEMPRE SOPRA) -->
<div id="modalOverlay" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <div style="position:sticky; top:0; background:#020617; padding:6px 0 10px; z-index:10; display:flex; justify-content:space-between; align-items:center;">
      <h2 id="modalTitle" style="margin:0;">{{ t['preview'] }}</h2>
      <button class="modal-close-btn" type="button" onclick="closeModal()">{{ t['close'] }}</button>
    </div>

    <img id="qr-modal-img" src="" alt="Preview" style="display:none;">
    <video id="qr-modal-video" controls style="display:none; width:100%; max-height:78vh; border-radius:14px; background:#000;"></video>
  </div>
</div>

<script>
  function openQrModal(){
    const img = document.getElementById('qr-modal-img');
    const vid = document.getElementById('qr-modal-video');
    img.style.display = 'block';
    vid.style.display = 'none';
    vid.pause();
    document.getElementById('modalTitle').textContent = "{{ t['qr_code'] }}";
    img.src = "/{{ ag.slug }}/qr.png{% if p_key %}?p={{ p_key }}{% endif %}";
    document.getElementById('modalOverlay').style.display = 'flex';
  }

  function openMediaModal(url, kind){
    const img = document.getElementById('qr-modal-img');
    const vid = document.getElementById('qr-modal-video');
    if(kind === 'video'){
      img.style.display = 'none';
      vid.style.display = 'block';
      document.getElementById('modalTitle').textContent = "{{ t['video'] }}";
      vid.src = url;
      vid.load();
      vid.play().catch(()=>{});
    }else{
      vid.pause();
      vid.style.display = 'none';
      img.style.display = 'block';
      document.getElementById('modalTitle').textContent = "{{ t['image'] }}";
      img.src = url;
    }
    document.getElementById('modalOverlay').style.display = 'flex';
  }

  function closeModal(){
    const overlay = document.getElementById('modalOverlay');
    const vid = document.getElementById('qr-modal-video');
    try{ vid.pause(); }catch(e){}
    overlay.style.display = 'none';
  }

  function copyText(t){
    if(navigator.clipboard){
      navigator.clipboard.writeText(t).then(()=>alert("{{ t['copied'] }}: " + t));
    }else{
      window.prompt("{{ t['copy'] }}:", t);
    }
  }

  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });
  document.getElementById('modalOverlay').addEventListener('click', (e)=>{
    if(e.target.id === 'modalOverlay') closeModal();
  });
</script>
{% endblock %}
