{% extends "base.html" %}

{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <!-- Sfondo blur -->
  <div class="card-glass-bg"></div>

  <div class="card-outer">
    <!-- Header con logo (usa extra_logo se presente) -->
    <div class="card-header-row">
      <img
        src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
        alt="Logo"
        class="card-logo-big"
      >
    </div>

    <!-- Blocco business: foto + nome + ruoli -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <!-- Avatar fronte/retro con rotazione lenta -->
        <div class="avatar-flip">
          <div class="avatar-inner">
            <!-- Fronte: foto agente -->
            <div class="avatar-face avatar-front">
              <img src="{{ ag.photo_url }}" alt="{{ ag.name }}">
            </div>
            <!-- Retro: logo (extra o Pay4You) -->
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% else %}
        <!-- Se non c'√® foto, mostra solo il logo tondo che gira fronte/retro -->
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>

        {% if ag.role %}
          <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}

        {% if ag.company %}
          <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}

        {% if ag.bio %}
          <div class="card-bio">{{ ag.bio }}</div>
        {% endif %}
      </div>
    </div>

    <!-- SEZIONE CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">üì±</div>
        <div class="label">Chiama mobile</div>
        <div class="value">
          <a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a>
        </div>
      </div>
      {% endif %}

      {% if ag.phone_office %}
      <div class="contact-row">
        <div class="icon">‚òéÔ∏è</div>
        <div class="label">Chiama ufficio</div>
        <div class="value">
          <a href="tel:{{ ag.phone_office }}">{{ ag.phone_office }}</a>
        </div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row whatsapp-row">
        <div class="icon">üü¢</div>
        <div class="label">WhatsApp</div>
        <div class="value">
          <a href="https://wa.me/{{ ag.whatsapp|replace(' ', '')|replace('+', '') }}">
            {{ ag.whatsapp }}
          </a>
        </div>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        <div class="icon">üìß</div>
        <div class="label">Email</div>
        <div class="value">
          <a href="mailto:{{ email }}">{{ email }}</a>
        </div>
      </div>
      {% endfor %}

      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">üìÆ</div>
        <div class="label">PEC</div>
        <div class="value">
          <a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a>
        </div>
      </div>
      {% endif %}

      {# SITI INTERNET:
         - se √® pay4you.store -> apre il sito a tutto schermo con ?from=card (freccia di ritorno nel sito)
         - altrimenti APRE IN NUOVA SCHEDA (niente iframe, cos√¨ funzionano anche quelli che bloccano l'iframe) #}
      {% for site in websites %}
      <div class="contact-row">
        <div class="icon">üåê</div>
        <div class="label">Sito internet</div>
        <div class="value">
          <button type="button"
                  class="link-button"
                  onclick="openWebsiteFromCard('{{ site }}')">
            Vai al sito
          </button>
        </div>
      </div>
      {% endfor %}

      {% if ag.facebook %}
      <div class="contact-row social-row">
        <div class="icon">üìò</div>
        <div class="label">Facebook</div>
        <div class="value">
          <a href="{{ ag.facebook }}" target="_blank" rel="noopener noreferrer">
            Profilo
          </a>
        </div>
      </div>
      {% endif %}

      {% if ag.instagram %}
      <div class="contact-row social-row">
        <div class="icon">üì∑</div>
        <div class="label">Instagram</div>
        <div class="value">
          <a href="{{ ag.instagram }}" target="_blank" rel="noopener noreferrer">
            Profilo
          </a>
        </div>
      </div>
      {% endif %}

      {% if ag.linkedin %}
      <div class="contact-row social-row">
        <div class="icon">üíº</div>
        <div class="label">LinkedIn</div>
        <div class="value">
          <a href="{{ ag.linkedin }}" target="_blank" rel="noopener noreferrer">
            Profilo
          </a>
        </div>
      </div>
      {% endif %}

      <!-- Link profilo card -->
      <div class="contact-row">
        <div class="icon">ü™™</div>
        <div class="label">Profilo digitale</div>
        <div class="value">
          <a href="{{ base_url }}/{{ ag.slug }}" target="_blank" rel="noopener noreferrer">
            Apri card
          </a>
        </div>
      </div>

      <!-- vCard -->
      <div class="contact-row">
        <div class="icon">üíæ</div>
        <div class="label">Salva contatto</div>
        <div class="value">
          <a href="{{ url_for('vcard', slug=ag.slug) }}?download=1">
            Salva contatto
          </a>
        </div>
      </div>

      <!-- QR con modal -->
      <div class="contact-row">
        <div class="icon">üî≥</div>
        <div class="label">QR code</div>
        <div class="value">
          <button type="button"
                  class="link-button"
                  onclick="openQrModal('{{ url_for('qr', slug=ag.slug) }}')">
            Apri QR
          </button>
        </div>
      </div>
    </section>

    <!-- SEZIONE DATI FISCALI -->
    {% if ag.piva or ag.sdi %}
    <section class="card-section">
      <h2>Dati fiscali</h2>

      {% if ag.piva %}
      <div class="address-row">
        <div class="icon">üèõÔ∏è</div>
        <span class="address-value">Partita IVA {{ ag.piva }}</span>
      </div>
      {% endif %}

      {% if ag.sdi %}
      <div class="address-row">
        <div class="icon">üì®</div>
        <span class="address-value">Codice SDI {{ ag.sdi }}</span>
      </div>
      {% endif %}
    </section>
    {% endif %}

    <!-- SEZIONE INDIRIZZI -->
    {% if addresses %}
    <section class="card-section">
      <h2>Indirizzi</h2>
      {% for addr in addresses %}
      <div class="address-row">
        <span class="address-value">{{ addr }}</span>
      </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- SEZIONE DOCUMENTI (PDF) -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>
      <div class="pdf-list">
        {% for pdf_url in pdfs %}
        <button type="button"
                class="pdf-item"
                onclick="openFrameModal('{{ pdf_url }}')">
          <span class="pdf-icon">üìÑ</span>
          <span>Documento {{ loop.index }}</span>
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- SEZIONE GALLERIA FOTO -->
    {% if gallery %}
    <section class="card-section">
      <h2>Galleria foto</h2>
      <div class="gallery-scroll">
        {% for img in gallery %}
        <button type="button"
                class="gallery-thumb-btn"
                onclick="openGalleryModal('{{ img }}')">
          <img src="{{ img }}" alt="Foto Pay4You">
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Footer opzionale -->
    <div class="card-footer">
      Pay4You ‚Äì Card digitale personale
    </div>
  </div>
</div>

<!-- MODAL QR / GALLERIA (IMMAGINI) -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:96%; width:96%; max-height:90vh; overflow:auto;">
    <h2>Visualizzazione immagine</h2>
    <img id="qr-modal-img"
         src=""
         alt="Immagine"
         style="max-width:100%; height:auto; display:block; margin:0 auto;">

    <!-- CONDIVISIONE IMMAGINE DENTRO IL MODAL -->
    <div id="img-share-row"
         style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
      <a id="img-email"
         class="link-button"
         href="#"
         style="text-decoration:none;">
        ‚û°Ô∏è Invia per email
      </a>
      <a id="img-wa"
         class="link-button"
         href="#"
         target="_blank" rel="noopener"
         style="text-decoration:none;">
        ‚û°Ô∏è Invia via WhatsApp
      </a>
    </div>

    <button type="button" class="modal-close-btn" onclick="closeQrModal()">
      Chiudi e torna alla card
    </button>
  </div>
</div>

<!-- MODAL PER SITO INTERNET / PDF (IFRAME) -->
<div id="frame-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width: 96%; width: 96%; height: 90vh;">
    <h2>Visualizzazione documento</h2>
    <iframe id="frame-modal-iframe"
            src=""
            style="width:100%; height: calc(90vh - 120px); border:none; border-radius: 12px; background:#000;"></iframe>

    <!-- CONDIVISIONE PDF DENTRO IL MODAL (solo se √® un PDF) -->
    <div id="frame-share-row"
         style="margin-top:10px; display:none; flex-wrap:wrap; gap:8px; justify-content:center;">
      <a id="frame-email"
         class="link-button"
         href="#"
         style="text-decoration:none;">
        ‚û°Ô∏è Invia per email
      </a>
      <a id="frame-wa"
         class="link-button"
         href="#"
         target="_blank" rel="noopener"
         style="text-decoration:none;">
        ‚û°Ô∏è Invia via WhatsApp
      </a>
    </div>

    <button type="button" class="modal-close-btn" onclick="closeFrameModal()">
      Chiudi e torna alla card
    </button>
  </div>
</div>

<script>
  let currentImageUrl = null;
  let currentFrameUrl = null;

  // --- IMMAGINI (QR + GALLERIA) ---
  function openQrModal(url) {
    const img = document.getElementById('qr-modal-img');
    img.src = url;
    currentImageUrl = url;
    updateImageShareLinks();
    document.getElementById('qr-modal').style.display = 'flex';
  }

  function openGalleryModal(url) {
    const img = document.getElementById('qr-modal-img');
    img.src = url;
    currentImageUrl = url;
    updateImageShareLinks();
    document.getElementById('qr-modal').style.display = 'flex';
  }

  function updateImageShareLinks() {
    const emailLink = document.getElementById('img-email');
    const waLink = document.getElementById('img-wa');
    if (!currentImageUrl || !emailLink || !waLink) return;

    const enc = encodeURIComponent(currentImageUrl);
    emailLink.href = "mailto:?subject=Immagine%20Pay4You&body=Ti%20invio%20questa%20immagine:%0A" + enc;
    waLink.href = "https://wa.me/?text=Ti%20invio%20questa%20immagine:%20" + enc;
  }

  function closeQrModal() {
    document.getElementById('qr-modal').style.display = 'none';
    document.getElementById('qr-modal-img').src = "";
    currentImageUrl = null;
  }

  // --- SITI / PDF ---
  // Se √® pay4you.store: stessa scheda con ?from=card (per mostrare freccia sul sito)
  // Altrimenti: nuova scheda (niente iframe, niente freccia, ma funziona sempre)
  function openWebsiteFromCard(url) {
    if (url.indexOf('pay4you.store') !== -1) {
      try {
        var u = new URL(url, window.location.href);
        u.searchParams.set('from', 'card');
        window.location.href = u.toString();
      } catch (e) {
        var base = url.split('#')[0];
        var sep = base.indexOf('?') === -1 ? '?' : '&';
        window.location.href = base + sep + 'from=card';
      }
    } else {
      // Siti esterni: apri in nuova scheda
      window.open(url, '_blank', 'noopener');
    }
  }

  function openFrameModal(url) {
    const iframe = document.getElementById('frame-modal-iframe');
    const shareRow = document.getElementById('frame-share-row');
    const emailLink = document.getElementById('frame-email');
    const waLink = document.getElementById('frame-wa');

    iframe.src = url;
    currentFrameUrl = url;
    document.getElementById('frame-modal').style.display = 'flex';

    // Se √® un PDF, mostra i pulsanti di condivisione
    if (currentFrameUrl && currentFrameUrl.toLowerCase().indexOf('.pdf') !== -1) {
      const enc = encodeURIComponent(currentFrameUrl);
      if (emailLink && waLink && shareRow) {
        emailLink.href = "mailto:?subject=Documento%20Pay4You&body=Ti%20invio%20questo%20documento:%0A" + enc;
        waLink.href = "https://wa.me/?text=Ti%20invio%20questo%20documento:%20" + enc;
        shareRow.style.display = 'flex';
      }
    } else {
      // Non √® un PDF (es: viewer generico): niente pulsanti
      if (shareRow) shareRow.style.display = 'none';
    }
  }

  function closeFrameModal() {
    const iframe = document.getElementById('frame-modal-iframe');
    const shareRow = document.getElementById('frame-share-row');
    iframe.src = "";
    currentFrameUrl = null;
    if (shareRow) shareRow.style.display = 'none';
    document.getElementById('frame-modal').style.display = 'none';
  }
</script>
{% endblock %}
