{% extends "base.html" %}
{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- HEADER LOGO -->
    <div class="card-header-row">
      <img
        src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
        alt="Logo"
        class="card-logo-big"
      >
    </div>

    <!-- PROFILO -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img src="{{ ag.photo_url }}" alt="{{ ag.name }}">
            </div>
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>

        {% if ag.role %}
          <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}

        {% if ag.company %}
          <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}

        {% if ag.bio %}
          <div class="card-bio">{{ ag.bio }}</div>
        {% endif %}
      </div>
    </div>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">üì±</div>
        <div class="label">Chiama mobile</div>
        <div class="value"><a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a></div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row">
        <div class="icon">üü¢</div>
        <div class="label">WhatsApp</div>
        <div class="value">
          <a href="https://wa.me/{{ ag.whatsapp|replace(' ', '')|replace('+', '') }}" target="_blank" rel="noopener noreferrer">
            Scrivi su WhatsApp
          </a>
        </div>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        <div class="icon">üìß</div>
        <div class="label">Email</div>
        <div class="value"><a href="mailto:{{ email }}">{{ email }}</a></div>
      </div>
      {% endfor %}

      {% for site in websites %}
      <div class="contact-row">
        <div class="icon">üåê</div>
        <div class="label">Sito internet</div>
        <div class="value">
          <a href="{{ site }}" target="_blank" rel="noopener noreferrer">
            {{ site }}
          </a>
        </div>
      </div>
      {% endfor %}

      {# =========================
         SOCIAL / PEC / P.IVA / SDI / INDIRIZZI
         ========================= #}

      {# Facebook #}
      {% set _fb = (ag.facebook if ag.facebook is defined and ag.facebook else (ag.fb if ag.fb is defined and ag.fb else None)) %}
      {% if _fb %}
        {% set _fb_url = _fb if _fb.startswith('http') else 'https://facebook.com/' ~ _fb %}
        <div class="contact-row">
          <div class="icon">üìò</div>
          <div class="label">Facebook</div>
          <div class="value"><a href="{{ _fb_url }}" target="_blank" rel="noopener noreferrer">Apri Facebook</a></div>
        </div>
      {% endif %}

      {# Instagram #}
      {% set _ig = (ag.instagram if ag.instagram is defined and ag.instagram else (ag.ig if ag.ig is defined and ag.ig else None)) %}
      {% if _ig %}
        {% set _ig_url = _ig if _ig.startswith('http') else 'https://instagram.com/' ~ (_ig|replace('@','')) %}
        <div class="contact-row">
          <div class="icon">üì∏</div>
          <div class="label">Instagram</div>
          <div class="value"><a href="{{ _ig_url }}" target="_blank" rel="noopener noreferrer">Apri Instagram</a></div>
        </div>
      {% endif %}

      {# LinkedIn #}
      {% set _li = (ag.linkedin if ag.linkedin is defined and ag.linkedin else
                    (ag.linkedin_url if ag.linkedin_url is defined and ag.linkedin_url else
                    (ag.li if ag.li is defined and ag.li else None))) %}
      {% if _li %}
        {% set _li_clean = _li|replace('@','') %}
        {% set _li_url = _li_clean if _li_clean.startswith('http') else 'https://www.linkedin.com/in/' ~ _li_clean %}
        <div class="contact-row">
          <div class="icon">üíº</div>
          <div class="label">LinkedIn</div>
          <div class="value"><a href="{{ _li_url }}" target="_blank" rel="noopener noreferrer">Apri LinkedIn</a></div>
        </div>
      {% endif %}

      {# TikTok #}
      {% set _tt = (ag.tiktok if ag.tiktok is defined and ag.tiktok else (ag.tt if ag.tt is defined and ag.tt else None)) %}
      {% if _tt %}
        {% set _tt_user = _tt|replace('@','') %}
        {% set _tt_url = _tt if _tt.startswith('http') else 'https://www.tiktok.com/@' ~ _tt_user %}
        <div class="contact-row">
          <div class="icon">üéµ</div>
          <div class="label">TikTok</div>
          <div class="value"><a href="{{ _tt_url }}" target="_blank" rel="noopener noreferrer">Apri TikTok</a></div>
        </div>
      {% endif %}

      {# Telegram #}
      {% set _tg = (ag.telegram if ag.telegram is defined and ag.telegram else (ag.tg if ag.tg is defined and ag.tg else None)) %}
      {% if _tg %}
        {% set _tg_user = _tg|replace('@','') %}
        {% set _tg_url = _tg if _tg.startswith('http') else 'https://t.me/' ~ _tg_user %}
        <div class="contact-row">
          <div class="icon">‚úàÔ∏è</div>
          <div class="label">Telegram</div>
          <div class="value"><a href="{{ _tg_url }}" target="_blank" rel="noopener noreferrer">Apri Telegram</a></div>
        </div>
      {% endif %}

      {# PEC #}
      {% set _pec = (ag.pec if ag.pec is defined and ag.pec else (ag.pec_email if ag.pec_email is defined and ag.pec_email else None)) %}
      {% if _pec %}
      <div class="contact-row">
        <div class="icon">üèõÔ∏è</div>
        <div class="label">PEC</div>
        <div class="value"><a href="mailto:{{ _pec }}">{{ _pec }}</a></div>
      </div>
      {% endif %}

      {# P.IVA #}
      {% set _piva = (ag.piva if ag.piva is defined and ag.piva else
                      (ag.partita_iva if ag.partita_iva is defined and ag.partita_iva else
                      (ag.vat if ag.vat is defined and ag.vat else None))) %}
      {% if _piva %}
      <div class="contact-row">
        <div class="icon">üßæ</div>
        <div class="label">Partita IVA</div>
        <div class="value">{{ _piva }}</div>
      </div>
      {% endif %}

      {# SDI #}
      {% set _sdi = (ag.sdi if ag.sdi is defined and ag.sdi else (ag.codice_sdi if ag.codice_sdi is defined and ag.codice_sdi else None)) %}
      {% if _sdi %}
      <div class="contact-row">
        <div class="icon">üè∑Ô∏è</div>
        <div class="label">Codice SDI</div>
        <div class="value">{{ _sdi }}</div>
      </div>
      {% endif %}

      {# ===== INDIRIZZI ===== #}
      {% set _addr_source = None %}
      {% if addresses is defined and addresses %}
        {% set _addr_source = addresses %}
      {% else %}
        {% set _addr_source =
          (ag.indirizzi if ag.indirizzi is defined and ag.indirizzi else
          (ag.addresses if ag.addresses is defined and ag.addresses else
          (ag.address_list if ag.address_list is defined and ag.address_list else
          (ag.indirizzo if ag.indirizzo is defined and ag.indirizzo else
          (ag.address if ag.address is defined and ag.address else None))))) %}
      {% endif %}

      {% if _addr_source %}
        {% if _addr_source is string %}
          {% set _addr_lines = _addr_source.splitlines() %}
        {% else %}
          {% set _addr_lines = _addr_source %}
        {% endif %}

        {% for line in _addr_lines %}
          {% if line and line|trim %}
          <div class="contact-row">
            <div class="icon">üìç</div>
            <div class="label">Indirizzo{% if _addr_lines|length > 1 %} {{ loop.index }}{% endif %}</div>
            <div class="value">
              <a href="https://www.google.com/maps?q={{ line|trim|urlencode }}"
                 target="_blank" rel="noopener noreferrer">
                {{ line|trim }}
              </a>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      {% endif %}

      <div class="contact-row">
        <div class="icon">üíæ</div>
        <div class="label">Salva contatto</div>
        <div class="value">
          <a href="{{ url_for('vcard', slug=ag.slug) }}">
            Salva
          </a>
        </div>
      </div>
    </section>

    <!-- DOCUMENTI PDF -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>

      <div class="pdf-list">
        {% for pdf in pdfs %}
        <div class="pdf-item">
          <div class="pdf-title">{{ pdf.name }}</div>

          <div class="pdf-actions">
            <a class="primary" href="{{ pdf.url }}" target="_blank" rel="noopener">
              Apri / Scarica
            </a>

            <a href="mailto:?subject={{ pdf.name }}&body=Ti invio questo documento:%0A{{ pdf.url }}">
              Invia Email
            </a>

            <a href="https://wa.me/?text=Ti invio questo documento: {{ pdf.url }}"
               target="_blank" rel="noopener">
              Invia WhatsApp
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- GALLERIA -->
    {% if gallery %}
    <section class="card-section">
      <h2>Galleria foto</h2>

      <div class="gallery-scroll">
        {% for img in gallery %}
        <button type="button"
                class="gallery-thumb-btn"
                onclick="openGalleryModal('{{ img }}')">
          <img src="{{ img }}" alt="Foto">
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- FOOTER -->
    <div class="card-footer">
      Pay4You ‚Äì Card digitale personale
    </div>
  </div>
</div>

<!-- MODAL IMMAGINI (CON FRECCE + CONTATORE) -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box modal-gallery">
    <button type="button" class="modal-nav-btn prev" onclick="prevGallery()" aria-label="Foto precedente">‚Äπ</button>

    <img id="qr-modal-img" src="" alt="Foto">

    <button type="button" class="modal-nav-btn next" onclick="nextGallery()" aria-label="Foto successiva">‚Ä∫</button>

    <div class="modal-controls">
      <div id="modal-counter" class="modal-counter"></div>
      <button type="button" class="modal-close-btn" onclick="closeQrModal()">Chiudi</button>
    </div>
  </div>
</div>

<script>
  // ‚úÖ lista immagini dalla gallery (Jinja/Flask)
  const galleryUrls = {{ (gallery if gallery else [])|tojson }};

  let currentIndex = -1;
  let touchStartX = null;

  function updateModalCounter(){
    const el = document.getElementById('modal-counter');
    if (!el) return;
    if (currentIndex >= 0 && galleryUrls.length){
      el.textContent = (currentIndex + 1) + " / " + galleryUrls.length;
    } else {
      el.textContent = "";
    }
  }

  function openGalleryModal(url) {
    const img = document.getElementById('qr-modal-img');

    const idx = galleryUrls.indexOf(url);
    currentIndex = (idx >= 0) ? idx : 0;

    img.src = galleryUrls[currentIndex] || url;
    document.getElementById('qr-modal').style.display = 'flex';
    updateModalCounter();
  }

  function closeQrModal() {
    document.getElementById('qr-modal').style.display = 'none';
    document.getElementById('qr-modal-img').src = "";
    currentIndex = -1;
    updateModalCounter();
  }

  function showIndex(i){
    if (!galleryUrls.length) return;
    currentIndex = (i + galleryUrls.length) % galleryUrls.length; // wrap
    document.getElementById('qr-modal-img').src = galleryUrls[currentIndex];
    updateModalCounter();
  }

  function nextGallery(){
    if (currentIndex < 0) return;
    showIndex(currentIndex + 1);
  }

  function prevGallery(){
    if (currentIndex < 0) return;
    showIndex(currentIndex - 1);
  }

  // ‚úÖ tastiera: sinistra/destra/esc
  document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;

    if (e.key === 'ArrowRight') nextGallery();
    if (e.key === 'ArrowLeft') prevGallery();
    if (e.key === 'Escape') closeQrModal();
  });

  // ‚úÖ click fuori dal box = chiudi
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (e.target === modal) closeQrModal();
  });

  // ‚úÖ swipe mobile
  document.addEventListener('touchstart', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    touchStartX = e.changedTouches[0].clientX;
  }, {passive:true});

  document.addEventListener('touchend', (e) => {
    const modal = document.getElementById('qr-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (touchStartX === null) return;

    const endX = e.changedTouches[0].clientX;
    const delta = endX - touchStartX;
    touchStartX = null;

    if (Math.abs(delta) > 40) {
      if (delta < 0) nextGallery();
      else prevGallery();
    }
  }, {passive:true});
</script>

<style>
/* PDF */
.pdf-item {
  background: #181716;
  border-radius: 10px;
  padding: 12px 14px;
  border: 1px solid #444036;
  font-size: 0.9rem;
  color: #ffffff;
}
.pdf-title {
  font-weight: 700;
  font-size: 1.02rem;
  color: #ffffff;
  margin-bottom: 8px;
}
.pdf-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.pdf-actions a {
  font-size: 0.8rem;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #c99a2f;
  text-decoration: none;
  color: #ffffff;
}
.pdf-actions a.primary {
  background: #c99a2f;
  color: #111;
}
.pdf-actions a.primary:hover {
  background: #b78924;
}

/* bio pi√π grande */
.card-bio{
  font-size: 1.10rem;
  line-height: 1.35;
  font-weight: 600;
}

/* ‚úÖ GALLERIA PI√ô GRANDE + ZOOM */
.gallery-scroll img{
  width: 185px;
  height: 185px;
  object-fit: cover;
  border-radius: 18px;
  transition: transform 180ms ease, box-shadow 180ms ease, filter 180ms ease;
  transform: scale(1);
  will-change: transform;
}
.gallery-scroll img:hover{
  transform: scale(1.12);
  box-shadow: 0 18px 48px rgba(0,0,0,0.80);
  filter: brightness(1.05);
}
.gallery-thumb-btn:active img{
  transform: scale(1.12);
  box-shadow: 0 18px 48px rgba(0,0,0,0.80);
  filter: brightness(1.05);
}

/* ‚úÖ MODAL FOTO GRANDISSIMO + FRECCE */
.modal-gallery{
  position: relative;
  width: min(1100px, 96vw);
  max-width: 1100px;
}
#qr-modal-img{
  width: 100%;
  height: auto;
  max-height: 78vh;
  object-fit: contain;
  border-radius: 14px;
  display: block;
}

/* frecce */
.modal-nav-btn{
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 48px;
  height: 48px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.5);
  background: rgba(2,6,23,0.65);
  color: #fff;
  font-size: 28px;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}
.modal-nav-btn:hover{
  background: rgba(2,6,23,0.82);
}
.modal-nav-btn.prev{ left: 10px; }
.modal-nav-btn.next{ right: 10px; }

/* barra sotto */
.modal-controls{
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-top: 12px;
}
.modal-counter{
  font-size: 13px;
  color: rgba(229,231,235,0.85);
}

/* Mobile */
@media (max-width: 640px){
  .modal-nav-btn{
    width: 42px;
    height: 42px;
    font-size: 24px;
  }
  #qr-modal-img{
    max-height: 72vh;
  }
}

@media (prefers-reduced-motion: reduce){
  .gallery-scroll img{ transition: none; }
}
</style>

{% endblock %}
