<!doctype html>
<html lang="{{ lang or 'it' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>{{ (ag.name or "Pay4You Card") }} | Pay4You</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body data-theme="auto">
  <div class="page-main">
    <div class="card-outer card-theme">

      {% set the_logo = ag.logo_url %}
      {% if the_logo %}
        <div class="top-left-logo">
          <img src="{{ the_logo }}" alt="Logo">
        </div>
      {% endif %}

      <div class="hero">
        <div class="avatar-wrap">

          {# ORBIT dietro: z-index sistemato nel CSS #}
          {% if the_logo %}
            <div class="orbit">
              <img src="{{ the_logo }}" alt="Logo orbit">
            </div>
          {% endif %}

          <!-- flip: tap = gira su se stessa e mostra il logo -->
          <div class="flip is-flippable" onclick="toggleFlip()">
            <div class="flip-inner">
              <div class="flip-front avatar">
                {% if ag.photo_url %}
                  <img class="avatar-img" src="{{ ag.photo_url }}" alt="Foto profilo">
                {% else %}
                  <div class="avatar-placeholder">üë§</div>
                {% endif %}
              </div>

              <div class="flip-back avatar">
                {% if the_logo %}
                  <img class="avatar-img" src="{{ the_logo }}" alt="Logo">
                {% else %}
                  <div class="avatar-placeholder">‚òÖ</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="hero-text">
          {% if ag.name %}<div class="name">{{ ag.name }}</div>{% endif %}
          {% if ag.company %}<div class="company">{{ ag.company }}</div>{% endif %}
          {% if ag.role %}<div class="role">{{ ag.role }}</div>{% endif %}
          {% if ag.bio %}<div class="bio">{{ ag.bio }}</div>{% endif %}

          {% if p2_enabled %}
            <div class="profile-switch">
              <a class="profile-pill {% if not p_key %}active{% endif %}"
                 href="/{{ ag.slug }}{% if request.args.get('lang') %}?lang={{ request.args.get('lang') }}{% endif %}">
                Profilo 1
              </a>
              <a class="profile-pill {% if p_key=='p2' %}active{% endif %}"
                 href="/{{ ag.slug }}?p=p2{% if request.args.get('lang') %}&lang={{ request.args.get('lang') }}{% endif %}">
                Profilo 2
              </a>
            </div>
          {% endif %}

          <!-- Social icons -->
          {% set has_social_icons = wa_link or ag.instagram or ag.facebook or ag.linkedin or ag.tiktok or ag.telegram %}
          {% if has_social_icons %}
            <div class="social-icons">
              {% if wa_link %}
                <a class="soc" href="{{ wa_link }}" target="_blank" rel="noopener" aria-label="WhatsApp" title="WhatsApp">
                  <svg viewBox="0 0 24 24"><path d="M12 2a9.7 9.7 0 0 0-8.4 14.6L2 22l5.6-1.5A9.7 9.7 0 1 0 12 2zm0 17.8a8 8 0 0 1-4.1-1.1l-.3-.2-3.3.9.9-3.2-.2-.3A8 8 0 1 1 12 19.8zm4.6-5.6c-.2-.1-1.3-.6-1.5-.7-.2-.1-.4-.1-.5.1-.1.2-.6.7-.7.8-.1.1-.3.2-.5.1-.2-.1-.9-.3-1.7-1.1-.7-.6-1.1-1.4-1.2-1.6-.1-.2 0-.4.1-.5l.4-.4c.1-.1.2-.3.3-.5.1-.2 0-.4 0-.5l-.7-1.6c-.2-.4-.4-.4-.5-.4h-.4c-.1 0-.4 0-.6.3-.2.2-.8.8-.8 2s.8 2.3.9 2.4c.1.2 1.6 2.5 3.9 3.5.6.2 1 .4 1.3.5.6.2 1.1.2 1.5.1.5-.1 1.3-.5 1.5-1.1.2-.5.2-1 .1-1.1-.1-.1-.2-.1-.4-.2z"/></svg>
                </a>
              {% endif %}

              {% if ag.instagram %}
                <a class="soc" href="{{ ag.instagram }}" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
                  <svg viewBox="0 0 24 24"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4.5A5.5 5.5 0 1 1 6.5 12 5.5 5.5 0 0 1 12 8.5zm0 2A3.5 3.5 0 1 0 15.5 12 3.5 3.5 0 0 0 12 10.5zM18 6.8a1.2 1.2 0 1 1-1.2 1.2A1.2 1.2 0 0 1 18 6.8z"/></svg>
                </a>
              {% endif %}

              {% if ag.facebook %}
                <a class="soc" href="{{ ag.facebook }}" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
                  <svg viewBox="0 0 24 24"><path d="M13.5 22v-8h2.7l.4-3H13.5V9.1c0-.9.2-1.5 1.6-1.5h1.6V5c-.3 0-1.4-.1-2.7-.1-2.7 0-4.5 1.6-4.5 4.6V11H7v3h2.9v8h3.6z"/></svg>
                </a>
              {% endif %}

              {% if ag.linkedin %}
                <a class="soc" href="{{ ag.linkedin }}" target="_blank" rel="noopener" aria-label="LinkedIn" title="LinkedIn">
                  <svg viewBox="0 0 24 24"><path d="M6.5 6.5A1.8 1.8 0 1 1 4.7 4.7 1.8 1.8 0 0 1 6.5 6.5zM5 20H2.8V8H5zM21 20h-2.2v-6.2c0-1.5-.5-2.6-2-2.6-1.1 0-1.7.8-2 1.5-.1.2-.1.6-.1.9V20h-2.2V8h2.2v1.7A3.1 3.1 0 0 1 15.8 8c2.2 0 3.9 1.4 3.9 4.5z"/></svg>
                </a>
              {% endif %}

              {% if ag.tiktok %}
                <a class="soc" href="{{ ag.tiktok }}" target="_blank" rel="noopener" aria-label="TikTok" title="TikTok">
                  <svg viewBox="0 0 24 24"><path d="M16 3c.7 2.2 2.3 3.8 4.5 4.3V10c-1.8 0-3.4-.6-4.5-1.5v6.2c0 3.1-2.5 5.6-5.6 5.6S4.8 17.8 4.8 14.7 7.3 9.1 10.4 9.1c.4 0 .9.1 1.3.2v3c-.4-.2-.8-.3-1.3-.3-1.4 0-2.6 1.2-2.6 2.6s1.2 2.6 2.6 2.6 2.6-1.2 2.6-2.6V3z"/></svg>
                </a>
              {% endif %}

              {% if ag.telegram %}
                <a class="soc" href="{{ ag.telegram }}" target="_blank" rel="noopener" aria-label="Telegram" title="Telegram">
                  <svg viewBox="0 0 24 24"><path d="M21.8 4.7 3.6 11.9c-1.2.5-1.2 1.2-.2 1.5l4.7 1.5 1.8 5.5c.2.6.4.6.8.2l2.6-2.5 5.3 3.9c1 .6 1.7.3 2-1l3.4-16c.3-1.5-.6-2.1-2.2-1.3zM9 14.3l9.2-6.1c.5-.3.9.1.5.5l-7.7 7.3-.3 3.4-1.6-5z"/></svg>
                </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="section actions-box">
        <div class="section-title">{{ t_func('actions') }}</div>

        <div class="actions-row">
          <a class="action-btn" href="/{{ ag.slug }}.vcf">{{ t_func('save_contact') }}</a>
          <button class="action-btn secondary" type="button" onclick="openMediaModal('{{ qr_url }}','image')">
            {{ t_func('scan_qr') }}
          </button>
        </div>

        <!-- Tema spostato vicino ad Azioni -->
        <div class="theme-toggle theme-toggle-compact">
          <div class="theme-label">{{ t_func('theme') }}:</div>
          <button class="theme-pill" type="button" data-theme="auto">{{ t_func('theme_auto') }}</button>
          <button class="theme-pill" type="button" data-theme="light">{{ t_func('theme_light') }}</button>
          <button class="theme-pill" type="button" data-theme="dark">{{ t_func('theme_dark') }}</button>
        </div>

        <div class="actions-hint">Suggerimento: salva il contatto e condividi la card ai tuoi clienti.</div>
      </div>

      <div class="section">
        <div class="section-title">{{ t_func('contacts') }}</div>

        {% for m in mobiles %}
          <div class="row"><span>{{ t_func('mobile_phone') }}</span><a href="tel:{{ m }}">{{ m }}</a></div>
        {% endfor %}

        {% if ag.phone_office %}
          <div class="row"><span>{{ t_func('office_phone') }}</span><a href="tel:{{ ag.phone_office }}">{{ ag.phone_office }}</a></div>
        {% endif %}

        {% if wa_link %}
          <div class="row"><span>{{ t_func('whatsapp') }}</span><a href="{{ wa_link }}" target="_blank" rel="noopener">Apri WhatsApp</a></div>
        {% endif %}

        {% if emails and emails|length > 0 %}
          {% for e in emails %}
            <div class="row"><span>Email</span><a href="mailto:{{ e }}">{{ e }}</a></div>
          {% endfor %}
        {% endif %}

        {% if pec_email %}
          <div class="row"><span>PEC</span><a href="mailto:{{ pec_email }}">{{ pec_email }}</a></div>
        {% endif %}

        {% if websites and websites|length > 0 %}
          {% for w in websites %}
            <div class="row"><span>{{ t_func('open_website') }}</span><a href="{{ w }}" target="_blank" rel="noopener">{{ t_func('open_website') }}</a></div>
          {% endfor %}
        {% endif %}
      </div>

      {% if ag.piva or ag.sdi or (addresses and addresses|length > 0) %}
        <div class="section">
          <div class="section-title">{{ t_func('data') }}</div>

          {% if ag.piva %}<div class="row"><span>{{ t_func('vat') }}</span><span>{{ ag.piva }}</span></div>{% endif %}
          {% if ag.sdi %}<div class="row"><span>{{ t_func('sdi') }}</span><span>{{ ag.sdi }}</span></div>{% endif %}

          {% if addresses and addresses|length > 0 %}
            <div class="addr-list">
              {% for a in addresses %}
                <a class="addr-item" href="{{ a.maps }}" target="_blank" rel="noopener">
                  üìç {{ a.text }} <span class="addr-mini">({{ t_func('open_maps') }})</span>
                </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if gallery and gallery|length > 0 %}
        <div class="section">
          <div class="section-title">{{ t_func('gallery') }}</div>
          <div class="gallery-scroll">
            {% for img in gallery %}
              <button class="thumb" type="button" onclick="openMediaModal('{{ img }}','image')">
                <img src="{{ img }}" alt="Foto {{ loop.index }}">
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if videos and videos|length > 0 %}
        <div class="section">
          <div class="section-title">{{ t_func('videos') }}</div>
          <div class="gallery-scroll">
            {% for v in videos %}
              <button class="thumb" type="button" onclick="openMediaModal('{{ v }}','video')">
                <div class="video-thumb">
                  <span class="video-play">‚ñ∂</span>
                  <video class="video-mini"
                         muted
                         playsinline
                         webkit-playsinline
                         preload="metadata"
                         src="{{ v }}"></video>
                </div>
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if pdfs and pdfs|length > 0 %}
        <div class="section">
          <div class="section-title">{{ t_func('documents') }}</div>
          <div class="pdf-list">
            {% for p in pdfs %}
              <button class="pdf-btn" type="button" onclick="openMediaModal('{{ p.url }}','pdf')">
                üìÑ {{ p.name }}
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <div class="footer">
        Realizzato ¬© Pay4You da Giuseppe Di Lisio 2026
      </div>

    </div>
  </div>

  <!-- MODAL -->
  <div id="mediaModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <button class="modal-x" type="button" onclick="closeMediaModal()">‚úï</button>

      <img id="mImg" src="" alt="media" style="display:none;">
      <video id="mVideo" controls playsinline webkit-playsinline style="display:none;"></video>
      <iframe id="mPdf" src="" style="display:none;" title="pdf"></iframe>

      <button class="modal-close" type="button" onclick="closeMediaModal()">{{ t_func('close') }}</button>
    </div>
  </div>

  <script>
    // Flip avatar
    function toggleFlip(){
      const el = document.querySelector('.flip');
      if(!el) return;
      el.classList.toggle('flipped');
    }

    // Modal
    function openMediaModal(src, type){
      const modal = document.getElementById('mediaModal');
      const img = document.getElementById('mImg');
      const vid = document.getElementById('mVideo');
      const pdf = document.getElementById('mPdf');

      img.style.display='none';
      vid.style.display='none';
      pdf.style.display='none';

      img.src='';
      pdf.src='';
      try{ vid.pause(); }catch(e){}
      vid.removeAttribute('src');
      vid.load();

      if(type === 'video'){
        // iOS: pi√π stabile cos√¨
        vid.src = src;
        vid.load();
        vid.style.display='block';
      } else if(type === 'pdf'){
        pdf.src = src;
        pdf.style.display='block';
      } else {
        img.src = src;
        img.style.display='block';
      }

      modal.style.display='flex';
    }

    function closeMediaModal(){
      const modal = document.getElementById('mediaModal');
      const vid = document.getElementById('mVideo');
      const pdf = document.getElementById('mPdf');
      const img = document.getElementById('mImg');

      try{ vid.pause(); }catch(e){}
      vid.removeAttribute('src');
      vid.load();
      pdf.src='';
      img.src='';
      modal.style.display='none';
    }

    // Tema toggle (Auto/Light/Dark) + salva sul telefono
    const THEME_KEY = 'pay4you_card_theme';
    function applyTheme(theme){
      document.body.setAttribute('data-theme', theme);
      document.querySelectorAll('.theme-pill').forEach(b=>{
        b.classList.toggle('active', b.dataset.theme === theme);
      });
    }
    function getStoredTheme(){
      return localStorage.getItem(THEME_KEY) || 'auto';
    }
    document.querySelectorAll('.theme-pill').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const th = btn.dataset.theme;
        localStorage.setItem(THEME_KEY, th);
        applyTheme(th);
      });
    });
    applyTheme(getStoredTheme());

    // Video thumbs: best effort (su iOS pu√≤ comunque non mostrare frame)
    function initVideoThumbs(){
      document.querySelectorAll('video.video-mini').forEach(v=>{
        try{
          v.muted = true;
          v.playsInline = true;
          v.setAttribute('playsinline','');
          v.setAttribute('webkit-playsinline','');
          v.preload = 'metadata';

          v.addEventListener('loadedmetadata', ()=>{
            try{
              if (v.duration && v.duration > 0.2) v.currentTime = 0.1;
            }catch(e){}
          });

          v.addEventListener('seeked', ()=>{
            try{ v.pause(); }catch(e){}
          });

          v.load();
        }catch(e){}
      });
    }
    initVideoThumbs();
  </script>

</body>
</html>
