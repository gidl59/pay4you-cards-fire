{% extends "base.html" %}
{% block title %}{{ ag.name }}{% endblock %}

{% block content %}
<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- HEADER LOGO -->
    <div class="card-header-row">
      <img
        src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
        alt="Logo"
        class="card-logo-big"
      >
    </div>

    <!-- PROFILO -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img src="{{ ag.photo_url }}" alt="{{ ag.name }}">
            </div>
            <div class="avatar-face avatar-back">
              <img
                src="{{ ag.extra_logo_url if ag.extra_logo_url else url_for('static', filename='logo.png') }}"
                alt="Logo"
              >
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>

        {% if ag.role %}
          <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}

        {% if ag.company %}
          <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}

        {% if ag.bio %}
          <div class="card-bio">{{ ag.bio }}</div>
        {% endif %}
      </div>
    </div>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">üì±</div>
        <div class="label">Chiama mobile</div>
        <div class="value"><a href="tel:{{ ag.phone_mobile }}">{{ ag.phone_mobile }}</a></div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row">
        <div class="icon">üü¢</div>
        <div class="label">WhatsApp</div>
        <div class="value">
          <a href="https://wa.me/{{ ag.whatsapp|replace(' ', '')|replace('+', '') }}" target="_blank" rel="noopener noreferrer">
            Scrivi su WhatsApp
          </a>
        </div>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        <div class="icon">üìß</div>
        <div class="label">Email</div>
        <div class="value"><a href="mailto:{{ email }}">{{ email }}</a></div>
      </div>
      {% endfor %}

      {% for site in websites %}
      <div class="contact-row">
        <div class="icon">üåê</div>
        <div class="label">Sito internet</div>
        <div class="value">
          <a href="{{ site }}" target="_blank" rel="noopener noreferrer">
            {{ site }}
          </a>
        </div>
      </div>
      {% endfor %}

      {# =========================
         SOCIAL / PEC / P.IVA / INDIRIZZO
         (gestione nomi alternativi)
         ========================= #}

      {# Facebook: ag.facebook oppure ag.fb #}
      {% set _fb = ag.facebook if ag.facebook is defined and ag.facebook else (ag.fb if ag.fb is defined and ag.fb else None) %}
      {% if _fb %}
      {% set _fb_url = _fb if _fb.startswith('http') else 'https://facebook.com/' ~ _fb %}
      <div class="contact-row">
        <div class="icon">üìò</div>
        <div class="label">Facebook</div>
        <div class="value">
          <a href="{{ _fb_url }}" target="_blank" rel="noopener noreferrer">
            Apri Facebook
          </a>
        </div>
      </div>
      {% endif %}

      {# Instagram: ag.instagram oppure ag.ig #}
      {% set _ig = ag.instagram if ag.instagram is defined and ag.instagram else (ag.ig if ag.ig is defined and ag.ig else None) %}
      {% if _ig %}
      {% set _ig_url = _ig if _ig.startswith('http') else 'https://instagram.com/' ~ _ig|replace('@','') %}
      <div class="contact-row">
        <div class="icon">üì∏</div>
        <div class="label">Instagram</div>
        <div class="value">
          <a href="{{ _ig_url }}" target="_blank" rel="noopener noreferrer">
            Apri Instagram
          </a>
        </div>
      </div>
      {% endif %}

      {# PEC: ag.pec oppure ag.pec_email #}
      {% set _pec = ag.pec if ag.pec is defined and ag.pec else (ag.pec_email if ag.pec_email is defined and ag.pec_email else None) %}
      {% if _pec %}
      <div class="contact-row">
        <div class="icon">üèõÔ∏è</div>
        <div class="label">PEC</div>
        <div class="value"><a href="mailto:{{ _pec }}">{{ _pec }}</a></div>
      </div>
      {% endif %}

      {# P.IVA: ag.piva oppure ag.partita_iva #}
      {% set _piva = ag.piva if ag.piva is defined and ag.piva else (ag.partita_iva if ag.partita_iva is defined and ag.partita_iva else None) %}
      {% if _piva %}
      <div class="contact-row">
        <div class="icon">üßæ</div>
        <div class="label">Partita IVA</div>
        <div class="value">{{ _piva }}</div>
      </div>
      {% endif %}

      {# Indirizzo: ag.indirizzo oppure ag.address #}
      {% set _addr = ag.indirizzo if ag.indirizzo is defined and ag.indirizzo else (ag.address if ag.address is defined and ag.address else None) %}
      {% if _addr %}
      <div class="contact-row">
        <div class="icon">üìç</div>
        <div class="label">Indirizzo</div>
        <div class="value">
          <a href="https://www.google.com/maps?q={{ _addr|urlencode }}"
             target="_blank" rel="noopener noreferrer">
            {{ _addr }}
          </a>
        </div>
      </div>
      {% endif %}

      <div class="contact-row">
        <div class="icon">üíæ</div>
        <div class="label">Salva contatto</div>
        <div class="value">
          <a href="{{ url_for('vcard', slug=ag.slug) }}">
            Salva
          </a>
        </div>
      </div>
    </section>

    <!-- DOCUMENTI PDF -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>

      <div class="pdf-list">
        {% for pdf in pdfs %}
        <div class="pdf-item">
          <div class="pdf-title">{{ pdf.name }}</div>

          <div class="pdf-actions">
            <a class="primary" href="{{ pdf.url }}" target="_blank" rel="noopener">
              Apri / Scarica
            </a>

            <a href="mailto:?subject={{ pdf.name }}&body=Ti invio questo documento:%0A{{ pdf.url }}">
              Invia Email
            </a>

            <a href="https://wa.me/?text=Ti invio questo documento: {{ pdf.url }}"
               target="_blank" rel="noopener">
              Invia WhatsApp
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- GALLERIA -->
    {% if gallery %}
    <section class="card-section">
      <h2>Galleria foto</h2>

      <div class="gallery-scroll">
        {% for img in gallery %}
        <button type="button"
                class="gallery-thumb-btn"
                onclick="openGalleryModal('{{ img }}')">
          <img src="{{ img }}" alt="Foto">
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- FOOTER -->
    <div class="card-footer">
      Pay4You ‚Äì Card digitale personale
    </div>
  </div>
</div>

<!-- MODAL IMMAGINI -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <img id="qr-modal-img" src="" style="max-width:90%;max-height:90vh;">
    <button type="button" class="modal-close-btn" onclick="closeQrModal()">
      Chiudi
    </button>
  </div>
</div>

<script>
function openGalleryModal(url) {
  const img = document.getElementById('qr-modal-img');
  img.src = url;
  document.getElementById('qr-modal').style.display = 'flex';
}
function closeQrModal() {
  document.getElementById('qr-modal').style.display = 'none';
  document.getElementById('qr-modal-img').src = "";
}
</script>

<style>
.pdf-item {
  background: #181716;
  border-radius: 10px;
  padding: 12px 14px;
  border: 1px solid #444036;
  font-size: 0.9rem;
  color: #ffffff;
}

.pdf-title {
  font-weight: 700;
  font-size: 1.02rem;
  color: #ffffff;
  margin-bottom: 8px;
}

.pdf-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.pdf-actions a {
  font-size: 0.8rem;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #c99a2f;
  text-decoration: none;
  color: #ffffff;
}

.pdf-actions a.primary {
  background: #c99a2f;
  color: #111;
}

.pdf-actions a.primary:hover {
  background: #b78924;
}
</style>

{% endblock %}
