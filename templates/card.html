<!doctype html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ ag.name or ag.slug }} | Pay4You</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/static/card.css">
</head>
<body>
  <div class="card-wrap">

    <!-- HERO: niente sfondo gigante -->
    <div class="hero">
      <div class="hero-overlay"></div>

      <div class="top">
        {% if ag.logo_url %}
          <!-- logo dentro cerchio -->
          <div class="logo-bubble {{ 'spin' if ag.logo_spin==1 else '' }}">
            <img class="logo-img" src="{{ ag.logo_url }}" alt="logo">
          </div>
        {% endif %}
      </div>

      <div class="avatar-wrap {{ 'orbit' if ag.orbit_spin==1 else '' }}">
        <div id="avatar3d" class="avatar {{ 'spin' if ag.avatar_spin==1 else '' }}">
          <div class="avatar-inner" id="avatarInner">
            <!-- FRONT: foto agente -->
            <div class="face front">
              {% if ag.photo_url %}
                <img
                  src="{{ ag.photo_url }}"
                  alt="foto"
                  style="object-position: {{ ag.photo_pos_x }}% {{ ag.photo_pos_y }}%; transform: scale({{ ag.photo_zoom }});"
                >
              {% else %}
                <div class="avatar-ph">üë§</div>
              {% endif %}
            </div>

            <!-- BACK: foto dietro (se esiste), altrimenti logo -->
            <div class="face back">
              {% if ag.back_media_url %}
                <img src="{{ ag.back_media_url }}" alt="retro">
              {% elif ag.logo_url %}
                <img src="{{ ag.logo_url }}" alt="logo">
              {% else %}
                <div class="avatar-ph">‚≠ê</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="title">
        <h1>{{ ag.name }}</h1>
        {% if ag.role %}<div class="sub">{{ ag.role }}</div>{% endif %}
        {% if ag.company %}<div class="sub2">{{ ag.company }}</div>{% endif %}
      </div>
    </div>

    <div class="content">

      {% if ag.bio %}
        <div class="box box-accent">
          <h3>{{ t_func("info") if t_func is defined else "Info" }}</h3>
          <p class="bio">{{ ag.bio }}</p>

          <!-- SOCIAL ICONS SOTTO BIO -->
          {% set socials = [] %}
          {% if ag.facebook %}{% set _ = socials.append(("facebook", ag.facebook)) %}{% endif %}
          {% if ag.instagram %}{% set _ = socials.append(("instagram", ag.instagram)) %}{% endif %}
          {% if ag.linkedin %}{% set _ = socials.append(("linkedin", ag.linkedin)) %}{% endif %}
          {% if ag.tiktok %}{% set _ = socials.append(("tiktok", ag.tiktok)) %}{% endif %}
          {% if ag.telegram %}{% set _ = socials.append(("telegram", ag.telegram)) %}{% endif %}
          {% if ag.youtube %}{% set _ = socials.append(("youtube", ag.youtube)) %}{% endif %}
          {% if ag.spotify %}{% set _ = socials.append(("spotify", ag.spotify)) %}{% endif %}

          {% if socials|length %}
            <div class="socials">
              {% for kind,url in socials %}
                <a class="sbtn s-{{kind}}" href="{{ url }}" target="_blank" rel="noopener" aria-label="{{kind}}">
                  {% if kind == "facebook" %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12a10 10 0 1 0-11.6 9.9v-7H8v-3h2.4V9.7c0-2.4 1.4-3.7 3.6-3.7 1 0 2 .2 2 .2v2.3h-1.2c-1.2 0-1.6.8-1.6 1.6V12H18l-.5 3H15v7A10 10 0 0 0 22 12z"/></svg>
                  {% elif kind == "instagram" %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4.5A5.5 5.5 0 1 1 6.5 14 5.5 5.5 0 0 1 12 8.5zm0 2A3.5 3.5 0 1 0 15.5 14 3.5 3.5 0 0 0 12 10.5zM18 6.8a1.2 1.2 0 1 1-1.2-1.2A1.2 1.2 0 0 1 18 6.8z"/></svg>
                  {% elif kind == "linkedin" %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6.5 6.5A2.5 2.5 0 1 1 4 4a2.5 2.5 0 0 1 2.5 2.5zM4.5 20h4V9h-4v11zM13 9a4.5 4.5 0 0 0-4 2.2V9H9v11h4v-6c0-1.6.3-3.2 2.3-3.2S18 12.4 18 14v6h4v-6.8C22 10.4 20.5 9 18 9a5 5 0 0 0-5 0z"/></svg>
                  {% elif kind == "tiktok" %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 3c.6 3.1 2.7 5 5 5v3c-1.9 0-3.6-.6-5-1.7V16a6 6 0 1 1-6-6c.4 0 .7 0 1 .1v3.2a3 3 0 1 0 2 2.9V3h3z"/></svg>
                  {% elif kind == "telegram" %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21.6 4.3 2.9 11.5c-1.3.5-1.3 1.2-.2 1.6l4.8 1.5 1.8 5.3c.2.6.1.9.9.9.6 0 .9-.3 1.2-.6l2.3-2.3 4.8 3.5c.9.5 1.5.2 1.7-.9l3-14.1c.3-1.3-.5-1.8-1.6-1.3zM9.2 14.6l9.5-6c.5-.3 1 .1.6.5l-7.7 7.1-.3 3.2-1.9-6.3z"/></svg>
                  {% elif kind == "youtube" %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21.8 8s-.2-1.5-.8-2.1c-.8-.8-1.7-.8-2.1-.9C15.9 4.7 12 4.7 12 4.7h0s-3.9 0-6.9.3c-.4.1-1.3.1-2.1.9C2.4 6.5 2.2 8 2.2 8S2 9.7 2 11.4v1.2C2 14.3 2.2 16 2.2 16s.2 1.5.8 2.1c.8.8 1.9.8 2.4.9 1.7.2 6.6.3 6.6.3s3.9 0 6.9-.3c.4-.1 1.3-.1 2.1-.9.6-.6.8-2.1.8-2.1s.2-1.7.2-3.4v-1.2C22 9.7 21.8 8 21.8 8zM10 14.8V9.2L15.5 12 10 14.8z"/></svg>
                  {% elif kind == "spotify" %}
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm4.6 14.4a.9.9 0 0 1-1.2.3c-2.5-1.5-5.7-1.9-9.3-1a.9.9 0 0 1-.4-1.8c4.1-1 7.8-.6 10.7 1.2.4.2.5.8.2 1.3zm.9-3a1 1 0 0 1-1.4.3c-2.9-1.8-7.3-2.4-10.6-1.3a1 1 0 0 1-.6-1.9c3.9-1.2 8.9-.5 12.3 1.6.5.3.6 1 .3 1.3zm.1-3.2c-3.5-2.1-9.2-2.3-12.6-1.3a1.1 1.1 0 0 1-.6-2c4-1.2 10.5-1 14.6 1.5a1.1 1.1 0 0 1-1.4 1.8z"/></svg>
                  {% endif %}
                </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}

      <div class="box">
        <h3>{{ t_func("actions") }}</h3>
        <div class="actions">
          <button class="btn btn-accent" type="button" onclick="openShareModal('qr', '{{ qr_url }}', 'QR Code')">
            {{ t_func("scan_qr") }}
          </button>
          {% if wa_link %}
            <a class="btn" href="{{ wa_link }}" target="_blank" rel="noopener">{{ t_func("whatsapp") }}</a>
          {% endif %}
        </div>
      </div>

      <div class="box">
        <h3>{{ t_func("contacts") }}</h3>

        {% if mobiles %}
          <div class="row">
            <div class="k">{{ t_func("mobile_phone") }}</div>
            <div class="v">
              {% for m in mobiles %}
                <a href="tel:{{ m }}">{{ m }}</a>{% if not loop.last %} ¬∑ {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if office_value %}
          <div class="row">
            <div class="k">{{ t_func("office_phone") }}</div>
            <div class="v"><a href="tel:{{ office_value }}">{{ office_value }}</a></div>
          </div>
        {% endif %}

        {% if emails %}
          <div class="row">
            <div class="k">Email</div>
            <div class="v">
              {% for e in emails %}
                <a href="mailto:{{ e }}">{{ e }}</a>{% if not loop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if websites %}
          <div class="row">
            <div class="k">{{ t_func("open_website") }}</div>
            <div class="v">
              {% for w in websites %}
                <a target="_blank" rel="noopener" href="{{ w }}">{{ w }}</a>{% if not loop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if addresses %}
          <div class="row">
            <div class="k">Indirizzi</div>
            <div class="v">
              {% for a in addresses %}
                <div class="addr">
                  <div>{{ a.text }}</div>
                  <a target="_blank" rel="noopener" href="{{ a.maps }}">{{ t_func("open_maps") }}</a>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      <div class="box">
        <h3>{{ t_func("data") }}</h3>
        {% if ag.piva %}
          <div class="row"><div class="k">{{ t_func("vat") }}</div><div class="v">{{ ag.piva }}</div></div>
        {% endif %}
        {% if ag.sdi %}
          <div class="row"><div class="k">{{ t_func("sdi") }}</div><div class="v">{{ ag.sdi }}</div></div>
        {% endif %}
      </div>

      <!-- ‚úÖ RIGA UNICA: PROFILI + TEMA (sotto dati aziendali) -->
      <div class="switch-row">
        <div class="profiles">
          {% if profile != 'p1' %}
            <a class="ps-btn" href="/{{ ag.slug }}">P1</a>
          {% endif %}
          {% if p2_enabled == 1 and profile != 'p2' %}
            <a class="ps-btn" href="/{{ ag.slug }}?p=p2">P2</a>
          {% endif %}
          {% if p3_enabled == 1 and profile != 'p3' %}
            <a class="ps-btn" href="/{{ ag.slug }}?p=p3">P3</a>
          {% endif %}
        </div>

        <div class="themes">
          <button class="th-btn" type="button" data-theme="auto">Auto</button>
          <button class="th-btn" type="button" data-theme="light">Chiaro</button>
          <button class="th-btn" type="button" data-theme="dark">Scuro</button>
        </div>
      </div>

      {% if gallery %}
        <div class="box">
          <h3>{{ t_func("gallery") }}</h3>
          <div class="media-grid small">
            {% for g in gallery %}
              <button class="thumb" type="button" onclick="openShareModal('img','{{ g }}','Foto')">
                <img src="{{ g }}" alt="">
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if videos %}
        <div class="box">
          <h3>{{ t_func("videos") }}</h3>
          <div class="media-grid small">
            {% for v in videos %}
              <button class="thumb" type="button" onclick="openShareModal('vid','{{ v }}','Video')">
                <div class="play-badge">‚ñ∂</div>
                <video muted playsinline preload="metadata" src="{{ v }}#t=0.1"></video>
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if pdfs %}
        <div class="box">
          <h3>{{ t_func("documents") }}</h3>
          <ul class="docs">
            {% for p in pdfs %}
              <li><button class="docbtn" type="button" onclick="openShareModal('pdf','{{ p.url }}','{{ p.name|e }}')">üìÑ {{ p.name }}</button></li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

    </div>

    <footer class="foot">
      <small>Pay4You Card 2026 ¬∑ realizzato da Giuseppe Di Lisio</small>
    </footer>

  </div>

  <!-- MODAL SHARE -->
  <div id="shareModal" class="modal-overlay" style="display:none" onclick="overlayClose(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-title" id="mTitle">Anteprima</div>
      <div id="mBody" style="margin-top:12px;"></div>

      <div class="modal-actions">
        <button class="btn" type="button" onclick="share('whatsapp')">Invia WhatsApp</button>
        <button class="btn" type="button" onclick="share('email')">Invia Email</button>
        <button class="btn ghost" type="button" onclick="closeModal()">Chiudi</button>
      </div>

      <input type="hidden" id="mKind" value="">
      <input type="hidden" id="mUrl" value="">
    </div>
  </div>

<script>
  function absUrl(u){
    if(!u) return '';
    u = (u + '').trim();
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }
  function outlookCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://outlook.office.com/mail/deeplink/compose?subject=${su}&body=${bd}`;
  }

  function overlayClose(e){
    if(e.target && e.target.id === "shareModal") closeModal();
  }
  function closeModal(){
    const m = document.getElementById('shareModal');
    if(m) m.style.display = 'none';
    const b = document.getElementById('mBody');
    if(b) b.innerHTML = '';
  }

  function openShareModal(kind, url, title){
    document.getElementById('mKind').value = kind;
    document.getElementById('mUrl').value = url;
    document.getElementById('mTitle').textContent = title || 'Anteprima';

    const abs = absUrl(url);
    const body = document.getElementById('mBody');

    if(kind === 'img'){
      body.innerHTML = `<img src="${abs}" style="width:100%; max-height:70vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);" alt="">`;
    } else if(kind === 'vid'){
      body.innerHTML = `<video src="${abs}" controls playsinline style="width:100%; max-height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:black;"></video>`;
    } else if(kind === 'pdf'){
      body.innerHTML = `<iframe src="${abs}" style="width:100%; height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:white;"></iframe>`;
    } else {
      body.innerHTML = `<img src="${abs}" style="width:100%; max-height:70vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);" alt="">`;
    }

    document.getElementById('shareModal').style.display = 'flex';
  }

  function share(channel){
    const kind = document.getElementById('mKind').value;
    const url = document.getElementById('mUrl').value;
    const media = absUrl(url);

    const msg = [
      `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : (kind === 'pdf' ? 'PDF' : 'QR'))}`,
      `Link: ${media}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : (kind === 'pdf' ? 'PDF' : 'QR'))}`;
    const g = gmailCompose(subject, msg);
    const w = window.open(g, '_blank');
    if(!w){
      window.open(outlookCompose(subject, msg), '_blank');
    }
  }

  /* ========= THEME SWITCH (auto/chiaro/scuro) ========= */
  (function(){
    const root = document.documentElement;
    const buttons = Array.from(document.querySelectorAll('.th-btn'));

    function applyTheme(mode){
      root.setAttribute('data-theme', mode);
      localStorage.setItem('p4y_theme', mode);
      paintActive(mode);
    }

    function paintActive(mode){
      buttons.forEach(b => b.classList.toggle('active', b.dataset.theme === mode));
    }

    const saved = localStorage.getItem('p4y_theme') || 'auto';
    applyTheme(saved);

    buttons.forEach(b => b.addEventListener('click', () => applyTheme(b.dataset.theme)));

    // auto segue sistema
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if((localStorage.getItem('p4y_theme') || 'auto') === 'auto') applyTheme('auto');
    });
  })();

  /* ========= EFFETTI FOTO: TAP or FLIP (orizzontale) ========= */
  (function(){
    const avatar = document.getElementById('avatar3d');
    const inner = document.getElementById('avatarInner');
    if(!avatar || !inner) return;

    const allowFlip = {{ 1 if ag.allow_flip==1 else 0 }};
    const tapRotate = {{ 1 if ag.avatar_spin==1 else 0 }};

    // Se flip attivo, disabilita tapRotate
    const tapEnabled = allowFlip ? 0 : tapRotate;

    if(allowFlip){
      // flip continuo (orizzontale) gestito via CSS .flip-on
      avatar.classList.add('flip-on');
    } else if(tapEnabled){
      avatar.classList.add('tap-on');
      avatar.addEventListener('click', () => {
        avatar.classList.toggle('tapped');
      });
    }
  })();
</script>

</body>
</html>
