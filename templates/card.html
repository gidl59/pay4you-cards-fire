{% extends "base.html" %}
{% block title %}{{ ag.name }}{% endblock %}
{% block content %}

<!-- Stop al comportamento telefono su PIVA/IBAN -->
<style>
  a[href^="tel"]:not(.phone-link) {
    text-decoration: none !important;
    pointer-events: none !important;
    color: inherit !important;
  }
</style>

<div class="card-fullscreen">
  <div class="card-glass-bg"></div>

  <div class="card-outer">

    <!-- LOGO HEADER -->
    <div class="card-header-row">
      <img src="{{ url_for('static', filename='logo.png') }}"
           alt="Pay4You"
           class="card-logo-big">
    </div>

    <!-- FOTO + NOME + RUOLI -->
    <div class="business-card">
      <div class="card-profile-photo-wrapper">
        {% if ag.photo_url %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img src="{{ ag.photo_url }}" alt="{{ ag.name }}">
            </div>
            <div class="avatar-face avatar-back">
              <img src="{{ url_for('static', filename='logo.png') }}" alt="Pay4You">
            </div>
          </div>
        </div>
        {% else %}
        <div class="avatar-flip">
          <div class="avatar-inner">
            <div class="avatar-face avatar-front">
              <img src="{{ url_for('static', filename='logo.png') }}" alt="Pay4You">
            </div>
            <div class="avatar-face avatar-back">
              <img src="{{ url_for('static', filename='logo.png') }}" alt="Pay4You">
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-name-block">
        <h1 class="card-name">{{ ag.name }}</h1>

        {% if ag.role %}
        <div class="card-role-main">{{ ag.role }}</div>
        {% endif %}
        {% if ag.company %}
        <div class="card-role-sub">{{ ag.company }}</div>
        {% endif %}
        {% if ag.bio %}
        <div class="card-bio">{{ ag.bio }}</div>
        {% endif %}
      </div>
    </div>

    <!-- CONTATTI -->
    <section class="card-section">
      <h2>Contatti</h2>

      {% if ag.phone_mobile %}
      <div class="contact-row">
        <div class="icon">ğŸ“±</div>
        <div class="label">Chiama mobile</div>
        <div class="value"><a href="tel:{{ ag.phone_mobile|replace(' ', '') }}" class="phone-link">{{ ag.phone_mobile }}</a></div>
      </div>
      {% endif %}

      {% if ag.phone_office %}
      <div class="contact-row">
        <div class="icon">â˜ï¸</div>
        <div class="label">Chiama ufficio</div>
        <div class="value"><a href="tel:{{ ag.phone_office|replace(' ', '') }}" class="phone-link">{{ ag.phone_office }}</a></div>
      </div>
      {% endif %}

      {% if ag.whatsapp %}
      <div class="contact-row whatsapp-row">
        <div class="icon">ğŸŸ¢</div>
        <div class="label">WhatsApp</div>
        <div class="value"><a href="https://wa.me/{{ ag.whatsapp|replace(' ', '')|replace('+','') }}">{{ ag.whatsapp }}</a></div>
      </div>
      {% endif %}

      {% for email in emails %}
      <div class="contact-row">
        <div class="icon">ğŸ“§</div>
        <div class="label">Email</div>
        <div class="value"><a href="mailto:{{ email }}">{{ email }}</a></div>
      </div>
      {% endfor %}

      {% if ag.pec %}
      <div class="contact-row">
        <div class="icon">ğŸ“®</div>
        <div class="label">PEC</div>
        <div class="value"><a href="mailto:{{ ag.pec }}">{{ ag.pec }}</a></div>
      </div>
      {% endif %}

      {% for site in websites %}
      <div class="contact-row">
        <div class="icon">ğŸŒ</div>
        <div class="label">Sito internet</div>
        <div class="value"><a href="{{ site }}" class="link-button" target="_blank">Vai al sito</a></div>
      </div>
      {% endfor %}

      {% if ag.facebook %}
      <div class="contact-row"><div class="icon">ğŸ“˜</div><div class="label">Facebook</div><div class="value"><a href="{{ ag.facebook }}" target="_blank">Profilo</a></div></div>
      {% endif %}
      {% if ag.instagram %}
      <div class="contact-row"><div class="icon">ğŸ“·</div><div class="label">Instagram</div><div class="value"><a href="{{ ag.instagram }}" target="_blank">Profilo</a></div></div>
      {% endif %}
      {% if ag.linkedin %}
      <div class="contact-row"><div class="icon">ğŸ’¼</div><div class="label">LinkedIn</div><div class="value"><a href="{{ ag.linkedin }}" target="_blank">Profilo</a></div></div>
      {% endif %}

      <div class="contact-row">
        <div class="icon">ğŸªª</div>
        <div class="label">Profilo digitale</div>
        <div class="value"><a href="{{ base_url }}/{{ ag.slug }}" target="_blank">Apri card</a></div>
      </div>

      <div class="contact-row">
        <div class="icon">ğŸ’¾</div>
        <div class="label">Salva contatto</div>
        <div class="value"><a href="{{ url_for('vcard', slug=ag.slug) }}?download=1">Salva contatto</a></div>
      </div>

      <div class="contact-row">
        <div class="icon">ğŸ”³</div>
        <div class="label">QR code</div>
        <div class="value"><button type="button" class="link-button" onclick="openQrModal('{{ url_for('qr', slug=ag.slug) }}')">Apri QR</button></div>
      </div>
    </section>

    <!-- DATI FISCALI -->
    {% if ag.piva or ag.sdi or ag.pdf2_url %}
    <section class="card-section">
      <h2>Dati fiscali</h2>

      {% if ag.piva %}
      <div class="address-row"><div class="icon">ğŸ›ï¸</div><span class="address-value">Partita IVA {{ ag.piva }}</span></div>
      {% endif %}
      {% if ag.sdi %}
      <div class="address-row"><div class="icon">ğŸ“¨</div><span class="address-value">Codice SDI {{ ag.sdi }}</span></div>
      {% endif %}
      {% if ag.pdf2_url %}
      <div class="address-row">
        <div class="icon">ğŸ </div>
        <span class="address-value">
          IBAN {{ ag.pdf2_url }}
          <button type="button" class="link-button" onclick="copyIban({{ ag.pdf2_url|tojson }}, this)">ğŸ“‹ Copia IBAN</button>
        </span>
      </div>
      {% endif %}
    </section>
    {% endif %}

    <!-- INDIRIZZI -->
    {% if addresses %}
    <section class="card-section">
      <h2>Indirizzi</h2>
      {% for addr in addresses %}
      <div class="address-row"><a href="https://maps.google.com?q={{ addr|urlencode }}" target="_blank"><span class="address-value">{{ addr }}</span></a></div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- PDF -->
    {% if pdfs %}
    <section class="card-section">
      <h2>Documenti</h2>
      <div class="pdf-list">
        {% for pdf_url in pdfs %}
        <button type="button" class="pdf-item" onclick="openFrameModal('{{ pdf_url }}')"><span class="pdf-icon">ğŸ“„</span><span>Documento {{ loop.index }}</span></button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- GALLERIA -->
    {% if gallery %}
    <section class="card-section">
      <h2>Galleria foto</h2>
      <div class="gallery-scroll">
        {% for img in gallery %}
        <button type="button" class="gallery-thumb-btn" onclick="openGalleryModal('{{ img }}')"><img src="{{ img }}" alt="Foto Pay4You"></button>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <div class="card-footer">
      Pay4You â€“ Card digitale personale
    </div>

  </div>
</div>

<!-- MODAL QR -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h2>Visualizzazione</h2>
    <img id="qr-modal-img" src="" style="max-width:260px">
    <button class="modal-close-btn" onclick="closeQrModal()">Chiudi e torna alla card</button>
  </div>
</div>

<!-- MODAL PDF -->
<div id="frame-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:96%;height:90vh;">
    <h2>Visualizzazione</h2>
    <iframe id="frame-modal-iframe" style="width:100%;height:calc(90vh - 80px);border:none;border-radius:12px;background:#000;"></iframe>
    <button class="modal-close-btn" onclick="closeFrameModal()">Chiudi e torna alla card</button>
  </div>
</div>

<script>
  function openQrModal(url){document.getElementById('qr-modal-img').src=url;document.getElementById('qr-modal').style.display='flex';}
  function openGalleryModal(url){openQrModal(url);}
  function closeQrModal(){document.getElementById('qr-modal').style.display='none';document.getElementById('qr-modal-img').src="";}
  function openFrameModal(url){document.getElementById('frame-modal-iframe').src=url;document.getElementById('frame-modal').style.display='flex';}
  function closeFrameModal(){document.getElementById('frame-modal').style.display='none';document.getElementById('frame-modal-iframe').src="";}

  function copyIban(iban, btn){
    if(!iban) return;
    const textarea=document.createElement("textarea");
    textarea.value=iban;
    textarea.style.position="absolute";
    textarea.style.left="-9999px";
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand("copy");
    document.body.removeChild(textarea);
    const old=btn.textContent;
    btn.textContent="âœ” IBAN copiato";
    btn.style.color="#22c55e";
    setTimeout(()=>{btn.textContent=old;btn.style.color="";},1500);
  }
</script>

{% endblock %}
