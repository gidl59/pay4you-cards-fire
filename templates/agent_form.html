{% extends "base.html" %}

{% block title %}
  {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
{% endblock %}

{% block content %}
<div class="agent-form-wrapper">
  <h1 class="agent-form-title">
    {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
  </h1>

  <form
    class="agent-form"
    method="post"
    enctype="multipart/form-data"
    action="{% if agent %}
               {{ url_for('update_agent', slug=agent.slug) }}
             {% else %}
               {{ url_for('create_agent') }}
             {% endif %}"
  >
    <!-- Dati base -->
    <label>
      Slug (es. giuseppe)
      <input
        type="text"
        name="slug"
        required
        value="{{ agent.slug if agent else '' }}"
      >
    </label>

    <label>
      Nome e cognome
      <input
        type="text"
        name="name"
        required
        value="{{ agent.name if agent else '' }}"
      >
    </label>

    <label>
      Ruolo / Qualifica
      <input
        type="text"
        name="role"
        value="{{ agent.role if agent else '' }}"
      >
    </label>

    <label>
      Azienda
      <input
        type="text"
        name="company"
        value="{{ agent.company if agent else '' }}"
      >
    </label>

    <label>
      Descrizione breve (bio)
      <textarea name="bio">{{ agent.bio if agent else '' }}</textarea>
    </label>

    <!-- Contatti -->
    <label>
      Mobile
      <input
        type="tel"
        name="phone_mobile"
        value="{{ agent.phone_mobile if agent else '' }}"
      >
    </label>

    <label>
      Telefono ufficio
      <input
        type="tel"
        name="phone_office"
        value="{{ agent.phone_office if agent else '' }}"
      >
    </label>

    <label>
      WhatsApp
      <input
        type="tel"
        name="whatsapp"
        value="{{ agent.whatsapp if agent else '' }}"
      >
    </label>

    <label>
      Email (una o più, separate da virgola)
      <input
        type="email"
        name="emails"
        value="{{ agent.emails if agent else '' }}"
      >
    </label>

    <label>
      PEC
      <input
        type="email"
        name="pec"
        value="{{ agent.pec if agent else '' }}"
      >
    </label>

    <label>
      Siti internet (uno o più, separati da virgola)
      <input
        type="text"
        name="websites"
        value="{{ agent.websites if agent else '' }}"
      >
    </label>

    <!-- Social -->
    <label>
      Facebook (URL profilo/pagina)
      <input
        type="text"
        name="facebook"
        value="{{ agent.facebook if agent else '' }}"
      >
    </label>

    <label>
      Instagram (URL profilo)
      <input
        type="text"
        name="instagram"
        value="{{ agent.instagram if agent else '' }}"
      >
    </label>

    <label>
      LinkedIn (URL profilo)
      <input
        type="text"
        name="linkedin"
        value="{{ agent.linkedin if agent else '' }}"
      >
    </label>

    <label>
      TikTok (URL profilo)
      <input
        type="text"
        name="tiktok"
        value="{{ agent.tiktok if agent else '' }}"
      >
    </label>

    <label>
      Telegram (username o link)
      <input
        type="text"
        name="telegram"
        value="{{ agent.telegram if agent else '' }}"
      >
    </label>

    <!-- Dati fiscali -->
    <label>
      Partita IVA
      <input
        type="text"
        name="piva"
        value="{{ agent.piva if agent else '' }}"
      >
    </label>

    <label>
      Codice SDI
      <input
        type="text"
        name="sdi"
        value="{{ agent.sdi if agent else '' }}"
      >
    </label>

    <!-- Indirizzi (uno per riga) -->
    <label>
      Indirizzi (uno per riga)
      <textarea name="addresses">{% if agent and agent.addresses %}{{ agent.addresses }}{% endif %}</textarea>
    </label>

    <!-- FOTO PROFILO con CROP OBBLIGATORIO -->
    <label>
      Foto profilo agente (ritaglio obbligatorio)
      <input
        type="file"
        name="photo"
        id="photo_input"
        accept="image/*"
      >
      {% if agent and agent.photo_url %}
        <small>Foto attuale già presente. Carica una nuova foto solo se vuoi sostituirla.</small>
      {% else %}
        <small>Carica una foto quadrata col volto centrato.</small>
      {% endif %}
    </label>

    <!-- DOCUMENTI PDF (fino a 6) -->
    <label>
      PDF 1
      <input type="file" name="pdf1" accept="application/pdf">
    </label>
    <label>
      PDF 2
      <input type="file" name="pdf2" accept="application/pdf">
    </label>
    <label>
      PDF 3
      <input type="file" name="pdf3" accept="application/pdf">
    </label>
    <label>
      PDF 4
      <input type="file" name="pdf4" accept="application/pdf">
    </label>
    <label>
      PDF 5
      <input type="file" name="pdf5" accept="application/pdf">
    </label>
    <label>
      PDF 6
      <input type="file" name="pdf6" accept="application/pdf">
    </label>

    <!-- Galleria foto (rimane senza crop, per ora) -->
    <label>
      Galleria foto (max 12 immagini)
      <input
        type="file"
        name="gallery"
        id="gallery_input"
        multiple
        accept="image/*"
      >
    </label>

    <div class="agent-form-buttons">
      <button type="submit">
        {% if agent %}Salva modifiche{% else %}Crea agente{% endif %}
      </button>
      <a href="{{ url_for('admin_home') }}" class="btn-secondary">Annulla</a>
    </div>
  </form>
</div>

<!-- MODAL RITAGLIO FOTO PROFILO -->
<div id="photo-crop-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width: 420px; width: 95%; max-height: 90vh;">
    <h2>Ritaglia foto profilo</h2>
    <p style="font-size: 13px; margin-top: 0; margin-bottom: 8px;">
      Usa le dita (su iPhone) o il mouse per spostare e zoomare. Il cerchio mostrerà l'area visibile.
    </p>
    <div style="width:100%; max-height:60vh; overflow:hidden;">
      <img id="photo-crop-image" src="" alt="Ritaglio foto" style="max-width:100%; display:block;">
    </div>
    <div style="margin-top: 10px; display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn-secondary modal-close-btn" onclick="cancelPhotoCrop()">
        Annulla
      </button>
      <button type="button" class="modal-close-btn" onclick="confirmPhotoCrop()">
        Conferma ritaglio
      </button>
    </div>
  </div>
</div>

<script>
  (function() {
    const photoInput = document.getElementById('photo_input');
    const modal = document.getElementById('photo-crop-modal');
    const img = document.getElementById('photo-crop-image');
    let cropper = null;
    let originalFileName = null;

    if (photoInput) {
      photoInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        originalFileName = file.name || 'profile.jpg';

        const reader = new FileReader();
        reader.onload = function (ev) {
          img.src = ev.target.result;
          modal.style.display = 'flex';

          if (cropper) {
            cropper.destroy();
          }

          cropper = new Cropper(img, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
            responsive: true,
            background: false,
            zoomOnWheel: true
          });
        };
        reader.readAsDataURL(file);
      });
    }

    window.confirmPhotoCrop = function() {
      if (!cropper || !photoInput) {
        closePhotoModal();
        return;
      }

      const canvas = cropper.getCroppedCanvas({
        width: 500,
        height: 500,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });

      canvas.toBlob(function(blob) {
        if (!blob) {
          closePhotoModal();
          return;
        }
        const newFile = new File([blob], originalFileName, { type: 'image/jpeg' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(newFile);
        photoInput.files = dataTransfer.files;

        closePhotoModal();
      }, 'image/jpeg', 0.9);
    };

    window.cancelPhotoCrop = function() {
      // Annulla: svuota l'input, non carica nulla
      if (photoInput) {
        photoInput.value = "";
      }
      closePhotoModal();
    };

    function closePhotoModal() {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      modal.style.display = 'none';
      img.src = "";
    }
  })();
</script>
{% endblock %}
