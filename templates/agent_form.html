<script>
  // ===== Helper Gmail + Mail App =====
  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }

  function makeMailto(subject, body){
    const b = (body || "").replace(/\n/g, "\r\n");
    return "mailto:?subject=" + encodeURIComponent(subject || "") + "&body=" + encodeURIComponent(b);
  }

  // ===== Ricava URL card + profilo selezionato =====
  function getSelectedProfile(){
    // Prova a leggere un input/radio/select se esiste
    const sel =
      document.querySelector('input[name="profile"]:checked') ||
      document.querySelector('#profileSelect') ||
      document.querySelector('[data-selected-profile]');

    if(sel){
      const v = sel.value || sel.getAttribute('data-selected-profile');
      if(v) return (v + "").toLowerCase(); // p1 / p2 / p3
    }

    // fallback: prova dal pulsante attivo (se hai class "active")
    const activeBtn = document.querySelector('.profile-btn.active, .btn-mini.active, .tab.active');
    if(activeBtn && activeBtn.dataset && activeBtn.dataset.profile){
      return (activeBtn.dataset.profile + "").toLowerCase();
    }

    // default
    return "p1";
  }

  function buildCardUrl(){
    const base = window.location.origin;

    // Se la pagina già conosce lo slug in un elemento data-slug:
    const slugEl = document.querySelector('[data-slug]');
    const slug = slugEl ? slugEl.getAttribute('data-slug') : "";

    // Se non c'è, prova a prenderlo dall'URL (es: /area/qr/giuseppe o simile)
    let s = slug;
    if(!s){
      const parts = (window.location.pathname || "").split("/").filter(Boolean);
      // ultimo pezzo come slug (fallback)
      s = parts.length ? parts[parts.length - 1] : "";
    }

    const prof = getSelectedProfile(); // p1/p2/p3
    let url = base + "/" + s;

    // P2/P3: se nel tuo sistema usi ?p=p2 / ?p=p3
    if(prof === "p2") url += "?p=p2";
    if(prof === "p3") url += "?p=p3";

    return { slug: s, prof, url };
  }

  function buildQrImageUrl(cardUrl){
    // immagine QR via servizio esterno (come negli altri file)
    return "https://api.qrserver.com/v1/create-qr-code/?size=600x600&data=" + encodeURIComponent(cardUrl);
  }

  // ===== FUNZIONE PRINCIPALE: INVIA EMAIL QR =====
  function sendQrEmail(){
    const info = buildCardUrl();
    if(!info.slug){
      alert("Slug non trovato. Dimmi dove si trova lo slug in questa pagina e lo allineo al 100%.");
      return;
    }

    const subject = "Pay4You - QR Code (" + info.prof.toUpperCase() + ")";
    const qrImg = buildQrImageUrl(info.url);

    const body =
      "Ciao!\n\n" +
      "Ti invio il QR Code della mia Card Pay4You (" + info.prof.toUpperCase() + ").\n\n" +
      "Link Card:\n" + info.url + "\n\n" +
      "Immagine QR (aprila e stampala):\n" + qrImg + "\n\n" +
      "— Pay4You";

    // 1) Gmail web (su PC funziona sempre con testo)
    const g = gmailCompose(subject, body);
    const w = window.open(g, "_blank");

    // 2) fallback su mailto (Thunderbird/Outlook/Apple Mail/Aruba se configurato)
    if(!w){
      window.location.href = makeMailto(subject, body);
    }
  }
</script>
