{% extends "base.html" %}
{% block title %}{% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}{% endblock %}

{% block content %}
<div class="page-main">
  <div class="agent-form-wrapper">

    <h1 class="agent-form-title">
      {% if agent %}Modifica agente: {{ agent.name }}{% else %}Nuovo agente{% endif %}
    </h1>

    <form class="agent-form" method="post" enctype="multipart/form-data">

      <label>Slug (es. pasqualesp)</label>
      <input type="text" name="slug" value="{{ agent.slug if agent else '' }}" required>

      <label>Nome e Cognome</label>
      <input type="text" name="name" value="{{ agent.name if agent else '' }}" required>

      <label>Ruolo</label>
      <input type="text" name="role" value="{{ agent.role if agent else '' }}">

      <label>Azienda</label>
      <input type="text" name="company" value="{{ agent.company if agent else '' }}">

      <label>Descrizione breve</label>
      <textarea name="bio" placeholder="Scrivi una descrizione...">{{ agent.bio if agent else '' }}</textarea>

      <hr style="border:0;border-top:1px solid rgba(148,163,184,0.25);margin:12px 0;">

      <label>Telefono mobile</label>
      <input type="text" name="phone_mobile" value="{{ agent.phone_mobile if agent else '' }}">

      <label>Telefono ufficio</label>
      <input type="text" name="phone_office" value="{{ agent.phone_office if agent else '' }}">

      <label>Email (separate da virgola)</label>
      <input type="text" name="emails" value="{{ agent.emails if agent else '' }}" placeholder="es. info@..., commerciale@...">

      <label>Siti web (separati da virgola — scrivi anche www...)</label>
      <input type="text" name="websites" value="{{ agent.websites if agent else '' }}" placeholder="es. https://..., www....">

      <label>WhatsApp (es. +39333...)</label>
      <input type="text" name="whatsapp" value="{{ agent.whatsapp if agent else '' }}">

      <label>Facebook</label>
      <input type="text" name="facebook" value="{{ agent.facebook if agent else '' }}">

      <label>Instagram</label>
      <input type="text" name="instagram" value="{{ agent.instagram if agent else '' }}">

      <label>LinkedIn</label>
      <input type="text" name="linkedin" value="{{ agent.linkedin if agent else '' }}">

      <label>TikTok</label>
      <input type="text" name="tiktok" value="{{ agent.tiktok if agent else '' }}">

      <label>Telegram</label>
      <input type="text" name="telegram" value="{{ agent.telegram if agent else '' }}">

      <label>PEC</label>
      <input type="text" name="pec" value="{{ agent.pec if agent else '' }}">

      <label>Partita IVA</label>
      <input type="text" name="piva" value="{{ agent.piva if agent else '' }}">

      <label>Codice SDI</label>
      <input type="text" name="sdi" value="{{ agent.sdi if agent else '' }}">

      <label>Indirizzi (uno per riga)</label>
      <textarea name="addresses" placeholder="Via ...&#10;Via ...">{{ agent.addresses if agent else '' }}</textarea>

      <hr style="border:0;border-top:1px solid rgba(148,163,184,0.25);margin:12px 0;">

      <!-- FOTO AGENTE (CROP) -->
      <label>Foto agente (con ritaglio/crop)</label>

      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <input type="file" name="photo" id="photoInput" accept="image/*">

        <div style="width:90px;height:90px;border-radius:999px;overflow:hidden;border:1px solid rgba(148,163,184,0.45);background:rgba(2,6,23,0.35);display:flex;align-items:center;justify-content:center;">
          <img id="photoPreview"
               src="{{ agent.photo_url if agent and agent.photo_url else '' }}"
               alt="preview"
               style="width:100%;height:100%;object-fit:cover;display:{{ 'block' if agent and agent.photo_url else 'none' }};">
          <span id="photoPreviewEmpty" style="font-size:12px;color:rgba(229,231,235,0.65);display:{{ 'none' if agent and agent.photo_url else 'block' }};">
            Nessuna foto
          </span>
        </div>
      </div>

      <label>Logo (retro avatar)</label>
      <input type="file" name="extra_logo" accept="image/*">

      <hr style="border:0;border-top:1px solid rgba(148,163,184,0.25);margin:12px 0;">

      <!-- PDF -->
      <label>Documenti PDF (max 12)</label>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;">
        {% for i in range(1,13) %}
          <input type="file" name="pdf{{ i }}" accept="application/pdf">
        {% endfor %}
      </div>

      <!-- ✅ ELIMINA PDF -->
      {% if agent and agent.pdf1_url %}
      <label style="display:flex;align-items:center;gap:10px;margin-top:10px;">
        <input type="checkbox" name="delete_pdfs" value="1">
        <span style="color:#fecaca;">Elimina tutti i documenti PDF già salvati</span>
      </label>
      {% endif %}

      <hr style="border:0;border-top:1px solid rgba(148,163,184,0.25);margin:12px 0;">

      <!-- ✅ GALLERIA FOTO -->
      <label>Galleria foto (max 30) — selezione multipla</label>
      <input type="file" name="gallery" multiple accept="image/*">

      <!-- ✅ VIDEO -->
      <label style="margin-top:10px;">Video (max 10) — selezione multipla</label>
      <input type="file" name="videos" multiple accept="video/*">

      <div class="agent-form-buttons">
        <button type="submit">{% if agent %}Salva modifiche{% else %}Crea agente{% endif %}</button>
        <a class="btn-secondary" href="{{ url_for('admin_home') }}">Torna alla lista</a>
      </div>
    </form>
  </div>
</div>

<!-- ===== CROPPER MODAL ===== -->
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css">
<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

<div id="cropModal" class="crop-modal" style="display:none;">
  <div class="crop-box">
    <div class="crop-title">Ritaglia la foto</div>

    <div class="crop-stage">
      <img id="cropImage" alt="crop">
    </div>

    <div class="crop-actions">
      <button type="button" class="crop-btn secondary" onclick="closeCrop()">Annulla</button>
      <button type="button" class="crop-btn primary" onclick="applyCrop()">Usa questa foto</button>
    </div>
  </div>
</div>

<script>
  let cropper = null;

  const input = document.getElementById('photoInput');
  const modal = document.getElementById('cropModal');
  const cropImg = document.getElementById('cropImage');

  const preview = document.getElementById('photoPreview');
  const previewEmpty = document.getElementById('photoPreviewEmpty');

  input.addEventListener('change', () => {
    const f = input.files && input.files[0];
    if (!f) return;

    const url = URL.createObjectURL(f);
    cropImg.src = url;
    modal.style.display = 'flex';

    cropImg.onload = () => {
      if (cropper) cropper.destroy();
      cropper = new Cropper(cropImg, {
        viewMode: 1,
        dragMode: 'move',
        aspectRatio: 1,
        autoCropArea: 1,
        background: false,
        responsive: true
      });
    };
  });

  function closeCrop(){
    if (cropper) { cropper.destroy(); cropper = null; }
    modal.style.display = 'none';
  }

  function applyCrop(){
    if (!cropper) return;

    const canvas = cropper.getCroppedCanvas({ width: 800, height: 800 });
    canvas.toBlob((blob) => {
      if (!blob) return;

      // sostituisco il file nell'input con quello croppato
      const file = new File([blob], 'photo.jpg', { type: 'image/jpeg' });
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;

      // preview
      preview.src = URL.createObjectURL(blob);
      preview.style.display = 'block';
      previewEmpty.style.display = 'none';

      closeCrop();
    }, 'image/jpeg', 0.90);
  }

  // chiudi cliccando fuori
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeCrop();
  });
</script>

<style>
  .crop-modal{
    position: fixed; inset: 0;
    background: rgba(2,6,23,0.82);
    display: flex; align-items: center; justify-content: center;
    z-index: 99999;
    padding: 14px;
  }
  .crop-box{
    width: min(680px, 96vw);
    background: #020617;
    border: 1px solid rgba(148,163,184,0.55);
    border-radius: 18px;
    padding: 12px 12px 14px;
    box-shadow: 0 22px 60px rgba(0,0,0,0.75);
  }
  .crop-title{
    font-size: 14px;
    color: rgba(229,231,235,0.9);
    margin: 2px 0 10px;
    font-weight: 600;
  }
  .crop-stage{
    width: 100%;
    height: min(60vh, 520px);
    background: rgba(15,23,42,0.55);
    border-radius: 14px;
    overflow: hidden;
  }
  .crop-stage img{
    width: 100%;
    height: 100%;
    display: block;
    object-fit: contain;
  }
  .crop-actions{
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 10px;
  }
  .crop-btn{
    border: none;
    padding: 8px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 700;
    font-size: 13px;
  }
  .crop-btn.primary{
    background: #facc15;
    color: #111;
  }
  .crop-btn.secondary{
    background: rgba(148,163,184,0.18);
    color: rgba(229,231,235,0.9);
    border: 1px solid rgba(148,163,184,0.35);
  }
</style>

{% endblock %}
