<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Modifica {{ "P2" if profile=="p2" else "P1" }} | Pay4You</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="app-shell">

    <header class="app-header">
      <a class="brand" href="/area">
        <img class="brand-logo" src="/static/logo.png" alt="" onerror="this.style.display='none'">
        <div class="brand-title">Pay4You Cards</div>
      </a>
      <div class="app-header-right">
        <a class="header-link" href="/area">Dashboard</a>
        <a class="header-link" href="/area/logout">Logout</a>
      </div>
    </header>

    <main class="app-main">
      <div class="page-main">
        <div class="panel panel-wide">

          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              <div class="flash-wrap">
                {% for cat,msg in messages %}
                  <div class="flash flash-{{cat}}">{{ msg }}</div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}

          <div class="form-head">
            <div>
              <h1 class="form-title">Modifica {{ "Profilo 2" if profile=="p2" else "Profilo 1" }}</h1>
              <div class="form-sub">
                Slug: <span class="mono">{{ agent.slug }}</span>
                {% if profile=="p2" and agent.p2_enabled != 1 %}
                  â€” <b style="color:#ffb2b2">P2 non attivo</b>
                {% endif %}
              </div>
            </div>

            <div class="form-actions">
              {% if is_admin %}
                <a class="btn" href="/area/edit/{{ agent.slug }}/p1">P1</a>
                {% if agent.p2_enabled == 1 %}
                  <a class="btn" href="/area/edit/{{ agent.slug }}/p2">P2</a>
                {% endif %}
              {% else %}
                <a class="btn" href="/area/me/p1">P1</a>
                {% if agent.p2_enabled == 1 %}
                  <a class="btn" href="/area/me/p2">P2</a>
                {% endif %}
              {% endif %}
              <a class="btn ghost" target="_blank" href="/{{ agent.slug }}{% if profile=='p2' %}?p=p2{% endif %}">Apri Card</a>
            </div>
          </div>

          <div class="sep"></div>

          <form class="card-form" method="post" enctype="multipart/form-data">

            <div class="section-box">
              <div class="h3">Dati principali</div>
              <div class="form-grid">
                <div class="field">
                  <label>Nome</label>
                  <input type="text" name="name" value="{{ (p.name if p else '') }}" required>
                </div>
                <div class="field">
                  <label>Azienda</label>
                  <input type="text" name="company" value="{{ (p.company if p else '') }}">
                </div>
                <div class="field">
                  <label>Ruolo</label>
                  <input type="text" name="role" value="{{ (p.role if p else '') }}">
                </div>
                <div class="field full">
                  <label>Bio</label>
                  <textarea name="bio">{{ (p.bio if p else '') }}</textarea>
                </div>
              </div>
            </div>

            <div class="section-box">
              <div class="h3">Contatti</div>
              <div class="form-grid">
                <div class="field">
                  <label>Cellulare</label>
                  <input type="text" name="phone_mobile" value="{{ (p.phone_mobile if p else '') }}">
                </div>
                <div class="field">
                  <label>Cellulare 2</label>
                  <input type="text" name="phone_mobile2" value="{{ (p.phone_mobile2 if p else '') }}">
                </div>
                <div class="field">
                  <label>Telefono ufficio</label>
                  <input type="text" name="phone_office" value="{{ (p.phone_office if p else '') }}">
                </div>
                <div class="field">
                  <label>WhatsApp (numero +39... oppure link)</label>
                  <input type="text" name="whatsapp" value="{{ (p.whatsapp if p else '') }}">
                </div>
                <div class="field full">
                  <label>Email (separate da virgola)</label>
                  <input type="text" name="emails" value="{{ (p.emails if p else '') }}">
                </div>
                <div class="field full">
                  <label>Siti web (separati da virgola)</label>
                  <input type="text" name="websites" value="{{ (p.websites if p else '') }}">
                </div>
                <div class="field">
                  <label>PEC</label>
                  <input type="text" name="pec" value="{{ (p.pec if p else '') }}">
                </div>
                <div class="field full">
                  <label>Indirizzi (uno per riga)</label>
                  <textarea name="addresses">{{ (p.addresses if p else '') }}</textarea>
                </div>
              </div>
            </div>

            <div class="section-box">
              <div class="h3">Dati fiscali</div>
              <div class="form-grid">
                <div class="field">
                  <label>P.IVA</label>
                  <input type="text" name="piva" value="{{ (p.piva if p else '') }}">
                </div>
                <div class="field">
                  <label>SDI</label>
                  <input type="text" name="sdi" value="{{ (p.sdi if p else '') }}">
                </div>
              </div>
            </div>

            <div class="section-box">
              <div class="h3">Social</div>

              <div class="hint-box">
                Importante: inserisci sempre URL completi.
              </div>

              <div class="form-grid">
                <div class="field full">
                  <label>Facebook</label>
                  <input type="text" name="facebook" value="{{ (p.facebook if p else '') }}">
                  <div class="hint">Esempio: https://www.facebook.com/share/.....</div>
                </div>
                <div class="field full">
                  <label>Instagram</label>
                  <input type="text" name="instagram" value="{{ (p.instagram if p else '') }}">
                  <div class="hint">Esempio: https://www.instagram.com/.....</div>
                </div>
                <div class="field full">
                  <label>LinkedIn</label>
                  <input type="text" name="linkedin" value="{{ (p.linkedin if p else '') }}">
                  <div class="hint">Esempio: https://www.linkedin.com/in/.....</div>
                </div>
                <div class="field full">
                  <label>TikTok</label>
                  <input type="text" name="tiktok" value="{{ (p.tiktok if p else '') }}">
                  <div class="hint">Esempio: https://www.tiktok.com/@.....</div>
                </div>
                <div class="field full">
                  <label>Telegram</label>
                  <input type="text" name="telegram" value="{{ (p.telegram if p else '') }}">
                  <div class="hint">Esempio: https://t.me/.....</div>
                </div>
                <div class="field full">
                  <label>YouTube</label>
                  <input type="text" name="youtube" value="{{ (p.youtube if p else '') }}">
                  <div class="hint">Esempio: https://www.youtube.com/@.....</div>
                </div>
                <div class="field full">
                  <label>Spotify</label>
                  <input type="text" name="spotify" value="{{ (p.spotify if p else '') }}">
                  <div class="hint">Esempio: https://open.spotify.com/.....</div>
                </div>
              </div>
            </div>

            <div class="section-box">
              <div class="h3">Foto profilo / Logo / Sfondo</div>

              <div class="form-grid">
                <div class="field">
                  <label>Foto profilo</label>
                  <input type="file" name="photo" accept="image/*" id="photoInput">
                  <div class="hint">Carica una foto, poi usa il crop sotto per centrare il volto.</div>
                </div>
                <div class="field">
                  <label>Logo</label>
                  <input type="file" name="logo" accept="image/*">
                </div>
                <div class="field">
                  <label>Sfondo (immagine)</label>
                  <input type="file" name="back_media" accept="image/*">
                </div>

                <div class="field">
                  <label>Retro: modalitÃ </label>
                  <select name="back_media_mode">
                    <option value="company" {% if p and p.back_media_mode=='company' %}selected{% endif %}>Company</option>
                    <option value="personal" {% if p and p.back_media_mode=='personal' %}selected{% endif %}>Personal</option>
                  </select>
                </div>

                <div class="field">
                  <label>Zoom foto (1.00 â€“ 2.00)</label>
                  <input type="text" name="photo_zoom" id="zoomField" value="{{ (p.photo_zoom if p else '1.0') }}">
                </div>
                <div class="field">
                  <label>Pos X (%)</label>
                  <input type="text" name="photo_pos_x" id="posXField" value="{{ (p.photo_pos_x if p else 50) }}">
                </div>
                <div class="field">
                  <label>Pos Y (%)</label>
                  <input type="text" name="photo_pos_y" id="posYField" value="{{ (p.photo_pos_y if p else 35) }}">
                </div>
              </div>

              <!-- CROP PREVIEW -->
              <div class="media-preview">
                <div class="media-title">Crop / Anteprima (trascina per centrare)</div>
                <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
                  <div id="cropCircle" style="
                    width:220px;height:220px;border-radius:999px;overflow:hidden;
                    border:3px solid rgba(243,198,43,.55);
                    background:rgba(0,0,0,.22);
                    position:relative;
                  ">
                    <img id="cropImg" src="{{ (p.photo_url if p and p.photo_url) else '' }}" alt="" style="
                      width:100%;height:100%;object-fit:cover;
                      object-position: {{ (p.photo_pos_x if p else 50) }}% {{ (p.photo_pos_y if p else 35) }}%;
                      transform: scale({{ (p.photo_zoom if p else '1.0') }});
                      cursor:grab;
                      user-select:none;
                      -webkit-user-drag:none;
                    ">
                  </div>

                  <div style="min-width:240px;flex:1;">
                    <div class="hint">
                      Usa il mouse/dito per trascinare lâ€™immagine nel cerchio. Lo zoom lo controlli qui sotto.
                    </div>
                    <div class="field" style="margin-top:10px;">
                      <label>Zoom (slider)</label>
                      <input type="range" id="zoomRange" min="1" max="2" step="0.01" value="{{ (p.photo_zoom if p else '1.0') }}">
                    </div>
                    <div class="hint">Posizione salvata in Pos X / Pos Y (percentuali).</div>
                  </div>
                </div>
              </div>

              <div class="media-preview">
                <div class="media-title">Effetti (ne puoi scegliere uno solo: Flip oppure Ruota)</div>
                <div class="checks">
                  <label class="btn-mini">
                    <input type="checkbox" name="orbit_spin" {% if p and p.orbit_spin==1 %}checked{% endif %}>
                    Orbit
                  </label>
                  <label class="btn-mini">
                    <input type="checkbox" name="logo_spin" {% if p and p.logo_spin==1 %}checked{% endif %}>
                    Logo ruota
                  </label>
                  <label class="btn-mini">
                    <input type="checkbox" id="spinCheck" name="avatar_spin" {% if p and p.avatar_spin==1 %}checked{% endif %}>
                    Foto ruota
                  </label>
                  <label class="btn-mini">
                    <input type="checkbox" id="flipCheck" name="allow_flip" {% if p and p.allow_flip==1 %}checked{% endif %}>
                    Flip (click)
                  </label>
                </div>
              </div>

            </div>

            <!-- GALLERY UPLOAD + PREVIEW -->
            <div class="section-box">
              <div class="h3">Galleria Foto</div>
              <div class="field">
                <label>Carica foto galleria (max {{ MAX_GALLERY_IMAGES if MAX_GALLERY_IMAGES else 30 }})</label>
                <input type="file" name="gallery" multiple accept="image/*">
                <div class="hint">Dopo lâ€™upload, sotto vedi lâ€™anteprima. Clic per aprire grande.</div>
              </div>

              <div class="media-preview">
                <div class="media-sub">Preview foto</div>
                <div class="media-grid">
                  {% for g in gallery %}
                    <div class="media-item">
                      <img src="{{ g }}" alt="" onclick="openMedia('img','{{ g }}','Foto', '{{ loop.index0 }}','gallery')">
                      <button class="media-del" type="button" onclick="deleteMedia('{{ loop.index0 }}','gallery')">ðŸ—‘</button>
                    </div>
                  {% endfor %}
                  {% if not gallery %}
                    <div class="dash-thumb-empty" style="width:160px;height:94px;border-radius:18px;">Nessuna foto</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- VIDEO UPLOAD + PREVIEW -->
            <div class="section-box">
              <div class="h3">Video</div>
              <div class="field">
                <label>Carica video (max {{ MAX_VIDEOS if MAX_VIDEOS else 10 }})</label>
                <input type="file" name="videos" multiple accept="video/*">
                <div class="hint">Clic per aprire grande.</div>
              </div>

              <div class="media-preview">
                <div class="media-sub">Preview video</div>
                <div class="media-grid">
                  {% for v in videos %}
                    <div class="media-item">
                      <video src="{{ v }}" muted playsinline preload="metadata" onclick="openMedia('video','{{ v }}','Video', '{{ loop.index0 }}','video')"></video>
                      <div class="media-play">PLAY</div>
                      <button class="media-del" type="button" onclick="deleteMedia('{{ loop.index0 }}','video')">ðŸ—‘</button>
                    </div>
                  {% endfor %}
                  {% if not videos %}
                    <div class="dash-thumb-empty" style="width:160px;height:94px;border-radius:18px;">Nessun video</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- PDF UPLOAD + PREVIEW -->
            <div class="section-box">
              <div class="h3">PDF / Documenti</div>
              <div class="hint-box">Carica fino a {{ MAX_PDFS if MAX_PDFS else 12 }} PDF. Puoi caricare uno o piÃ¹ slot.</div>

              <div class="pdf-grid">
                {% for i in range(1, 13) %}
                  <div class="field">
                    <label>PDF {{ i }}</label>
                    <input type="file" name="pdf{{ i }}" accept="application/pdf">
                  </div>
                {% endfor %}
              </div>

              <div class="media-preview">
                <div class="media-sub">Preview PDF</div>
                <div class="pdf-preview">
                  {% for ppdf in pdfs %}
                    <div class="pdf-row">
                      <div class="pdf-name" onclick="openMedia('pdf','{{ ppdf.url }}','{{ ppdf.name|e }}','{{ loop.index0 }}','pdf')" style="cursor:pointer;">
                        ðŸ“„ {{ ppdf.name }}
                      </div>
                      <button class="pdf-del" type="button" onclick="deleteMedia('{{ loop.index0 }}','pdf')">ðŸ—‘</button>
                    </div>
                  {% endfor %}
                  {% if not pdfs %}
                    <div class="dash-thumb-empty" style="width:100%;max-width:420px;height:auto;padding:14px;border-radius:14px;">Nessun PDF</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- TRANSLATIONS -->
            <div class="section-box">
              <div class="h3">Traduzioni (auto-lingua da telefono)</div>
              <div class="hint-box">
                Se un cliente apre la card da telefono in lingua EN/FR/ES/DE, la card mostra automaticamente i testi tradotti.
                Se un campo Ã¨ vuoto, resta in italiano.
              </div>

              <details open>
                <summary>Traduzioni Profilo 1</summary>
                <div class="grid-2" style="margin-top:12px;">
                  {% for L in ['en','fr','es','de'] %}
                    <div class="section-box">
                      <div class="h3" style="font-size:14px;margin-bottom:10px;">{{ L|upper }} (P1)</div>
                      <div class="field">
                        <label>Nome</label>
                        <input type="text" name="p1_name_{{L}}" value="{{ ((i18n_data.get(L,{}).get('p1',{}).get('name','')) if i18n_data else '') }}">
                      </div>
                      <div class="field">
                        <label>Azienda</label>
                        <input type="text" name="p1_company_{{L}}" value="{{ ((i18n_data.get(L,{}).get('p1',{}).get('company','')) if i18n_data else '') }}">
                      </div>
                      <div class="field">
                        <label>Ruolo</label>
                        <input type="text" name="p1_role_{{L}}" value="{{ ((i18n_data.get(L,{}).get('p1',{}).get('role','')) if i18n_data else '') }}">
                      </div>
                      <div class="field">
                        <label>Bio</label>
                        <textarea name="p1_bio_{{L}}">{{ ((i18n_data.get(L,{}).get('p1',{}).get('bio','')) if i18n_data else '') }}</textarea>
                      </div>
                      <div class="field">
                        <label>Indirizzi</label>
                        <textarea name="p1_addresses_{{L}}">{{ ((i18n_data.get(L,{}).get('p1',{}).get('addresses','')) if i18n_data else '') }}</textarea>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </details>

              <details>
                <summary>Traduzioni Profilo 2</summary>
                <div class="grid-2" style="margin-top:12px;">
                  {% for L in ['en','fr','es','de'] %}
                    <div class="section-box">
                      <div class="h3" style="font-size:14px;margin-bottom:10px;">{{ L|upper }} (P2)</div>
                      <div class="field">
                        <label>Nome</label>
                        <input type="text" name="p2_name_{{L}}" value="{{ ((i18n_data.get(L,{}).get('p2',{}).get('name','')) if i18n_data else '') }}">
                      </div>
                      <div class="field">
                        <label>Azienda</label>
                        <input type="text" name="p2_company_{{L}}" value="{{ ((i18n_data.get(L,{}).get('p2',{}).get('company','')) if i18n_data else '') }}">
                      </div>
                      <div class="field">
                        <label>Ruolo</label>
                        <input type="text" name="p2_role_{{L}}" value="{{ ((i18n_data.get(L,{}).get('p2',{}).get('role','')) if i18n_data else '') }}">
                      </div>
                      <div class="field">
                        <label>Bio</label>
                        <textarea name="p2_bio_{{L}}">{{ ((i18n_data.get(L,{}).get('p2',{}).get('bio','')) if i18n_data else '') }}</textarea>
                      </div>
                      <div class="field">
                        <label>Indirizzi</label>
                        <textarea name="p2_addresses_{{L}}">{{ ((i18n_data.get(L,{}).get('p2',{}).get('addresses','')) if i18n_data else '') }}</textarea>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </details>
            </div>

            <div class="sticky-save">
              <button class="btn primary" type="submit">Salva</button>
              <a class="btn ghost" href="/area">Torna alla dashboard</a>
            </div>

          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- MEDIA MODAL -->
  <div id="modal" class="modal-overlay" style="display:none;">
    <div class="modal-box modal-big">
      <button class="modal-x" type="button" onclick="closeModal()">âœ•</button>

      <img id="mImg" src="" alt="" style="display:none;">
      <video id="mVideo" controls playsinline style="display:none;"></video>
      <iframe id="mPdf" src="" style="display:none;"></iframe>

      <div class="modal-actions">
        <button class="btn" type="button" onclick="shareMediaWhatsApp()">Invia via WhatsApp</button>
        <button class="btn" type="button" onclick="shareMediaEmail()">Invia via Email</button>
        <button class="btn danger" type="button" onclick="deleteFromModal()">Elimina</button>
        <button class="btn ghost" type="button" onclick="closeModal()">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- hidden delete form -->
  <form id="delForm" method="post" action="/area/media/delete/{{ agent.slug }}" style="display:none;">
    <input type="hidden" name="type" id="delType" value="">
    <input type="hidden" name="idx" id="delIdx" value="">
    <input type="hidden" name="profile" id="delProfile" value="{{ profile }}">
    <input type="hidden" name="target" value="edit">
  </form>

<script>
  // ====== EFFETTI: spin vs flip mutuamente esclusivi
  const spinCheck = document.getElementById("spinCheck");
  const flipCheck = document.getElementById("flipCheck");
  function enforceExclusive(){
    if(spinCheck?.checked) flipCheck.checked = false;
    if(flipCheck?.checked) spinCheck.checked = false;
  }
  spinCheck?.addEventListener("change", enforceExclusive);
  flipCheck?.addEventListener("change", enforceExclusive);

  // ====== CROP: drag + zoom -> updates posX/posY/zoom fields and preview
  const cropImg = document.getElementById("cropImg");
  const cropCircle = document.getElementById("cropCircle");
  const posXField = document.getElementById("posXField");
  const posYField = document.getElementById("posYField");
  const zoomField = document.getElementById("zoomField");
  const zoomRange = document.getElementById("zoomRange");
  const photoInput = document.getElementById("photoInput");

  function applyCrop(){
    const x = parseFloat(posXField.value || "50");
    const y = parseFloat(posYField.value || "35");
    const z = parseFloat(zoomField.value || "1.0");
    if(cropImg){
      cropImg.style.objectPosition = `${x}% ${y}%`;
      cropImg.style.transform = `scale(${z})`;
    }
    if(zoomRange) zoomRange.value = String(z);
  }

  zoomRange?.addEventListener("input", ()=>{
    zoomField.value = String(zoomRange.value);
    applyCrop();
  });

  let dragging = false;
  let lastX = 0;
  let lastY = 0;

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  cropImg?.addEventListener("pointerdown", (e)=>{
    dragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
    cropImg.setPointerCapture(e.pointerId);
    cropImg.style.cursor = "grabbing";
  });

  cropImg?.addEventListener("pointermove", (e)=>{
    if(!dragging) return;
    const rect = cropCircle.getBoundingClientRect();
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX; lastY = e.clientY;

    // convert px move into percentage approx (tuned)
    let x = parseFloat(posXField.value || "50") + (dx / rect.width) * 100;
    let y = parseFloat(posYField.value || "35") + (dy / rect.height) * 100;
    x = clamp(x, 0, 100);
    y = clamp(y, 0, 100);
    posXField.value = String(Math.round(x));
    posYField.value = String(Math.round(y));
    applyCrop();
  });

  cropImg?.addEventListener("pointerup", (e)=>{
    dragging = false;
    cropImg.style.cursor = "grab";
  });

  // show selected image immediately in crop preview
  photoInput?.addEventListener("change", ()=>{
    const f = photoInput.files && photoInput.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    cropImg.src = url;
  });

  applyCrop();

  // ====== MEDIA modal open/close/share/delete
  window.__MEDIA = {type:"", url:"", title:"", idx:-1, deltype:""};

  function openModal(type){
    const m = document.getElementById("modal");
    m.style.display = "flex";
    document.getElementById("mImg").style.display = (type==="img") ? "block" : "none";
    document.getElementById("mVideo").style.display = (type==="video") ? "block" : "none";
    document.getElementById("mPdf").style.display = (type==="pdf") ? "block" : "none";
  }

  function closeModal(){
    const m = document.getElementById("modal");
    m.style.display = "none";

    const img = document.getElementById("mImg");
    const vid = document.getElementById("mVideo");
    const pdf = document.getElementById("mPdf");

    img.src = "";
    try{ vid.pause(); }catch(e){}
    vid.removeAttribute("src");
    try{ vid.load(); }catch(e){}
    pdf.src = "";

    window.__MEDIA = {type:"", url:"", title:"", idx:-1, deltype:""};
  }

  function openMedia(kind, url, title, idx, deltype){
    window.__MEDIA = {type:kind, url:url, title:title, idx:parseInt(idx,10), deltype:deltype};

    if(kind==="img"){
      document.getElementById("mImg").src = url;
      openModal("img");
    }else if(kind==="video"){
      const v = document.getElementById("mVideo");
      v.src = url;
      openModal("video");
      v.play().catch(()=>{});
    }else{
      document.getElementById("mPdf").src = url;
      openModal("pdf");
    }
  }

  function shareMediaWhatsApp(){
    const u = window.__MEDIA.url;
    if(!u) return;
    const text = (window.__MEDIA.title ? (window.__MEDIA.title + "\n") : "") + u;
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  }

  function shareMediaEmail(){
    const u = window.__MEDIA.url;
    if(!u) return;
    const subject = window.__MEDIA.title || "Pay4You";
    const body = "Ciao!\n\nTi invio questo contenuto:\n" + u + "\n";
    window.location.href = "mailto:?subject=" + encodeURIComponent(subject) + "&body=" + encodeURIComponent(body);
  }

  function deleteMedia(idx, deltype){
    if(!confirm("Eliminare questo elemento?")) return;
    if(!confirm("Confermi eliminazione definitiva?")) return;
    document.getElementById("delType").value = deltype;
    document.getElementById("delIdx").value = idx;
    document.getElementById("delForm").submit();
  }

  function deleteFromModal(){
    const idx = window.__MEDIA.idx;
    const deltype = window.__MEDIA.deltype;
    if(idx < 0 || !deltype) return;
    deleteMedia(idx, deltype);
  }

  // close modal clicking overlay
  document.getElementById("modal")?.addEventListener("click", function(e){
    if(e.target === this) closeModal();
  });

  // iOS: show first frame in preview
  (function(){
    const vids = document.querySelectorAll('video[preload="metadata"]');
    vids.forEach(v=>{
      v.addEventListener('loadedmetadata', ()=>{
        try{ v.currentTime = 0.05; v.pause(); }catch(e){}
      });
    });
  })();
</script>

</body>
</html>
