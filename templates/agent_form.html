<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    {% if editing_profile == "p2" %}Modifica Profilo 2{% elif editing_profile == "p3" %}Modifica Profilo 3{% else %}Modifica Profilo 1{% endif %}
    | Pay4You
  </title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">

  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">
          {% if editing_profile == "p2" %}Profilo 2{% elif editing_profile == "p3" %}Profilo 3{% else %}Profilo 1{% endif %}
        </div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">← Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">
              {% if editing_profile == "p2" %}Modifica Profilo 2{% elif editing_profile == "p3" %}Modifica Profilo 3{% else %}Modifica Profilo 1{% endif %}
            </h1>

            <div class="hint">
              {% if editing_profile == "p1" %}
                Qui modifichi i dati principali della tua Pay4You Card.
              {% else %}
                Questo profilo è indipendente (parte vuoto quando lo attivi).
              {% endif %}
            </div>
          </div>

          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}">Apri P1</a>
              {% if agent.p2_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p2">Apri P2</a>
              {% endif %}
              {% if agent.p3_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p3">Apri P3</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        <form method="post" enctype="multipart/form-data" class="card-form">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field full">
                <label>Slug (non modificabile)</label>
                <input type="text" value="{{ agent.slug }}" readonly>
                <div class="hint">È il link pubblico della card.</div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ===================== DATI PRINCIPALI ===================== -->
          <div class="section-box">
            <div class="h3">Dati principali</div>
            <div class="form-grid">
              <div class="field">
                <label>Nome</label>
                <input type="text" name="name" value="{% if editing_profile=='p1' %}{{ agent.name if agent else '' }}{% else %}{{ profile_data.get('name','') }}{% endif %}">
              </div>
              <div class="field">
                <label>Azienda</label>
                <input type="text" name="company" value="{% if editing_profile=='p1' %}{{ agent.company if agent else '' }}{% else %}{{ profile_data.get('company','') }}{% endif %}">
              </div>
              <div class="field">
                <label>Ruolo</label>
                <input type="text" name="role" value="{% if editing_profile=='p1' %}{{ agent.role if agent else '' }}{% else %}{{ profile_data.get('role','') }}{% endif %}">
              </div>
              <div class="field full">
                <label>Bio</label>
                <textarea name="bio" placeholder="Breve descrizione...">{% if editing_profile=='p1' %}{{ agent.bio if agent else '' }}{% else %}{{ profile_data.get('bio','') }}{% endif %}</textarea>
              </div>
            </div>
          </div>

          <!-- ===================== CROP solo P1 ===================== -->
          {% if editing_profile == "p1" %}
          <div class="section-box">
            <div class="h3">Crop / posizione foto agente</div>
            <div class="hint">Carica una foto e regolala subito qui sotto (anche prima di salvare).</div>

            <div class="form-grid" style="margin-top:10px">
              <div class="field full">
                <label>Foto profilo (JPG/PNG)</label>
                <input id="photoInput" type="file" name="photo" accept="image/*">
                <div class="hint">Max {{ 3 }} MB</div>
              </div>
            </div>

            <div class="crop-preview">
              <div class="crop-circle" id="cropCircle">
                {% if agent and agent.photo_url %}
                  <img id="cropImg" src="{{ agent.photo_url }}" alt=""
                       style="object-position: {{ agent.photo_pos_x }}% {{ agent.photo_pos_y }}%;
                              transform: scale({{ agent.photo_zoom }});">
                {% else %}
                  <div class="crop-empty" id="cropEmpty">Carica una foto profilo</div>
                  <img id="cropImg" src="" alt="" style="display:none">
                {% endif %}
              </div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>X (0–100)</label>
                <input id="posX" type="range" min="0" max="100" name="photo_pos_x" value="{{ agent.photo_pos_x if agent else 50 }}">
              </div>
              <div class="field">
                <label>Y (0–100)</label>
                <input id="posY" type="range" min="0" max="100" name="photo_pos_y" value="{{ agent.photo_pos_y if agent else 35 }}">
              </div>
              <div class="field full">
                <label>Zoom (1.0 – 2.5)</label>
                <input id="zoom" type="range" min="1" max="2.5" step="0.05" name="photo_zoom" value="{{ (agent.photo_zoom if agent else '1.0') or '1.0' }}">
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Logo / sfondo</div>
            <div class="form-grid">
              <div class="field">
                <label>Logo (PNG consigliato)</label>
                <input type="file" name="logo" accept="image/*">
                <div class="hint">Max 3 MB</div>
              </div>

              <div class="field">
                <label>Modalità sfondo</label>
                <select name="back_media_mode">
                  <option value="company" {% if agent and agent.back_media_mode=='company' %}selected{% endif %}>Company</option>
                  <option value="personal" {% if agent and agent.back_media_mode=='personal' %}selected{% endif %}>Personal</option>
                </select>
              </div>

              <div class="field full">
                <label>Immagine sfondo (opzionale)</label>
                <input type="file" name="back_media" accept="image/*">
                <div class="hint">Max 3 MB</div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ===================== CONTATTI ===================== -->
          <div class="section-box">
            <div class="h3">Contatti</div>
            <div class="form-grid">
              <div class="field">
                <label>Cellulare</label>
                <input type="text" name="phone_mobile" value="{% if editing_profile=='p1' %}{{ agent.phone_mobile if agent else '' }}{% else %}{{ profile_data.get('phone_mobile','') }}{% endif %}">
              </div>
              <div class="field">
                <label>Cellulare 2</label>
                <input type="text" name="phone_mobile2" value="{% if editing_profile=='p1' %}{{ agent.phone_mobile2 if agent else '' }}{% else %}{{ profile_data.get('phone_mobile2','') }}{% endif %}">
              </div>
              <div class="field">
                <label>Ufficio</label>
                <input type="text" name="phone_office" value="{% if editing_profile=='p1' %}{{ agent.phone_office if agent else '' }}{% else %}{{ profile_data.get('phone_office','') }}{% endif %}">
              </div>
              <div class="field">
                <label>WhatsApp (link o numero +39...)</label>
                <input type="text" name="whatsapp" value="{% if editing_profile=='p1' %}{{ agent.whatsapp if agent else '' }}{% else %}{{ profile_data.get('whatsapp','') }}{% endif %}">
              </div>

              <div class="field full">
                <label>Email (separate da virgola)</label>
                <input type="text" name="emails" placeholder="es: info@..., commerciale@..." value="{% if editing_profile=='p1' %}{{ agent.emails if agent else '' }}{% else %}{{ profile_data.get('emails','') }}{% endif %}">
              </div>

              <div class="field full">
                <label>Siti web (separati da virgola)</label>
                <input type="text" name="websites" placeholder="es: https://pay4you.store, https://..." value="{% if editing_profile=='p1' %}{{ agent.websites if agent else '' }}{% else %}{{ profile_data.get('websites','') }}{% endif %}">
              </div>

              <div class="field">
                <label>PEC</label>
                <input type="text" name="pec" value="{% if editing_profile=='p1' %}{{ agent.pec if agent else '' }}{% else %}{{ profile_data.get('pec','') }}{% endif %}">
              </div>

              <div class="field full">
                <label>Indirizzi (uno per riga)</label>
                <textarea name="addresses" placeholder="Via ...&#10;Via ...">{% if editing_profile=='p1' %}{{ agent.addresses if agent else '' }}{% else %}{{ profile_data.get('addresses','') }}{% endif %}</textarea>
              </div>
            </div>
          </div>

          <!-- ===================== DATI AZIENDALI ===================== -->
          <div class="section-box">
            <div class="h3">Dati aziendali</div>
            <div class="form-grid">
              <div class="field">
                <label>P.IVA</label>
                <input type="text" name="piva" value="{% if editing_profile=='p1' %}{{ agent.piva if agent else '' }}{% else %}{{ profile_data.get('piva','') }}{% endif %}">
              </div>
              <div class="field">
                <label>SDI</label>
                <input type="text" name="sdi" value="{% if editing_profile=='p1' %}{{ agent.sdi if agent else '' }}{% else %}{{ profile_data.get('sdi','') }}{% endif %}">
              </div>
            </div>
          </div>

          <!-- ===================== SOCIAL ===================== -->
          <div class="section-box">
            <div class="h3">Social</div>
            <div class="form-grid">
              <div class="field full">
                <label>Facebook</label>
                <input type="text" name="facebook" placeholder="https://www.facebook.com/..." value="{% if editing_profile=='p1' %}{{ agent.facebook if agent else '' }}{% else %}{{ profile_data.get('facebook','') }}{% endif %}">
                <div class="hint">Esempio: https://www.facebook.com/tuapagina</div>
              </div>

              <div class="field full">
                <label>Instagram</label>
                <input type="text" name="instagram" placeholder="https://www.instagram.com/..." value="{% if editing_profile=='p1' %}{{ agent.instagram if agent else '' }}{% else %}{{ profile_data.get('instagram','') }}{% endif %}">
                <div class="hint">Esempio: https://www.instagram.com/tuoprofilo</div>
              </div>

              <div class="field full">
                <label>LinkedIn</label>
                <input type="text" name="linkedin" placeholder="https://www.linkedin.com/in/..." value="{% if editing_profile=='p1' %}{{ agent.linkedin if agent else '' }}{% else %}{{ profile_data.get('linkedin','') }}{% endif %}">
                <div class="hint">Esempio: https://www.linkedin.com/in/tuonome</div>
              </div>

              <div class="field full">
                <label>TikTok</label>
                <input type="text" name="tiktok" placeholder="https://www.tiktok.com/@..." value="{% if editing_profile=='p1' %}{{ agent.tiktok if agent else '' }}{% else %}{{ profile_data.get('tiktok','') }}{% endif %}">
                <div class="hint">Esempio: https://www.tiktok.com/@tuoprofilo</div>
              </div>

              <div class="field full">
                <label>Telegram</label>
                <input type="text" name="telegram" placeholder="https://t.me/..." value="{% if editing_profile=='p1' %}{{ agent.telegram if agent else '' }}{% else %}{{ profile_data.get('telegram','') }}{% endif %}">
                <div class="hint">Esempio: https://t.me/tuocanale</div>
              </div>

              <div class="field full">
                <label>YouTube</label>
                <input type="text" name="youtube" placeholder="https://www.youtube.com/@..." value="{% if editing_profile=='p1' %}{{ agent.youtube if agent else '' }}{% else %}{{ profile_data.get('youtube','') }}{% endif %}">
                <div class="hint">Esempio: https://www.youtube.com/@tuocanale</div>
              </div>

              <div class="field full">
                <label>Spotify</label>
                <input type="text" name="spotify" placeholder="https://open.spotify.com/..." value="{% if editing_profile=='p1' %}{{ agent.spotify if agent else '' }}{% else %}{{ profile_data.get('spotify','') }}{% endif %}">
                <div class="hint">Esempio: https://open.spotify.com/artist/... oppure playlist</div>
              </div>
            </div>
          </div>

          <!-- ===================== MEDIA SOLO P1 ===================== -->
          {% if editing_profile == "p1" %}
          <div class="section-box">
            <div class="h3">Media</div>

            <div class="hint" style="margin-top:6px">
              Limiti: <b>{{ 15 }}</b> foto (max <b>{{ 3 }}</b>MB),
              <b>{{ 8 }}</b> video (max <b>{{ 25 }}</b>MB),
              <b>{{ 10 }}</b> PDF (max <b>{{ 10 }}</b>MB).
            </div>

            <div class="media-preview">
              <div class="media-title">Galleria (foto)</div>

              {% if gallery and gallery|length > 0 %}
                <div class="media-grid">
                  {% for g in gallery %}
                    <div class="media-item">
                      <img src="{{ g }}" alt="" onclick="openViewer('gallery','{{ g }}','{{ agent.slug }}',{{ loop.index0 }})">
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="hint">Nessuna foto caricata.</div>
              {% endif %}

              <div class="media-block">
                <div class="media-sub">Carica foto</div>
                <input type="file" name="gallery" accept="image/*" multiple>
                <div class="hint">Max 15 file – 3MB ciascuno</div>
              </div>

              <div class="sep"></div>

              <div class="media-title">Video</div>
              {% if videos and videos|length > 0 %}
                <div class="media-grid">
                  {% for v in videos %}
                    <div class="media-item">
                      <video muted playsinline preload="metadata" src="{{ v }}#t=0.1" onclick="openViewer('video','{{ v }}','{{ agent.slug }}',{{ loop.index0 }})"></video>
                      <div class="media-play">▶</div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="hint">Nessun video caricato.</div>
              {% endif %}

              <div class="media-block">
                <div class="media-sub">Carica video</div>
                <input type="file" name="videos" accept="video/*" multiple>
                <div class="hint">Max 8 file – 25MB ciascuno</div>
              </div>

              <div class="sep"></div>

              <div class="media-title">PDF</div>
              {% if pdfs and pdfs|length > 0 %}
                <div class="pdf-preview">
                  {% for p in pdfs %}
                    <div class="pdf-row">
                      <div class="pdf-name" onclick="openViewer('pdf','{{ p.url }}','{{ agent.slug }}',{{ loop.index0 }})" title="{{ p.name }}">{{ p.name }}</div>
                      <button class="btn-mini ghost" type="button" onclick="openViewer('pdf','{{ p.url }}','{{ agent.slug }}',{{ loop.index0 }})">Apri</button>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="hint">Nessun PDF caricato.</div>
              {% endif %}

              <div class="media-block">
                <div class="media-sub">Carica PDF (slot 1–10)</div>
                <div class="form-grid">
                  {% for i in range(1, 11) %}
                    <div class="field">
                      <label>PDF {{ i }}</label>
                      <input type="file" name="pdf{{ i }}" accept="application/pdf">
                    </div>
                  {% endfor %}
                </div>
                <div class="hint">Max 10 file – 10MB ciascuno</div>
              </div>

            </div>
          </div>

          <!-- ===================== TRADUZIONI in fondo e CHIUSE ===================== -->
          <div class="section-box">
            <details class="details-box">
              <summary class="details-summary">
                <span class="h3" style="margin:0">Traduzioni (EN/FR/ES/DE)</span>
                <span class="hint">Apri/chiudi</span>
              </summary>

              <div class="hint" style="margin-top:8px">
                Queste traduzioni verranno usate quando il cliente cambia lingua sulla card.
              </div>

              <div class="sep"></div>

              <div class="form-grid compact">
                {% for L in ["en","fr","es","de"] %}
                  <div class="field full">
                    <label style="opacity:.9">{{ L|upper }}</label>
                  </div>

                  <div class="field">
                    <label>Nome ({{ L|upper }})</label>
                    <input type="text" name="name_{{L}}" value="{{ (i18n_data.get(L,{}).get('name','')) }}">
                  </div>
                  <div class="field">
                    <label>Azienda ({{ L|upper }})</label>
                    <input type="text" name="company_{{L}}" value="{{ (i18n_data.get(L,{}).get('company','')) }}">
                  </div>
                  <div class="field">
                    <label>Ruolo ({{ L|upper }})</label>
                    <input type="text" name="role_{{L}}" value="{{ (i18n_data.get(L,{}).get('role','')) }}">
                  </div>
                  <div class="field full">
                    <label>Bio ({{ L|upper }})</label>
                    <textarea name="bio_{{L}}">{{ (i18n_data.get(L,{}).get('bio','')) }}</textarea>
                  </div>
                  <div class="field full">
                    <label>Indirizzi ({{ L|upper }})</label>
                    <textarea name="addresses_{{L}}">{{ (i18n_data.get(L,{}).get('addresses','')) }}</textarea>
                  </div>

                  <div class="sep"></div>
                {% endfor %}
              </div>
            </details>
          </div>
          {% endif %}

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>
      </div>
    </div>

  </main>

</div>

<!-- VIEWER MODAL -->
<div id="viewer" class="modal-overlay" style="display:none" onclick="overlayCloseViewer(event)">
  <div class="modal-box modal-big" onclick="event.stopPropagation()">
    <div class="viewer-topbar">
      <button class="btn danger" type="button" onclick="deleteCurrentMedia()">ELIMINA</button>
    </div>

    <div class="modal-title">Anteprima</div>

    <img id="vImg" style="display:none" src="" alt="">
    <video id="vVideo" style="display:none" controls playsinline></video>
    <iframe id="vPdf" style="display:none" src=""></iframe>

    <div class="modal-actions">
      <button class="btn" type="button" onclick="shareViewer('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareViewer('email')">Invia Email</button>
      <button class="btn ghost" type="button" onclick="closeViewer()">Chiudi</button>
    </div>
  </div>
</div>

<script>
  function absUrl(u){
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      return false;
    }
  }

  // ===== CROP FIX (X ora funziona davvero) =====
  document.addEventListener('DOMContentLoaded', () => {
    const cropImg = document.getElementById('cropImg');
    const cropEmpty = document.getElementById('cropEmpty');
    const photoInput = document.getElementById('photoInput');

    const posX = document.getElementById('posX');
    const posY = document.getElementById('posY');
    const zoom = document.getElementById('zoom');

    function forceObjectPosition(){
      if(!cropImg) return;
      if(cropImg.style.display === 'none') return;

      const x = posX ? posX.value : 50;
      const y = posY ? posY.value : 35;
      const z = zoom ? zoom.value : 1.0;

      cropImg.style.setProperty('object-position', `${x}% ${y}%`, 'important');
      cropImg.style.setProperty('transform', `scale(${z})`, 'important');
      cropImg.style.setProperty('object-fit', 'cover', 'important');
      cropImg.style.setProperty('width', '100%', 'important');
      cropImg.style.setProperty('height', '100%', 'important');
      cropImg.style.setProperty('display', 'block', 'important');
    }

    if(posX){ posX.addEventListener('input', forceObjectPosition); posX.addEventListener('change', forceObjectPosition); }
    if(posY){ posY.addEventListener('input', forceObjectPosition); posY.addEventListener('change', forceObjectPosition); }
    if(zoom){ zoom.addEventListener('input', forceObjectPosition); zoom.addEventListener('change', forceObjectPosition); }

    if(photoInput){
      photoInput.addEventListener('change', () => {
        const f = photoInput.files && photoInput.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        cropImg.src = url;
        cropImg.style.display = 'block';
        if(cropEmpty) cropEmpty.style.display = 'none';
        setTimeout(forceObjectPosition, 0);
      });
    }

    setTimeout(forceObjectPosition, 0);
  });

  // ===== VIEWER =====
  let viewerState = { slug:'', type:'', idx:-1, url:'' };

  function openViewer(type, url, slug, idx){
    viewerState = { slug, type, idx, url };

    const modal = document.getElementById('viewer');
    const vImg = document.getElementById('vImg');
    const vVideo = document.getElementById('vVideo');
    const vPdf = document.getElementById('vPdf');

    vImg.style.display = 'none';
    vVideo.style.display = 'none';
    vPdf.style.display = 'none';
    try{ vVideo.pause(); }catch(e){}

    if(type === 'gallery'){
      vImg.src = url;
      vImg.style.display = 'block';
    } else if(type === 'video'){
      vVideo.src = url;
      vVideo.style.display = 'block';
    } else {
      vPdf.src = url;
      vPdf.style.display = 'block';
    }
    modal.style.display = 'flex';
  }

  function closeViewer(){
    const modal = document.getElementById('viewer');
    const vVideo = document.getElementById('vVideo');
    try{ vVideo.pause(); }catch(e){}
    modal.style.display = 'none';
  }
  function overlayCloseViewer(e){
    if(e.target && e.target.id === 'viewer'){
      closeViewer();
    }
  }

  async function shareViewer(channel){
    const kind = (viewerState.type || '').toUpperCase();
    const slug = viewerState.slug || '';
    const mediaUrl = absUrl(viewerState.url || '');

    // ✅ per WhatsApp: SOLO link file (così apre solo quello)
    const msg = `Pay4You Media ${kind}\r\n${mediaUrl}`;

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    // ✅ Email: copio sicuro (il body mailto spesso non funziona)
    const ok = await copyToClipboard(msg);
    alert(ok
      ? "Testo copiato negli appunti ✅\nApri la mail e incolla (CTRL+V)."
      : "Non riesco a copiare automaticamente.\nCopia manualmente questo testo:\n\n" + msg
    );
  }

  function deleteCurrentMedia(){
    const t = viewerState.type;
    const slug = viewerState.slug;
    const idx = viewerState.idx;

    if(idx < 0) return;

    const ok1 = confirm("ELIMINARE questo file?\nNon sarà più ripristinabile.");
    if(!ok1) return;
    const ok2 = confirm("Conferma definitiva: eliminare ora?");
    if(!ok2) return;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/area/media/delete/${slug}`;

    const iType = document.createElement('input');
    iType.type = 'hidden';
    iType.name = 'type';
    iType.value = (t === 'gallery') ? 'gallery' : (t === 'video' ? 'video' : 'pdf');

    const iIdx = document.createElement('input');
    iIdx.type = 'hidden';
    iIdx.name = 'idx';
    iIdx.value = String(idx);

    form.appendChild(iType);
    form.appendChild(iIdx);
    document.body.appendChild(form);
    form.submit();
  }
</script>

</body>
</html>
