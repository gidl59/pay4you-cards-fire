<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ "Modifica Profilo 2" if editing_profile2 else "Modifica Profilo 1" }} | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">{{ "Profilo 2" if editing_profile2 else "Profilo 1" }}</div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">‚Üê Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">{{ "Modifica Profilo 2" if editing_profile2 else "Modifica Profilo 1" }}</h1>
            <div class="hint">
              {% if editing_profile2 %}
                Questo √® il Profilo 2 (se attivo). Se √® vuoto, resta vuoto: non copia il Profilo 1.
              {% else %}
                Qui modifichi i dati principali della tua Pay4You Card.
              {% endif %}
            </div>
          </div>
          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}">Apri P1</a>
              {% if agent.p2_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p2">Apri P2</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        <form method="post" enctype="multipart/form-data" class="card-form">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field">
                <label>Slug (non modificabile)</label>
                <input type="text" value="{{ agent.slug }}" readonly>
                <div class="hint">√à il link pubblico della card.</div>
              </div>
              <div class="field">
                <label>Username</label>
                <input type="text" value="{{ agent.username }}" readonly>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="section-box">
            <div class="h3">Dati principali</div>
            <div class="form-grid">
              <div class="field">
                <label>Nome</label>
                <input type="text" name="name" value="{{ agent.name if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>Azienda</label>
                <input type="text" name="company" value="{{ agent.company if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>Ruolo</label>
                <input type="text" name="role" value="{{ agent.role if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>Bio</label>
                <textarea name="bio" placeholder="Breve descrizione...">{{ agent.bio if (agent and not editing_profile2) else '' }}</textarea>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Contatti</div>
            <div class="form-grid">
              <div class="field">
                <label>Cellulare</label>
                <input type="text" name="phone_mobile" value="{{ agent.phone_mobile if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>Cellulare 2</label>
                <input type="text" name="phone_mobile2" value="{{ agent.phone_mobile2 if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>Ufficio</label>
                <input type="text" name="phone_office" value="{{ agent.phone_office if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>WhatsApp</label>
                <input type="text" name="whatsapp" value="{{ agent.whatsapp if (agent and not editing_profile2) else '' }}">
                <div class="hint">Formato consigliato: +39XXXXXXXXXX oppure link https://wa.me/...</div>
              </div>
              <div class="field full">
                <label>Email (separate da virgola)</label>
                <input type="text" name="emails" value="{{ agent.emails if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field full">
                <label>Siti web (separati da virgola)</label>
                <input type="text" name="websites" value="{{ agent.websites if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>PEC</label>
                <input type="text" name="pec" value="{{ agent.pec if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field full">
                <label>Indirizzi (uno per riga)</label>
                <textarea name="addresses">{{ agent.addresses if (agent and not editing_profile2) else '' }}</textarea>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Dati fiscali</div>
            <div class="form-grid">
              <div class="field">
                <label>P.IVA</label>
                <input type="text" name="piva" value="{{ agent.piva if (agent and not editing_profile2) else '' }}">
              </div>
              <div class="field">
                <label>SDI</label>
                <input type="text" name="sdi" value="{{ agent.sdi if (agent and not editing_profile2) else '' }}">
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Social</div>

            <div class="hint-box">
              ‚úÖ Inserisci sempre il link completo (https://...). Se un campo √® vuoto NON verr√† mostrato nella card.
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>Facebook</label>
                <input type="text" name="facebook" value="{{ agent.facebook if (agent and not editing_profile2) else '' }}">
                <div class="hint">Usa: https://www.facebook.com/share/... (oppure https://www.facebook.com/tuapagina)</div>
              </div>
              <div class="field">
                <label>Instagram</label>
                <input type="text" name="instagram" value="{{ agent.instagram if (agent and not editing_profile2) else '' }}">
                <div class="hint">Usa: https://www.instagram.com/tuonome</div>
              </div>
              <div class="field">
                <label>LinkedIn</label>
                <input type="text" name="linkedin" value="{{ agent.linkedin if (agent and not editing_profile2) else '' }}">
                <div class="hint">Usa: https://www.linkedin.com/in/tuonome (oppure /company/...)</div>
              </div>
              <div class="field">
                <label>TikTok</label>
                <input type="text" name="tiktok" value="{{ agent.tiktok if (agent and not editing_profile2) else '' }}">
                <div class="hint">Usa: https://www.tiktok.com/@tuonome</div>
              </div>
              <div class="field">
                <label>Telegram</label>
                <input type="text" name="telegram" value="{{ agent.telegram if (agent and not editing_profile2) else '' }}">
                <div class="hint">Usa: https://t.me/tuonome</div>
              </div>
              <div class="field">
                <label>YouTube</label>
                <input type="text" name="youtube" value="{{ agent.youtube if (agent and not editing_profile2) else '' }}">
                <div class="hint">Usa: https://www.youtube.com/@tuonome (o link canale completo)</div>
              </div>
              <div class="field full">
                <label>Spotify</label>
                <input type="text" name="spotify" value="{{ agent.spotify if (agent and not editing_profile2) else '' }}">
                <div class="hint">Usa: https://open.spotify.com/artist/... (o playlist/album)</div>
              </div>
            </div>
          </div>

          {% if not editing_profile2 %}
          <div class="section-box">
            <div class="h3">Crop / posizione foto agente</div>
            <div class="hint">Carica una foto e regolala subito qui sotto (anche prima di salvare).</div>

            <div class="crop-preview">
              <div class="crop-circle" id="cropCircle">
                {% if agent.photo_url %}
                  <img id="cropImg" src="{{ agent.photo_url }}" alt=""
                       style="object-position: {{ agent.photo_pos_x }}% {{ agent.photo_pos_y }}%;
                              transform: scale({{ agent.photo_zoom }});">
                {% else %}
                  <div class="crop-empty" id="cropEmpty">Carica una foto profilo</div>
                  <img id="cropImg" src="" alt="" style="display:none">
                {% endif %}
              </div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>X (0‚Äì100)</label>
                <input id="posX" type="range" min="0" max="100" name="photo_pos_x" value="{{ agent.photo_pos_x }}">
              </div>
              <div class="field">
                <label>Y (0‚Äì100)</label>
                <input id="posY" type="range" min="0" max="100" name="photo_pos_y" value="{{ agent.photo_pos_y }}">
              </div>
              <div class="field full">
                <label>Zoom (1.0 ‚Äì 2.5)</label>
                <input id="zoom" type="range" min="1" max="2.5" step="0.05" name="photo_zoom" value="{{ agent.photo_zoom or '1.0' }}">
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Media</div>

            <div class="field">
              <label>Foto profilo</label>
              <input id="photoInput" type="file" name="photo" accept="image/*">
              <div class="hint">Appena selezioni la foto, la vedi subito nel crop sopra.</div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>Logo</label>
                <input type="file" name="logo" accept="image/*">
              </div>
              <div class="field full">
                <label>Background (immagine)</label>
                <input type="file" name="back_media" accept="image/*">
              </div>
            </div>

            <!-- GALLERIA -->
            <div class="media-block" style="margin-top:14px">
              <div class="media-sub">Galleria (aggiunge nuove foto)</div>
              <input type="file" name="gallery" accept="image/*" multiple>
              <div class="hint">Preview sotto (click per aprire grande).</div>

              <div class="media-preview" style="margin-top:10px">
                <div class="media-grid">
                  {% for g in gallery %}
                    <div class="media-item">
                      <img src="{{ g }}" alt="" onclick="openViewer('gallery','{{ g }}','{{ agent.slug }}',{{ loop.index0 }})">
                      <button type="button" class="media-del" onclick="confirmDelete('{{ agent.slug }}','gallery',{{ loop.index0 }})">üóë</button>
                    </div>
                  {% endfor %}
                  {% if gallery|length == 0 %}
                    <div class="hint">Nessuna foto in galleria.</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- VIDEO -->
            <div class="media-block" style="margin-top:14px">
              <div class="media-sub">Video (aggiunge nuovi video)</div>
              <input type="file" name="videos" accept="video/*" multiple>
              <div class="hint">Preview sotto (click per aprire grande).</div>

              <div class="media-preview" style="margin-top:10px">
                <div class="media-grid">
                  {% for v in videos %}
                    <div class="media-item">
                      <video src="{{ v }}#t=0.1" muted playsinline preload="metadata"
                             onclick="openViewer('video','{{ v }}','{{ agent.slug }}',{{ loop.index0 }})"></video>
                      <span class="media-play">video</span>
                      <button type="button" class="media-del" onclick="confirmDelete('{{ agent.slug }}','video',{{ loop.index0 }})">üóë</button>
                    </div>
                  {% endfor %}
                  {% if videos|length == 0 %}
                    <div class="hint">Nessun video caricato.</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- PDF -->
            <div class="media-block" style="margin-top:14px">
              <div class="media-sub">PDF (fino a 12)</div>
              <div class="grid-3">
                {% for i in range(1, 13) %}
                  <div class="field">
                    <label>PDF {{ i }}</label>
                    <input type="file" name="pdf{{ i }}" accept="application/pdf">
                  </div>
                {% endfor %}
              </div>

              <div class="media-preview" style="margin-top:10px">
                <div class="pdf-preview">
                  {% for p in pdfs %}
                    <div class="pdf-row">
                      <div class="pdf-name" onclick="openViewer('pdf','{{ p.url }}','{{ agent.slug }}',{{ loop.index0 }})">{{ p.name }}</div>
                      <button type="button" class="pdf-del" onclick="confirmDelete('{{ agent.slug }}','pdf',{{ loop.index0 }})">üóë</button>
                    </div>
                  {% endfor %}
                  {% if pdfs|length == 0 %}
                    <div class="hint">Nessun PDF caricato.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Traduzioni</div>
            <div class="hint">Compila solo i campi che vuoi tradurre.</div>

            <details style="margin-top:10px">
              <summary style="padding:10px 0; cursor:pointer; font-weight:900;">English (EN)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Name</label><input type="text" name="name_en" value="{{ (i18n_data.get('en',{})).get('name','') }}"></div>
                <div class="field"><label>Company</label><input type="text" name="company_en" value="{{ (i18n_data.get('en',{})).get('company','') }}"></div>
                <div class="field"><label>Role</label><input type="text" name="role_en" value="{{ (i18n_data.get('en',{})).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_en">{{ (i18n_data.get('en',{})).get('bio','') }}</textarea></div>
                <div class="field full"><label>Addresses</label><textarea name="addresses_en">{{ (i18n_data.get('en',{})).get('addresses','') }}</textarea></div>
              </div>
            </details>

            <details>
              <summary style="padding:10px 0; cursor:pointer; font-weight:900;">Fran√ßais (FR)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Nom</label><input type="text" name="name_fr" value="{{ (i18n_data.get('fr',{})).get('name','') }}"></div>
                <div class="field"><label>Entreprise</label><input type="text" name="company_fr" value="{{ (i18n_data.get('fr',{})).get('company','') }}"></div>
                <div class="field"><label>R√¥le</label><input type="text" name="role_fr" value="{{ (i18n_data.get('fr',{})).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_fr">{{ (i18n_data.get('fr',{})).get('bio','') }}</textarea></div>
                <div class="field full"><label>Adresses</label><textarea name="addresses_fr">{{ (i18n_data.get('fr',{})).get('addresses','') }}</textarea></div>
              </div>
            </details>

            <details>
              <summary style="padding:10px 0; cursor:pointer; font-weight:900;">Espa√±ol (ES)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Nombre</label><input type="text" name="name_es" value="{{ (i18n_data.get('es',{})).get('name','') }}"></div>
                <div class="field"><label>Empresa</label><input type="text" name="company_es" value="{{ (i18n_data.get('es',{})).get('company','') }}"></div>
                <div class="field"><label>Rol</label><input type="text" name="role_es" value="{{ (i18n_data.get('es',{})).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_es">{{ (i18n_data.get('es',{})).get('bio','') }}</textarea></div>
                <div class="field full"><label>Direcciones</label><textarea name="addresses_es">{{ (i18n_data.get('es',{})).get('addresses','') }}</textarea></div>
              </div>
            </details>

            <details>
              <summary style="padding:10px 0; cursor:pointer; font-weight:900;">Deutsch (DE)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Name</label><input type="text" name="name_de" value="{{ (i18n_data.get('de',{})).get('name','') }}"></div>
                <div class="field"><label>Firma</label><input type="text" name="company_de" value="{{ (i18n_data.get('de',{})).get('company','') }}"></div>
                <div class="field"><label>Rolle</label><input type="text" name="role_de" value="{{ (i18n_data.get('de',{})).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_de">{{ (i18n_data.get('de',{})).get('bio','') }}</textarea></div>
                <div class="field full"><label>Adressen</label><textarea name="addresses_de">{{ (i18n_data.get('de',{})).get('addresses','') }}</textarea></div>
              </div>
            </details>
          </div>
          {% endif %}

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>
      </div>
    </div>

  </main>
</div>

<!-- VIEWER MODAL -->
<div id="viewer" class="modal-overlay" style="display:none" onclick="overlayCloseViewer(event)">
  <div class="modal-box modal-big" onclick="event.stopPropagation()">

    <!-- ‚úÖ chiudi + cestino funzionanti -->
    <button class="modal-x" type="button" onclick="closeViewer()">‚úï</button>
    <button id="viewerDel" type="button" class="modal-back" style="left:auto; right:58px;" onclick="deleteFromViewer()">üóë</button>

    <img id="vImg" style="display:none" src="" alt="">
    <video id="vVideo" style="display:none" controls playsinline></video>
    <iframe id="vPdf" style="display:none" src=""></iframe>

    <!-- ‚úÖ invia wa / email + chiudi -->
    <div class="modal-actions">
      <a id="shareWa" class="btn" target="_blank" href="#">Invia per WhatsApp</a>
      <a id="shareMail" class="btn" href="#">Invia per Email</a>
      <button class="btn danger" type="button" onclick="closeViewer()">Chiudi</button>
    </div>
  </div>
</div>

<form id="delForm" method="post" style="display:none"></form>

<script>
  // ===== CROP LIVE PREVIEW =====
  const cropImg = document.getElementById('cropImg');
  const cropEmpty = document.getElementById('cropEmpty');
  const photoInput = document.getElementById('photoInput');

  const posX = document.getElementById('posX');
  const posY = document.getElementById('posY');
  const zoom = document.getElementById('zoom');

  function updateCrop(){
    if(!cropImg || !posX || !posY || !zoom) return;
    cropImg.style.objectPosition = `${posX.value}% ${posY.value}%`;
    cropImg.style.transform = `scale(${zoom.value})`;
  }

  if(posX){
    posX.addEventListener('input', updateCrop);
    posX.addEventListener('change', updateCrop);
  }
  if(posY){
    posY.addEventListener('input', updateCrop);
    posY.addEventListener('change', updateCrop);
  }
  if(zoom){
    zoom.addEventListener('input', updateCrop);
    zoom.addEventListener('change', updateCrop);
  }

  // init (cos√¨ X non resta ‚Äúbloccato‚Äù)
  document.addEventListener('DOMContentLoaded', () => {
    updateCrop();
  });

  if(photoInput && cropImg){
    photoInput.addEventListener('change', () => {
      const f = photoInput.files && photoInput.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      cropImg.src = url;
      cropImg.style.display = 'block';
      if(cropEmpty) cropEmpty.style.display = 'none';
      updateCrop();
      cropImg.onload = () => { try{ URL.revokeObjectURL(url); }catch(e){} };
    });
  }

  // ===== VIEWER + DELETE INSIDE + SHARE =====
  let viewerState = { slug:'', type:'', idx:-1, url:'' };

  function setShareLinks(url){
    const wa = document.getElementById('shareWa');
    const mail = document.getElementById('shareMail');
    const txt = encodeURIComponent("Pay4You - Contenuto: " + url);

    if(wa) wa.href = `https://wa.me/?text=${txt}`;
    if(mail) mail.href = `mailto:?subject=${encodeURIComponent("Pay4You - Contenuto")}&body=${txt}`;
  }

  function openViewer(type, url, slug, idx){
    viewerState = { slug, type, idx, url };

    const modal = document.getElementById('viewer');
    const vImg = document.getElementById('vImg');
    const vVideo = document.getElementById('vVideo');
    const vPdf = document.getElementById('vPdf');

    vImg.style.display = 'none';
    vVideo.style.display = 'none';
    vPdf.style.display = 'none';

    try{ vVideo.pause(); }catch(e){}

    if(type === 'gallery'){
      vImg.src = url;
      vImg.style.display = 'block';
    } else if(type === 'video'){
      vVideo.src = url;
      vVideo.style.display = 'block';
    } else {
      vPdf.src = url;
      vPdf.style.display = 'block';
    }

    setShareLinks(url);
    modal.style.display = 'flex';
  }

  function closeViewer(){
    const modal = document.getElementById('viewer');
    const vVideo = document.getElementById('vVideo');
    try{ vVideo.pause(); }catch(e){}
    modal.style.display = 'none';
  }

  function overlayCloseViewer(e){
    if(e.target && e.target.id === 'viewer'){
      closeViewer();
    }
  }

  function confirmDelete(slug, type, idx){
    if(!confirm('Vuoi eliminare questo contenuto?')) return;
    if(!confirm('Conferma definitiva: una volta eliminato NON sar√† ripristinabile.')) return;

    const form = document.getElementById('delForm');
    form.action = `/area/media/delete/${slug}`;
    form.innerHTML = `
      <input type="hidden" name="type" value="${type}">
      <input type="hidden" name="idx" value="${idx}">
    `;
    form.submit();
  }

  function deleteFromViewer(){
    if(!viewerState.slug) return;
    confirmDelete(viewerState.slug, viewerState.type, viewerState.idx);
  }

  // ===== P2: carica SOLO p2_json (se vuoto, resta vuoto) =====
  document.addEventListener('DOMContentLoaded', () => {
    const isP2 = {{ 'true' if editing_profile2 else 'false' }};
    if(!isP2) return;

    // Forza vuoto prima (cos√¨ non resta niente di P1)
    document.querySelectorAll('input[name], textarea[name]').forEach(el => {
      const n = el.getAttribute('name');
      // non toccare i file input
      if(el.type === 'file') return;
      // lascia i campi ‚Äúnascosti‚Äù eventuali
      if(!n) return;
      el.value = '';
    });

    try{
      const p2 = JSON.parse({{ (agent.p2_json if agent else '{}')|tojson }});
      if(p2 && typeof p2 === 'object'){
        Object.keys(p2).forEach(k => {
          const el = document.querySelector(`[name="${k}"]`);
          if(!el) return;
          if(el.type === 'file') return;
          el.value = (p2[k] ?? '');
        });
      }
    }catch(e){
      // se JSON rotto: meglio vuoto che copiare P1
    }
  });
</script>

</body>
</html>
