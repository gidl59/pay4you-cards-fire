{% extends "base.html" %}

{% block title %}
  {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
{% endblock %}

{% block content %}
<div class="agent-form-wrapper">
  <h1 class="agent-form-title">
    {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
  </h1>

  <form class="agent-form" method="post" enctype="multipart/form-data">
    <!-- Slug -->
    <label for="slug">Codice card (slug unico – senza spazi)</label>
    <input type="text" id="slug" name="slug"
           value="{{ agent.slug if agent else '' }}"
           placeholder="es: giuseppe" required>

    <!-- Nome -->
    <label for="name">Nome e Cognome</label>
    <input type="text" id="name" name="name"
           value="{{ agent.name if agent else '' }}" required>

    <!-- Azienda -->
    <label for="company">Azienda</label>
    <input type="text" id="company" name="company"
           value="{{ agent.company if agent else '' }}">

    <!-- Ruolo -->
    <label for="role">Ruolo</label>
    <input type="text" id="role" name="role"
           value="{{ agent.role if agent else '' }}">

    <!-- Bio -->
    <label for="bio">Descrizione breve (max 200 caratteri)</label>
    <textarea id="bio" name="bio" maxlength="200"
              placeholder="Breve descrizione professionale">{{ agent.bio if agent else '' }}</textarea>

    <!-- Contatti -->
    <label for="phone_mobile">Telefono mobile</label>
    <input type="tel" id="phone_mobile" name="phone_mobile"
           value="{{ agent.phone_mobile if agent else '' }}">

    <label for="phone_office">Telefono ufficio</label>
    <input type="tel" id="phone_office" name="phone_office"
           value="{{ agent.phone_office if agent else '' }}">

    <!-- EMAIL MULTIPLE -->
    <label for="emails">Email (separate da virgola)</label>
    <input type="text" id="emails" name="emails"
           value="{{ agent.emails if agent else '' }}"
           placeholder="es: nome@mail.it, info@mail.it">
    <small style="font-size:12px;color:#9ca3af;">
      Puoi inserire più email separate da virgola.
    </small>

    <!-- WEBSITES -->
    <label for="websites">Siti web (separati da virgola)</label>
    <input type="text" id="websites" name="websites"
           value="{{ agent.websites if agent else '' }}"
           placeholder="https://www.miosito.it, https://www.altro.it">

    <!-- Social -->
    <label for="facebook">Facebook (URL)</label>
    <input type="text" id="facebook" name="facebook"
           value="{{ agent.facebook if agent else '' }}">

    <label for="instagram">Instagram (URL)</label>
    <input type="text" id="instagram" name="instagram"
           value="{{ agent.instagram if agent else '' }}">

    <label for="linkedin">LinkedIn (URL)</label>
    <input type="text" id="linkedin" name="linkedin"
           value="{{ agent.linkedin if agent else '' }}">

    <label for="tiktok">TikTok (URL)</label>
    <input type="text" id="tiktok" name="tiktok"
           value="{{ agent.tiktok if agent else '' }}">

    <label for="telegram">Telegram (URL)</label>
    <input type="text" id="telegram" name="telegram"
           value="{{ agent.telegram if agent else '' }}">

    <!-- WhatsApp -->
    <label for="whatsapp">WhatsApp (numero)</label>
    <input type="text" id="whatsapp" name="whatsapp"
           value="{{ agent.whatsapp if agent else '' }}"
           placeholder="+39 333 1234567">

    <!-- PEC -->
    <label for="pec">PEC</label>
    <input type="email" id="pec" name="pec"
           value="{{ agent.pec if agent else '' }}">

    <!-- Dati fiscali -->
    <label for="piva">Partita IVA</label>
    <input type="text" id="piva" name="piva"
           value="{{ agent.piva if agent else '' }}">

    <label for="sdi">Codice SDI</label>
    <input type="text" id="sdi" name="sdi"
           value="{{ agent.sdi if agent else '' }}">

    <!-- Indirizzi (multi-linea) -->
    <label for="addresses">Indirizzi (uno per riga)</label>
    <textarea id="addresses" name="addresses"
              placeholder="Via, CAP, Città&#10;Secondo indirizzo">{{ agent.addresses if agent else '' }}</textarea>

    <!-- FOTO PROFILO -->
    <label for="photo">Foto profilo (consigliata 1000×1000 JPG/PNG)</label>
    <input type="file" id="photo" name="photo" accept="image/*">
    <!-- Qui salviamo il ritaglio in base64 per app.py -->
    <input type="hidden" id="photo_cropped" name="photo_cropped" value="">

    <!-- LOGO EXTRA (per logo in alto / retro avatar) -->
    <label for="extra_logo">Logo extra (per testata e retro foto)</label>
    <input type="file" id="extra_logo" name="extra_logo" accept="image/*">
    <small style="font-size:12px;color:#9ca3af;">
      Verrà usato come logo in alto e sul retro della foto agente (se previsto dal template).
    </small>

    <!-- DOCUMENTI PDF -->
    <label>Documenti PDF (max 12)</label>
    {% for i in range(1, 13) %}
      <input type="file" name="pdf{{ i }}" accept="application/pdf">
    {% endfor %}
    <small style="font-size:12px;color:#9ca3af;">
      Caricando almeno un nuovo PDF, sostituirai la lista esistente.
    </small>

    <!-- GALLERIA FOTO -->
    <label>Galleria foto (fino a 20 immagini)</label>
    <input type="file" name="gallery" accept="image/*" multiple>
    <small style="font-size:12px;color:#9ca3af;">
      Se carichi nuove immagini, la galleria precedente verrà sostituita.
    </small>

    <!-- BOTTONI -->
    <div class="agent-form-buttons">
      <button type="submit">
        {% if agent %}Aggiorna agente{% else %}Crea agente{% endif %}
      </button>
      <a class="btn-secondary" href="{{ url_for('admin_home') }}">Annulla</a>
    </div>

  </form>
</div>

<!-- MODALE CROP FOTO -->
<div id="cropper-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h2>Ritaglia la foto profilo</h2>
    <div style="width:100%;max-width:360px;margin:0 auto;">
      <img id="cropper-image" src="" alt="Anteprima foto"
           style="max-width:100%;display:block;">
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;">
      <button type="button" id="cropper-use" class="modal-close-btn">
        Usa questa foto
      </button>
      <button type="button" id="cropper-cancel"
              class="modal-close-btn"
              style="background:#111827;color:#e5e7eb;border:1px solid #4b5563;">
        Annulla
      </button>
    </div>
  </div>
</div>

<script>
  (function() {
    const input = document.getElementById('photo');
    const hiddenCropped = document.getElementById('photo_cropped');
    const modal = document.getElementById('cropper-modal');
    const imgEl = document.getElementById('cropper-image');
    const btnUse = document.getElementById('cropper-use');
    const btnCancel = document.getElementById('cropper-cancel');

    let cropper = null;

    if (!input) return;

    // Quando selezioni la foto profilo
    input.addEventListener('change', function(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      imgEl.src = url;
      modal.style.display = 'flex';

      if (cropper) {
        cropper.destroy();
        cropper = null;
      }

      // Inizializza Cropper (1:1)
      cropper = new Cropper(imgEl, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 0.9,
        responsive: true,
        background: false,
        zoomOnWheel: false
      });
    });

    // Usa questa foto (salva il ritaglio in base64 dentro il campo nascosto)
    btnUse.addEventListener('click', function() {
      if (!cropper) {
        modal.style.display = 'none';
        return;
      }

      const canvas = cropper.getCroppedCanvas({
        width: 1000,
        height: 1000,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });

      // Salviamo il dataURL JPG nel campo nascosto; app.py userà questo per salvare il file
      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
      hiddenCropped.value = dataUrl;

      // opzionale: possiamo anche azzerare l'input file se vuoi usare SOLO il base64
      // input.value = '';

      modal.style.display = 'none';
      cropper.destroy();
      cropper = null;
    });

    // Annulla
    btnCancel.addEventListener('click', function() {
      modal.style.display = 'none';
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      // opzionale: svuotare l'input:
      // input.value = '';
      hiddenCropped.value = '';
    });
  })();
</script>

{% endblock %}
