{% extends "base.html" %}
{% block title %}
  {% if agent %}
    {% if editing_profile2 %}Modifica Profilo 2{% else %}Modifica Profilo 1{% endif %} | Pay4You
  {% else %}
    Nuova Card | Pay4You
  {% endif %}
{% endblock %}

{% block content %}
<div class="form-wrap">

  <div class="form-head">
    <div>
      <h1 class="form-title">
        {% if agent %}
          {% if editing_profile2 %}Modifica Profilo 2{% else %}Modifica Profilo 1{% endif %}
        {% else %}
          Crea nuova Card
        {% endif %}
      </h1>

      <div class="form-sub">
        {% if editing_profile2 %}
          Questo √® il Profilo 2 (se attivo). Pu√≤ essere completamente diverso dal Profilo 1.
        {% else %}
          Dati della card (Profilo 1).
        {% endif %}
      </div>

      {% if not agent and session.get('role') == 'admin' %}
        <div class="hint-box">
          <strong>Slug</strong>: √® la parte finale del link della card.<br>
          Esempio: <span class="mono">https://TUO-DOMINIO/</span><span class="mono">mario-rossi</span><br>
          Usa solo lettere, numeri e trattini (niente spazi).
        </div>
      {% endif %}
    </div>

    <div class="form-actions">
      <a class="btn-mini ghost" href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>
      {% if session.get('role') != 'admin' %}
        {% if editing_profile2 %}
          <a class="btn-mini ghost" href="{{ url_for('me_edit') }}">Profilo 1</a>
        {% else %}
          {% if agent and agent.p2_enabled == 1 %}
            <a class="btn-mini ghost" href="{{ url_for('me_profile2') }}">Profilo 2</a>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="card-form">

    {% if session.get('role') == 'admin' and not agent %}
      <div class="grid-2">
        <div class="field">
          <label>Slug (obbligatorio)</label>
          <input name="slug" type="text" placeholder="es: mario-rossi" required>
          <div class="mini-help">Verr√† creato anche l‚Äôutente di accesso con lo stesso nome.</div>
        </div>

        <div class="field">
          <label>Nome (obbligatorio)</label>
          <input name="name" type="text" placeholder="Nome e Cognome" required>
        </div>
      </div>
    {% endif %}

    {% if agent %}
      <div class="section-box">
        <div class="section-title">Identificativo</div>
        <div class="grid-2">
          <div class="field">
            <label>Slug (non modificabile)</label>
            <input type="text" value="{{ agent.slug }}" readonly>
            <div class="mini-help">√à il link pubblico della card.</div>
          </div>
          <div class="field">
            <label>Link card</label>
            <input type="text" value="{{ request.url_root.strip().rstrip('/') }}/{{ agent.slug }}" readonly>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="grid-2">
      <div class="field">
        <label>Nome</label>
        <input name="name" type="text" value="{{ agent.name if agent else '' }}" {% if session.get('role')=='admin' and not agent %}disabled{% endif %}>
        <div class="mini-help">Per P2 pu√≤ essere diverso dal P1.</div>
      </div>

      <div class="field">
        <label>Azienda</label>
        <input name="company" type="text" value="{{ agent.company if agent and agent.company else '' }}">
      </div>

      <div class="field">
        <label>Ruolo</label>
        <input name="role" type="text" value="{{ agent.role if agent and agent.role else '' }}">
      </div>

      <div class="field">
        <label>Bio</label>
        <textarea name="bio" rows="3" placeholder="Breve descrizione...">{{ agent.bio if agent and agent.bio else '' }}</textarea>
      </div>
    </div>

    <div class="section-box">
      <div class="section-title">Contatti</div>

      <div class="grid-2">
        <div class="field">
          <label>Cellulare</label>
          <input name="phone_mobile" type="text" value="{{ agent.phone_mobile if agent and agent.phone_mobile else '' }}" placeholder="+39 ...">
        </div>

        <div class="field">
          <label>Cellulare 2</label>
          <input name="phone_mobile2" type="text" value="{{ agent.phone_mobile2 if agent and agent.phone_mobile2 else '' }}" placeholder="+39 ...">
        </div>

        <div class="field">
          <label>Ufficio</label>
          <input name="phone_office" type="text" value="{{ agent.phone_office if agent and agent.phone_office else '' }}">
        </div>

        <div class="field">
          <label>WhatsApp (link o numero)</label>
          <input name="whatsapp" type="text" value="{{ agent.whatsapp if agent and agent.whatsapp else '' }}" placeholder="es: +39333... oppure https://wa.me/...">
        </div>

        <div class="field">
          <label>Email (separate da virgola)</label>
          <input name="emails" type="text" value="{{ agent.emails if agent and agent.emails else '' }}" placeholder="mail1@... , mail2@...">
        </div>

        <div class="field">
          <label>Siti (separati da virgola)</label>
          <input name="websites" type="text" value="{{ agent.websites if agent and agent.websites else '' }}" placeholder="pay4you.store, ...">
        </div>

        <div class="field">
          <label>PEC</label>
          <input name="pec" type="text" value="{{ agent.pec if agent and agent.pec else '' }}">
        </div>

        <div class="field">
          <label>Indirizzi (uno per riga)</label>
          <textarea name="addresses" rows="3" placeholder="Via..., Citt√†...">{{ agent.addresses if agent and agent.addresses else '' }}</textarea>
        </div>
      </div>
    </div>

    <div class="section-box">
      <div class="section-title">Dati</div>
      <div class="grid-2">
        <div class="field">
          <label>P.IVA</label>
          <input name="piva" type="text" value="{{ agent.piva if agent and agent.piva else '' }}">
        </div>
        <div class="field">
          <label>SDI</label>
          <input name="sdi" type="text" value="{{ agent.sdi if agent and agent.sdi else '' }}">
        </div>
      </div>
    </div>

    <div class="section-box">
      <div class="section-title">Social</div>
      <div class="grid-2">
        <div class="field"><label>Facebook</label><input name="facebook" type="text" value="{{ agent.facebook if agent and agent.facebook else '' }}"></div>
        <div class="field"><label>Instagram</label><input name="instagram" type="text" value="{{ agent.instagram if agent and agent.instagram else '' }}"></div>
        <div class="field"><label>LinkedIn</label><input name="linkedin" type="text" value="{{ agent.linkedin if agent and agent.linkedin else '' }}"></div>
        <div class="field"><label>TikTok</label><input name="tiktok" type="text" value="{{ agent.tiktok if agent and agent.tiktok else '' }}"></div>
        <div class="field"><label>Telegram</label><input name="telegram" type="text" value="{{ agent.telegram if agent and agent.telegram else '' }}"></div>
        <div class="field"><label>YouTube</label><input name="youtube" type="text" value="{{ agent.youtube if agent and agent.youtube else '' }}"></div>
        <div class="field"><label>Spotify</label><input name="spotify" type="text" value="{{ agent.spotify if agent and agent.spotify else '' }}"></div>
      </div>
      <div class="mini-help">Suggerimento: incolla link completi (https://...). Se non √® valido, l‚Äôicona non verr√† mostrata.</div>
    </div>

    <div class="section-box">
      <div class="section-title">Immagini</div>

      <div class="grid-2">
        <div class="field">
          <label>Foto profilo (upload)</label>
          <input name="photo" type="file" accept="image/*">
          {% if agent and agent.photo_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.photo_url }}</span></div>
          {% endif %}
        </div>

        <div class="field">
          <label>Logo (upload)</label>
          <input name="logo" type="file" accept="image/*">
          {% if agent and agent.logo_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.logo_url }}</span></div>
          {% endif %}
        </div>

        <div class="field">
          <label>Contenuto dietro foto</label>
          <select name="back_media_mode">
            {% set bm = (agent.back_media_mode if agent and agent.back_media_mode else 'company') %}
            <option value="company" {% if bm=='company' %}selected{% endif %}>Logo aziendale</option>
            <option value="personal" {% if bm=='personal' %}selected{% endif %}>Foto/Logo personale</option>
          </select>
        </div>

        <div class="field">
          <label>Upload retro (solo se ‚Äúpersonale‚Äù)</label>
          <input name="back_media" type="file" accept="image/*">
          {% if agent and agent.back_media_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.back_media_url }}</span></div>
          {% endif %}
        </div>
      </div>

      <div class="grid-3">
        <div class="field">
          <label>Crop X (0‚Äì100)</label>
          <input name="photo_pos_x" type="number" min="0" max="100" step="1"
                 value="{{ agent.photo_pos_x if agent and agent.photo_pos_x is not none else 50 }}">
        </div>
        <div class="field">
          <label>Crop Y (0‚Äì100)</label>
          <input name="photo_pos_y" type="number" min="0" max="100" step="1"
                 value="{{ agent.photo_pos_y if agent and agent.photo_pos_y is not none else 35 }}">
        </div>
        <div class="field">
          <label>Zoom (1.0‚Äì2.6)</label>
          <input name="photo_zoom" type="number" min="1" max="2.6" step="0.05"
                 value="{{ agent.photo_zoom if agent and agent.photo_zoom is not none else 1.0 }}">
        </div>
      </div>
    </div>

    <div class="section-box">
      <div class="section-title">Effetti</div>

      <div class="check-grid">
        {% set orbit = 1 if agent and (agent.orbit_spin or 0) == 1 else 0 %}
        {% set aspin = 1 if agent and (agent.avatar_spin or 0) == 1 else 0 %}
        {% set lspin = 1 if agent and (agent.logo_spin or 0) == 1 else 0 %}
        {% set flip  = 1 if agent and (agent.allow_flip or 0) == 1 else 0 %}

        <label class="check">
          <input type="checkbox" name="orbit_spin" {% if orbit==1 %}checked{% endif %}>
          <span>Orbit logo (ruota dietro)</span>
        </label>

        <label class="check">
          <input type="checkbox" name="avatar_spin" {% if aspin==1 %}checked{% endif %}>
          <span>Ruota foto</span>
        </label>

        <label class="check">
          <input type="checkbox" name="logo_spin" {% if lspin==1 %}checked{% endif %}>
          <span>Ruota logo sul retro</span>
        </label>

        <label class="check">
          <input type="checkbox" name="allow_flip" {% if flip==1 %}checked{% endif %}>
          <span>Flip (tap per retro)</span>
        </label>
      </div>

      <div class="mini-help">
        Nota: se attivi ‚ÄúRuota foto‚Äù il flip viene disabilitato automaticamente.
      </div>
    </div>

    <div class="section-box">
      <div class="section-title">Media (foto / video / PDF)</div>

      <div class="grid-2">
        <div class="field">
          <label>Galleria foto (max 30)</label>
          <input name="gallery" type="file" accept="image/*" multiple>
        </div>

        <div class="field">
          <label>Video (max 10)</label>
          <input name="videos" type="file" accept="video/*" multiple>
        </div>
      </div>

      <div class="field">
        <label>PDF (fino a 12)</label>
        <div class="grid-3">
          {% for i in range(1,13) %}
            <div class="field mini">
              <label>PDF {{ i }}</label>
              <input name="pdf{{ i }}" type="file" accept="application/pdf">
            </div>
          {% endfor %}
        </div>
      </div>

      {# ===== PREVIEW + ELIMINA SINGOLO ===== #}
      {% if agent %}
        {% set gal = (agent.gallery_urls or '').split('|') if agent.gallery_urls else [] %}
        {% set vids = (agent.video_urls or '').split('|') if agent.video_urls else [] %}
        {% set pdfraw = (agent.pdf1_url or '') %}
        {% set pdfs = pdfraw.split('|') if pdfraw else [] %}

        <div class="media-preview">
          <div class="media-title">Anteprima caricati (puoi eliminare singoli)</div>

          {% if gal %}
          <div class="media-block">
            <div class="media-sub">Foto</div>
            <div class="media-grid">
              {% for g in gal %}
              <div class="media-item">
                <img src="{{ g }}" alt="img">
                <form method="post"
                      action="{% if session.get('role')=='admin' %}{{ url_for('admin_delete_media', slug=agent.slug) }}{% else %}{{ url_for('me_delete_media') }}{% endif %}">
                  <input type="hidden" name="kind" value="gallery">
                  <input type="hidden" name="url" value="{{ g }}">
                  <button class="media-del" type="submit" title="Elimina">üóë</button>
                </form>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if vids %}
          <div class="media-block">
            <div class="media-sub">Video</div>
            <div class="media-grid">
              {% for v in vids %}
              <div class="media-item">
                <video src="{{ v }}" muted playsinline preload="metadata"></video>
                <div class="media-play">PLAY</div>
                <form method="post"
                      action="{% if session.get('role')=='admin' %}{{ url_for('admin_delete_media', slug=agent.slug) }}{% else %}{{ url_for('me_delete_media') }}{% endif %}">
                  <input type="hidden" name="kind" value="video">
                  <input type="hidden" name="url" value="{{ v }}">
                  <button class="media-del" type="submit" title="Elimina">üóë</button>
                </form>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if pdfs %}
          <div class="media-block">
            <div class="media-sub">PDF</div>
            <div class="pdf-preview">
              {% for item in pdfs %}
                {% if '||' in item %}
                  {% set parts = item.split('||') %}
                  {% set pdfname = parts[0] %}
                  {% set pdfurl = parts[1] %}
                {% else %}
                  {% set pdfname = item %}
                  {% set pdfurl = item %}
                {% endif %}
                <div class="pdf-row">
                  <div class="pdf-name" title="{{ pdfname }}">{{ pdfname }}</div>
                  <form method="post"
                        action="{% if session.get('role')=='admin' %}{{ url_for('admin_delete_media', slug=agent.slug) }}{% else %}{{ url_for('me_delete_media') }}{% endif %}">
                    <input type="hidden" name="kind" value="pdf">
                    <input type="hidden" name="url" value="{{ pdfurl }}">
                    <button class="pdf-del" type="submit" title="Elimina">üóë</button>
                  </form>
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <div class="sticky-save">
      <button class="btn primary" type="submit">
        {% if agent %}
          {% if editing_profile2 %}Salva Profilo 2{% else %}Salva Profilo 1{% endif %}
        {% else %}
          Crea Card
        {% endif %}
      </button>

      <a class="btn ghost" href="{{ url_for('dashboard') }}">Annulla</a>
    </div>

  </form>

  <div class="footer">¬© 2026 Pay4You ‚Äî Giuseppe Di Lisio</div>
</div>

<script>
  // preview 1¬∞ frame video mini
  (function(){
    document.querySelectorAll('.media-item video').forEach(v=>{
      v.addEventListener('loadedmetadata', ()=>{
        try{ v.currentTime = 0.05; }catch(e){}
      });
      v.addEventListener('seeked', ()=>{ try{ v.pause(); }catch(e){} });
    });
  })();
</script>
{% endblock %}
