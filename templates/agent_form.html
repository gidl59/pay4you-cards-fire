{% extends "base.html" %}

{% block title %}
  {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
{% endblock %}

{% block content %}
<div class="agent-form-wrapper">
  <h1 class="agent-form-title">
    {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
  </h1>

  <form class="agent-form" method="post" enctype="multipart/form-data">

    <!-- Slug -->
    <label for="slug">Codice card (slug unico – senza spazi)</label>
    <input type="text" id="slug" name="slug"
           value="{{ agent.slug if agent else '' }}"
           placeholder="es: giuseppe" required>

    <!-- Nome -->
    <label for="name">Nome e Cognome</label>
    <input type="text" id="name" name="name"
           value="{{ agent.name if agent else '' }}" required>

    <!-- Azienda -->
    <label for="company">Azienda</label>
    <input type="text" id="company" name="company"
           value="{{ agent.company if agent else '' }}">

    <!-- Ruolo -->
    <label for="role">Ruolo</label>
    <input type="text" id="role" name="role"
           value="{{ agent.role if agent else '' }}">

    <!-- Bio -->
    <label for="bio">Descrizione breve (max 200 caratteri)</label>
    <textarea id="bio" name="bio" maxlength="200"
              placeholder="Breve descrizione professionale">{{ agent.bio if agent else '' }}</textarea>

    <!-- Contatti -->
    <label for="phone_mobile">Telefono mobile</label>
    <input type="tel" id="phone_mobile" name="phone_mobile"
           value="{{ agent.phone_mobile if agent else '' }}">

    <label for="phone_office">Telefono ufficio</label>
    <input type="tel" id="phone_office" name="phone_office"
           value="{{ agent.phone_office if agent else '' }}">

    <!-- EMAIL MULTIPLE -->
    <label for="emails">Email (separate da virgola)</label>
    <input type="text" id="emails" name="emails"
           value="{{ agent.emails if agent else '' }}"
           placeholder="es: nome@mail.it, info@mail.it">
    <small style="font-size:12px;color:#9ca3af;">
      Puoi inserire più email separate da virgola.
    </small>

    <!-- WEBSITES -->
    <label for="websites">Siti web (separati da virgola)</label>
    <input type="text" id="websites" name="websites"
           value="{{ agent.websites if agent else '' }}"
           placeholder="https://www.miosito.it, https://www.altro.it">

    <!-- Social -->
    <label for="facebook">Facebook (URL)</label>
    <input type="text" id="facebook" name="facebook"
           value="{{ agent.facebook if agent else '' }}">

    <label for="instagram">Instagram (URL)</label>
    <input type="text" id="instagram" name="instagram"
           value="{{ agent.instagram if agent else '' }}">

    <label for="linkedin">LinkedIn (URL)</label>
    <input type="text" id="linkedin" name="linkedin"
           value="{{ agent.linkedin if agent else '' }}">

    <label for="tiktok">TikTok (URL)</label>
    <input type="text" id="tiktok" name="tiktok"
           value="{{ agent.tiktok if agent else '' }}">

    <label for="telegram">Telegram (URL)</label>
    <input type="text" id="telegram" name="telegram"
           value="{{ agent.telegram if agent else '' }}">

    <!-- WhatsApp -->
    <label for="whatsapp">WhatsApp (numero)</label>
    <input type="text" id="whatsapp" name="whatsapp"
           value="{{ agent.whatsapp if agent else '' }}"
           placeholder="+39 333 1234567">

    <!-- PEC -->
    <label for="pec">PEC</label>
    <input type="email" id="pec" name="pec"
           value="{{ agent.pec if agent else '' }}">

    <!-- Dati fiscali -->
    <label for="piva">Partita IVA</label>
    <input type="text" id="piva" name="piva"
           value="{{ agent.piva if agent else '' }}">

    <label for="sdi">Codice SDI</label>
    <input type="text" id="sdi" name="sdi"
           value="{{ agent.sdi if agent else '' }}">

    <!-- Indirizzi (multi-linea) -->
    <label for="addresses">Indirizzi (uno per riga)</label>
    <textarea id="addresses" name="addresses"
              placeholder="Via, CAP, Città&#10;Secondo indirizzo">{{ agent.addresses if agent else '' }}</textarea>

    <!-- FOTO PROFILO con crop -->
    <label for="photo">Foto profilo (consigliata 1000×1000 JPG/PNG)</label>
    <input type="file" id="photo" name="photo" accept="image/*">

    <input type="hidden" id="photo_cropped" name="photo_cropped">

    <div style="margin-top:8px;">
      <canvas id="photo-canvas" width="400" height="400"
              style="max-width:100%; border-radius:16px; border:1px solid #4b5563;"></canvas>
      <small style="display:block;font-size:12px;color:#9ca3af;margin-top:4px;">
        Carica la foto, verrà centrata e ritagliata in formato quadrato.
      </small>
    </div>

    <!-- LOGO PERSONALIZZATO -->
    <label for="logo_custom">Logo personalizzato (PNG/JPG, opzionale)</label>
    <input type="file" id="logo_custom" name="logo_custom" accept="image/*">
    <small style="font-size:12px;color:#9ca3af;">
      Se carichi un logo qui, verrà usato al posto del logo Pay4You nella card e dietro la foto dell'agente.
    </small>

    <!-- DOCUMENTI PDF -->
    <label>Documenti PDF (max 6)</label>
    {% for i in range(1, 7) %}
      <input type="file" name="pdf{{ i }}" accept="application/pdf">
    {% endfor %}
    <small style="font-size:12px;color:#9ca3af;">Caricando almeno un nuovo PDF, sostituirai la lista esistente.</small>

    <!-- GALLERIA FOTO -->
    <label>Galleria foto (fino a 12 immagini)</label>
    <input type="file" name="gallery" accept="image/*" multiple>
    <small style="font-size:12px;color:#9ca3af;">
      Se carichi nuove immagini, la galleria precedente verrà sostituita.
    </small>

    <!-- BOTTONI -->
    <div class="agent-form-buttons">
      <button type="submit">
        {% if agent %}Aggiorna agente{% else %}Crea agente{% endif %}
      </button>
      <a class="btn-secondary" href="{{ url_for('admin_home') }}">Annulla</a>
    </div>

  </form>
</div>

<script>
  (function () {
    const fileInput = document.getElementById('photo');
    const hiddenField = document.getElementById('photo_cropped');
    const canvas = document.getElementById('photo-canvas');
    const ctx = canvas.getContext('2d');

    function clearCanvas() {
      ctx.fillStyle = '#020617';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    clearCanvas();

    fileInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (ev) {
        const img = new Image();
        img.onload = function () {
          const cw = canvas.width;
          const ch = canvas.height;
          clearCanvas();

          const iw = img.width;
          const ih = img.height;
          const scale = Math.max(cw / iw, ch / ih);

          const nw = iw * scale;
          const nh = ih * scale;
          const dx = (cw - nw) / 2;
          const dy = (ch - nh) / 2;

          ctx.drawImage(img, dx, dy, nw, nh);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
          hiddenField.value = dataUrl;
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  })();
</script>
{% endblock %}
