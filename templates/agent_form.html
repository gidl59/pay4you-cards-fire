<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">
  <title>{% if agent and agent.slug %}{{ agent.slug }}{% else %}Nuova card{% endif %} | Pay4You</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body data-theme="">

  <div class="app-shell">
    <header class="app-header">
      <a class="brand" href="{{ url_for('dashboard') }}" aria-label="Pay4You">
        <span class="brand-title">Pay4You — Editor</span>
      </a>
      <div class="app-header-right">
        <a class="btn-mini ghost" href="{{ url_for('dashboard') }}">← Dashboard</a>
        <a class="btn-mini danger" href="{{ url_for('logout') }}">Esci</a>
      </div>
    </header>

    <main class="app-main">
      <div class="flash-wrap">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for cat, msg in messages %}
              <div class="flash flash-{{ cat|default('success') }}">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <div class="page-main">
        <div class="panel panel-wide">

          <div class="panel-head">
            <div>
              <div class="page-title">
                {% if agent and agent.slug %}
                  Modifica {{ "Profilo 2" if editing_profile2 else "Profilo 1" }} — {{ agent.slug }}
                {% else %}
                  Nuova card
                {% endif %}
              </div>
              <div class="hint">
                {% if editing_profile2 %}
                  Stai modificando il profilo 2 (se lasci i campi vuoti, non verranno mostrati sulla card).
                {% else %}
                  Stai modificando il profilo 1 (principale).
                {% endif %}
              </div>
            </div>

            <div class="toolbar">
              {% if agent and agent.slug %}
                <a class="btn-mini" href="/{{ agent.slug }}" target="_blank" rel="noopener">Apri card</a>
                <a class="btn-mini ghost" href="/{{ agent.slug }}?p=p2" target="_blank" rel="noopener">Apri P2</a>
                <a class="btn-mini ghost" href="/{{ agent.slug }}.vcf" target="_blank" rel="noopener">VCF</a>
              {% endif %}
            </div>
          </div>

          {# ===== FORM ACTION ===== #}
          {% set is_new = (not agent) or (not agent.slug) %}
          {% if is_new %}
            {% set form_action = url_for('create_agent') %}
          {% else %}
            {% if editing_profile2 %}
              {# admin e client usano due route diverse, ma noi non sappiamo il ruolo qui:
                 usiamo path relativo: se sei admin apri /admin/<slug>/profile2, se client /me/profile2
                 quindi: nel template passiamo l'action già corretto tramite logica JS (fallback) #}
              {% set form_action = '' %}
            {% else %}
              {# stesso discorso: admin /admin/<slug>/edit, client /me/edit #}
              {% set form_action = '' %}
            {% endif %}
          {% endif %}

          <form method="post"
                action="{{ form_action if form_action else request.path }}"
                enctype="multipart/form-data">

            <div class="form-grid">

              {% if is_new %}
              <div class="field">
                <label>Slug (es: mario-rossi)</label>
                <input type="text" name="slug" required>
              </div>
              {% endif %}

              <div class="field {% if not is_new %}full{% endif %}">
                <label>Nome</label>
                <input type="text" name="name" value="{{ agent.name if agent else '' }}" {% if not editing_profile2 %}required{% endif %}>
              </div>

              <div class="field">
                <label>Azienda</label>
                <input type="text" name="company" value="{{ agent.company if agent else '' }}">
              </div>

              <div class="field">
                <label>Ruolo</label>
                <input type="text" name="role" value="{{ agent.role if agent else '' }}">
              </div>

              <div class="field full">
                <label>Bio</label>
                <textarea name="bio">{{ agent.bio if agent else '' }}</textarea>
              </div>

              <div class="field">
                <label>Cellulare 1</label>
                <input type="text" name="phone_mobile" value="{{ agent.phone_mobile if agent else '' }}">
              </div>

              <div class="field">
                <label>Cellulare 2</label>
                <input type="text" name="phone_mobile2" value="{{ agent.phone_mobile2 if agent else '' }}">
              </div>

              <div class="field">
                <label>Telefono ufficio</label>
                <input type="text" name="phone_office" value="{{ agent.phone_office if agent else '' }}">
              </div>

              <div class="field">
                <label>WhatsApp (numero o link)</label>
                <input type="text" name="whatsapp" value="{{ agent.whatsapp if agent else '' }}">
              </div>

              <div class="field">
                <label>Email (separate da virgola)</label>
                <input type="text" name="emails" value="{{ agent.emails if agent else '' }}">
              </div>

              <div class="field">
                <label>Siti (separati da virgola)</label>
                <input type="text" name="websites" value="{{ agent.websites if agent else '' }}">
              </div>

              <div class="field">
                <label>PEC</label>
                <input type="text" name="pec" value="{{ agent.pec if agent else '' }}">
              </div>

              <div class="field">
                <label>P.IVA</label>
                <input type="text" name="piva" value="{{ agent.piva if agent else '' }}">
              </div>

              <div class="field">
                <label>SDI</label>
                <input type="text" name="sdi" value="{{ agent.sdi if agent else '' }}">
              </div>

              <div class="field full">
                <label>Indirizzi (uno per riga)</label>
                <textarea name="addresses">{{ agent.addresses if agent else '' }}</textarea>
              </div>

              <div class="field">
                <label>Facebook</label>
                <input type="text" name="facebook" value="{{ agent.facebook if agent else '' }}">
              </div>

              <div class="field">
                <label>Instagram</label>
                <input type="text" name="instagram" value="{{ agent.instagram if agent else '' }}">
              </div>

              <div class="field">
                <label>LinkedIn</label>
                <input type="text" name="linkedin" value="{{ agent.linkedin if agent else '' }}">
              </div>

              <div class="field">
                <label>TikTok</label>
                <input type="text" name="tiktok" value="{{ agent.tiktok if agent else '' }}">
              </div>

              <div class="field">
                <label>Telegram</label>
                <input type="text" name="telegram" value="{{ agent.telegram if agent else '' }}">
              </div>

              <div class="field">
                <label>YouTube</label>
                <input type="text" name="youtube" value="{{ agent.youtube if agent else '' }}">
              </div>

              <div class="field full">
                <div class="sep"></div>
              </div>

              <div class="field">
                <label>Foto profilo</label>
                <input type="file" name="photo" accept="image/*">
                {% if agent and agent.photo_url %}
                  <div class="hint">Attuale: <a href="{{ agent.photo_url }}" target="_blank" rel="noopener">Apri</a></div>
                {% endif %}
              </div>

              <div class="field">
                <label>Logo</label>
                <input type="file" name="logo" accept="image/*">
                {% if agent and agent.logo_url %}
                  <div class="hint">Attuale: <a href="{{ agent.logo_url }}" target="_blank" rel="noopener">Apri</a></div>
                {% endif %}
              </div>

              <div class="field">
                <label>Contenuto dietro avatar</label>
                <select name="back_media_mode" style="padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(8,12,20,.55);color:#fff;">
                  <option value="company" {% if agent and agent.back_media_mode=='company' %}selected{% endif %}>Logo aziendale</option>
                  <option value="personal" {% if agent and agent.back_media_mode=='personal' %}selected{% endif %}>Foto/Logo personale</option>
                </select>
                <div class="hint">Se “personale”, carica sotto.</div>
              </div>

              <div class="field">
                <label>File per retro avatar (solo se personale)</label>
                <input type="file" name="back_media" accept="image/*">
                {% if agent and agent.back_media_url %}
                  <div class="hint">Attuale: <a href="{{ agent.back_media_url }}" target="_blank" rel="noopener">Apri</a></div>
                {% endif %}
              </div>

              <div class="field full">
                <details>
                  <summary>Opzioni animazioni (orbita / flip / logo)</summary>
                  <div style="margin-top:10px;" class="grid-3">
                    <label class="btn-mini ghost" style="justify-content:flex-start;">
                      <input type="checkbox" name="orbit_spin" value="1" {% if agent and (agent.orbit_spin or 0)|int==1 %}checked{% endif %}>
                      Orbit spin
                    </label>
                    <label class="btn-mini ghost" style="justify-content:flex-start;">
                      <input type="checkbox" name="avatar_spin" value="1" {% if agent and (agent.avatar_spin or 0)|int==1 %}checked{% endif %}>
                      Auto flip avatar
                    </label>
                    <label class="btn-mini ghost" style="justify-content:flex-start;">
                      <input type="checkbox" name="logo_spin" value="1" {% if agent and (agent.logo_spin or 0)|int==1 %}checked{% endif %}>
                      Logo spin (retro)
                    </label>
                    <label class="btn-mini ghost" style="justify-content:flex-start;">
                      <input type="checkbox" name="allow_flip" value="1" {% if agent and (agent.allow_flip or 0)|int==1 %}checked{% endif %}>
                      Flip manuale (tap)
                    </label>
                  </div>
                </details>
              </div>

              <div class="field full">
                <div class="sep"></div>
              </div>

              <div class="field full">
                <details>
                  <summary>Media: Galleria, Video, PDF</summary>
                  <div style="margin-top:12px;" class="grid-2">
                    <div class="field">
                      <label>Foto galleria (max 30)</label>
                      <input type="file" name="gallery" accept="image/*" multiple>
                      {% if agent and agent.gallery_urls %}
                        <div class="hint">Già presenti: sì (puoi ricaricare per sostituire)</div>
                      {% endif %}
                    </div>
                    <div class="field">
                      <label>Video (max 10)</label>
                      <input type="file" name="videos" accept="video/*" multiple>
                      {% if agent and agent.video_urls %}
                        <div class="hint">Già presenti: sì (puoi ricaricare per sostituire)</div>
                      {% endif %}
                    </div>

                    <div class="field full">
                      <label>PDF (fino a 12 file)</label>
                      <div class="grid-3">
                        {% for i in range(1, 13) %}
                          <input type="file" name="pdf{{ i }}" accept="application/pdf">
                        {% endfor %}
                      </div>
                      {% if agent and agent.pdf1_url %}
                        <div class="hint">Già presenti: sì (puoi ricaricare per sostituire)</div>
                      {% endif %}
                    </div>
                  </div>
                </details>
              </div>

              <div class="field full">
                <details>
                  <summary>Traduzioni (EN/FR/ES/DE) — opzionali</summary>

                  {% set tr = i18n_data or {} %}
                  {% for L in ['en','fr','es','de'] %}
                    {% set d = tr.get(L, {}) %}
                    <div style="margin-top:12px;">
                      <div class="h3">Lingua: {{ L|upper }}</div>
                      <div class="grid-2">
                        <div class="field">
                          <label>Nome ({{ L|upper }})</label>
                          <input type="text" name="name_{{ L }}" value="{{ d.get('name','') }}">
                        </div>
                        <div class="field">
                          <label>Azienda ({{ L|upper }})</label>
                          <input type="text" name="company_{{ L }}" value="{{ d.get('company','') }}">
                        </div>
                        <div class="field">
                          <label>Ruolo ({{ L|upper }})</label>
                          <input type="text" name="role_{{ L }}" value="{{ d.get('role','') }}">
                        </div>
                        <div class="field">
                          <label>Indirizzi ({{ L|upper }})</label>
                          <input type="text" name="addresses_{{ L }}" value="{{ d.get('addresses','') }}">
                        </div>
                        <div class="field full">
                          <label>Bio ({{ L|upper }})</label>
                          <textarea name="bio_{{ L }}">{{ d.get('bio','') }}</textarea>
                        </div>
                      </div>
                      <div class="sep" style="margin-top:10px;"></div>
                    </div>
                  {% endfor %}
                </details>
              </div>

            </div>

            <div class="actions-footer" style="margin-top:14px;">
              <button class="btn primary" type="submit">Salva</button>
              <a class="btn ghost" href="{{ url_for('dashboard') }}">Annulla</a>
            </div>

          </form>

          <div class="footer">© 2026 Pay4You — Giuseppe Di Lisio</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Theme
    (function(){
      const KEY="p4y_theme";
      const saved = localStorage.getItem(KEY) || "auto";
      document.body.setAttribute("data-theme", saved === "auto" ? "" : saved);
    })();

    // Fix campi select in light theme (solo UI)
    (function(){
      const sel = document.querySelector('select[name="back_media_mode"]');
      if(!sel) return;
      function sync(){
        const theme = document.body.getAttribute("data-theme") || "";
        if(theme === "light"){
          sel.style.background = "#fff";
          sel.style.color = "#0f172a";
          sel.style.borderColor = "rgba(15,23,42,.14)";
        }
      }
      sync();
    })();
  </script>
</body>
</html>
