{% extends "base.html" %}

{% block title %}
  {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
{% endblock %}

{% block content %}
<div class="agent-form-wrapper">
  <h1 class="agent-form-title">
    {% if agent %}Modifica agente{% else %}Nuovo agente{% endif %}
  </h1>

  <form class="agent-form" method="post" enctype="multipart/form-data">

    <!-- Slug -->
    <label for="slug">Codice card (slug unico – senza spazi)</label>
    <input type="text" id="slug" name="slug"
           value="{{ agent.slug if agent else '' }}"
           placeholder="es: giuseppe" required>

    <!-- Nome -->
    <label for="name">Nome e Cognome</label>
    <input type="text" id="name" name="name"
           value="{{ agent.name if agent else '' }}" required>

    <!-- Azienda -->
    <label for="company">Azienda</label>
    <input type="text" id="company" name="company"
           value="{{ agent.company if agent else '' }}">

    <!-- Ruolo -->
    <label for="role">Ruolo</label>
    <input type="text" id="role" name="role"
           value="{{ agent.role if agent else '' }}">

    <!-- Bio -->
    <label for="bio">Descrizione breve (max 200 caratteri)</label>
    <textarea id="bio" name="bio" maxlength="200"
              placeholder="Breve descrizione professionale">{{ agent.bio if agent else '' }}</textarea>

    <!-- Contatti -->
    <label for="phone_mobile">Telefono mobile</label>
    <input type="tel" id="phone_mobile" name="phone_mobile"
           value="{{ agent.phone_mobile if agent else '' }}">

    <label for="phone_office">Telefono ufficio</label>
    <input type="tel" id="phone_office" name="phone_office"
           value="{{ agent.phone_office if agent else '' }}">

    <!-- EMAIL MULTIPLE -->
    <label for="emails">Email (separate da virgola)</label>
    <input type="text" id="emails" name="emails"
           value="{{ agent.emails if agent else '' }}"
           placeholder="es: nome@mail.it, info@mail.it">
    <small style="font-size:12px;color:#9ca3af;">
      Puoi inserire più email separate da virgola.
    </small>

    <!-- WEBSITES -->
    <label for="websites">Siti web (separati da virgola)</label>
    <input type="text" id="websites" name="websites"
           value="{{ agent.websites if agent else '' }}"
           placeholder="https://www.miosito.it, https://www.altro.it">

    <!-- Social -->
    <label for="facebook">Facebook (URL)</label>
    <input type="text" id="facebook" name="facebook"
           value="{{ agent.facebook if agent else '' }}">

    <label for="instagram">Instagram (URL)</label>
    <input type="text" id="instagram" name="instagram"
           value="{{ agent.instagram if agent else '' }}">

    <label for="linkedin">LinkedIn (URL)</label>
    <input type="text" id="linkedin" name="linkedin"
           value="{{ agent.linkedin if agent else '' }}">

    <label for="tiktok">TikTok (URL)</label>
    <input type="text" id="tiktok" name="tiktok"
           value="{{ agent.tiktok if agent else '' }}">

    <label for="telegram">Telegram (URL)</label>
    <input type="text" id="telegram" name="telegram"
           value="{{ agent.telegram if agent else '' }}">

    <!-- WhatsApp -->
    <label for="whatsapp">WhatsApp (numero)</label>
    <input type="text" id="whatsapp" name="whatsapp"
           value="{{ agent.whatsapp if agent else '' }}"
           placeholder="+39 333 1234567">

    <!-- PEC -->
    <label for="pec">PEC</label>
    <input type="email" id="pec" name="pec"
           value="{{ agent.pec if agent else '' }}">

    <!-- Dati fiscali -->
    <label for="piva">Partita IVA</label>
    <input type="text" id="piva" name="piva"
           value="{{ agent.piva if agent else '' }}">

    <label for="sdi">Codice SDI</label>
    <input type="text" id="sdi" name="sdi"
           value="{{ agent.sdi if agent else '' }}">

    <!-- Indirizzi (multi-linea) -->
    <label for="addresses">Indirizzi (uno per riga)</label>
    <textarea id="addresses" name="addresses"
              placeholder="Via, CAP, Città&#10;Secondo indirizzo">{{ agent.addresses if agent else '' }}</textarea>

    <!-- FOTO PROFILO -->
    <label for="photo">Foto profilo (consigliata 1000×1000 JPG/PNG)</label>
    <input type="file" id="photo" name="photo" accept="image/*">

    <!-- DOCUMENTI PDF -->
    <label>Documenti PDF (max 6)</label>
    {% for i in range(1, 7) %}
      <input type="file" name="pdf{{ i }}" accept="application/pdf">
    {% endfor %}
    <small style="font-size:12px;color:#9ca3af;">Caricando almeno un nuovo PDF, sostituirai la lista esistente.</small>

    <!-- GALLERIA FOTO -->
    <label>Galleria foto (fino a 12 immagini)</label>
    <input type="file" name="gallery" accept="image/*" multiple>
    <small style="font-size:12px;color:#9ca3af;">
      Se carichi nuove immagini, la galleria precedente verrà sostituita.
    </small>

    <!-- BOTTONI -->
    <div class="agent-form-buttons">
      <button type="submit">
        {% if agent %}Aggiorna agente{% else %}Crea agente{% endif %}
      </button>
      <a class="btn-secondary" href="{{ url_for('admin_home') }}">Annulla</a>
    </div>

  </form>
</div>

<!-- MODAL RITAGLIO FOTO -->
<div id="cropper-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h2>Ritaglia la foto profilo</h2>
    <div style="max-width: 360px; max-height: 360px; margin: 0 auto;">
      <img id="cropper-image"
           src=""
           alt="Anteprima foto"
           style="max-width:100%; display:block;">
    </div>
    <div class="agent-form-buttons" style="justify-content:center; margin-top:12px;">
      <button type="button" id="cropper-confirm">Usa questa foto</button>
      <button type="button" class="btn-secondary" id="cropper-cancel">Annulla</button>
    </div>
  </div>
</div>

<!-- Cropper.js -->
<link rel="stylesheet"
      href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css">
<script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>

<script>
  (function () {
    const inputPhoto   = document.getElementById("photo");
    const modal        = document.getElementById("cropper-modal");
    const image        = document.getElementById("cropper-image");
    const btnConfirm   = document.getElementById("cropper-confirm");
    const btnCancel    = document.getElementById("cropper-cancel");
    let cropper        = null;
    let originalFile   = null;

    if (!inputPhoto) return;

    // Quando selezioni una foto
    inputPhoto.addEventListener("change", function (e) {
      const files = e.target.files;
      if (!files || !files.length) return;

      originalFile = files[0];

      const reader = new FileReader();
      reader.onload = function (ev) {
        image.src = ev.target.result;

        // Mostra il modal
        modal.style.display = "flex";

        // Distruggi cropper precedente se esiste
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }

        // Inizializza Cropper con cerchio più grande e centrato
        cropper = new Cropper(image, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: "move",
          background: false,
          responsive: true,
          autoCropArea: 0.9,
          movable: true,
          zoomable: true,
          scalable: false,
          cropBoxResizable: false,
          minCropBoxWidth: 280,
          minCropBoxHeight: 280,
          ready() {
            const data = cropper.getContainerData();
            const boxSize = Math.min(data.width, data.height) * 0.75;

            cropper.setCropBoxData({
              left: (data.width  - boxSize) / 2,
              top:  (data.height - boxSize) / 2,
              width: boxSize,
              height: boxSize
            });

            // leggero zoom iniziale sul volto
            cropper.zoomTo(1.2);
          }
        });
      };
      reader.readAsDataURL(originalFile);
    });

    // Conferma ritaglio
    btnConfirm.addEventListener("click", function () {
      if (!cropper || !originalFile) {
        modal.style.display = "none";
        return;
      }

      const canvas = cropper.getCroppedCanvas({
        width: 1000,
        height: 1000
      });

      canvas.toBlob(function (blob) {
        if (!blob) {
          modal.style.display = "none";
          return;
        }

        const fileName = originalFile.name || "avatar.jpg";
        const croppedFile = new File([blob], fileName, { type: blob.type });

        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(croppedFile);
        inputPhoto.files = dataTransfer.files;

        modal.style.display = "none";
        cropper.destroy();
        cropper = null;
      }, "image/jpeg", 0.92);
    });

    // Annulla ritaglio
    btnCancel.addEventListener("click", function () {
      modal.style.display = "none";
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      // Se vuoi, puoi anche svuotare il file selezionato:
      // inputPhoto.value = "";
    });
  })();
</script>
{% endblock %}
