<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Modifica {{ profile|upper }} | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">Profilo {{ profile|upper }}</div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">‚Üê Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">Modifica Profilo {{ profile|upper }}</h1>
            <div class="hint">
              {% if profile != "p1" %}
                Questo profilo √® indipendente: pu√≤ essere diverso da P1.
              {% else %}
                Profilo principale (sempre attivo).
              {% endif %}
            </div>
          </div>
          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}">Apri P1</a>
              {% if agent.p2_enabled == 1 %}<a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p2">Apri P2</a>{% endif %}
              {% if agent.p3_enabled == 1 %}<a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p3">Apri P3</a>{% endif %}
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        <form method="post" enctype="multipart/form-data" class="card-form">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field">
                <label>Slug</label>
                <input type="text" value="{{ agent.slug }}" readonly>
              </div>
              <div class="field">
                <label>Profilo</label>
                <input type="text" value="{{ profile|upper }}" readonly>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ===== Effetti (come prima) ===== -->
          <div class="section-box">
            <div class="h3">Effetti grafici</div>
            <div class="hint">Le opzioni ‚Äúruota‚Äù e ‚Äúflip‚Äù si escludono automaticamente.</div>

            <div class="form-grid">
              <div class="field">
                <label><input type="checkbox" name="orbit_spin" {% if vis and vis.orbit_spin == 1 %}checked{% endif %}> Ruota orbita</label>
              </div>
              <div class="field">
                <label><input type="checkbox" name="logo_spin" {% if vis and vis.logo_spin == 1 %}checked{% endif %}> Ruota logo</label>
              </div>
              <div class="field">
                <label><input type="checkbox" name="avatar_spin" {% if vis and vis.avatar_spin == 1 %}checked{% endif %}> Ruota foto</label>
              </div>
              <div class="field">
                <label><input type="checkbox" name="allow_flip" {% if vis and vis.allow_flip == 1 %}checked{% endif %}> Flip card</label>
              </div>
            </div>
          </div>

          <!-- ===== Dati ===== -->
          <div class="section-box">
            <div class="h3">Dati principali</div>
            <div class="form-grid">
              <div class="field"><label>Nome</label><input type="text" name="name" value="{{ data.get('name','') }}"></div>
              <div class="field"><label>Azienda</label><input type="text" name="company" value="{{ data.get('company','') }}"></div>
              <div class="field"><label>Ruolo</label><input type="text" name="role" value="{{ data.get('role','') }}"></div>
              <div class="field"><label>Bio</label><textarea name="bio">{{ data.get('bio','') }}</textarea></div>
            </div>
          </div>

          <!-- ===== Foto + Logo + Background + Crop ===== -->
          <div class="section-box">
            <div class="h3">Foto / Logo / Background</div>

            <div class="form-grid">
              <div class="field">
                <label>Foto personale</label>
                <input id="photoInput" type="file" name="photo" accept="image/*">
              </div>
              <div class="field">
                <label>Logo</label>
                <input id="logoInput" type="file" name="logo" accept="image/*">
              </div>
              <div class="field full">
                <label>Background (immagine)</label>
                <input id="backInput" type="file" name="back_media" accept="image/*">
                <div class="hint">Se vuoto: usa sfondo ‚Äúazienda‚Äù.</div>
              </div>
              <div class="field full">
                <label>Background mode</label>
                <select name="back_media_mode">
                  <option value="company" {% if vis and vis.back_media_mode == 'company' %}selected{% endif %}>Azienda</option>
                  <option value="custom" {% if vis and vis.back_media_mode == 'custom' %}selected{% endif %}>Custom</option>
                </select>
              </div>
            </div>

            <div class="hint" style="margin-top:8px">
              Preview foto: se non carichi una foto, usa il logo (cos√¨ P2/P3 ‚Äúvuoti‚Äù non mostrano P1).
            </div>

            <div class="crop-preview">
              <div class="crop-circle-bg" id="cropCircleBg"
                   data-url="{{ preview_photo or '' }}"
                   data-x="{{ (vis.photo_pos_x if vis else 50) }}"
                   data-y="{{ (vis.photo_pos_y if vis else 35) }}"
                   data-z="{{ (vis.photo_zoom if vis else '1.0') }}">
                <div class="crop-empty" id="cropEmptyBg" style="display:none">Nessuna immagine</div>
              </div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>X (0‚Äì100)</label>
                <input id="posX" type="range" min="0" max="100" name="photo_pos_x" value="{{ (vis.photo_pos_x if vis else 50) }}">
              </div>
              <div class="field">
                <label>Y (0‚Äì100)</label>
                <input id="posY" type="range" min="0" max="100" name="photo_pos_y" value="{{ (vis.photo_pos_y if vis else 35) }}">
              </div>
              <div class="field full">
                <label>Zoom (1.0‚Äì2.5)</label>
                <input id="zoom" type="range" min="1" max="2.5" step="0.05" name="photo_zoom" value="{{ (vis.photo_zoom if vis else '1.0') }}">
              </div>
            </div>
          </div>

          <!-- ===== Contatti ===== -->
          <div class="section-box">
            <div class="h3">Contatti</div>
            <div class="form-grid">
              <div class="field"><label>Cellulare</label><input type="text" name="phone_mobile" value="{{ data.get('phone_mobile','') }}"></div>
              <div class="field"><label>Cellulare 2</label><input type="text" name="phone_mobile2" value="{{ data.get('phone_mobile2','') }}"></div>
              <div class="field"><label>Telefono ufficio</label><input type="text" name="phone_office" value="{{ data.get('phone_office','') }}"></div>
              <div class="field"><label>WhatsApp</label><input type="text" name="whatsapp" value="{{ data.get('whatsapp','') }}"></div>

              <div class="field full"><label>Email (virgola)</label><input type="text" name="emails" value="{{ data.get('emails','') }}"></div>
              <div class="field full"><label>Siti (virgola)</label><input type="text" name="websites" value="{{ data.get('websites','') }}"></div>

              <div class="field"><label>PEC</label><input type="text" name="pec" value="{{ data.get('pec','') }}"></div>
              <div class="field full"><label>Indirizzi (1 per riga)</label><textarea name="addresses">{{ data.get('addresses','') }}</textarea></div>
            </div>
          </div>

          <!-- ===== Social ===== -->
          <div class="section-box">
            <div class="h3">Social</div>
            <div class="form-grid">
              <div class="field"><label>Facebook</label><input type="text" name="facebook" value="{{ data.get('facebook','') }}"></div>
              <div class="field"><label>Instagram</label><input type="text" name="instagram" value="{{ data.get('instagram','') }}"></div>
              <div class="field"><label>LinkedIn</label><input type="text" name="linkedin" value="{{ data.get('linkedin','') }}"></div>
              <div class="field"><label>TikTok</label><input type="text" name="tiktok" value="{{ data.get('tiktok','') }}"></div>
              <div class="field"><label>Telegram</label><input type="text" name="telegram" value="{{ data.get('telegram','') }}"></div>
              <div class="field"><label>YouTube</label><input type="text" name="youtube" value="{{ data.get('youtube','') }}"></div>
              <div class="field"><label>Spotify</label><input type="text" name="spotify" value="{{ data.get('spotify','') }}"></div>
            </div>
          </div>

          <!-- ===== MEDIA ===== -->
          <div class="section-box">
            <div class="h3">Media</div>
            <div class="hint">
              Limiti: {{ limits.max_imgs }} foto, {{ limits.max_vids }} video, {{ limits.max_pdfs }} PDF.
            </div>

            <!-- Upload -->
            <div class="form-grid">
              <div class="field full">
                <label>Carica foto galleria</label>
                <input type="file" name="gallery" multiple accept="image/*">
              </div>
              <div class="field full">
                <label>Carica video</label>
                <input type="file" name="videos" multiple accept="video/*">
              </div>
            </div>

            <!-- Griglia: NIENTE X -->
            <div class="media-grid" style="margin-top:10px">
              {% for g in gallery %}
                <div class="media-item">
                  <img src="{{ g }}" alt="" onclick="openViewer('gallery','{{ g }}','{{ agent.slug }}',{{ loop.index0 }},'{{ profile }}')">
                </div>
              {% endfor %}
              {% for v in videos %}
                <div class="media-item">
                  <video src="{{ v }}#t=0.1" muted playsinline preload="metadata"
                         onclick="openViewer('video','{{ v }}','{{ agent.slug }}',{{ loop.index0 }},'{{ profile }}')"></video>
                  <div class="media-play">‚ñ∂</div>
                </div>
              {% endfor %}
              {% if gallery|length == 0 and videos|length == 0 %}
                <div class="dash-mini-empty" style="width:100%">Nessuna foto/video</div>
              {% endif %}
            </div>

            <!-- PDF -->
            <div class="sep" style="margin:14px 0"></div>
            <div class="h3">PDF (max {{ limits.max_pdfs }})</div>
            <div class="form-grid">
              {% for i in range(1, limits.max_pdfs + 1) %}
                <div class="field">
                  <label>PDF {{ i }}</label>
                  <input type="file" name="pdf{{ i }}" accept="application/pdf">
                </div>
              {% endfor %}
            </div>

            <div class="pdf-preview" style="margin-top:10px">
              {% for p in pdfs %}
                <div class="pdf-row" onclick="openViewer('pdf','{{ p.url }}','{{ agent.slug }}',{{ loop.index0 }},'{{ profile }}')">
                  <div class="pdf-name">{{ p.name }}</div>
                </div>
              {% endfor %}
              {% if pdfs|length == 0 %}
                <div class="dash-mini-empty">Nessun PDF</div>
              {% endif %}
            </div>
          </div>

          <!-- ===== TRADUZIONI (come volevi) ===== -->
          <div class="section-box">
            <div class="h3">Traduzioni</div>
            <div class="hint">4 righe: clicca la lingua e si apre la traduzione.</div>

            <details class="section-box" style="margin-top:10px; padding:12px 14px;">
              <summary style="cursor:pointer; font-weight:950;">üá¨üáß English</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Name</label><input type="text" name="name_en" value="{{ i18n_data.get('en',{}).get('name','') }}"></div>
                <div class="field"><label>Company</label><input type="text" name="company_en" value="{{ i18n_data.get('en',{}).get('company','') }}"></div>
                <div class="field"><label>Role</label><input type="text" name="role_en" value="{{ i18n_data.get('en',{}).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_en">{{ i18n_data.get('en',{}).get('bio','') }}</textarea></div>
                <div class="field full"><label>Addresses</label><textarea name="addresses_en">{{ i18n_data.get('en',{}).get('addresses','') }}</textarea></div>
              </div>
            </details>

            <details class="section-box" style="margin-top:10px; padding:12px 14px;">
              <summary style="cursor:pointer; font-weight:950;">üá´üá∑ Fran√ßais</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Nom</label><input type="text" name="name_fr" value="{{ i18n_data.get('fr',{}).get('name','') }}"></div>
                <div class="field"><label>Soci√©t√©</label><input type="text" name="company_fr" value="{{ i18n_data.get('fr',{}).get('company','') }}"></div>
                <div class="field"><label>R√¥le</label><input type="text" name="role_fr" value="{{ i18n_data.get('fr',{}).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_fr">{{ i18n_data.get('fr',{}).get('bio','') }}</textarea></div>
                <div class="field full"><label>Adresses</label><textarea name="addresses_fr">{{ i18n_data.get('fr',{}).get('addresses','') }}</textarea></div>
              </div>
            </details>

            <details class="section-box" style="margin-top:10px; padding:12px 14px;">
              <summary style="cursor:pointer; font-weight:950;">üá™üá∏ Espa√±ol</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Nombre</label><input type="text" name="name_es" value="{{ i18n_data.get('es',{}).get('name','') }}"></div>
                <div class="field"><label>Empresa</label><input type="text" name="company_es" value="{{ i18n_data.get('es',{}).get('company','') }}"></div>
                <div class="field"><label>Rol</label><input type="text" name="role_es" value="{{ i18n_data.get('es',{}).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_es">{{ i18n_data.get('es',{}).get('bio','') }}</textarea></div>
                <div class="field full"><label>Direcciones</label><textarea name="addresses_es">{{ i18n_data.get('es',{}).get('addresses','') }}</textarea></div>
              </div>
            </details>

            <details class="section-box" style="margin-top:10px; padding:12px 14px;">
              <summary style="cursor:pointer; font-weight:950;">üá©üá™ Deutsch</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Name</label><input type="text" name="name_de" value="{{ i18n_data.get('de',{}).get('name','') }}"></div>
                <div class="field"><label>Firma</label><input type="text" name="company_de" value="{{ i18n_data.get('de',{}).get('company','') }}"></div>
                <div class="field"><label>Rolle</label><input type="text" name="role_de" value="{{ i18n_data.get('de',{}).get('role','') }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_de">{{ i18n_data.get('de',{}).get('bio','') }}</textarea></div>
                <div class="field full"><label>Adressen</label><textarea name="addresses_de">{{ i18n_data.get('de',{}).get('addresses','') }}</textarea></div>
              </div>
            </details>
          </div>

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>
      </div>
    </div>
  </main>
</div>

<!-- ===== VIEWER con ELIMINA DENTRO (come vuoi tu) ===== -->
<div id="viewer" class="modal-overlay" style="display:none" onclick="overlayCloseViewer(event)">
  <div class="modal-box modal-big" onclick="event.stopPropagation()">
    <div class="modal-title" id="viewerTitle">Anteprima</div>

    <img id="vImg" style="display:none" src="" alt="">
    <video id="vVideo" style="display:none" controls playsinline></video>

    <!-- PDF: aggiungo parametri per stabilit√† (niente grafica che salta) -->
    <iframe id="vPdf" style="display:none" src="" loading="lazy"></iframe>

    <form id="deleteForm" method="post" style="display:none"></form>

    <div class="modal-actions" style="margin-top:12px">
      <button class="btn danger" type="button" onclick="deleteCurrent()">Elimina</button>
      <button class="btn" type="button" onclick="shareViewer('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareViewer('email')">Invia Email</button>
      <button class="btn ghost" type="button" onclick="closeViewer()">Chiudi</button>
    </div>
  </div>
</div>

<script>
  // ===== CROP PREVIEW =====
  document.addEventListener('DOMContentLoaded', () => {
    const box = document.getElementById('cropCircleBg');
    if(!box) return;

    const posX = document.getElementById('posX');
    const posY = document.getElementById('posY');
    const zoom = document.getElementById('zoom');
    const photoInput = document.getElementById('photoInput');
    const empty = document.getElementById('cropEmptyBg');

    function apply(){
      const url = box.getAttribute('data-url') || '';
      const x = posX ? posX.value : (box.getAttribute('data-x') || 50);
      const y = posY ? posY.value : (box.getAttribute('data-y') || 35);
      const z = zoom ? zoom.value : (box.getAttribute('data-z') || 1.0);

      if(!url){
        box.style.backgroundImage = 'none';
        if(empty) empty.style.display = 'flex';
        return;
      }
      if(empty) empty.style.display = 'none';

      box.style.backgroundImage = `url("${url}")`;
      box.style.backgroundRepeat = 'no-repeat';
      box.style.backgroundPosition = `${x}% ${y}%`;
      box.style.backgroundSize = `${parseFloat(z) * 100}% ${parseFloat(z) * 100}%`;
    }

    apply();
    if(posX){ posX.addEventListener('input', apply); posX.addEventListener('change', apply); }
    if(posY){ posY.addEventListener('input', apply); posY.addEventListener('change', apply); }
    if(zoom){ zoom.addEventListener('input', apply); zoom.addEventListener('change', apply); }

    // se carichi una nuova foto, preview immediata (solo UI)
    if(photoInput){
      photoInput.addEventListener('change', () => {
        const f = photoInput.files && photoInput.files[0];
        if(!f) return;
        const u = URL.createObjectURL(f);
        box.setAttribute('data-url', u);
        apply();
      });
    }
  });

  function absUrl(u){
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&su=${su}&body=${bd}`;
  }
  function outlookCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://outlook.office.com/mail/deeplink/compose?subject=${su}&body=${bd}`;
  }
  function mailtoCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `mailto:?subject=${su}&body=${bd}`;
  }

  // ===== VIEWER =====
  let viewerState = { slug:'', type:'', idx:-1, url:'', profile:'p1' };

  function openViewer(type, url, slug, idx, profile){
    viewerState = { slug, type, idx, url: url, profile: profile || 'p1' };

    const modal = document.getElementById('viewer');
    const vImg = document.getElementById('vImg');
    const vVideo = document.getElementById('vVideo');
    const vPdf = document.getElementById('vPdf');

    vImg.style.display = 'none';
    vVideo.style.display = 'none';
    vPdf.style.display = 'none';
    try{ vVideo.pause(); }catch(e){}

    document.getElementById('viewerTitle').textContent =
      `Anteprima ‚Ä¢ ${type.toUpperCase()} ‚Ä¢ ${viewerState.profile.toUpperCase()}`;

    if(type === 'gallery'){
      vImg.src = url;
      vImg.style.display = 'block';
    } else if(type === 'video'){
      vVideo.src = url;
      vVideo.style.display = 'block';
    } else {
      // ‚úÖ PDF stabile: evita zoom strani/toolbar
      const pdfUrl = url + (url.includes('#') ? '' : '#view=FitH&toolbar=0&navpanes=0');
      vPdf.src = pdfUrl;
      vPdf.style.display = 'block';
    }
    modal.style.display = 'flex';
  }

  function closeViewer(){
    const modal = document.getElementById('viewer');
    const vVideo = document.getElementById('vVideo');
    try{ vVideo.pause(); }catch(e){}
    modal.style.display = 'none';
  }
  function overlayCloseViewer(e){
    if(e.target && e.target.id === 'viewer'){
      closeViewer();
    }
  }

  // ‚úÖ elimina SOLO dal viewer
  function deleteCurrent(){
    const ok = confirm("Eliminare questo elemento? Non sar√† pi√π ripristinabile.");
    if(!ok) return;

    const form = document.getElementById('deleteForm');
    form.innerHTML = '';
    form.action = `/area/media/delete/${viewerState.slug}`;
    form.method = 'post';

    const a = (name, value) => {
      const i = document.createElement('input');
      i.type = 'hidden'; i.name = name; i.value = value;
      form.appendChild(i);
    };

    a('type', viewerState.type === 'gallery' ? 'gallery' : (viewerState.type === 'video' ? 'video' : 'pdf'));
    a('idx', String(viewerState.idx));
    a('profile', viewerState.profile);

    form.submit();
  }

  function shareViewer(channel){
    const kind = (viewerState.type || '').toUpperCase();
    const slug = viewerState.slug || '';
    const prof = (viewerState.profile || 'p1').toUpperCase();
    const mediaUrl = absUrl(viewerState.url || '');

    const msg = [
      `Pay4You Media ${kind} (${prof})`,
      `Slug: ${slug}`,
      `Link: ${mediaUrl}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    // ‚úÖ s√¨: aprire Gmail e precompilare va BENISSIMO.
    // metto anche fallback (Outlook / mailto) se serve.
    const subject = `Pay4You Media ${kind} ${slug ? slug.toUpperCase() : ''} ${prof}`.trim();
    const g = gmailCompose(subject, msg);
    const w = window.open(g, '_blank');
    if(!w){
      // popup bloccato ‚Üí fallback
      window.location.href = outlookCompose(subject, msg);
      setTimeout(()=>{ window.location.href = mailtoCompose(subject, msg); }, 700);
    }
  }
</script>

</body>
</html>
