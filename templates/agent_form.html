{% extends "base.html" %}
{% block title %}
  {% if agent %}
    {% if editing_profile2 %}Modifica Profilo 2{% else %}Modifica Profilo 1{% endif %} | Pay4You
  {% else %}
    Nuova Card | Pay4You
  {% endif %}
{% endblock %}

{% block content %}
<div class="form-wrap">

  <div class="form-head">
    <div>
      <h1 class="form-title">
        {% if agent %}
          {% if editing_profile2 %}Modifica Profilo 2{% else %}Modifica Profilo 1{% endif %}
        {% else %}
          Crea nuova Card
        {% endif %}
      </h1>

      <div class="form-sub">
        {% if editing_profile2 %}
          Questo è il Profilo 2 (se attivo). Può essere completamente diverso dal Profilo 1.
        {% else %}
          Dati della card (Profilo 1).
        {% endif %}
      </div>

      {% if not agent and session.get('role') == 'admin' %}
        <!-- ✅ MODIFICA RICHIESTA: hint chiara sullo slug / dominio -->
        <div class="hint-box">
          <strong>Slug</strong>: è la parte finale del link della card.<br>
          Esempio: <span class="mono">https://TUO-DOMINIO/</span><span class="mono">mario-rossi</span><br>
          Usa solo lettere, numeri e trattini (niente spazi).
        </div>
      {% endif %}
    </div>

    <div class="form-actions">
      {% if session.get('role') == 'admin' %}
        <a class="btn-mini ghost" href="{{ url_for('dashboard') }}">← Dashboard</a>
      {% else %}
        <a class="btn-mini ghost" href="{{ url_for('dashboard') }}">← Dashboard</a>
        {% if editing_profile2 %}
          <a class="btn-mini ghost" href="{{ url_for('me_edit') }}">Profilo 1</a>
        {% else %}
          {% if agent and agent.p2_enabled == 1 %}
            <a class="btn-mini ghost" href="{{ url_for('me_profile2') }}">Profilo 2</a>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="card-form">

    {% if session.get('role') == 'admin' and not agent %}
      <div class="grid-2">
        <div class="field">
          <label>Slug (obbligatorio)</label>
          <input name="slug" type="text" placeholder="es: mario-rossi" required>
          <div class="mini-help">Verrà creato anche l’utente di accesso con lo stesso nome.</div>
        </div>

        <div class="field">
          <label>Nome (obbligatorio)</label>
          <input name="name" type="text" placeholder="Nome e Cognome" required>
        </div>
      </div>
    {% endif %}

    <!-- Dati principali -->
    <div class="grid-2">
      <div class="field">
        <label>Nome</label>
        <input name="name" type="text" value="{{ agent.name if agent else '' }}" {% if session.get('role')=='admin' and not agent %}disabled{% endif %}>
        <div class="mini-help">Per P2 può essere diverso dal P1.</div>
      </div>

      <div class="field">
        <label>Azienda</label>
        <input name="company" type="text" value="{{ agent.company if agent and agent.company else '' }}">
      </div>

      <div class="field">
        <label>Ruolo</label>
        <input name="role" type="text" value="{{ agent.role if agent and agent.role else '' }}">
      </div>

      <div class="field">
        <label>Bio</label>
        <textarea name="bio" rows="3" placeholder="Breve descrizione...">{{ agent.bio if agent and agent.bio else '' }}</textarea>
      </div>
    </div>

    <!-- Contatti -->
    <div class="section-box">
      <div class="section-title">Contatti</div>

      <div class="grid-2">
        <div class="field">
          <label>Cellulare</label>
          <input name="phone_mobile" type="text" value="{{ agent.phone_mobile if agent and agent.phone_mobile else '' }}" placeholder="+39 ...">
        </div>

        <div class="field">
          <label>Cellulare 2</label>
          <input name="phone_mobile2" type="text" value="{{ agent.phone_mobile2 if agent and agent.phone_mobile2 else '' }}" placeholder="+39 ...">
        </div>

        <div class="field">
          <label>Ufficio</label>
          <input name="phone_office" type="text" value="{{ agent.phone_office if agent and agent.phone_office else '' }}">
        </div>

        <div class="field">
          <label>WhatsApp (link o numero)</label>
          <input name="whatsapp" type="text" value="{{ agent.whatsapp if agent and agent.whatsapp else '' }}" placeholder="es: +39333... oppure https://wa.me/...">
        </div>

        <div class="field">
          <label>Email (separate da virgola)</label>
          <input name="emails" type="text" value="{{ agent.emails if agent and agent.emails else '' }}" placeholder="mail1@... , mail2@...">
        </div>

        <div class="field">
          <label>Siti (separati da virgola)</label>
          <input name="websites" type="text" value="{{ agent.websites if agent and agent.websites else '' }}" placeholder="pay4you.store, ...">
        </div>

        <div class="field">
          <label>PEC</label>
          <input name="pec" type="text" value="{{ agent.pec if agent and agent.pec else '' }}">
        </div>

        <div class="field">
          <label>Indirizzi (uno per riga)</label>
          <textarea name="addresses" rows="3" placeholder="Via..., Città...">{{ agent.addresses if agent and agent.addresses else '' }}</textarea>
        </div>
      </div>
    </div>

    <!-- Dati fiscali -->
    <div class="section-box">
      <div class="section-title">Dati</div>
      <div class="grid-2">
        <div class="field">
          <label>P.IVA</label>
          <input name="piva" type="text" value="{{ agent.piva if agent and agent.piva else '' }}">
        </div>
        <div class="field">
          <label>SDI</label>
          <input name="sdi" type="text" value="{{ agent.sdi if agent and agent.sdi else '' }}">
        </div>
      </div>
    </div>

    <!-- Social -->
    <div class="section-box">
      <div class="section-title">Social</div>
      <div class="grid-2">
        <div class="field"><label>Facebook</label><input name="facebook" type="text" value="{{ agent.facebook if agent and agent.facebook else '' }}"></div>
        <div class="field"><label>Instagram</label><input name="instagram" type="text" value="{{ agent.instagram if agent and agent.instagram else '' }}"></div>
        <div class="field"><label>LinkedIn</label><input name="linkedin" type="text" value="{{ agent.linkedin if agent and agent.linkedin else '' }}"></div>
        <div class="field"><label>TikTok</label><input name="tiktok" type="text" value="{{ agent.tiktok if agent and agent.tiktok else '' }}"></div>
        <div class="field"><label>Telegram</label><input name="telegram" type="text" value="{{ agent.telegram if agent and agent.telegram else '' }}"></div>
        <div class="field"><label>YouTube</label><input name="youtube" type="text" value="{{ agent.youtube if agent and agent.youtube else '' }}"></div>
        <div class="field"><label>Spotify</label><input name="spotify" type="text" value="{{ agent.spotify if agent and agent.spotify else '' }}"></div>
      </div>
    </div>

    <!-- Media avatar/logo/back -->
    <div class="section-box">
      <div class="section-title">Immagini</div>

      <div class="grid-2">
        <div class="field">
          <label>Foto profilo (upload)</label>
          <input name="photo" type="file" accept="image/*">
          {% if agent and agent.photo_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.photo_url }}</span></div>
          {% endif %}
        </div>

        <div class="field">
          <label>Logo (upload)</label>
          <input name="logo" type="file" accept="image/*">
          {% if agent and agent.logo_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.logo_url }}</span></div>
          {% endif %}
        </div>

        <div class="field">
          <label>Contenuto dietro foto</label>
          <select name="back_media_mode">
            {% set bm = (agent.back_media_mode if agent and agent.back_media_mode else 'company') %}
            <option value="company" {% if bm=='company' %}selected{% endif %}>Logo aziendale</option>
            <option value="personal" {% if bm=='personal' %}selected{% endif %}>Foto/Logo personale</option>
          </select>
        </div>

        <div class="field">
          <label>Upload retro (solo se “personale”)</label>
          <input name="back_media" type="file" accept="image/*">
          {% if agent and agent.back_media_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.back_media_url }}</span></div>
          {% endif %}
        </div>
      </div>

      <!-- Crop -->
      <div class="grid-3">
        <div class="field">
          <label>Crop X (0–100)</label>
          <input name="photo_pos_x" type="number" min="0" max="100" step="1"
                 value="{{ agent.photo_pos_x if agent and agent.photo_pos_x is not none else 50 }}">
        </div>
        <div class="field">
          <label>Crop Y (0–100)</label>
          <input name="photo_pos_y" type="number" min="0" max="100" step="1"
                 value="{{ agent.photo_pos_y if agent and agent.photo_pos_y is not none else 35 }}">
        </div>
        <div class="field">
          <label>Zoom (1.0–2.6)</label>
          <input name="photo_zoom" type="number" min="1" max="2.6" step="0.05"
                 value="{{ agent.photo_zoom if agent and agent.photo_zoom is not none else 1.0 }}">
        </div>
      </div>
    </div>

    <!-- Effetti -->
    <div class="section-box">
      <div class="section-title">Effetti</div>

      <div class="check-grid">
        {% set orbit = 1 if agent and (agent.orbit_spin or 0) == 1 else 0 %}
        {% set aspin = 1 if agent and (agent.avatar_spin or 0) == 1 else 0 %}
        {% set lspin = 1 if agent and (agent.logo_spin or 0) == 1 else 0 %}
        {% set flip  = 1 if agent and (agent.allow_flip or 0) == 1 else 0 %}

        <label class="check">
          <input type="checkbox" name="orbit_spin" {% if orbit==1 %}checked{% endif %}>
          <span>Orbit logo (ruota dietro)</span>
        </label>

        <label class="check">
          <input type="checkbox" name="avatar_spin" {% if aspin==1 %}checked{% endif %}>
          <span>Ruota foto</span>
        </label>

        <label class="check">
          <input type="checkbox" name="logo_spin" {% if lspin==1 %}checked{% endif %}>
          <span>Ruota logo sul retro</span>
        </label>

        <label class="check">
          <input type="checkbox" name="allow_flip" {% if flip==1 %}checked{% endif %}>
          <span>Flip (tap per retro)</span>
        </label>
      </div>

      <div class="mini-help">
        Nota: se attivi “Ruota foto” il flip viene disabilitato automaticamente.
      </div>
    </div>

    <!-- Gallery / video / pdf -->
    <div class="section-box">
      <div class="section-title">Media (foto / video / PDF)</div>

      <div class="grid-2">
        <div class="field">
          <label>Galleria foto (max {{ 30 }})</label>
          <input name="gallery" type="file" accept="image/*" multiple>
          {% if agent and agent.gallery_urls %}
            <div class="mini-help">Già presenti: sì (sovrascrive se ricarichi)</div>
          {% endif %}
        </div>

        <div class="field">
          <label>Video (max {{ 10 }})</label>
          <input name="videos" type="file" accept="video/*" multiple>
          {% if agent and agent.video_urls %}
            <div class="mini-help">Già presenti: sì (sovrascrive se ricarichi)</div>
          {% endif %}
        </div>
      </div>

      <div class="field">
        <label>PDF (fino a 12)</label>
        <div class="grid-3">
          {% for i in range(1,13) %}
            <div class="field mini">
              <label>PDF {{ i }}</label>
              <input name="pdf{{ i }}" type="file" accept="application/pdf">
            </div>
          {% endfor %}
        </div>
        {% if agent and agent.pdf1_url %}
          <div class="mini-help">Già presenti: sì (aggiunge/sovrascrive quelli che ricarichi)</div>
        {% endif %}
      </div>
    </div>

    <!-- i18n -->
    {% if session.get('role') == 'admin' %}
    <div class="section-box">
      <div class="section-title">Traduzioni (opzionali)</div>
      <div class="mini-help">Solo per la card pubblica quando lang=en/fr/es/de.</div>

      {% for L in ['en','fr','es','de'] %}
        {% set d = (i18n_data.get(L) if i18n_data and i18n_data.get(L) else {}) %}
        <div class="lang-box">
          <div class="lang-title">{{ L|upper }}</div>
          <div class="grid-2">
            <div class="field"><label>Nome</label><input name="name_{{L}}" value="{{ d.get('name','') }}"></div>
            <div class="field"><label>Azienda</label><input name="company_{{L}}" value="{{ d.get('company','') }}"></div>
            <div class="field"><label>Ruolo</label><input name="role_{{L}}" value="{{ d.get('role','') }}"></div>
            <div class="field"><label>Bio</label><textarea name="bio_{{L}}" rows="2">{{ d.get('bio','') }}</textarea></div>
            <div class="field" style="grid-column:1/-1"><label>Indirizzi</label><textarea name="addresses_{{L}}" rows="2">{{ d.get('addresses','') }}</textarea></div>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Submit -->
    <div class="sticky-save">
      <button class="btn primary" type="submit">
        {% if agent %}
          {% if editing_profile2 %}Salva Profilo 2{% else %}Salva Profilo 1{% endif %}
        {% else %}
          Crea Card
        {% endif %}
      </button>

      {% if session.get('role') == 'admin' %}
        <a class="btn ghost" href="{{ url_for('dashboard') }}">Annulla</a>
      {% else %}
        {% if editing_profile2 %}
          <a class="btn ghost" href="{{ url_for('me_profile2') }}">Ricarica</a>
        {% else %}
          <a class="btn ghost" href="{{ url_for('me_edit') }}">Ricarica</a>
        {% endif %}
      {% endif %}
    </div>

  </form>

  <div class="footer">© 2026 Pay4You — Giuseppe Di Lisio</div>
</div>
{% endblock %}
