{% extends "base.html" %}
{% block title %}
  {% if agent %}
    {% if editing_profile2 %}Modifica Profilo 2{% else %}Modifica Profilo 1{% endif %} | Pay4You
  {% else %}
    Nuova Card | Pay4You
  {% endif %}
{% endblock %}

{% block content %}
<div class="form-wrap">

  <div class="form-head">
    <div>
      <h1 class="form-title">
        {% if agent %}
          {% if editing_profile2 %}Modifica Profilo 2{% else %}Modifica Profilo 1{% endif %}
        {% else %}
          Crea nuova Card
        {% endif %}
      </h1>

      <div class="form-sub">
        {% if editing_profile2 %}
          Questo √® il Profilo 2 (se attivo). Pu√≤ essere completamente diverso dal Profilo 1.
        {% else %}
          Dati della card (Profilo 1).
        {% endif %}
      </div>

      {% if not agent and session.get('role') == 'admin' %}
        <div class="hint-box">
          <strong>Slug</strong>: √® la parte finale del link della card.<br>
          Esempio: <span class="mono">https://TUO-DOMINIO/</span><span class="mono">mario-rossi</span><br>
          Usa solo lettere, numeri e trattini (niente spazi).
        </div>
      {% endif %}
    </div>

    <div class="form-actions">
      <a class="btn-mini ghost" href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>

      {% if session.get('role') != 'admin' %}
        {% if editing_profile2 %}
          <a class="btn-mini ghost" href="{{ url_for('me_edit') }}">Profilo 1</a>
        {% else %}
          {% if agent and agent.p2_enabled == 1 %}
            <a class="btn-mini ghost" href="{{ url_for('me_profile2') }}">Profilo 2</a>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="card-form">

    <!-- ‚úÖ SLUG: visibile solo admin. Non modificabile per i client. -->
    {% if session.get('role') == 'admin' and agent and agent.slug %}
      <div class="section-box">
        <div class="section-title">Identificativo</div>
        <div class="grid-2">
          <div class="field">
            <label>Slug (non modificabile)</label>
            <input type="text" value="{{ agent.slug }}" readonly>
            <div class="mini-help">Link card: <span class="mono">{{ request.url_root.rstrip('/') }}/{{ agent.slug }}</span></div>
          </div>
        </div>
      </div>
    {% endif %}

    {% if session.get('role') == 'admin' and not agent %}
      <div class="grid-2">
        <div class="field">
          <label>Slug (obbligatorio)</label>
          <input name="slug" type="text" placeholder="es: mario-rossi" required>
          <div class="mini-help">Verr√† creato anche l‚Äôutente di accesso con lo stesso nome.</div>
        </div>

        <div class="field">
          <label>Nome (obbligatorio)</label>
          <input name="name" type="text" placeholder="Nome e Cognome" required>
        </div>
      </div>
    {% endif %}

    <!-- Dati principali -->
    <div class="grid-2">
      <div class="field">
        <label>Nome</label>
        <input name="name" type="text" value="{{ agent.name if agent else '' }}">
        <div class="mini-help">Per P2 pu√≤ essere diverso dal P1.</div>
      </div>

      <div class="field">
        <label>Azienda</label>
        <input name="company" type="text" value="{{ agent.company if agent and agent.company else '' }}">
      </div>

      <div class="field">
        <label>Ruolo</label>
        <input name="role" type="text" value="{{ agent.role if agent and agent.role else '' }}">
      </div>

      <div class="field">
        <label>Bio</label>
        <textarea name="bio" rows="3" placeholder="Breve descrizione...">{{ agent.bio if agent and agent.bio else '' }}</textarea>
      </div>
    </div>

    <!-- Contatti -->
    <div class="section-box">
      <div class="section-title">Contatti</div>

      <div class="grid-2">
        <div class="field">
          <label>Cellulare</label>
          <input name="phone_mobile" type="text" value="{{ agent.phone_mobile if agent and agent.phone_mobile else '' }}" placeholder="+39 ...">
        </div>

        <div class="field">
          <label>Cellulare 2</label>
          <input name="phone_mobile2" type="text" value="{{ agent.phone_mobile2 if agent and agent.phone_mobile2 else '' }}" placeholder="+39 ...">
        </div>

        <div class="field">
          <label>Ufficio</label>
          <input name="phone_office" type="text" value="{{ agent.phone_office if agent and agent.phone_office else '' }}">
        </div>

        <div class="field">
          <label>WhatsApp (link o numero)</label>
          <input name="whatsapp" type="text" value="{{ agent.whatsapp if agent and agent.whatsapp else '' }}" placeholder="es: +39333... oppure https://wa.me/...">
        </div>

        <div class="field">
          <label>Email (separate da virgola)</label>
          <input name="emails" type="text" value="{{ agent.emails if agent and agent.emails else '' }}" placeholder="mail1@... , mail2@...">
        </div>

        <div class="field">
          <label>Siti (separati da virgola)</label>
          <input name="websites" type="text" value="{{ agent.websites if agent and agent.websites else '' }}" placeholder="pay4you.store, ...">
        </div>

        <div class="field">
          <label>PEC</label>
          <input name="pec" type="text" value="{{ agent.pec if agent and agent.pec else '' }}">
        </div>

        <div class="field">
          <label>Indirizzi (uno per riga)</label>
          <textarea name="addresses" rows="3" placeholder="Via..., Citt√†...">{{ agent.addresses if agent and agent.addresses else '' }}</textarea>
        </div>
      </div>
    </div>

    <!-- Dati fiscali -->
    <div class="section-box">
      <div class="section-title">Dati</div>
      <div class="grid-2">
        <div class="field">
          <label>P.IVA</label>
          <input name="piva" type="text" value="{{ agent.piva if agent and agent.piva else '' }}">
        </div>
        <div class="field">
          <label>SDI</label>
          <input name="sdi" type="text" value="{{ agent.sdi if agent and agent.sdi else '' }}">
        </div>
      </div>
    </div>

    <!-- Social -->
    <div class="section-box">
      <div class="section-title">Social</div>
      <div class="mini-help">
        Inserisci un link completo (https://...) oppure il tuo @ (solo per Telegram). Se il formato √® sbagliato, l‚Äôicona non comparir√† sulla card.
      </div>

      <div class="grid-2">
        <div class="field">
          <label>Facebook</label>
          <input class="js-url" name="facebook" type="text" value="{{ agent.facebook if agent and agent.facebook else '' }}" placeholder="https://facebook.com/tuapagina">
        </div>
        <div class="field">
          <label>Instagram</label>
          <input class="js-url" name="instagram" type="text" value="{{ agent.instagram if agent and agent.instagram else '' }}" placeholder="https://instagram.com/tuoprofilo">
        </div>
        <div class="field">
          <label>LinkedIn</label>
          <input class="js-url" name="linkedin" type="text" value="{{ agent.linkedin if agent and agent.linkedin else '' }}" placeholder="https://linkedin.com/in/...">
        </div>
        <div class="field">
          <label>TikTok</label>
          <input class="js-url" name="tiktok" type="text" value="{{ agent.tiktok if agent and agent.tiktok else '' }}" placeholder="https://tiktok.com/@...">
        </div>
        <div class="field">
          <label>Telegram</label>
          <input class="js-telegram" name="telegram" type="text" value="{{ agent.telegram if agent and agent.telegram else '' }}" placeholder="@username oppure https://t.me/username">
        </div>
        <div class="field">
          <label>YouTube</label>
          <input class="js-url" name="youtube" type="text" value="{{ agent.youtube if agent and agent.youtube else '' }}" placeholder="https://youtube.com/@...">
        </div>
        <div class="field">
          <label>Spotify</label>
          <input class="js-url" name="spotify" type="text" value="{{ agent.spotify if agent and agent.spotify else '' }}" placeholder="https://open.spotify.com/...">
        </div>
      </div>

      <div id="urlWarn" class="mini-help" style="display:none; color:#ffb2b2; font-weight:900; margin-top:10px;">
        ‚ö†Ô∏è Alcuni link social sembrano non validi (controlla http/https o @telegram). Non blocco il salvataggio, ma l‚Äôicona potrebbe non apparire.
      </div>
    </div>

    <!-- Media avatar/logo/back -->
    <div class="section-box">
      <div class="section-title">Immagini</div>

      <div class="grid-2">
        <div class="field">
          <label>Foto profilo (upload)</label>
          <input name="photo" type="file" accept="image/*">
          {% if agent and agent.photo_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.photo_url }}</span></div>
          {% endif %}
        </div>

        <div class="field">
          <label>Logo (upload)</label>
          <input name="logo" type="file" accept="image/*">
          {% if agent and agent.logo_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.logo_url }}</span></div>
          {% endif %}
        </div>

        <div class="field">
          <label>Contenuto dietro foto</label>
          <select name="back_media_mode">
            {% set bm = (agent.back_media_mode if agent and agent.back_media_mode else 'company') %}
            <option value="company" {% if bm=='company' %}selected{% endif %}>Logo aziendale</option>
            <option value="personal" {% if bm=='personal' %}selected{% endif %}>Foto/Logo personale</option>
          </select>
          <div class="mini-help">Se scegli ‚Äúpersonale‚Äù, carica l‚Äôimmagine sotto.</div>
        </div>

        <div class="field">
          <label>Upload retro (solo se ‚Äúpersonale‚Äù)</label>
          <input name="back_media" type="file" accept="image/*">
          {% if agent and agent.back_media_url %}
            <div class="mini-help">Attuale: <span class="mono">{{ agent.back_media_url }}</span></div>
          {% endif %}
        </div>
      </div>

      <!-- ‚úÖ CROP ‚Äúcome prima‚Äù: slider + preview -->
      <div class="section-box" style="margin-top:12px;">
        <div class="section-title">Crop foto (Zoom / Sposta)</div>

        <div style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start;">
          <div style="width:220px; height:220px; border-radius:999px; overflow:hidden; border:3px solid rgba(243,198,43,.55); background:rgba(0,0,0,.25); box-shadow:0 18px 40px rgba(0,0,0,.45);">
            {% if agent and agent.photo_url %}
              <img id="cropPreview" src="{{ agent.photo_url }}" alt="Preview" style="width:100%; height:100%; object-fit:cover;">
            {% else %}
              <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:42px;opacity:.8;">üë§</div>
            {% endif %}
          </div>

          <div style="flex:1; min-width:260px;">
            <div class="grid-3">
              <div class="field">
                <label>Crop X (0‚Äì100)</label>
                <input id="posX" name="photo_pos_x" type="range" min="0" max="100" step="1"
                       value="{{ agent.photo_pos_x if agent and agent.photo_pos_x is not none else 50 }}">
                <div class="mini-help">Valore: <span class="mono" id="posXVal"></span></div>
              </div>

              <div class="field">
                <label>Crop Y (0‚Äì100)</label>
                <input id="posY" name="photo_pos_y" type="range" min="0" max="100" step="1"
                       value="{{ agent.photo_pos_y if agent and agent.photo_pos_y is not none else 35 }}">
                <div class="mini-help">Valore: <span class="mono" id="posYVal"></span></div>
              </div>

              <div class="field">
                <label>Zoom (1.0‚Äì2.6)</label>
                <input id="zoom" name="photo_zoom" type="range" min="1" max="2.6" step="0.05"
                       value="{{ agent.photo_zoom if agent and agent.photo_zoom is not none else 1.0 }}">
                <div class="mini-help">Valore: <span class="mono" id="zoomVal"></span></div>
              </div>
            </div>

            <div class="mini-help" style="margin-top:10px;">
              Suggerimento: metti Zoom 1.15‚Äì1.35 e centra il volto con X/Y.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Effetti -->
    <div class="section-box">
      <div class="section-title">Effetti</div>

      <div class="check-grid">
        {% set orbit = 1 if agent and (agent.orbit_spin or 0) == 1 else 0 %}
        {% set aspin = 1 if agent and (agent.avatar_spin or 0) == 1 else 0 %}
        {% set lspin = 1 if agent and (agent.logo_spin or 0) == 1 else 0 %}
        {% set flip  = 1 if agent and (agent.allow_flip or 0) == 1 else 0 %}

        <label class="check">
          <input type="checkbox" name="orbit_spin" {% if orbit==1 %}checked{% endif %}>
          <span>Orbit logo (ruota dietro)</span>
        </label>

        <label class="check">
          <input id="avatarSpin" type="checkbox" name="avatar_spin" {% if aspin==1 %}checked{% endif %}>
          <span>Ruota foto</span>
        </label>

        <label class="check">
          <input type="checkbox" name="logo_spin" {% if lspin==1 %}checked{% endif %}>
          <span>Ruota logo sul retro</span>
        </label>

        <label class="check">
          <input id="allowFlip" type="checkbox" name="allow_flip" {% if flip==1 %}checked{% endif %}>
          <span>Flip (tap per retro)</span>
        </label>
      </div>

      <div class="mini-help">
        Nota: ‚ÄúRuota foto‚Äù e ‚ÄúFlip‚Äù non possono essere attivi insieme (se attivi uno, l‚Äôaltro si disattiva).
      </div>
    </div>

    <!-- Gallery / video / pdf -->
    <div class="section-box">
      <div class="section-title">Media (foto / video / PDF)</div>

      <div class="grid-2">
        <div class="field">
          <label>Galleria foto (max 30)</label>
          <input name="gallery" type="file" accept="image/*" multiple>
          {% if agent and agent.gallery_urls %}
            <div class="mini-help">Gi√† presenti: s√¨ (sovrascrive se ricarichi)</div>
          {% endif %}
        </div>

        <div class="field">
          <label>Video (max 10)</label>
          <input name="videos" type="file" accept="video/*" multiple>
          {% if agent and agent.video_urls %}
            <div class="mini-help">Gi√† presenti: s√¨ (sovrascrive se ricarichi)</div>
          {% endif %}
        </div>
      </div>

      <div class="field">
        <label>PDF (fino a 12)</label>
        <div class="grid-3">
          {% for i in range(1,13) %}
            <div class="field mini">
              <label>PDF {{ i }}</label>
              <input name="pdf{{ i }}" type="file" accept="application/pdf">
            </div>
          {% endfor %}
        </div>
        {% if agent and agent.pdf1_url %}
          <div class="mini-help">Gi√† presenti: s√¨ (aggiunge/sovrascrive quelli che ricarichi)</div>
        {% endif %}
      </div>
    </div>

    <!-- i18n -->
    {% if session.get('role') == 'admin' %}
    <div class="section-box">
      <div class="section-title">Traduzioni (opzionali)</div>
      <div class="mini-help">Solo per la card pubblica quando lang=en/fr/es/de.</div>

      {% for L in ['en','fr','es','de'] %}
        {% set d = (i18n_data.get(L) if i18n_data and i18n_data.get(L) else {}) %}
        <div class="lang-box">
          <div class="lang-title">{{ L|upper }}</div>
          <div class="grid-2">
            <div class="field"><label>Nome</label><input name="name_{{L}}" value="{{ d.get('name','') }}"></div>
            <div class="field"><label>Azienda</label><input name="company_{{L}}" value="{{ d.get('company','') }}"></div>
            <div class="field"><label>Ruolo</label><input name="role_{{L}}" value="{{ d.get('role','') }}"></div>
            <div class="field"><label>Bio</label><textarea name="bio_{{L}}" rows="2">{{ d.get('bio','') }}</textarea></div>
            <div class="field" style="grid-column:1/-1"><label>Indirizzi</label><textarea name="addresses_{{L}}" rows="2">{{ d.get('addresses','') }}</textarea></div>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Submit -->
    <div class="sticky-save">
      <button class="btn primary" type="submit">
        {% if agent %}
          {% if editing_profile2 %}Salva Profilo 2{% else %}Salva Profilo 1{% endif %}
        {% else %}
          Crea Card
        {% endif %}
      </button>

      <a class="btn ghost" href="{{ url_for('dashboard') }}">Annulla</a>
    </div>
  </form>

  <div class="footer">¬© 2026 Pay4You ‚Äî Giuseppe Di Lisio</div>
</div>

<script>
  // ‚úÖ Crop preview live
  (function(){
    const img = document.getElementById('cropPreview');
    const x = document.getElementById('posX');
    const y = document.getElementById('posY');
    const z = document.getElementById('zoom');

    const xv = document.getElementById('posXVal');
    const yv = document.getElementById('posYVal');
    const zv = document.getElementById('zoomVal');

    function apply(){
      if(xv) xv.textContent = (x ? x.value : '');
      if(yv) yv.textContent = (y ? y.value : '');
      if(zv) zv.textContent = (z ? Number(z.value).toFixed(2) : '');
      if(!img) return;
      const px = x ? x.value : 50;
      const py = y ? y.value : 35;
      const pz = z ? z.value : 1.0;
      img.style.objectPosition = px + "% " + py + "%";
      img.style.transformOrigin = "center center";
      img.style.transform = "scale(" + pz + ")";
    }
    [x,y,z].forEach(el => el && el.addEventListener('input', apply));
    apply();
  })();

  // ‚úÖ Mutual exclusion: ruota foto vs flip
  (function(){
    const a = document.getElementById('avatarSpin');
    const f = document.getElementById('allowFlip');
    if(!a || !f) return;

    function sync(){
      if(a.checked) f.checked = false;
    }
    function sync2(){
      if(f.checked) a.checked = false;
    }
    a.addEventListener('change', sync);
    f.addEventListener('change', sync2);
    sync();
  })();

  // ‚úÖ Mini warning su social
  (function(){
    const warn = document.getElementById('urlWarn');
    function okUrl(v){
      v = (v||"").trim();
      if(!v) return true;
      if(v.startsWith("http://") || v.startsWith("https://")) return true;
      return false;
    }
    function okTelegram(v){
      v = (v||"").trim();
      if(!v) return true;
      if(v.startsWith("@")) return true;
      if(v.startsWith("http://") || v.startsWith("https://")) return true;
      return false;
    }
    function check(){
      let bad = false;
      document.querySelectorAll(".js-url").forEach(i=>{
        if(!okUrl(i.value)) bad = true;
      });
      document.querySelectorAll(".js-telegram").forEach(i=>{
        if(!okTelegram(i.value)) bad = true;
      });
      if(warn) warn.style.display = bad ? "block" : "none";
    }
    document.querySelectorAll(".js-url,.js-telegram").forEach(i=> i.addEventListener('input', check));
    check();
  })();
</script>
{% endblock %}
