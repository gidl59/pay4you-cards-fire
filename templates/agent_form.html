<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page_title }} | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">{{ profile_label }}</div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">← Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">{{ page_title }}</h1>
            <div class="hint">{{ page_hint }}</div>
          </div>

          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}">Apri P1</a>
              {% if agent.p2_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p2">Apri P2</a>
              {% endif %}
              {% if agent.p3_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p3">Apri P3</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        <!-- ===== FORM (INVARIATO) ===== -->
        <form method="post" enctype="multipart/form-data" class="card-form">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field">
                <label>Slug (non modificabile)</label>
                <input type="text" value="{{ agent.slug }}" readonly>
                <div class="hint">È il link pubblico della card.</div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ... (TUTTO IL TUO FORM RESTA UGUALE) ... -->
          <!-- Qui incolla identico il tuo contenuto della form (Dati principali, contatti, social, gallerie, pdf, traduzioni, sticky-save) -->
          <!-- Io non lo tocco per non perderti pezzi. -->

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>

      </div>
    </div>
  </main>
</div>

<!-- ✅ MEDIA MODAL (NO X) -->
<div id="mediaModal" class="modal-overlay" style="display:none" onclick="overlayCloseMedia(event)">
  <div class="modal-box" onclick="event.stopPropagation()" style="max-width:920px;">
    <div class="modal-title" id="mediaTitle">Media</div>
    <div id="mediaBody" style="margin-top:12px;"></div>

    <div class="modal-actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
      <button class="btn" type="button" onclick="shareMedia('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareMedia('email')">Invia Email</button>

      {% if agent %}
        <button class="btn danger" type="button" onclick="deleteMedia()">Elimina</button>
      {% endif %}

      <button class="btn ghost" type="button" onclick="closeMediaModal()">Chiudi</button>
    </div>

    <input type="hidden" id="mmKind" value="">
    <input type="hidden" id="mmUrl" value="">
    <input type="hidden" id="mmDeleteHref" value="">
  </div>
</div>

<script>
  function absUrl(u){
    if(!u) return '';
    u = (u + '').trim();
    if(/^https?:\/\//i.test(u)) return u;
    if(u.startsWith('uploads/')) u = '/' + u;
    if(u.startsWith('pdf/') || u.startsWith('images/') || u.startsWith('videos/')) u = '/uploads/' + u;
    if(u.startsWith('/pdf/') || u.startsWith('/images/') || u.startsWith('/videos/')) u = '/uploads' + u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    // click su thumb immagini/video (come già avevi)
    document.querySelectorAll('.media-thumb-btn').forEach(btn => {
      btn.addEventListener('click', () => openMediaModal(btn.dataset.kind, btn.dataset.url));
    });

    // ✅ PDF: apri nel MODAL (non più in nuova scheda)
    document.querySelectorAll('.pdf-open-btn').forEach(b => {
      b.addEventListener('click', () => openMediaModal('pdf', b.dataset.url));
    });
  });

  function overlayCloseMedia(e){
    if(e.target && e.target.id === "mediaModal") closeMediaModal();
  }
  function closeMediaModal(){
    const m = document.getElementById('mediaModal');
    const body = document.getElementById('mediaBody');
    if(body) body.innerHTML = '';
    if(m) m.style.display = 'none';
  }

  function openMediaModal(kind, url){
    const m = document.getElementById('mediaModal');
    const t = document.getElementById('mediaTitle');
    const body = document.getElementById('mediaBody');

    document.getElementById('mmKind').value = kind;
    document.getElementById('mmUrl').value = url;

    const abs = absUrl(url);

    if(kind === 'img'){
      t.textContent = 'Foto';
      body.innerHTML = `<img src="${abs}" alt="" style="width:100%; max-height:65vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);">`;
    } else if(kind === 'vid'){
      t.textContent = 'Video';
      body.innerHTML = `<video src="${abs}" controls playsinline style="width:100%; max-height:65vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:black;"></video>`;
    } else {
      t.textContent = 'PDF';
      body.innerHTML = `
        <iframe src="${abs}" style="width:100%; height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.2)"></iframe>
        <div style="margin-top:10px; opacity:.75; font-size:12px;">
          Se non vedi il PDF: <a href="${abs}" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline;">Apri in nuova scheda</a>
        </div>`;
    }

    {% if agent %}
      const profile =
        ("{{ profile_label }}" === "Profilo 1") ? "p1" :
        ("{{ profile_label }}" === "Profilo 2") ? "p2" : "p3";

      const kindParam = (kind === 'img') ? 'img' : (kind === 'vid' ? 'vid' : 'pdf');
      const del = `/area/media/delete/{{ agent.slug }}/${profile}?kind=${kindParam}&url=` + encodeURIComponent(url);
      document.getElementById('mmDeleteHref').value = del;
    {% endif %}

    m.style.display = 'flex';
  }

  function shareMedia(channel){
    const kind = document.getElementById('mmKind').value;
    const url = document.getElementById('mmUrl').value;
    const media = absUrl(url);

    const label = (kind === 'img') ? 'Foto Pay4You' : (kind === 'vid' ? 'Video Pay4You' : 'PDF Pay4You');
    const msg = `${label}\n${media}`;

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = label;
    const g = gmailCompose(subject, msg);
    const w = window.open(g, '_blank');
    if(!w){
      window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(msg)}`, '_blank');
    }
  }

  function deleteMedia(){
    const href = document.getElementById('mmDeleteHref').value;
    if(!href) return;
    if(!confirm("Sei sicuro di eliminare questo file?")) return;
    if(!confirm("Conferma eliminazione DEFINITIVA.")) return;
    window.location.href = href;
  }
</script>

</body>
</html>
