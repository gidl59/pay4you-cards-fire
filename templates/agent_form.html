<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Modifica {{ profile_key|upper }} | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">

  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">Modifica {{ profile_key|upper }}</div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">← Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">Modifica {{ profile_key|upper }}</h1>
            <div class="hint">
              Limiti: {{limits.imgs}} foto (max {{limits.img_mb}}MB) •
              {{limits.vids}} video (max {{limits.vid_mb}}MB) •
              {{limits.pdfs}} PDF (max {{limits.pdf_mb}}MB)
            </div>
          </div>
          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p={{profile_key}}">Apri {{ profile_key|upper }}</a>
              <button class="btn-mini ghost" type="button" onclick="openQr('{{ agent.slug }}','{{profile_key}}')">QR {{ profile_key|upper }}</button>
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        <form method="post" enctype="multipart/form-data" class="card-form">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field">
                <label>Slug (non modificabile)</label>
                <input type="text" value="{{ agent.slug }}" readonly>
              </div>
              <!-- ✅ tolto campo username "none" -->
              <div class="field">
                <label>Username</label>
                <input type="text" value="{{ agent.username }}" readonly>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="section-box">
            <div class="h3">Dati principali</div>
            <div class="form-grid">
              <div class="field">
                <label>Nome</label>
                <input type="text" name="name" value="{{ profile.data.name }}">
              </div>
              <div class="field">
                <label>Azienda</label>
                <input type="text" name="company" value="{{ profile.data.company }}">
              </div>
              <div class="field">
                <label>Ruolo</label>
                <input type="text" name="role" value="{{ profile.data.role }}">
              </div>
              <div class="field">
                <label>Bio</label>
                <textarea name="bio" placeholder="Breve descrizione...">{{ profile.data.bio }}</textarea>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Contatti</div>
            <div class="form-grid">
              <div class="field">
                <label>Cellulare</label>
                <input type="text" name="phone_mobile" value="{{ profile.data.phone_mobile }}">
              </div>
              <div class="field">
                <label>Cellulare 2</label>
                <input type="text" name="phone_mobile2" value="{{ profile.data.phone_mobile2 }}">
              </div>
              <div class="field">
                <label>Ufficio</label>
                <input type="text" name="phone_office" value="{{ profile.data.phone_office }}">
              </div>
              <div class="field">
                <label>WhatsApp</label>
                <input type="text" name="whatsapp" value="{{ profile.data.whatsapp }}">
              </div>
              <div class="field full">
                <label>Email (separate da virgola)</label>
                <input type="text" name="emails" value="{{ profile.data.emails }}">
              </div>
              <div class="field full">
                <label>Siti web (separati da virgola)</label>
                <input type="text" name="websites" value="{{ profile.data.websites }}">
              </div>
              <div class="field">
                <label>PEC</label>
                <input type="text" name="pec" value="{{ profile.data.pec }}">
              </div>
              <div class="field full">
                <label>Indirizzi (uno per riga)</label>
                <textarea name="addresses">{{ profile.data.addresses }}</textarea>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Dati fiscali</div>
            <div class="form-grid">
              <div class="field">
                <label>P.IVA</label>
                <input type="text" name="piva" value="{{ profile.data.piva }}">
              </div>
              <div class="field">
                <label>SDI</label>
                <input type="text" name="sdi" value="{{ profile.data.sdi }}">
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Social</div>
            <div class="hint-box">
              ✅ Inserisci sempre il link completo (https://...)<br>
              Facebook: usa https://www.facebook.com/..... oppure https://www.facebook.com/share/.....<br>
              Instagram: usa https://www.instagram.com/.....<br>
              LinkedIn: usa https://www.linkedin.com/in/.....<br>
              TikTok: usa https://www.tiktok.com/@.....<br>
              Telegram: usa https://t.me/.....<br>
              YouTube: usa https://www.youtube.com/@.....<br>
              Spotify: usa https://open.spotify.com/.....
            </div>
            <div class="form-grid" style="margin-top:12px">
              <div class="field"><label>Facebook</label><input type="text" name="facebook" value="{{ profile.data.facebook }}"></div>
              <div class="field"><label>Instagram</label><input type="text" name="instagram" value="{{ profile.data.instagram }}"></div>
              <div class="field"><label>LinkedIn</label><input type="text" name="linkedin" value="{{ profile.data.linkedin }}"></div>
              <div class="field"><label>TikTok</label><input type="text" name="tiktok" value="{{ profile.data.tiktok }}"></div>
              <div class="field"><label>Telegram</label><input type="text" name="telegram" value="{{ profile.data.telegram }}"></div>
              <div class="field"><label>YouTube</label><input type="text" name="youtube" value="{{ profile.data.youtube }}"></div>
              <div class="field full"><label>Spotify</label><input type="text" name="spotify" value="{{ profile.data.spotify }}"></div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Crop / posizione foto agente</div>
            <div class="hint">Carica una foto e regolala subito qui sotto (X, Y e Zoom).</div>

            <div class="crop-preview">
              <div class="crop-circle" id="cropCircle">
                {% if profile.media.photo_url %}
                  <img id="cropImg" src="{{ profile.media.photo_url }}" alt=""
                       style="object-position: {{ profile.media.photo_pos_x }}% {{ profile.media.photo_pos_y }}%;
                              transform: scale({{ profile.media.photo_zoom }});">
                {% else %}
                  <div class="crop-empty" id="cropEmpty">Carica una foto profilo</div>
                  <img id="cropImg" src="" alt="" style="display:none">
                {% endif %}
              </div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>X (0–100)</label>
                <input id="posX" type="range" min="0" max="100" name="photo_pos_x" value="{{ profile.media.photo_pos_x }}">
              </div>
              <div class="field">
                <label>Y (0–100)</label>
                <input id="posY" type="range" min="0" max="100" name="photo_pos_y" value="{{ profile.media.photo_pos_y }}">
              </div>
              <div class="field full">
                <label>Zoom (1.0 – 2.5)</label>
                <input id="zoom" type="range" min="1" max="2.5" step="0.05" name="photo_zoom" value="{{ profile.media.photo_zoom }}">
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Media</div>

            <div class="field">
              <label>Foto profilo</label>
              <input id="photoInput" type="file" name="photo" accept="image/*">
              <div class="hint">Max {{limits.img_mb}}MB.</div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>Logo</label>
                <input type="file" name="logo" accept="image/*">
                <div class="hint">Max {{limits.img_mb}}MB.</div>
              </div>
              <div class="field full">
                <label>Background (immagine)</label>
                <input type="file" name="back_media" accept="image/*">
                <div class="hint">Max {{limits.img_mb}}MB.</div>
              </div>
            </div>

            <!-- GALLERIA: upload sotto -->
            <div class="media-block" style="margin-top:14px">
              <div class="media-sub">Galleria (max {{limits.imgs}} • max {{limits.img_mb}}MB)</div>

              <div class="media-preview" style="margin-top:10px">
                <div class="media-grid">
                  {% for g in (profile.media.gallery or []) %}
                    <div class="media-item">
                      <img src="{{ g }}" alt="" onclick="openViewer('gallery','{{ g }}')">
                    </div>
                  {% endfor %}
                  {% if (profile.media.gallery or [])|length == 0 %}
                    <div class="hint">Nessuna foto in galleria.</div>
                  {% endif %}
                </div>
              </div>

              <div class="field" style="margin-top:10px">
                <label>Carica nuove foto (si aggiungono)</label>
                <input type="file" name="gallery" accept="image/*" multiple>
              </div>
            </div>

            <!-- VIDEO: upload sotto -->
            <div class="media-block" style="margin-top:14px">
              <div class="media-sub">Video (max {{limits.vids}} • max {{limits.vid_mb}}MB)</div>

              <div class="media-preview" style="margin-top:10px">
                <div class="media-grid">
                  {% for v in (profile.media.videos or []) %}
                    <div class="media-item">
                      <video src="{{ v }}#t=0.1" muted playsinline preload="metadata"
                             onclick="openViewer('video','{{ v }}')"></video>
                      <span class="media-play">video</span>
                    </div>
                  {% endfor %}
                  {% if (profile.media.videos or [])|length == 0 %}
                    <div class="hint">Nessun video caricato.</div>
                  {% endif %}
                </div>
              </div>

              <div class="field" style="margin-top:10px">
                <label>Carica nuovi video (si aggiungono)</label>
                <input type="file" name="videos" accept="video/*" multiple>
              </div>
            </div>

            <!-- PDF: upload sotto -->
            <div class="media-block" style="margin-top:14px">
              <div class="media-sub">PDF (max {{limits.pdfs}} • max {{limits.pdf_mb}}MB)</div>

              <div class="media-preview" style="margin-top:10px">
                <div class="pdf-preview">
                  {% for p in (profile.media.pdfs or []) %}
                    <div class="pdf-row">
                      <div class="pdf-name" onclick="openViewer('pdf','{{ p.url }}')">{{ p.name }}</div>
                    </div>
                  {% endfor %}
                  {% if (profile.media.pdfs or [])|length == 0 %}
                    <div class="hint">Nessun PDF caricato.</div>
                  {% endif %}
                </div>
              </div>

              <div class="grid-3" style="margin-top:10px">
                {% for i in range(1, limits.pdfs + 1) %}
                  <div class="field">
                    <label>Carica PDF {{ i }}</label>
                    <input type="file" name="pdf{{ i }}" accept="application/pdf">
                  </div>
                {% endfor %}
              </div>
            </div>

          </div>

          <!-- ✅ TRADUZIONI in fondo dopo i PDF e CHIUSE -->
          <div class="section-box">
            <div class="h3">Traduzioni</div>
            <div class="hint">Tutte chiuse: apri solo quella che ti serve.</div>

            <details>
              <summary>English (EN)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Name</label><input type="text" name="name_en" value="{{ profile.i18n.en.name }}"></div>
                <div class="field"><label>Company</label><input type="text" name="company_en" value="{{ profile.i18n.en.company }}"></div>
                <div class="field"><label>Role</label><input type="text" name="role_en" value="{{ profile.i18n.en.role }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_en">{{ profile.i18n.en.bio }}</textarea></div>
                <div class="field full"><label>Addresses</label><textarea name="addresses_en">{{ profile.i18n.en.addresses }}</textarea></div>
              </div>
            </details>

            <details>
              <summary>Français (FR)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Nom</label><input type="text" name="name_fr" value="{{ profile.i18n.fr.name }}"></div>
                <div class="field"><label>Entreprise</label><input type="text" name="company_fr" value="{{ profile.i18n.fr.company }}"></div>
                <div class="field"><label>Rôle</label><input type="text" name="role_fr" value="{{ profile.i18n.fr.role }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_fr">{{ profile.i18n.fr.bio }}</textarea></div>
                <div class="field full"><label>Adresses</label><textarea name="addresses_fr">{{ profile.i18n.fr.addresses }}</textarea></div>
              </div>
            </details>

            <details>
              <summary>Español (ES)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Nombre</label><input type="text" name="name_es" value="{{ profile.i18n.es.name }}"></div>
                <div class="field"><label>Empresa</label><input type="text" name="company_es" value="{{ profile.i18n.es.company }}"></div>
                <div class="field"><label>Rol</label><input type="text" name="role_es" value="{{ profile.i18n.es.role }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_es">{{ profile.i18n.es.bio }}</textarea></div>
                <div class="field full"><label>Direcciones</label><textarea name="addresses_es">{{ profile.i18n.es.addresses }}</textarea></div>
              </div>
            </details>

            <details>
              <summary>Deutsch (DE)</summary>
              <div class="form-grid" style="margin-top:10px">
                <div class="field"><label>Name</label><input type="text" name="name_de" value="{{ profile.i18n.de.name }}"></div>
                <div class="field"><label>Firma</label><input type="text" name="company_de" value="{{ profile.i18n.de.company }}"></div>
                <div class="field"><label>Rolle</label><input type="text" name="role_de" value="{{ profile.i18n.de.role }}"></div>
                <div class="field full"><label>Bio</label><textarea name="bio_de">{{ profile.i18n.de.bio }}</textarea></div>
                <div class="field full"><label>Adressen</label><textarea name="addresses_de">{{ profile.i18n.de.addresses }}</textarea></div>
              </div>
            </details>
          </div>

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>
      </div>
    </div>

  </main>

</div>

<!-- QR MODAL -->
<div id="qrModal" class="modal-overlay" style="display:none" onclick="overlayClose(event,'qrModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <button class="modal-x" type="button" onclick="closeModal('qrModal')">✕</button>
    <div class="modal-title" id="qrTitle">QR</div>

    <div class="qr-wrap">
      <img id="qrImg" src="" alt="QR">
    </div>

    <div class="modal-actions">
      <button class="btn ghost" type="button" onclick="closeModal('qrModal')">Chiudi</button>
    </div>
  </div>
</div>

<!-- VIEWER MODAL + ELIMINA (solo dentro, non sulla griglia) -->
<div id="viewer" class="modal-overlay" style="display:none" onclick="overlayCloseViewer(event)">
  <div class="modal-box modal-big" onclick="event.stopPropagation()">
    <div class="modal-title">Anteprima</div>
    <img id="vImg" style="display:none" src="" alt="">
    <video id="vVideo" style="display:none" controls playsinline></video>
    <iframe id="vPdf" style="display:none" src=""></iframe>

    <div class="modal-actions">
      <button class="btn" type="button" onclick="shareViewer('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareViewer('email')">Invia Email</button>
      <button class="btn danger" type="button" onclick="alert('Elimina: lo mettiamo nella prossima modifica (serve endpoint dedicato per profilo).')">Elimina</button>
      <button class="btn ghost" type="button" onclick="closeViewer()">Chiudi</button>
    </div>
  </div>
</div>

<script>
  // ===== CROP LIVE PREVIEW (X/Y/Zoom) =====
  document.addEventListener('DOMContentLoaded', () => {
    const cropImg = document.getElementById('cropImg');
    const cropEmpty = document.getElementById('cropEmpty');
    const photoInput = document.getElementById('photoInput');

    const posX = document.getElementById('posX');
    const posY = document.getElementById('posY');
    const zoom = document.getElementById('zoom');

    function forceObjectPosition(){
      if(!cropImg) return;
      if(cropImg.style.display === 'none') return;

      const x = posX ? posX.value : 50;
      const y = posY ? posY.value : 35;
      const z = zoom ? zoom.value : 1.0;

      cropImg.style.setProperty('object-position', `${x}% ${y}%`, 'important');
      cropImg.style.setProperty('transform', `scale(${z})`, 'important');
      cropImg.style.setProperty('object-fit', 'cover', 'important');
      cropImg.style.setProperty('width', '100%', 'important');
      cropImg.style.setProperty('height', '100%', 'important');
      cropImg.style.setProperty('display', 'block', 'important');
    }

    if(posX){ posX.addEventListener('input', forceObjectPosition); posX.addEventListener('change', forceObjectPosition); }
    if(posY){ posY.addEventListener('input', forceObjectPosition); posY.addEventListener('change', forceObjectPosition); }
    if(zoom){ zoom.addEventListener('input', forceObjectPosition); zoom.addEventListener('change', forceObjectPosition); }

    if(photoInput){
      photoInput.addEventListener('change', () => {
        const f = photoInput.files && photoInput.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        cropImg.src = url;
        cropImg.style.display = 'block';
        if(cropEmpty) cropEmpty.style.display = 'none';
        setTimeout(forceObjectPosition, 0);
      });
    }

    setTimeout(forceObjectPosition, 0);
  });

  // ===== MODALS =====
  function overlayClose(e, id){
    if(e.target && e.target.id === id){
      closeModal(id);
    }
  }
  function closeModal(id){
    const el = document.getElementById(id);
    if(el) el.style.display = 'none';
  }

  function openQr(slug, profile){
    const modal = document.getElementById('qrModal');
    const img = document.getElementById('qrImg');
    const title = document.getElementById('qrTitle');
    title.textContent = `QR ${slug.toUpperCase()} • ${profile.toUpperCase()}`;
    img.src = `/qr/${slug}.png?p=${profile}`;
    modal.style.display = 'flex';
  }

  // ===== VIEWER + SHARE =====
  let viewerState = { type:'', url:'' };

  function absUrl(u){
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function mailtoOpen(subject, body){
    const s = encodeURIComponent(subject || "");
    const b = encodeURIComponent(body || "");
    window.location.href = `mailto:?subject=${s}&body=${b}`;
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      alert("Il client email non ha inserito il testo.\nCopia manualmente questo testo (già copiato negli appunti) ✅");
    }catch(e){
      alert("Il client email non ha inserito il testo.\nCopia manualmente questo testo:\n\n" + text);
    }
  }

  function openViewer(type, url){
    viewerState = { type, url };

    const modal = document.getElementById('viewer');
    const vImg = document.getElementById('vImg');
    const vVideo = document.getElementById('vVideo');
    const vPdf = document.getElementById('vPdf');

    vImg.style.display = 'none';
    vVideo.style.display = 'none';
    vPdf.style.display = 'none';
    try{ vVideo.pause(); }catch(e){}

    if(type === 'gallery'){
      vImg.src = url;
      vImg.style.display = 'block';
    } else if(type === 'video'){
      vVideo.src = url;
      vVideo.style.display = 'block';
    } else {
      vPdf.src = url;
      vPdf.style.display = 'block';
    }
    modal.style.display = 'flex';
  }

  function closeViewer(){
    const modal = document.getElementById('viewer');
    const vVideo = document.getElementById('vVideo');
    try{ vVideo.pause(); }catch(e){}
    modal.style.display = 'none';
  }

  function overlayCloseViewer(e){
    if(e.target && e.target.id === 'viewer'){
      closeViewer();
    }
  }

  function shareViewer(channel){
    const kind = (viewerState.type || '').toUpperCase();
    const mediaUrl = absUrl(viewerState.url || '');
    const msg = [
      `Pay4You Media ${kind}`,
      `Link: ${mediaUrl}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    // Email: molti client mettono solo subject => fallback clipboard
    mailtoOpen(`Pay4You Media ${kind}`, msg);
    setTimeout(() => { copyToClipboard(msg); }, 700);
  }
</script>

</body>
</html>
