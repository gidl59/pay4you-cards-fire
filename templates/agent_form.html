<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page_title }} | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">{{ profile_label }}</div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">‚Üê Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">{{ page_title }}</h1>
            <div class="hint">{{ page_hint }}</div>
          </div>

          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}">Apri P1</a>
              {% if agent.p2_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p2">Apri P2</a>
              {% endif %}
              {% if agent.p3_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p3">Apri P3</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        <form method="post" enctype="multipart/form-data" class="card-form">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field">
                <label>Slug (non modificabile)</label>
                <input type="text" value="{{ agent.slug }}" readonly>
                <div class="hint">√à il link pubblico della card.</div>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="section-box">
            <div class="h3">Dati principali</div>
            <div class="form-grid">
              <div class="field">
                <label>Nome</label>
                <input type="text" name="name" value="{{ data.get('name','') }}">
              </div>
              <div class="field">
                <label>Azienda</label>
                <input type="text" name="company" value="{{ data.get('company','') }}">
              </div>
              <div class="field">
                <label>Ruolo</label>
                <input type="text" name="role" value="{{ data.get('role','') }}">
              </div>
              <div class="field full">
                <label>Bio</label>
                <textarea name="bio" placeholder="Breve descrizione...">{{ data.get('bio','') }}</textarea>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Contatti</div>
            <div class="form-grid">
              <div class="field">
                <label>Telefono (mobile)</label>
                <input type="text" name="phone_mobile" value="{{ data.get('phone_mobile','') }}">
              </div>
              <div class="field">
                <label>Telefono (mobile 2)</label>
                <input type="text" name="phone_mobile2" value="{{ data.get('phone_mobile2','') }}">
              </div>
              <div class="field">
                <label>Telefono ufficio</label>
                <input type="text" name="phone_office" value="{{ data.get('phone_office','') }}">
              </div>
              <div class="field">
                <label>WhatsApp</label>
                <input type="text" name="whatsapp" value="{{ data.get('whatsapp','') }}">
                <div class="hint">Esempio: +39350.... oppure link wa.me</div>
              </div>
              <div class="field full">
                <label>Email (separate da virgola)</label>
                <input type="text" name="emails" value="{{ data.get('emails','') }}">
              </div>
              <div class="field full">
                <label>Siti (separati da virgola)</label>
                <input type="text" name="websites" value="{{ data.get('websites','') }}">
              </div>
              <div class="field">
                <label>PEC</label>
                <input type="text" name="pec" value="{{ data.get('pec','') }}">
              </div>
              <div class="field full">
                <label>Indirizzi (uno per riga)</label>
                <textarea name="addresses">{{ data.get('addresses','') }}</textarea>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Dati aziendali</div>
            <div class="form-grid">
              <div class="field">
                <label>P.IVA</label>
                <input type="text" name="piva" value="{{ data.get('piva','') }}">
              </div>
              <div class="field">
                <label>SDI</label>
                <input type="text" name="sdi" value="{{ data.get('sdi','') }}">
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Social</div>
            <div class="hint">Inserisci URL completi (se non valido non verr√† mostrato).</div>

            <div class="form-grid">
              <div class="field">
                <label>Facebook</label>
                <input type="text" name="facebook" placeholder="https://www.facebook.com/..." value="{{ data.get('facebook','') }}">
                <div class="hint">Inserisci il link completo (es. https://www.facebook.com/share/...)</div>
              </div>
              <div class="field">
                <label>Instagram</label>
                <input type="text" name="instagram" placeholder="https://www.instagram.com/..." value="{{ data.get('instagram','') }}">
                <div class="hint">Inserisci il link completo (es. https://www.instagram.com/tuoprofilo)</div>
              </div>
              <div class="field">
                <label>LinkedIn</label>
                <input type="text" name="linkedin" placeholder="https://www.linkedin.com/in/..." value="{{ data.get('linkedin','') }}">
                <div class="hint">Inserisci il link completo (es. https://www.linkedin.com/in/tuonome)</div>
              </div>
              <div class="field">
                <label>TikTok</label>
                <input type="text" name="tiktok" placeholder="https://www.tiktok.com/@..." value="{{ data.get('tiktok','') }}">
                <div class="hint">Inserisci il link completo (es. https://www.tiktok.com/@tuoprofilo)</div>
              </div>
              <div class="field">
                <label>Telegram</label>
                <input type="text" name="telegram" placeholder="https://t.me/..." value="{{ data.get('telegram','') }}">
                <div class="hint">Inserisci il link completo (es. https://t.me/tuocanale)</div>
              </div>
              <div class="field">
                <label>YouTube</label>
                <input type="text" name="youtube" placeholder="https://www.youtube.com/@..." value="{{ data.get('youtube','') }}">
                <div class="hint">Inserisci il link completo (es. https://www.youtube.com/@tuocanale)</div>
              </div>
              <div class="field">
                <label>Spotify</label>
                <input type="text" name="spotify" placeholder="https://open.spotify.com/..." value="{{ data.get('spotify','') }}">
                <div class="hint">Inserisci il link completo (es. https://open.spotify.com/artist/...)</div>
              </div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Foto profilo ¬∑ Logo ¬∑ Foto dietro</div>
            <div class="hint">Tre riquadri quadrati affiancati con anteprima e upload.</div>

            <div class="triple-cols">

              <div class="triple-col">
                <div class="tc-title">Foto profilo</div>
                <div class="tc-preview square">
                  {% if data.get("photo_url") %}
                    <img id="prevPhoto" src="{{ data.get('photo_url') }}" alt="">
                  {% else %}
                    <div class="tc-ph">Foto</div>
                    <img id="prevPhoto" src="" style="display:none" alt="">
                  {% endif %}
                </div>
                <input id="photoInput" type="file" name="photo" accept="image/*">
              </div>

              <div class="triple-col">
                <div class="tc-title">Logo</div>
                <div class="tc-preview square">
                  {% if data.get("logo_url") %}
                    <img id="prevLogo" src="{{ data.get('logo_url') }}" alt="">
                  {% else %}
                    <div class="tc-ph">Logo</div>
                    <img id="prevLogo" src="" style="display:none" alt="">
                  {% endif %}
                </div>
                <input id="logoInput" type="file" name="logo" accept="image/*">
              </div>

              <div class="triple-col">
                <div class="tc-title">Foto dietro</div>
                <div class="tc-preview square">
                  {% if data.get("back_media_url") %}
                    <img id="prevBack" src="{{ data.get('back_media_url') }}" alt="">
                  {% else %}
                    <div class="tc-ph">Dietro</div>
                    <img id="prevBack" src="" style="display:none" alt="">
                  {% endif %}
                </div>
                <input id="backInput" type="file" name="back_media" accept="image/*">
              </div>

            </div>

            <div class="crop-preview" style="margin-top:12px;">
              <div class="crop-circle-bg" id="cropCircleBg"
                   data-url="{{ data.get('photo_url','') }}"
                   data-x="{{ data.get('photo_pos_x',50) }}"
                   data-y="{{ data.get('photo_pos_y',35) }}"
                   data-z="{{ data.get('photo_zoom','1.0') }}">
                <div class="crop-empty" id="cropEmptyBg" style="display:none">Carica una foto profilo</div>
              </div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field"><label>X (0‚Äì100)</label><input id="posX" type="range" min="0" max="100" name="photo_pos_x" value="{{ data.get('photo_pos_x',50) }}"></div>
              <div class="field"><label>Y (0‚Äì100)</label><input id="posY" type="range" min="0" max="100" name="photo_pos_y" value="{{ data.get('photo_pos_y',35) }}"></div>
              <div class="field full"><label>Zoom (1.0 ‚Äì 2.5)</label><input id="zoom" type="range" min="1" max="2.5" step="0.05" name="photo_zoom" value="{{ data.get('photo_zoom','1.0') }}"></div>
            </div>

            <div class="sep"></div>

            <div class="h3">Effetti</div>
            <div class="form-grid">
              <div class="field"><label><input type="checkbox" name="orbit_spin" {% if data.get('orbit_spin',0) == 1 %}checked{% endif %}> Ruota orbita</label></div>
              <div class="field"><label><input type="checkbox" name="avatar_spin" {% if data.get('avatar_spin',0) == 1 %}checked{% endif %}> Tap su foto (ruota)</label></div>
              <div class="field"><label><input type="checkbox" name="logo_spin" {% if data.get('logo_spin',0) == 1 %}checked{% endif %}> Ruota logo</label></div>
              <div class="field"><label><input type="checkbox" name="allow_flip" {% if data.get('allow_flip',0) == 1 %}checked{% endif %}> Flip</label></div>
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Galleria Foto</div>
            <div class="form-grid">
              <div class="field full"><label>Aggiungi foto (multiple)</label><input type="file" name="gallery_images" accept="image/*" multiple></div>
            </div>

            <div class="media-strip">
              {% set imgs = (data.get("gallery_urls","") or "").split("|") %}
              {% for g in imgs %}
                {% if g and g.strip() %}
                  <button type="button" class="media-thumb-btn" data-kind="img" data-url="{{ g }}">
                    <img src="{{ g }}" alt="">
                  </button>
                {% endif %}
              {% endfor %}
              {% if imgs|length == 0 %}<div class="hint">‚Äî</div>{% endif %}
            </div>
          </div>

          <div class="section-box">
            <div class="h3">Galleria Video</div>
            <div class="form-grid">
              <div class="field full"><label>Aggiungi video (multiple)</label><input type="file" name="gallery_videos" accept="video/*" multiple></div>
            </div>

            <div class="media-strip">
              {% set vids = (data.get("video_urls","") or "").split("|") %}
              {% for v in vids %}
                {% if v and v.strip() %}
                  <button type="button" class="media-thumb-btn" data-kind="vid" data-url="{{ v }}">
                    <video src="{{ v }}#t=0.1" muted playsinline preload="metadata"></video>
                  </button>
                {% endif %}
              {% endfor %}
              {% if vids|length == 0 %}<div class="hint">‚Äî</div>{% endif %}
            </div>
          </div>

          <div class="section-box">
            <div class="h3">PDF</div>
            <div class="form-grid">
              <div class="field full"><label>Aggiungi PDF (multiple)</label><input type="file" name="pdf_files" accept="application/pdf" multiple></div>
            </div>

            <div class="pdf-list">
              {% set pdfs = (data.get("pdf_urls","") or "").split("|") %}
              {% set any_pdf = false %}
              {% for p in pdfs %}
                {% if p and p.strip() %}
                  {% set any_pdf = true %}
                  {% if "||" in p %}
                    {% set nm = p.split("||")[0] %}
                    {% set u = p.split("||")[1] %}
                  {% else %}
                    {% set nm = p %}
                    {% set u = p %}
                  {% endif %}
                  <button type="button" class="pdf-open-btn" data-url="{{ u }}" data-name="{{ nm|e }}">üìÑ {{ nm }}</button>
                {% endif %}
              {% endfor %}
              {% if not any_pdf %}<div class="hint">‚Äî</div>{% endif %}
            </div>
          </div>

          {% if show_i18n %}
          <div class="section-box">
            <div class="h3">Traduzioni</div>
            <div class="hint">4 lingue. Clicca per aprire.</div>

            {% for L, title in [("en","English"),("fr","Fran√ßais"),("es","Espa√±ol"),("de","Deutsch")] %}
            <details style="margin-top:10px;">
              <summary style="cursor:pointer; font-weight:950;">{{ title }}</summary>
              <div style="margin-top:10px;">
                <div class="form-grid compact">
                  <div class="field"><label>Name</label><input type="text" name="name_{{L}}" value="{{ i18n.get(L,{}).get('name','') }}"></div>
                  <div class="field"><label>Company</label><input type="text" name="company_{{L}}" value="{{ i18n.get(L,{}).get('company','') }}"></div>
                  <div class="field"><label>Role</label><input type="text" name="role_{{L}}" value="{{ i18n.get(L,{}).get('role','') }}"></div>
                  <div class="field full"><label>Bio</label><textarea name="bio_{{L}}">{{ i18n.get(L,{}).get('bio','') }}</textarea></div>
                  <div class="field full"><label>Addresses</label><textarea name="addresses_{{L}}">{{ i18n.get(L,{}).get('addresses','') }}</textarea></div>
                </div>
              </div>
            </details>
            {% endfor %}
          </div>
          {% endif %}

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>

      </div>
    </div>
  </main>
</div>

<div id="mediaModal" class="modal-overlay" style="display:none" onclick="overlayCloseMedia(event)">
  <div class="modal-box" onclick="event.stopPropagation()" style="max-width:920px;">
    <div class="modal-title" id="mediaTitle">Media</div>
    <div id="mediaBody" style="margin-top:12px;"></div>

    <div class="modal-actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
      <button class="btn" type="button" onclick="shareMedia('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareMedia('email')">Invia Email</button>

      {% if agent %}
        <button class="btn danger" type="button" onclick="deleteMedia()">Elimina</button>
      {% endif %}

      <button class="btn ghost" type="button" onclick="closeMediaModal()">Chiudi</button>
    </div>

    <input type="hidden" id="mmKind" value="">
    <input type="hidden" id="mmUrl" value="">
    <input type="hidden" id="mmDeleteHref" value="">
  </div>
</div>

<script>
  function bindPreview(inputId, imgId){
    const inp = document.getElementById(inputId);
    const img = document.getElementById(imgId);
    if(!inp || !img) return;

    inp.addEventListener('change', () => {
      const f = inp.files && inp.files[0];
      if(!f) return;
      img.style.display = 'block';
      img.src = URL.createObjectURL(f);
    });
  }

  function absUrl(u){
    if(!u) return '';
    u = (u + '').trim();
    if(/^https?:\/\//i.test(u)) return u;
    if(u.startsWith('uploads/')) u = '/' + u;
    if(u.startsWith('/uploads/')) {} else if(u.startsWith('pdf/') || u.startsWith('images/') || u.startsWith('videos/')) u = '/uploads/' + u;
    else if(u.startsWith('/pdf/') || u.startsWith('/images/') || u.startsWith('/videos/')) u = '/uploads' + u;

    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }
  function outlookCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://outlook.office.com/mail/deeplink/compose?subject=${su}&body=${bd}`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    bindPreview('photoInput','prevPhoto');
    bindPreview('logoInput','prevLogo');
    bindPreview('backInput','prevBack');

    // ‚úÖ Mutua esclusione: FLIP (auto) e TAP su foto
    const cbFlip = document.querySelector('input[name="allow_flip"]');
    const cbTap  = document.querySelector('input[name="avatar_spin"]');
    function syncFlipTap(){
      if(!cbFlip || !cbTap) return;
      if(cbFlip.checked){ cbTap.checked = false; cbTap.disabled = true; }
      else { cbTap.disabled = false; }
      if(cbTap.checked){ cbFlip.checked = false; cbFlip.disabled = true; }
      else { cbFlip.disabled = false; }
    }
    if(cbFlip) cbFlip.addEventListener('change', syncFlipTap);
    if(cbTap) cbTap.addEventListener('change', syncFlipTap);
    syncFlipTap();

    const box = document.getElementById('cropCircleBg');
    if(box){
      const posX = document.getElementById('posX');
      const posY = document.getElementById('posY');
      const zoom = document.getElementById('zoom');
      const photoInput = document.getElementById('photoInput');
      const empty = document.getElementById('cropEmptyBg');

      function apply(){
        const url = box.getAttribute('data-url') || '';
        const x = posX ? posX.value : (box.getAttribute('data-x') || 50);
        const y = posY ? posY.value : (box.getAttribute('data-y') || 35);
        const z = zoom ? zoom.value : (box.getAttribute('data-z') || 1.0);

        if(!url){
          box.style.backgroundImage = 'none';
          if(empty) empty.style.display = 'flex';
          return;
        }
        if(empty) empty.style.display = 'none';

        box.style.backgroundImage = `url("${url}")`;
        box.style.backgroundRepeat = 'no-repeat';
        box.style.backgroundPosition = `${x}% ${y}%`;
        box.style.backgroundSize = `${parseFloat(z) * 100}% ${parseFloat(z) * 100}%`;
      }

      apply();

      if(posX){ posX.addEventListener('input', apply); posX.addEventListener('change', apply); }
      if(posY){ posY.addEventListener('input', apply); posY.addEventListener('change', apply); }
      if(zoom){ zoom.addEventListener('input', apply); zoom.addEventListener('change', apply); }

      if(photoInput){
        photoInput.addEventListener('change', () => {
          const f = photoInput.files && photoInput.files[0];
          if(!f) return;
          const url = URL.createObjectURL(f);
          box.setAttribute('data-url', url);
          apply();
        });
      }
    }

    document.querySelectorAll('.media-thumb-btn').forEach(btn => {
      btn.addEventListener('click', () => openMediaModal(btn.dataset.kind, btn.dataset.url));
    });

    document.querySelectorAll('.pdf-open-btn').forEach(b => {
      b.addEventListener('click', () => openPdfModal(b.dataset.url, b.dataset.name || 'PDF'));
    });
  });

  function overlayCloseMedia(e){
    if(e.target && e.target.id === "mediaModal"){
      closeMediaModal();
    }
  }
  function closeMediaModal(){
    const m = document.getElementById('mediaModal');
    if(m) m.style.display = 'none';
    const body = document.getElementById('mediaBody');
    if(body) body.innerHTML = '';
  }

  function openMediaModal(kind, url){
    const m = document.getElementById('mediaModal');
    const t = document.getElementById('mediaTitle');
    const body = document.getElementById('mediaBody');

    document.getElementById('mmKind').value = kind;
    document.getElementById('mmUrl').value = url;

    const abs = absUrl(url);
    t.textContent = (kind === 'img') ? 'Foto' : 'Video';

    if(kind === 'img'){
      body.innerHTML = `<img src="${abs}" alt="" style="width:100%; max-height:65vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12);">`;
    } else {
      body.innerHTML = `<video src="${abs}" controls playsinline style="width:100%; max-height:65vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:black;"></video>`;
    }

    {% if agent %}
      const profile =
        ("{{ profile_label }}" === "Profilo 1") ? "p1" :
        ("{{ profile_label }}" === "Profilo 2") ? "p2" : "p3";

      const kindParam = (kind === 'img') ? 'img' : 'vid';
      const del = `/area/media/delete/{{ agent.slug }}/${profile}?kind=${kindParam}&url=` + encodeURIComponent(url);
      document.getElementById('mmDeleteHref').value = del;
    {% endif %}

    m.style.display = 'flex';
  }

  function openPdfModal(url, name){
    const m = document.getElementById('mediaModal');
    const t = document.getElementById('mediaTitle');
    const body = document.getElementById('mediaBody');

    document.getElementById('mmKind').value = 'pdf';
    document.getElementById('mmUrl').value = url;

    t.textContent = 'PDF: ' + (name || 'Documento');
    body.innerHTML = `<iframe src="${absUrl(url)}" style="width:100%; height:65vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:white;"></iframe>`;

    {% if agent %}
      const profile =
        ("{{ profile_label }}" === "Profilo 1") ? "p1" :
        ("{{ profile_label }}" === "Profilo 2") ? "p2" : "p3";

      const del = `/area/media/delete/{{ agent.slug }}/${profile}?kind=pdf&url=` + encodeURIComponent(url);
      document.getElementById('mmDeleteHref').value = del;
    {% endif %}

    m.style.display = 'flex';
  }

  function shareMedia(channel){
    const kind = document.getElementById('mmKind').value;
    const url = document.getElementById('mmUrl').value;
    const media = absUrl(url);

    const msg = [
      `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : 'PDF')}`,
      `Link: ${media}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = `Pay4You ${kind === 'img' ? 'Foto' : (kind === 'vid' ? 'Video' : 'PDF')}`;
    const g = gmailCompose(subject, msg);
    const w = window.open(g, '_blank');
    if(!w){
      window.open(outlookCompose(subject, msg), '_blank');
    }
  }

  function deleteMedia(){
    const href = document.getElementById('mmDeleteHref').value;
    if(!href) return;

    if(!confirm("Sei sicuro di eliminare questo file?")) return;
    if(!confirm("Conferma eliminazione DEFINITIVA.")) return;

    window.location.href = href;
  }
</script>

</body>
</html>
