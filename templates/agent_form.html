<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page_title }} | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">{{ profile_label }}</div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">← Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">{{ page_title }}</h1>
            <div class="hint">{{ page_hint }}</div>
          </div>

          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}">Apri P1</a>
              {% if agent.p2_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p2">Apri P2</a>
              {% endif %}
              {% if agent.p3_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p3">Apri P3</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        <form method="post" enctype="multipart/form-data" class="card-form">

          <!-- ✅ hidden sempre presenti: così non spariscono gallerie/pdf al Salva -->
          <input type="hidden" id="gallery_urls" name="gallery_urls" value="{{ data.get('gallery_urls','') }}">
          <input type="hidden" id="video_urls" name="video_urls" value="{{ data.get('video_urls','') }}">
          <input type="hidden" id="pdf_urls" name="pdf_urls" value="{{ data.get('pdf_urls','') }}">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field">
                <label>Slug (non modificabile)</label>
                <input type="text" value="{{ agent.slug }}" readonly>
                <div class="hint">È il link pubblico della card.</div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ===================== DATI PRINCIPALI ===================== -->
          <div class="section-box">
            <div class="h3">Dati principali</div>
            <div class="form-grid">
              <div class="field">
                <label>Nome</label>
                <input type="text" name="name" value="{{ data.get('name','') }}">
              </div>
              <div class="field">
                <label>Azienda</label>
                <input type="text" name="company" value="{{ data.get('company','') }}">
              </div>
              <div class="field">
                <label>Ruolo</label>
                <input type="text" name="role" value="{{ data.get('role','') }}">
              </div>
              <div class="field full">
                <label>Bio</label>
                <textarea name="bio" placeholder="Breve descrizione...">{{ data.get('bio','') }}</textarea>
              </div>
            </div>
          </div>

          <!-- ===================== FOTO/LOGO/DIETRO + CROP + EFFETTI ===================== -->
          <div class="section-box">
            <div class="h3">Foto profilo + Logo + Foto dietro</div>

            <div class="form-grid">
              <div class="field">
                <label>Carica foto profilo</label>
                <input id="photoInput" type="file" name="photo" accept="image/*">
              </div>
              <div class="field">
                <label>Carica logo</label>
                <input id="logoInput" type="file" name="logo" accept="image/*">
              </div>
              <div class="field">
                <label>Carica foto dietro</label>
                <input id="backInput" type="file" name="back_media" accept="image/*">
              </div>
            </div>

            <div style="margin-top:10px; padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10);">
              <div class="hint" style="margin-bottom:8px">Anteprime attuali (si aggiornano anche quando scegli un nuovo file)</div>

              <div style="display:grid; grid-template-columns:repeat(3, 150px); gap:10px; justify-content:start;">
                <div style="width:150px; height:150px; border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);">
                  {% if data.get("photo_url") %}
                    <img id="prevPhoto" src="{{ data.get('photo_url') }}" style="width:100%; height:100%; object-fit:cover;" alt="">
                  {% else %}
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; opacity:.7; font-weight:900;">Foto</div>
                    <img id="prevPhoto" src="" style="display:none; width:100%; height:100%; object-fit:cover;" alt="">
                  {% endif %}
                </div>

                <div style="width:150px; height:150px; border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);">
                  {% if data.get("logo_url") %}
                    <img id="prevLogo" src="{{ data.get('logo_url') }}" style="width:100%; height:100%; object-fit:cover;" alt="">
                  {% else %}
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; opacity:.7; font-weight:900;">Logo</div>
                    <img id="prevLogo" src="" style="display:none; width:100%; height:100%; object-fit:cover;" alt="">
                  {% endif %}
                </div>

                <div style="width:150px; height:150px; border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);">
                  {% if data.get("back_media_url") %}
                    <img id="prevBack" src="{{ data.get('back_media_url') }}" style="width:100%; height:100%; object-fit:cover;" alt="">
                  {% else %}
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; opacity:.7; font-weight:900;">Dietro</div>
                    <img id="prevBack" src="" style="display:none; width:100%; height:100%; object-fit:cover;" alt="">
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="crop-preview" style="margin-top:12px;">
              <div class="crop-circle-bg" id="cropCircleBg"
                   data-url="{{ data.get('photo_url','') }}"
                   data-x="{{ data.get('photo_pos_x',50) }}"
                   data-y="{{ data.get('photo_pos_y',35) }}"
                   data-z="{{ data.get('photo_zoom','1.0') }}">
                <div class="crop-empty" id="cropEmptyBg" style="display:none">Carica una foto profilo</div>
              </div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>X (0–100)</label>
                <input id="posX" type="range" min="0" max="100" name="photo_pos_x" value="{{ data.get('photo_pos_x',50) }}">
              </div>
              <div class="field">
                <label>Y (0–100)</label>
                <input id="posY" type="range" min="0" max="100" name="photo_pos_y" value="{{ data.get('photo_pos_y',35) }}">
              </div>
              <div class="field full">
                <label>Zoom (1.0 – 2.5)</label>
                <input id="zoom" type="range" min="1" max="2.5" step="0.05" name="photo_zoom" value="{{ data.get('photo_zoom','1.0') }}">
              </div>
            </div>

            <div class="sep"></div>

            <div class="h3">Effetti</div>
            <div class="form-grid">
              <div class="field">
                <label><input type="checkbox" name="orbit_spin" {% if data.get('orbit_spin',0) == 1 %}checked{% endif %}> Ruota orbita</label>
              </div>
              <div class="field">
                <label><input id="ckAvatar" type="checkbox" name="avatar_spin" {% if data.get('avatar_spin',0) == 1 %}checked{% endif %}> Ruota foto</label>
              </div>
              <div class="field">
                <label><input type="checkbox" name="logo_spin" {% if data.get('logo_spin',0) == 1 %}checked{% endif %}> Ruota logo</label>
              </div>
              <div class="field">
                <label><input id="ckFlip" type="checkbox" name="allow_flip" {% if data.get('allow_flip',0) == 1 %}checked{% endif %}> Flip card</label>
              </div>
            </div>
          </div>

          <!-- ===================== GALLERIA FOTO ===================== -->
          <div class="section-box">
            <div class="h3">Galleria Foto</div>
            <div class="hint">Carica più immagini. Verranno aggiunte alle foto già presenti.</div>

            <div class="form-grid">
              <div class="field full">
                <label>Aggiungi foto</label>
                <input type="file" name="gallery_files" accept="image/*" multiple>
              </div>
            </div>

            <div style="margin-top:10px;">
              {% set imgs = (data.get('gallery_urls','') or '').split('|') %}
              {% set imgs2 = [] %}
              {% for x in imgs %}
                {% if x and x.strip() %}
                  {% set _ = imgs2.append(x) %}
                {% endif %}
              {% endfor %}

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                {% for g in imgs2 %}
                  <div style="width:110px;">
                    <div style="width:110px; height:110px; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);">
                      <img src="{{ g }}" style="width:100%; height:100%; object-fit:cover;" alt="">
                    </div>
                    {% if agent %}
                      <a class="btn-mini danger" style="margin-top:6px; display:inline-block;"
                         href="/area/media/delete/{{ agent.slug }}/{{ 'p1' if profile_label=='Profilo 1' else ('p2' if profile_label=='Profilo 2' else 'p3') }}?kind=img&url={{ g|urlencode }}">
                        Elimina
                      </a>
                    {% endif %}
                  </div>
                {% endfor %}
                {% if imgs2|length == 0 %}
                  <div class="hint">Nessuna foto in galleria.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- ===================== GALLERIA VIDEO ===================== -->
          <div class="section-box">
            <div class="h3">Galleria Video</div>
            <div class="hint">Carica video MP4/WEBM/MOV. Verranno aggiunti ai video già presenti.</div>

            <div class="form-grid">
              <div class="field full">
                <label>Aggiungi video</label>
                <input type="file" name="video_files" accept="video/*" multiple>
              </div>
            </div>

            <div style="margin-top:10px;">
              {% set vids = (data.get('video_urls','') or '').split('|') %}
              {% set vids2 = [] %}
              {% for x in vids %}
                {% if x and x.strip() %}
                  {% set _ = vids2.append(x) %}
                {% endif %}
              {% endfor %}

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                {% for v in vids2 %}
                  <div style="width:180px;">
                    <video src="{{ v }}#t=0.1" controls playsinline style="width:180px; border-radius:14px; border:1px solid rgba(255,255,255,.10);"></video>
                    {% if agent %}
                      <a class="btn-mini danger" style="margin-top:6px; display:inline-block;"
                         href="/area/media/delete/{{ agent.slug }}/{{ 'p1' if profile_label=='Profilo 1' else ('p2' if profile_label=='Profilo 2' else 'p3') }}?kind=vid&url={{ v|urlencode }}">
                        Elimina
                      </a>
                    {% endif %}
                  </div>
                {% endfor %}
                {% if vids2|length == 0 %}
                  <div class="hint">Nessun video in galleria.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- ===================== PDF ===================== -->
          <div class="section-box">
            <div class="h3">Documenti PDF</div>
            <div class="hint">Carica uno o più PDF. Saranno cliccabili e apribili.</div>

            <div class="form-grid">
              <div class="field full">
                <label>Aggiungi PDF</label>
                <input type="file" name="pdf_files" accept="application/pdf" multiple>
              </div>
            </div>

            <div style="margin-top:10px;">
              {% set pdfs = (data.get('pdf_urls','') or '').split('|') %}
              {% set pdfs2 = [] %}
              {% for x in pdfs %}
                {% if x and x.strip() %}
                  {% set _ = pdfs2.append(x) %}
                {% endif %}
              {% endfor %}

              <div style="display:flex; flex-direction:column; gap:8px;">
                {% for p in pdfs2 %}
                  {% if "||" in p %}
                    {% set nm = p.split("||")[0] %}
                    {% set u = p.split("||")[1] %}
                  {% else %}
                    {% set nm = p %}
                    {% set u = p %}
                  {% endif %}

                  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <a class="btn-mini ghost" target="_blank" href="{{ u }}">{{ nm }}</a>
                    {% if agent %}
                      <a class="btn-mini danger"
                         href="/area/media/delete/{{ agent.slug }}/{{ 'p1' if profile_label=='Profilo 1' else ('p2' if profile_label=='Profilo 2' else 'p3') }}?kind=pdf&url={{ u|urlencode }}">
                        Elimina
                      </a>
                    {% endif %}
                  </div>
                {% endfor %}

                {% if pdfs2|length == 0 %}
                  <div class="hint">Nessun PDF caricato.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- ===================== CONTATTI ===================== -->
          <div class="section-box">
            <div class="h3">Contatti</div>
            <div class="form-grid">
              <div class="field">
                <label>Telefono (mobile)</label>
                <input type="text" name="phone_mobile" value="{{ data.get('phone_mobile','') }}">
              </div>
              <div class="field">
                <label>Telefono (mobile 2)</label>
                <input type="text" name="phone_mobile2" value="{{ data.get('phone_mobile2','') }}">
              </div>
              <div class="field">
                <label>Telefono ufficio</label>
                <input type="text" name="phone_office" value="{{ data.get('phone_office','') }}">
              </div>
              <div class="field">
                <label>WhatsApp</label>
                <input type="text" name="whatsapp" value="{{ data.get('whatsapp','') }}">
                <div class="hint">Esempio: +39350.... oppure link wa.me</div>
              </div>
              <div class="field full">
                <label>Email (separate da virgola)</label>
                <input type="text" name="emails" value="{{ data.get('emails','') }}">
              </div>
              <div class="field full">
                <label>Siti (separati da virgola)</label>
                <input type="text" name="websites" value="{{ data.get('websites','') }}">
              </div>
              <div class="field">
                <label>PEC</label>
                <input type="text" name="pec" value="{{ data.get('pec','') }}">
              </div>
              <div class="field full">
                <label>Indirizzi (uno per riga)</label>
                <textarea name="addresses">{{ data.get('addresses','') }}</textarea>
              </div>
            </div>
          </div>

          <!-- ===================== DATI AZIENDALI ===================== -->
          <div class="section-box">
            <div class="h3">Dati aziendali</div>
            <div class="form-grid">
              <div class="field">
                <label>P.IVA</label>
                <input type="text" name="piva" value="{{ data.get('piva','') }}">
              </div>
              <div class="field">
                <label>SDI</label>
                <input type="text" name="sdi" value="{{ data.get('sdi','') }}">
              </div>
            </div>
          </div>

          <!-- ===================== SOCIAL ===================== -->
          <div class="section-box">
            <div class="h3">Social</div>
            <div class="hint">Inserisci URL completi (se non valido non verrà mostrato).</div>

            <div class="form-grid">
              <div class="field"><label>Facebook</label><input type="text" name="facebook" value="{{ data.get('facebook','') }}"></div>
              <div class="field"><label>Instagram</label><input type="text" name="instagram" value="{{ data.get('instagram','') }}"></div>
              <div class="field"><label>LinkedIn</label><input type="text" name="linkedin" value="{{ data.get('linkedin','') }}"></div>
              <div class="field"><label>TikTok</label><input type="text" name="tiktok" value="{{ data.get('tiktok','') }}"></div>
              <div class="field"><label>Telegram</label><input type="text" name="telegram" value="{{ data.get('telegram','') }}"></div>
              <div class="field"><label>YouTube</label><input type="text" name="youtube" value="{{ data.get('youtube','') }}"></div>
              <div class="field"><label>Spotify</label><input type="text" name="spotify" value="{{ data.get('spotify','') }}"></div>
            </div>
          </div>

          <!-- ===================== TRADUZIONI ===================== -->
          {% if show_i18n %}
          <div class="section-box">
            <div class="h3">Traduzioni</div>
            <div class="hint">4 righe. Clicca per aprire.</div>

            <details style="margin-top:10px;">
              <summary style="cursor:pointer; font-weight:950;">English</summary>
              <div style="margin-top:10px;">
                <div class="form-grid compact">
                  <div class="field"><label>Name (EN)</label><input type="text" name="name_en" value="{{ i18n.get('en',{}).get('name','') }}"></div>
                  <div class="field"><label>Company (EN)</label><input type="text" name="company_en" value="{{ i18n.get('en',{}).get('company','') }}"></div>
                  <div class="field"><label>Role (EN)</label><input type="text" name="role_en" value="{{ i18n.get('en',{}).get('role','') }}"></div>
                  <div class="field full"><label>Bio (EN)</label><textarea name="bio_en">{{ i18n.get('en',{}).get('bio','') }}</textarea></div>
                  <div class="field full"><label>Addresses (EN)</label><textarea name="addresses_en">{{ i18n.get('en',{}).get('addresses','') }}</textarea></div>
                </div>
              </div>
            </details>

            <details style="margin-top:10px;">
              <summary style="cursor:pointer; font-weight:950;">Français</summary>
              <div style="margin-top:10px;">
                <div class="form-grid compact">
                  <div class="field"><label>Nom (FR)</label><input type="text" name="name_fr" value="{{ i18n.get('fr',{}).get('name','') }}"></div>
                  <div class="field"><label>Société (FR)</label><input type="text" name="company_fr" value="{{ i18n.get('fr',{}).get('company','') }}"></div>
                  <div class="field"><label>Rôle (FR)</label><input type="text" name="role_fr" value="{{ i18n.get('fr',{}).get('role','') }}"></div>
                  <div class="field full"><label>Bio (FR)</label><textarea name="bio_fr">{{ i18n.get('fr',{}).get('bio','') }}</textarea></div>
                  <div class="field full"><label>Adresses (FR)</label><textarea name="addresses_fr">{{ i18n.get('fr',{}).get('addresses','') }}</textarea></div>
                </div>
              </div>
            </details>

            <details style="margin-top:10px;">
              <summary style="cursor:pointer; font-weight:950;">Español</summary>
              <div style="margin-top:10px;">
                <div class="form-grid compact">
                  <div class="field"><label>Nombre (ES)</label><input type="text" name="name_es" value="{{ i18n.get('es',{}).get('name','') }}"></div>
                  <div class="field"><label>Empresa (ES)</label><input type="text" name="company_es" value="{{ i18n.get('es',{}).get('company','') }}"></div>
                  <div class="field"><label>Rol (ES)</label><input type="text" name="role_es" value="{{ i18n.get('es',{}).get('role','') }}"></div>
                  <div class="field full"><label>Bio (ES)</label><textarea name="bio_es">{{ i18n.get('es',{}).get('bio','') }}</textarea></div>
                  <div class="field full"><label>Direcciones (ES)</label><textarea name="addresses_es">{{ i18n.get('es',{}).get('addresses','') }}</textarea></div>
                </div>
              </div>
            </details>

            <details style="margin-top:10px;">
              <summary style="cursor:pointer; font-weight:950;">Deutsch</summary>
              <div style="margin-top:10px;">
                <div class="form-grid compact">
                  <div class="field"><label>Name (DE)</label><input type="text" name="name_de" value="{{ i18n.get('de',{}).get('name','') }}"></div>
                  <div class="field"><label>Firma (DE)</label><input type="text" name="company_de" value="{{ i18n.get('de',{}).get('company','') }}"></div>
                  <div class="field"><label>Rolle (DE)</label><input type="text" name="role_de" value="{{ i18n.get('de',{}).get('role','') }}"></div>
                  <div class="field full"><label>Bio (DE)</label><textarea name="bio_de">{{ i18n.get('de',{}).get('bio','') }}</textarea></div>
                  <div class="field full"><label>Adressen (DE)</label><textarea name="addresses_de">{{ i18n.get('de',{}).get('addresses','') }}</textarea></div>
                </div>
              </div>
            </details>
          </div>
          {% endif %}

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>

      </div>
    </div>
  </main>
</div>

<script>
  function bindPreview(inputId, imgId){
    const inp = document.getElementById(inputId);
    const img = document.getElementById(imgId);
    if(!inp || !img) return;
    inp.addEventListener('change', () => {
      const f = inp.files && inp.files[0];
      if(!f) return;
      img.style.display = 'block';
      img.src = URL.createObjectURL(f);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    bindPreview('photoInput','prevPhoto');
    bindPreview('logoInput','prevLogo');
    bindPreview('backInput','prevBack');

    const box = document.getElementById('cropCircleBg');
    if(!box) return;

    const posX = document.getElementById('posX');
    const posY = document.getElementById('posY');
    const zoom = document.getElementById('zoom');
    const photoInput = document.getElementById('photoInput');
    const empty = document.getElementById('cropEmptyBg');

    function apply(){
      const url = box.getAttribute('data-url') || '';
      const x = posX ? posX.value : (box.getAttribute('data-x') || 50);
      const y = posY ? posY.value : (box.getAttribute('data-y') || 35);
      const z = zoom ? zoom.value : (box.getAttribute('data-z') || 1.0);

      if(!url){
        box.style.backgroundImage = 'none';
        if(empty) empty.style.display = 'flex';
        return;
      }
      if(empty) empty.style.display = 'none';

      box.style.backgroundImage = `url("${url}")`;
      box.style.backgroundRepeat = 'no-repeat';
      box.style.backgroundPosition = `${x}% ${y}%`;
      box.style.backgroundSize = `${parseFloat(z) * 100}% ${parseFloat(z) * 100}%`;
    }

    apply();

    if(posX){ posX.addEventListener('input', apply); posX.addEventListener('change', apply); }
    if(posY){ posY.addEventListener('input', apply); posY.addEventListener('change', apply); }
    if(zoom){ zoom.addEventListener('input', apply); zoom.addEventListener('change', apply); }

    if(photoInput){
      photoInput.addEventListener('change', () => {
        const f = photoInput.files && photoInput.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        box.setAttribute('data-url', url);
        apply();
      });
    }
  });
</script>

</body>
</html>
