<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ "Modifica Profilo 2" if editing_profile2 else ("Modifica Profilo 3" if editing_profile3 else "Modifica Profilo 1") }} | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">
          {% if editing_profile2 %}Profilo 2{% elif editing_profile3 %}Profilo 3{% else %}Profilo 1{% endif %}
        </div>
      </div>
    </a>

    <div class="toolbar">
      <a class="btn" href="/area">← Dashboard</a>
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="page-main">
      <div class="panel panel-wide">

        <div class="panel-head">
          <div>
            <h1 class="page-title">
              {% if editing_profile2 %}Modifica Profilo 2{% elif editing_profile3 %}Modifica Profilo 3{% else %}Modifica Profilo 1{% endif %}
            </h1>
            <div class="hint">
              {% if editing_profile2 %}
                Profilo 2 indipendente dal Profilo 1.
              {% elif editing_profile3 %}
                Profilo 3 indipendente dal Profilo 1.
              {% else %}
                Profilo principale.
              {% endif %}
            </div>
          </div>

          <div class="toolbar">
            {% if agent %}
              <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}">Apri P1</a>
              {% if agent.p2_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p2">Apri P2</a>
              {% endif %}
              {% if agent.p3_enabled == 1 %}
                <a class="btn-mini ghost" target="_blank" href="/{{ agent.slug }}?p=p3">Apri P3</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="sep"></div>

        {# d = dati del profilo attuale #}
        {% set d = p2_data if editing_profile2 else (p3_data if editing_profile3 else agent) %}
        {% set isP = (editing_profile2 or editing_profile3) %}

        <form method="post" enctype="multipart/form-data" class="card-form">

          {% if agent %}
          <div class="section-box">
            <div class="h3">Identificativo</div>
            <div class="form-grid">
              <div class="field">
                <label>Slug (non modificabile)</label>
                <input type="text" value="{{ agent.slug }}" readonly>
              </div>
              <div class="field">
                <label>Username</label>
                <input type="text" value="{{ agent.username }}" readonly>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ===================== DATI PRINCIPALI ===================== -->
          <div class="section-box">
            <div class="h3">Dati principali</div>
            <div class="form-grid">
              <div class="field">
                <label>Nome</label>
                <input type="text" name="name" value="{{ (d.name if not isP else d.get('name','')) }}">
              </div>
              <div class="field">
                <label>Azienda</label>
                <input type="text" name="company" value="{{ (d.company if not isP else d.get('company','')) }}">
              </div>
              <div class="field">
                <label>Ruolo</label>
                <input type="text" name="role" value="{{ (d.role if not isP else d.get('role','')) }}">
              </div>
              <div class="field">
                <label>Bio</label>
                <textarea name="bio" placeholder="Breve descrizione...">{{ (d.bio if not isP else d.get('bio','')) }}</textarea>
              </div>
            </div>
          </div>

          <!-- ===================== FOTO / LOGO / FOTO DIETRO + CROP ===================== -->
          <div class="section-box">
            <div class="h3">Foto profilo, Logo e Foto dietro</div>
            <div class="hint">
              Nota: è normale che il browser mostri “nessun file selezionato” dopo il salvataggio.
              Qui sotto vedi sempre l’anteprima attuale e l’anteprima appena selezioni un nuovo file.
            </div>

            <div class="form-grid">
              <div class="field full">
                <label>Carica foto profilo</label>
                <input id="photoInput" type="file" name="photo" accept="image/*">
                <div class="hint">
                  Attuale:
                  {% if (d.photo_url if not isP else d.get('photo_url','')) %}
                    <span class="slug-badge">{{ (d.photo_url if not isP else d.get('photo_url','')) }}</span>
                  {% else %}
                    —
                  {% endif %}
                </div>
                <div class="dash-mini-grid" style="margin-top:8px">
                  <img id="photoPreview" class="dash-mini"
                       src="{{ (d.photo_url if not isP else d.get('photo_url','')) }}"
                       alt=""
                       style="{% if not (d.photo_url if not isP else d.get('photo_url','')) %}display:none{% endif %}">
                </div>
              </div>

              <div class="field full">
                <label>Carica logo</label>
                <input id="logoInput" type="file" name="logo" accept="image/*">
                <div class="hint">
                  Attuale:
                  {% if (d.logo_url if not isP else d.get('logo_url','')) %}
                    <span class="slug-badge">{{ (d.logo_url if not isP else d.get('logo_url','')) }}</span>
                  {% else %}
                    —
                  {% endif %}
                </div>
                <div class="dash-mini-grid" style="margin-top:8px">
                  <img id="logoPreview" class="dash-mini"
                       src="{{ (d.logo_url if not isP else d.get('logo_url','')) }}"
                       alt=""
                       style="{% if not (d.logo_url if not isP else d.get('logo_url','')) %}display:none{% endif %}">
                </div>
              </div>

              <div class="field full">
                <label>Carica foto dietro (immagine personalizzata dietro la foto agente)</label>
                <input id="backInput" type="file" name="back_media" accept="image/*">
                <div class="hint">
                  Attuale:
                  {% if (d.back_media_url if not isP else d.get('back_media_url','')) %}
                    <span class="slug-badge">{{ (d.back_media_url if not isP else d.get('back_media_url','')) }}</span>
                  {% else %}
                    —
                  {% endif %}
                </div>
                <div class="dash-mini-grid" style="margin-top:8px">
                  <img id="backPreview" class="dash-mini"
                       src="{{ (d.back_media_url if not isP else d.get('back_media_url','')) }}"
                       alt=""
                       style="{% if not (d.back_media_url if not isP else d.get('back_media_url','')) %}display:none{% endif %}">
                </div>
              </div>
            </div>

            <div class="crop-preview">
              <div class="crop-circle-bg" id="cropCircleBg"
                   data-url="{{ (d.photo_url if not isP else d.get('photo_url','')) }}"
                   data-x="{{ (d.photo_pos_x if not isP else d.get('photo_pos_x',50)) }}"
                   data-y="{{ (d.photo_pos_y if not isP else d.get('photo_pos_y',35)) }}"
                   data-z="{{ (d.photo_zoom if not isP else d.get('photo_zoom','1.0')) }}">
                <div class="crop-empty" id="cropEmptyBg" style="display:none">Carica una foto profilo</div>
              </div>
            </div>

            <div class="form-grid" style="margin-top:12px">
              <div class="field">
                <label>X (0–100)</label>
                <input id="posX" type="range" min="0" max="100" name="photo_pos_x" value="{{ (d.photo_pos_x if not isP else d.get('photo_pos_x',50)) }}">
              </div>
              <div class="field">
                <label>Y (0–100)</label>
                <input id="posY" type="range" min="0" max="100" name="photo_pos_y" value="{{ (d.photo_pos_y if not isP else d.get('photo_pos_y',35)) }}">
              </div>
              <div class="field full">
                <label>Zoom (1.0 – 2.5)</label>
                <input id="zoom" type="range" min="1" max="2.5" step="0.05" name="photo_zoom" value="{{ (d.photo_zoom if not isP else d.get('photo_zoom','1.0')) }}">
              </div>
            </div>
          </div>

          <!-- ===================== EFFETTI GRAFICI (SUBITO DOPO CROP) ===================== -->
          <div class="section-box">
            <div class="h3">Effetti grafici</div>
            <div class="hint">Ruota foto e Flip si escludono automaticamente e quello escluso diventa non cliccabile.</div>
            <div class="form-grid">
              <div class="field">
                <label><input id="orbitSpin" type="checkbox" name="orbit_spin" {% if (d.orbit_spin if not isP else d.get('orbit_spin',0))==1 %}checked{% endif %}> Orbita (decorazione)</label>
              </div>
              <div class="field">
                <label><input id="logoSpin" type="checkbox" name="logo_spin" {% if (d.logo_spin if not isP else d.get('logo_spin',0))==1 %}checked{% endif %}> Ruota logo</label>
              </div>
              <div class="field">
                <label><input id="avatarSpin" type="checkbox" name="avatar_spin" {% if (d.avatar_spin if not isP else d.get('avatar_spin',0))==1 %}checked{% endif %}> Ruota foto profilo</label>
              </div>
              <div class="field">
                <label><input id="allowFlip" type="checkbox" name="allow_flip" {% if (d.allow_flip if not isP else d.get('allow_flip',0))==1 %}checked{% endif %}> Flip card (fronte/retro)</label>
              </div>
            </div>
          </div>

          <!-- ===================== CONTATTI ===================== -->
          <div class="section-box">
            <div class="h3">Contatti</div>
            <div class="form-grid">
              <div class="field">
                <label>Telefono (mobile)</label>
                <input type="text" name="phone_mobile" value="{{ (agent.phone_mobile if not isP else d.get('phone_mobile','')) if agent else '' }}">
              </div>
              <div class="field">
                <label>Telefono (mobile 2)</label>
                <input type="text" name="phone_mobile2" value="{{ (agent.phone_mobile2 if not isP else d.get('phone_mobile2','')) if agent else '' }}">
              </div>
              <div class="field">
                <label>Telefono ufficio</label>
                <input type="text" name="phone_office" value="{{ (agent.phone_office if not isP else d.get('phone_office','')) if agent else '' }}">
              </div>
              <div class="field">
                <label>WhatsApp</label>
                <input type="text" name="whatsapp" value="{{ (agent.whatsapp if not isP else d.get('whatsapp','')) if agent else '' }}">
                <div class="hint">Esempio: +39350.... oppure link wa.me</div>
              </div>
              <div class="field full">
                <label>Email (separate da virgola)</label>
                <input type="text" name="emails" value="{{ (agent.emails if not isP else d.get('emails','')) if agent else '' }}">
              </div>
              <div class="field full">
                <label>Siti (separati da virgola)</label>
                <input type="text" name="websites" value="{{ (agent.websites if not isP else d.get('websites','')) if agent else '' }}">
              </div>
              <div class="field">
                <label>PEC</label>
                <input type="text" name="pec" value="{{ (agent.pec if not isP else d.get('pec','')) if agent else '' }}">
              </div>
              <div class="field full">
                <label>Indirizzi (uno per riga)</label>
                <textarea name="addresses">{{ (agent.addresses if not isP else d.get('addresses','')) if agent else '' }}</textarea>
              </div>
            </div>
          </div>

          <!-- ===================== DATI AZIENDALI ===================== -->
          <div class="section-box">
            <div class="h3">Dati aziendali</div>
            <div class="form-grid">
              <div class="field">
                <label>P.IVA</label>
                <input type="text" name="piva" value="{{ (agent.piva if not isP else d.get('piva','')) if agent else '' }}">
              </div>
              <div class="field">
                <label>SDI</label>
                <input type="text" name="sdi" value="{{ (agent.sdi if not isP else d.get('sdi','')) if agent else '' }}">
              </div>
            </div>
          </div>

          <!-- ===================== SOCIAL (ISTRUZIONI) ===================== -->
          <div class="section-box">
            <div class="h3">Social</div>
            <div class="hint">Inserisci URL completi. Se non è un URL valido, non verrà mostrato sulla card.</div>

            <div class="form-grid">
              <div class="field">
                <label>Facebook</label>
                <input type="text" name="facebook" value="{{ (agent.facebook if not isP else d.get('facebook','')) if agent else '' }}">
                <div class="hint">https://www.facebook.com/tuapagina</div>
              </div>
              <div class="field">
                <label>Instagram</label>
                <input type="text" name="instagram" value="{{ (agent.instagram if not isP else d.get('instagram','')) if agent else '' }}">
                <div class="hint">https://www.instagram.com/tuoprofilo</div>
              </div>
              <div class="field">
                <label>LinkedIn</label>
                <input type="text" name="linkedin" value="{{ (agent.linkedin if not isP else d.get('linkedin','')) if agent else '' }}">
                <div class="hint">https://www.linkedin.com/in/tuoprofilo</div>
              </div>
              <div class="field">
                <label>TikTok</label>
                <input type="text" name="tiktok" value="{{ (agent.tiktok if not isP else d.get('tiktok','')) if agent else '' }}">
                <div class="hint">https://www.tiktok.com/@tuoprofilo</div>
              </div>
              <div class="field">
                <label>Telegram</label>
                <input type="text" name="telegram" value="{{ (agent.telegram if not isP else d.get('telegram','')) if agent else '' }}">
                <div class="hint">https://t.me/username</div>
              </div>
              <div class="field">
                <label>YouTube</label>
                <input type="text" name="youtube" value="{{ (agent.youtube if not isP else d.get('youtube','')) if agent else '' }}">
                <div class="hint">https://www.youtube.com/@channel</div>
              </div>
              <div class="field">
                <label>Spotify</label>
                <input type="text" name="spotify" value="{{ (agent.spotify if not isP else d.get('spotify','')) if agent else '' }}">
                <div class="hint">https://open.spotify.com/...</div>
              </div>
            </div>
          </div>

          <!-- ===================== MEDIA (ORA ANCHE IN P2/P3) ===================== -->
          <div class="section-box">
            <div class="h3">Media</div>
            <div class="hint">
              Limiti:
              <b>{{ limits.max_imgs }}</b> foto (max <b>{{ limits.img_mb }}MB</b>),
              <b>{{ limits.max_vids }}</b> video (max <b>{{ limits.vid_mb }}MB</b>),
              <b>{{ limits.max_pdfs }}</b> PDF (max <b>{{ limits.pdf_mb }}MB</b>).
            </div>

            <!-- FOTO -->
            <div class="media-preview">
              <div class="media-title">Galleria foto</div>
              <div class="form-grid">
                <div class="field full">
                  <label>Carica foto in galleria</label>
                  <input type="file" name="gallery" multiple accept="image/*">
                </div>
              </div>

              <div class="media-grid" style="margin-top:10px">
                {% for g in gallery %}
                  <div class="media-item">
                    <img src="{{ g }}" alt="" onclick="openViewer('gallery','{{ g }}','{{ agent.slug }}',{{ loop.index0 }})">
                  </div>
                {% endfor %}
                {% if gallery|length == 0 %}
                  <div class="dash-mini-empty" style="width:100%">Nessuna foto</div>
                {% endif %}
              </div>
            </div>

            <!-- VIDEO -->
            <div class="media-preview">
              <div class="media-title">Video</div>
              <div class="form-grid">
                <div class="field full">
                  <label>Carica video</label>
                  <input type="file" name="videos" multiple accept="video/*">
                </div>
              </div>

              <div class="media-grid" style="margin-top:10px">
                {% for v in videos %}
                  <div class="media-item">
                    <video src="{{ v }}#t=0.1" muted playsinline preload="metadata"
                           onclick="openViewer('video','{{ v }}','{{ agent.slug }}',{{ loop.index0 }})"></video>
                    <div class="media-play">▶</div>
                  </div>
                {% endfor %}
                {% if videos|length == 0 %}
                  <div class="dash-mini-empty" style="width:100%">Nessun video</div>
                {% endif %}
              </div>
            </div>

            <!-- PDF -->
            <div class="media-preview">
              <div class="media-title">PDF</div>
              <div class="hint">Carica fino a {{ limits.max_pdfs }} PDF. Oltre non verranno salvati.</div>

              <div class="form-grid">
                {% for i in range(1, limits.max_pdfs + 1) %}
                <div class="field">
                  <label>PDF {{ i }}</label>
                  <input type="file" name="pdf{{ i }}" accept="application/pdf">
                </div>
                {% endfor %}
              </div>

              <div class="pdf-preview" style="margin-top:10px">
                {% for p in pdfs %}
                  <div class="pdf-row">
                    <div class="pdf-name" onclick="openViewer('pdf','{{ p.url }}','{{ agent.slug }}',{{ loop.index0 }})">
                      {{ p.name }}
                    </div>
                  </div>
                {% endfor %}
                {% if pdfs|length == 0 %}
                  <div class="dash-mini-empty">Nessun PDF</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- ===================== TRADUZIONI (solo P1) ===================== -->
          {% if not isP %}
          <div class="section-box">
            <div class="h3">Traduzioni</div>
            <div class="hint">Clicca per aprire i campi completi.</div>

            <div class="sep"></div>

            <details>
              <summary class="btn-mini ghost" style="cursor:pointer;">English</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Name (EN)</label><input type="text" name="name_en" value="{{ (i18n_data.get('en',{}).get('name','')) }}"></div>
                <div class="field"><label>Company (EN)</label><input type="text" name="company_en" value="{{ (i18n_data.get('en',{}).get('company','')) }}"></div>
                <div class="field"><label>Role (EN)</label><input type="text" name="role_en" value="{{ (i18n_data.get('en',{}).get('role','')) }}"></div>
                <div class="field full"><label>Bio (EN)</label><textarea name="bio_en">{{ (i18n_data.get('en',{}).get('bio','')) }}</textarea></div>
                <div class="field full"><label>Addresses (EN)</label><textarea name="addresses_en">{{ (i18n_data.get('en',{}).get('addresses','')) }}</textarea></div>
              </div>
            </details>

            <div class="sep"></div>

            <details>
              <summary class="btn-mini ghost" style="cursor:pointer;">Français</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Nom (FR)</label><input type="text" name="name_fr" value="{{ (i18n_data.get('fr',{}).get('name','')) }}"></div>
                <div class="field"><label>Société (FR)</label><input type="text" name="company_fr" value="{{ (i18n_data.get('fr',{}).get('company','')) }}"></div>
                <div class="field"><label>Rôle (FR)</label><input type="text" name="role_fr" value="{{ (i18n_data.get('fr',{}).get('role','')) }}"></div>
                <div class="field full"><label>Bio (FR)</label><textarea name="bio_fr">{{ (i18n_data.get('fr',{}).get('bio','')) }}</textarea></div>
                <div class="field full"><label>Adresses (FR)</label><textarea name="addresses_fr">{{ (i18n_data.get('fr',{}).get('addresses','')) }}</textarea></div>
              </div>
            </details>

            <div class="sep"></div>

            <details>
              <summary class="btn-mini ghost" style="cursor:pointer;">Español</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Nombre (ES)</label><input type="text" name="name_es" value="{{ (i18n_data.get('es',{}).get('name','')) }}"></div>
                <div class="field"><label>Empresa (ES)</label><input type="text" name="company_es" value="{{ (i18n_data.get('es',{}).get('company','')) }}"></div>
                <div class="field"><label>Rol (ES)</label><input type="text" name="role_es" value="{{ (i18n_data.get('es',{}).get('role','')) }}"></div>
                <div class="field full"><label>Bio (ES)</label><textarea name="bio_es">{{ (i18n_data.get('es',{}).get('bio','')) }}</textarea></div>
                <div class="field full"><label>Direcciones (ES)</label><textarea name="addresses_es">{{ (i18n_data.get('es',{}).get('addresses','')) }}</textarea></div>
              </div>
            </details>

            <div class="sep"></div>

            <details>
              <summary class="btn-mini ghost" style="cursor:pointer;">Deutsch</summary>
              <div class="sep"></div>
              <div class="form-grid compact">
                <div class="field"><label>Name (DE)</label><input type="text" name="name_de" value="{{ (i18n_data.get('de',{}).get('name','')) }}"></div>
                <div class="field"><label>Firma (DE)</label><input type="text" name="company_de" value="{{ (i18n_data.get('de',{}).get('company','')) }}"></div>
                <div class="field"><label>Rolle (DE)</label><input type="text" name="role_de" value="{{ (i18n_data.get('de',{}).get('role','')) }}"></div>
                <div class="field full"><label>Bio (DE)</label><textarea name="bio_de">{{ (i18n_data.get('de',{}).get('bio','')) }}</textarea></div>
                <div class="field full"><label>Adressen (DE)</label><textarea name="addresses_de">{{ (i18n_data.get('de',{}).get('addresses','')) }}</textarea></div>
              </div>
            </details>

          </div>
          {% endif %}

          <div class="sticky-save">
            <button class="btn primary" type="submit">Salva</button>
            <a class="btn" href="/area">Annulla</a>
          </div>

        </form>
      </div>
    </div>

  </main>

</div>

<!-- VIEWER MODAL: elimina solo qui -->
<div id="viewer" class="modal-overlay" style="display:none" onclick="overlayCloseViewer(event)">
  <div class="modal-box modal-big" onclick="event.stopPropagation()">
    <div class="modal-title" id="vTitle">Anteprima</div>

    <img id="vImg" style="display:none" src="" alt="">
    <video id="vVideo" style="display:none" controls playsinline></video>
    <iframe id="vPdf" style="display:none" src=""></iframe>

    <div class="modal-actions" style="margin-top:12px">
      <button class="btn danger" type="button" onclick="deleteCurrentMedia()">ELIMINA</button>
      <button class="btn" type="button" onclick="shareViewer('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareViewer('email')">Invia Email</button>
      <button class="btn ghost" type="button" onclick="closeViewer()">Chiudi</button>
    </div>
  </div>
</div>

<script>
  function absUrl(u){
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }
  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }

  // ===== ANTEPRIMA FILE INPUT (logo/foto/back) =====
  function bindPreview(inputId, imgId){
    const inp = document.getElementById(inputId);
    const img = document.getElementById(imgId);
    if(!inp || !img) return;
    inp.addEventListener('change', () => {
      const f = inp.files && inp.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      img.src = url;
      img.style.display = 'block';
    });
  }

  // ===== CROP (background-position) =====
  function setupCrop(){
    const box = document.getElementById('cropCircleBg');
    if(!box) return;

    const posX = document.getElementById('posX');
    const posY = document.getElementById('posY');
    const zoom = document.getElementById('zoom');
    const photoInput = document.getElementById('photoInput');
    const empty = document.getElementById('cropEmptyBg');

    function apply(){
      const url = box.getAttribute('data-url') || '';
      const x = posX ? posX.value : (box.getAttribute('data-x') || 50);
      const y = posY ? posY.value : (box.getAttribute('data-y') || 35);
      const z = zoom ? zoom.value : (box.getAttribute('data-z') || 1.0);

      if(!url){
        box.style.backgroundImage = 'none';
        if(empty) empty.style.display = 'flex';
        return;
      }
      if(empty) empty.style.display = 'none';

      box.style.backgroundImage = `url("${url}")`;
      box.style.backgroundRepeat = 'no-repeat';
      box.style.backgroundPosition = `${x}% ${y}%`;
      box.style.backgroundSize = `${parseFloat(z) * 100}% ${parseFloat(z) * 100}%`;
    }

    apply();
    if(posX){ posX.addEventListener('input', apply); posX.addEventListener('change', apply); }
    if(posY){ posY.addEventListener('input', apply); posY.addEventListener('change', apply); }
    if(zoom){ zoom.addEventListener('input', apply); zoom.addEventListener('change', apply); }

    if(photoInput){
      photoInput.addEventListener('change', () => {
        const f = photoInput.files && photoInput.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        box.setAttribute('data-url', url);
        apply();
      });
    }
  }

  // ===== MUTUA ESCLUSIONE (ruota foto vs flip) + DISABILITA =====
  function syncSpinFlip(){
    const avatarSpin = document.getElementById('avatarSpin');
    const allowFlip = document.getElementById('allowFlip');
    if(!avatarSpin || !allowFlip) return;

    if(avatarSpin.checked){
      allowFlip.checked = false;
      allowFlip.disabled = true;
    }else{
      allowFlip.disabled = false;
    }

    if(allowFlip.checked){
      avatarSpin.checked = false;
      avatarSpin.disabled = true;
    }else{
      avatarSpin.disabled = false;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    bindPreview('photoInput','photoPreview');
    bindPreview('logoInput','logoPreview');
    bindPreview('backInput','backPreview');

    setupCrop();

    const avatarSpin = document.getElementById('avatarSpin');
    const allowFlip = document.getElementById('allowFlip');
    if(avatarSpin) avatarSpin.addEventListener('change', syncSpinFlip);
    if(allowFlip) allowFlip.addEventListener('change', syncSpinFlip);
    syncSpinFlip();
  });

  // ===== VIEWER =====
  let viewerState = { slug:'', type:'', idx:-1, url:'' };

  function openViewer(type, url, slug, idx){
    viewerState = { slug, type, idx, url: url };

    const modal = document.getElementById('viewer');
    const vImg = document.getElementById('vImg');
    const vVideo = document.getElementById('vVideo');
    const vPdf = document.getElementById('vPdf');
    const title = document.getElementById('vTitle');

    vImg.style.display = 'none';
    vVideo.style.display = 'none';
    vPdf.style.display = 'none';
    try{ vVideo.pause(); }catch(e){}

    if(type === 'gallery'){
      title.textContent = 'Foto';
      vImg.src = url;
      vImg.style.display = 'block';
    } else if(type === 'video'){
      title.textContent = 'Video';
      vVideo.src = url;
      vVideo.style.display = 'block';
    } else {
      title.textContent = 'PDF';
      vPdf.src = url;
      vPdf.style.display = 'block';
    }
    modal.style.display = 'flex';
  }

  function closeViewer(){
    const modal = document.getElementById('viewer');
    const vVideo = document.getElementById('vVideo');
    try{ vVideo.pause(); }catch(e){}
    modal.style.display = 'none';
  }
  function overlayCloseViewer(e){
    if(e.target && e.target.id === 'viewer'){
      closeViewer();
    }
  }

  function shareViewer(channel){
    const kind = (viewerState.type || '').toUpperCase();
    const slug = viewerState.slug || '';
    const mediaUrl = absUrl(viewerState.url || '');

    const msg = [
      `Pay4You Media ${kind}`,
      `Slug: ${slug}`,
      `Link: ${mediaUrl}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = `Pay4You Media ${kind} ${slug ? slug.toUpperCase() : ''}`.trim();
    window.open(gmailCompose(subject, msg), '_blank');
  }

  function postDelete(slug, type, idx){
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/area/media/delete/${slug}`;

    const i1 = document.createElement('input');
    i1.type = 'hidden'; i1.name = 'type'; i1.value = type;
    const i2 = document.createElement('input');
    i2.type = 'hidden'; i2.name = 'idx'; i2.value = String(idx);

    // profilo corrente (p1/p2/p3)
    const prof = document.createElement('input');
    prof.type = 'hidden'; prof.name = 'profile'; prof.value = '{{ "p2" if editing_profile2 else ("p3" if editing_profile3 else "p1") }}';

    form.appendChild(i1);
    form.appendChild(i2);
    form.appendChild(prof);
    document.body.appendChild(form);
    form.submit();
  }

  function deleteCurrentMedia(){
    const slug = viewerState.slug;
    const type = viewerState.type;
    const idx = viewerState.idx;

    if(!slug || idx < 0 || !type) return;

    if(!confirm("Eliminare questo file?")) return;
    if(!confirm("Conferma definitiva: NON sarà ripristinabile.")) return;

    postDelete(slug, type === 'gallery' ? 'gallery' : (type === 'video' ? 'video' : 'pdf'), idx);
  }
</script>

</body>
</html>
