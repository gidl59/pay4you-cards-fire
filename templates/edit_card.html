<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Modifica Card PRO</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* STILI AGGIORNATI E FORZATI */
    body { background:#050505; color:white; font-family:sans-serif; }
    .edit-container { max-width:900px; margin:20px auto; padding-bottom:110px; }
    .edit-box { background:#111; padding:25px; border-radius:15px; border:1px solid #333; margin-bottom:20px; }
    .box-title { color:#00ffc8; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px; font-size:14px; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; }

    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .full-width { grid-column: span 2; }

    label { display:block; color:#aaa; margin-bottom:5px; font-size:12px; font-weight:bold; }
    input[type="text"], textarea { width:100%; padding:12px; background:#222; border:1px solid #444; color:white; border-radius:6px; box-sizing:border-box; }

    /* SLIDER E CROP */
    .crop-area { text-align:center; background:#000; padding:15px; border-radius:10px; border:1px solid #333; }
    .crop-circle {
        width:160px; height:160px;
        border-radius:50%; border:3px solid #00ffc8;
        overflow:hidden; margin:0 auto 15px auto;
        position:relative; background:#222;
        display: flex; align-items: center; justify-content: center;
    }
    .crop-circle img {
        width:100%; height:100%;
        object-fit:cover;
        transform-origin: center center;
        display:block;
    }

    .slider-row { display:flex; align-items:center; gap:10px; margin-bottom:15px; }
    .slider-row label { margin:0; width:30px; text-align:center; font-size:18px; }
    input[type="range"] { width: 100%; cursor: pointer; }

    /* AVVISO GIALLO */
    #boxAvvisoGiallo {
        background-color: #382800 !important;
        border: 2px solid #ffb000 !important;
        color: #ffd58a !important;
        padding: 15px !important;
        border-radius: 8px !important;
        font-size: 13px !important;
        font-weight: bold !important;
        margin-top: 15px !important;
        text-align: left !important;
        display: none;
    }

    /* MEDIA GALLERY */
    .dash-gallery { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .dash-item { position:relative; width:80px; height:80px; border-radius:8px; overflow:hidden; border:1px solid #444; cursor:pointer; transition:0.2s; }
    .dash-item:hover { transform:scale(1.05); border-color:#00ffc8; }
    .dash-item img, .dash-item video { width:100%; height:100%; object-fit:cover; }
    .dash-item.deleted { display:none; }

    .pdf-row { display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; margin-bottom:5px; border-radius:5px; cursor:pointer; border:1px solid #333; }
    .btn-del-all { background:#330000; color:#ff4444; border:1px solid #ff4444; padding:5px 10px; border-radius:5px; font-size:10px; cursor:pointer; float:right; }

    .btn-save { position:fixed; bottom:20px; right:20px; background:linear-gradient(90deg, #0088cc, #00ffc8); color:#000; padding:15px 50px; border-radius:40px; border:none; font-weight:bold; font-size:16px; cursor:pointer; z-index:999; box-shadow:0 10px 30px rgba(0,255,200,0.3); }

    /* MODALE */
    .dash-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; justify-content:center; align-items:center; flex-direction:column; padding:14px; box-sizing:border-box; }
    .dash-modal-content { max-width:90%; max-height:80vh; margin-bottom:15px; border-radius:10px; }
    .dash-actions { display:flex; gap:15px; margin-bottom:10px; flex-wrap:wrap; justify-content:center; }
    .d-btn { display:flex; align-items:center; gap:8px; padding:12px 24px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; border:none; cursor:pointer; font-size:14px; }
    .db-wa { background:#25D366; color:#041b0c; }
    .db-em { background:#666; }
    .db-del { background:#ff4444; }
    .db-cl { background:#0088cc; color:white; }
    .db-cp { background:#222; border:1px solid #00ffc8; color:#00ffc8; }

    details summary{ cursor:pointer; user-select:none; font-weight:bold; outline:none; margin-bottom: 10px;}
    .hint { color:#777; font-size:11px; margin-top:5px; }

    /* BOX TESTO EMAIL (fallback/copia) */
    #emailBox {
      width: min(920px, 95vw);
      background:#0d0d0d;
      border:1px solid rgba(0,255,200,.25);
      border-radius:12px;
      padding:12px;
      margin:10px 0 12px 0;
      display:none;
      box-sizing:border-box;
    }
    #emailBox .emailTitle { color:#00ffc8; font-weight:900; font-size:12px; letter-spacing:.05em; margin-bottom:8px; text-transform:uppercase; }
    #emailText {
      width:100%;
      min-height:130px;
      background:#111;
      border:1px solid #333;
      color:#fff;
      border-radius:10px;
      padding:10px;
      box-sizing:border-box;
      font-size:12px;
      line-height:1.4;
      resize:vertical;
    }
    .emailHint {
      color:#aaa;
      font-size:11px;
      margin-top:8px;
      opacity:.9;
    }
  </style>
</head>
<body>

  <div class="dash-head">
    <a href="/area" style="color:white; font-weight:900; text-decoration:none;">‚Üê Indietro</a>
    <span style="color:#00ffc8; font-weight:900;">MODIFICA P{{ p_id }}</span>
  </div>

  <form method="POST" enctype="multipart/form-data" class="edit-container" id="editForm">

    <div class="edit-box">
      <h3 class="box-title">üë§ Dati & Business</h3>
      <div class="form-grid">
        <div class="full-width"><label>Nome</label><input type="text" name="name" value="{{ p.name }}"></div>
        <div><label>Ruolo</label><input type="text" name="role" value="{{ p.role }}"></div>
        <div><label>Azienda</label><input type="text" name="company" value="{{ p.company }}"></div>
        <div><label>P. IVA</label><input type="text" name="piva" value="{{ p.piva }}"></div>
        <div><label>Codice SDI</label><input type="text" name="cod_sdi" value="{{ p.cod_sdi }}"></div>
        <div class="full-width"><label>PEC</label><input type="text" name="pec" value="{{ p.pec }}"></div>
        <div class="full-width"><label>Bio</label><textarea name="bio" rows="3">{{ p.bio }}</textarea></div>
      </div>
    </div>

    <div class="edit-box">
      <h3 class="box-title">üìû Contatti</h3>
      <div class="form-grid">
        <div><label>Cellulare 1</label><input type="text" name="mobile1" value="{{ p.mobiles[0] if p.mobiles|length > 0 else '' }}"></div>
        <div><label>Cellulare 2</label><input type="text" name="mobile2" value="{{ p.mobiles[1] if p.mobiles|length > 1 else '' }}"></div>
        <div><label>Tel. Ufficio</label><input type="text" name="office_phone" value="{{ p.office_phone }}"></div>
        <div class="full-width"><label>Email (virgola)</label><input type="text" name="email1" value="{{ p.emails|join(',') }}"></div>
        <div class="full-width"><label>Siti Web (virgola)</label><input type="text" name="website" value="{{ p.websites|join(',') }}"></div>
        <div class="full-width"><label>Indirizzi Maps (virgola)</label><input type="text" name="address" value="{{ p.address }}"></div>
      </div>
    </div>

    <div class="edit-box">
      <h3 class="box-title">üì∏ Foto & Crop</h3>

      <div class="form-grid">
        <div class="crop-area">
          <label style="color:#00ffc8; margin-bottom:10px;">FOTO AGENTE</label>

          <div class="crop-circle">
            <img id="imgAgenteTarget"
                 src="{{ p.foto if p.foto else 'https://via.placeholder.com/150' }}"
                 style="object-position: {{ p.pos_x|int }}% {{ p.pos_y|int }}%; transform: scale({{ p.zoom|float }});">
          </div>

          <input type="file" name="foto" accept="image/*" onchange="caricaAnteprima(this, 'imgAgenteTarget')">

          <div style="margin-top:15px; text-align:left;">
            <div class="slider-row">
              <label>‚ÜîÔ∏è</label>
              <input type="range" id="inputX_new" name="pos_x" min="0" max="100" step="1" value="{{ p.pos_x|int }}" oninput="applicaCropImmediato()">
            </div>

            <!-- NOTA: slider Y ‚Äúintuitivo‚Äù (su = sale). Inviamo al backend pos_y gi√† corretto invertendo in JS -->
            <div class="slider-row">
              <label>‚ÜïÔ∏è</label>
              <input type="range" id="inputY_new" name="pos_y" min="0" max="100" step="1" value="{{ (100 - (p.pos_y|int)) }}" oninput="applicaCropImmediato()">
            </div>

            <div class="slider-row">
              <label>üîç</label>
              <input type="range" id="inputZ_new" name="zoom" min="1" max="3" step="0.1" value="{{ p.zoom|float }}" oninput="applicaCropImmediato()">
            </div>
          </div>

          <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
            <label style="display:inline-block; margin-right:5px; cursor:pointer;">Gira Foto Agente?</label>
            <input type="checkbox" id="checkGiraFoto" name="fx_rotate_agent" {% if p.fx_rotate_agent=='on' %}checked{% endif %} onchange="gestisciAvvisoGiallo()">

            <div id="boxAvvisoGiallo">
              ‚ö†Ô∏è ATTENZIONE:<br>
              Hai attivato "Gira Foto Agente".<br>
              Gli effetti <b>Tap</b> e <b>Specchio</b> sono stati disabilitati.
            </div>
          </div>
        </div>

        <div class="crop-area">
          <label style="color:#00ffc8; margin-bottom:10px;">LOGO AZIENDA</label>
          <img id="anteprimaLogo" src="{{ p.logo if p.logo else 'https://via.placeholder.com/150' }}" style="height:80px; object-fit:contain; margin:10px auto; display:block;">
          <input type="file" name="logo" accept="image/*" onchange="caricaAnteprima(this, 'anteprimaLogo')">

          <div style="margin-top:10px;">
            <label style="display:inline-block;">Gira Logo?</label>
            <input type="checkbox" name="fx_rotate_logo" {% if p.fx_rotate_logo=='on' %}checked{% endif %}>
          </div>

          <hr style="border-color:#333; margin:15px 0;">

          <label style="color:#aaa;">FOTO RETRO</label>
          <img id="anteprimaRetro" src="{{ p.personal_foto if p.personal_foto else '' }}" style="height:50px; object-fit:contain; margin:5px auto; display:block;">
          <input type="file" name="personal_foto" accept="image/*" onchange="caricaAnteprima(this, 'anteprimaRetro')">
        </div>
      </div>

      <div style="margin-top:20px; background:#222; padding:15px; border-radius:10px;">
        <label>Effetto Moneta:</label>
        <div style="margin-bottom:10px;">
          <input type="radio" name="fx_interaction" value="tap" {% if p.fx_interaction=='tap' %}checked{% endif %} class="radioEffetto"> TAP (tocca)
          <span style="margin:0 10px;"></span>
          <input type="radio" name="fx_interaction" value="mirror" {% if p.fx_interaction=='mirror' %}checked{% endif %} class="radioEffetto"> SPECCHIO (automatico)
        </div>

        <label>Retro della Card:</label>
        <div>
          <input type="radio" name="fx_back_content" value="logo" {% if p.fx_back_content=='logo' %}checked{% endif %}> Logo
          <span style="margin:0 10px;"></span>
          <input type="radio" name="fx_back_content" value="personal" {% if p.fx_back_content=='personal' %}checked{% endif %}> Foto
        </div>
      </div>
    </div>

    <div class="edit-box">
      <h3 class="box-title">üì± Social</h3>
      {% set soc_map = {} %}{% for s in p.socials %}{% do soc_map.update({s.label: s.url}) %}{% endfor %}
      <div class="form-grid">
        {% for sn in ['Facebook','Instagram','Linkedin','TikTok','Spotify','Telegram','YouTube'] %}
        <div><label>{{ sn }}</label><input type="text" name="{{ sn|lower }}" value="{{ soc_map.get(sn,'') }}"></div>
        {% endfor %}
      </div>
    </div>

    <div class="edit-box">
      <h3 class="box-title"><span>üì∏ FOTO</span><button type="button" class="btn-del-all" onclick="svuotaTutto('img')">ELIMINA TUTTE</button></h3>
      <input type="file" name="gallery_img" multiple accept="image/*">
      <div class="dash-gallery">
        {% for img in p.gallery_img %}
        <div class="dash-item img-item" onclick="apriPopup('{{ img }}', 'img', this)">
          <img src="{{ img }}"><input type="checkbox" name="delete_media" value="{{ img }}" style="display:none;" class="del-chk-img">
        </div>
        {% endfor %}
      </div>

      <hr style="border-color:#333; margin:20px 0;">

      <h3 class="box-title"><span>üé¨ VIDEO</span><button type="button" class="btn-del-all" onclick="svuotaTutto('vid')">ELIMINA TUTTI</button></h3>
      <input type="file" name="gallery_vid" multiple accept="video/*">
      <div class="dash-gallery">
        {% for vid in p.gallery_vid %}
        <div class="dash-item vid-item" onclick="apriPopup('{{ vid }}', 'vid', this)">
          <video src="{{ vid }}#t=2.0" preload="metadata"></video>
          <i class="fas fa-play" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white;"></i>
          <input type="checkbox" name="delete_media" value="{{ vid }}" style="display:none;" class="del-chk-vid">
        </div>
        {% endfor %}
      </div>

      <hr style="border-color:#333; margin:20px 0;">

      <h3 class="box-title"><span>üìÑ PDF</span><button type="button" class="btn-del-all" onclick="svuotaTutto('pdf')">ELIMINA TUTTI</button></h3>
      <input type="file" name="gallery_pdf" multiple accept=".pdf">
      <div style="margin-top:10px;">
        {% for pdf in p.gallery_pdf %}
        <div class="pdf-row pdf-item" onclick="apriPopup('{{ pdf.path }}', 'pdf', this)">
          <span><i class="fas fa-file-pdf" style="color:#f44;"></i> {{ pdf.name }}</span>
          <input type="checkbox" name="delete_media" value="{{ pdf.path }}" style="display:none;" class="del-chk-pdf">
        </div>
        {% endfor %}
      </div>
    </div>

    <details class="edit-box">
      <summary class="box-title">üåç TRADUZIONI (4 lingue) <i class="fas fa-chevron-down"></i></summary>
      <div class="hint">Testi alternativi per le altre lingue.</div>
      <details style="margin-top:14px;">
        <summary class="box-title">üá¨üáß Inglese</summary>
        <div class="form-grid">
          <div><label>Role (EN)</label><input type="text" name="role_en" value="{{ p.trans.en.role if p.trans and p.trans.en else '' }}"></div>
          <div class="full-width"><label>Bio (EN)</label><textarea name="bio_en" rows="2">{{ p.trans.en.bio if p.trans and p.trans.en else '' }}</textarea></div>
        </div>
      </details>
      <details style="margin-top:10px;">
        <summary class="box-title">üá´üá∑ Francese</summary>
        <div class="form-grid">
          <div><label>R√¥le (FR)</label><input type="text" name="role_fr" value="{{ p.trans.fr.role if p.trans and p.trans.fr else '' }}"></div>
          <div class="full-width"><label>Bio (FR)</label><textarea name="bio_fr" rows="2">{{ p.trans.fr.bio if p.trans and p.trans.fr else '' }}</textarea></div>
        </div>
      </details>
      <details style="margin-top:10px;">
        <summary class="box-title">üá™üá∏ Spagnolo</summary>
        <div class="form-grid">
          <div><label>Rol (ES)</label><input type="text" name="role_es" value="{{ p.trans.es.role if p.trans and p.trans.es else '' }}"></div>
          <div class="full-width"><label>Bio (ES)</label><textarea name="bio_es" rows="2">{{ p.trans.es.bio if p.trans and p.trans.es else '' }}</textarea></div>
        </div>
      </details>
      <details style="margin-top:10px;">
        <summary class="box-title">üá©üá™ Tedesco</summary>
        <div class="form-grid">
          <div><label>Rolle (DE)</label><input type="text" name="role_de" value="{{ p.trans.de.role if p.trans and p.trans.de else '' }}"></div>
          <div class="full-width"><label>Bio (DE)</label><textarea name="bio_de" rows="2">{{ p.trans.de.bio if p.trans and p.trans.de else '' }}</textarea></div>
        </div>
      </details>
    </details>

    <button type="submit" class="btn-save" id="btnSalva">üíæ SALVA MODIFICHE</button>
  </form>

  <div id="modalFile" class="dash-modal">
    <button onclick="chiudiPopup()" class="d-btn db-cl" style="margin-bottom:10px;">CHIUDI X</button>

    <div id="boxAnteprimaFile"></div>

    <!-- BOX TESTO EMAIL (mostrato quando premi Email) -->
    <div id="emailBox">
      <div class="emailTitle">Testo Email pronto (se il tasto Email apre solo il browser, copia e incolla)</div>
      <textarea id="emailText" readonly></textarea>
      <div class="emailHint">
        Suggerimento: se non si apre l‚Äôapp Mail, premi <b>COPIA TESTO</b> e incolla in Gmail/Outlook.
      </div>
    </div>

    <div class="dash-actions">
      <button onclick="inviaWA()" class="d-btn db-wa"><i class="fab fa-whatsapp"></i> WA</button>
      <button onclick="inviaEmail()" class="d-btn db-em"><i class="fas fa-envelope"></i> Email</button>
      <button onclick="copiaTestoEmail()" class="d-btn db-cp"><i class="fas fa-copy"></i> COPIA TESTO</button>
      <button onclick="cancellaFile()" class="d-btn db-del"><i class="fas fa-trash"></i> DEL</button>
    </div>
  </div>

  <script>
    // --- 1. FUNZIONI CROP (BLINDATE) ---
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function applicaCropImmediato() {
        var x = parseInt(document.getElementById('inputX_new').value, 10) || 50;

        // Slider Y ‚Äúintuitivo‚Äù: 0 = su, 100 = gi√π.
        // object-position invece: 0 = alto, 100 = basso come punto di fuoco.
        // Per far s√¨ che "sposto su" = immagine sale, invertiamo:
        var y_slider = parseInt(document.getElementById('inputY_new').value, 10) || 50;
        var y = 100 - y_slider; // <-- inversione

        var z = parseFloat(document.getElementById('inputZ_new').value) || 1;

        x = clamp(x, 0, 100);
        y = clamp(y, 0, 100);
        z = Math.max(1, Math.min(3, z));

        var img = document.getElementById('imgAgenteTarget');
        img.style.objectPosition = x + "% " + y + "%";
        img.style.transform = "scale(" + z + ")";

        // IMPORTANTISSIMO: salviamo al backend pos_y gi√† invertito
        // cos√¨ in DB rimane coerente e la card fuori dashboard non cambia.
        document.getElementById('inputY_new').dataset.realY = String(y);
    }

    function caricaAnteprima(input, targetId) {
        if(input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(targetId).src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 2. FUNZIONI AVVISO GIALLO ---
    function gestisciAvvisoGiallo() {
        var checkbox = document.getElementById('checkGiraFoto');
        var boxGiallo = document.getElementById('boxAvvisoGiallo');
        var radioButtons = document.querySelectorAll('.radioEffetto');

        if(checkbox.checked) {
            boxGiallo.style.display = 'block';
            radioButtons.forEach(function(r){ r.disabled = true; });
        } else {
            boxGiallo.style.display = 'none';
            radioButtons.forEach(function(r){ r.disabled = false; });
        }
    }

    // --- 3. FUNZIONI POPUP E INVIO ---
    var FILE_CORRENTE = { url: "", type: "" };
    var ELEMENTO_CORRENTE = null;

    function apriPopup(urlRelativo, tipo, elementoHtml) {
        if(elementoHtml.classList.contains('deleted')) return;

        ELEMENTO_CORRENTE = elementoHtml;
        FILE_CORRENTE.url = window.location.origin + urlRelativo;
        FILE_CORRENTE.type = tipo;

        var box = document.getElementById('boxAnteprimaFile');
        box.innerHTML = "";

        // reset email box
        document.getElementById('emailBox').style.display = 'none';
        document.getElementById('emailText').value = "";

        if(tipo === 'img') {
            box.innerHTML = '<img src="' + urlRelativo + '" class="dash-modal-content">';
        } else if(tipo === 'vid') {
            box.innerHTML = '<video src="' + urlRelativo + '" controls autoplay class="dash-modal-content"></video>';
        } else if(tipo === 'pdf') {
            box.innerHTML = '<iframe src="' + urlRelativo + '" class="dash-modal-content" style="background:white; width:95vw; height:80vh;"></iframe>';
        }

        document.getElementById('modalFile').style.display = 'flex';
    }

    function chiudiPopup() {
        document.getElementById('modalFile').style.display = 'none';
        document.getElementById('boxAnteprimaFile').innerHTML = "";
        document.getElementById('emailBox').style.display = 'none';
        document.getElementById('emailText').value = "";
    }

    function inviaWA() {
        var label = "File";
        if(FILE_CORRENTE.type === "img") label = "Foto";
        if(FILE_CORRENTE.type === "vid") label = "Video";
        if(FILE_CORRENTE.type === "pdf") label = "Documento";

        var testo = "Pay4You - " + label + ":\n" + FILE_CORRENTE.url;
        window.open("https://wa.me/?text=" + encodeURIComponent(testo), "_blank");
    }

    function buildEmailPayload() {
        var nomeAgente = "{{ p.name|default('', true) }}";
        var oggetto = "Pay4You - File Condiviso";
        var corpo =
          "Ciao!\n" +
          "Ecco un file dalla mia Card Digitale Pay4You.\n\n" +
          (nomeAgente ? ("Da: " + nomeAgente + "\n\n") : "") +
          "Link al file:\n" + FILE_CORRENTE.url + "\n\n" +
          "Saluti.\n" +
          "‚Äî Pay4You";

        return { oggetto: oggetto, corpo: corpo };
    }

    function inviaEmail() {
        var payload = buildEmailPayload();

        // Mostra sempre anche il testo pronto da copiare (fallback)
        document.getElementById('emailBox').style.display = 'block';
        document.getElementById('emailText').value =
          "OGGETTO: " + payload.oggetto + "\n\n" +
          payload.corpo;

        // mailto (alcuni device/browser lo gestiscono male -> almeno hai copia)
        var linkMail = "mailto:?subject=" + encodeURIComponent(payload.oggetto) +
                       "&body=" + encodeURIComponent(payload.corpo).replace(/%0A/g, "%0D%0A");

        try {
          // usare location.href √® il modo pi√π compatibile
          window.location.href = linkMail;
        } catch(e) {
          // se fallisce, resta comunque il testo da copiare
        }
    }

    function copiaTestoEmail() {
        var t = document.getElementById('emailText');
        if(!t.value) {
          // se non √® stato generato ancora, lo generiamo adesso
          var payload = buildEmailPayload();
          document.getElementById('emailBox').style.display = 'block';
          t.value = "OGGETTO: " + payload.oggetto + "\n\n" + payload.corpo;
        }

        t.focus();
        t.select();

        // Clipboard API (se disponibile)
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(t.value).then(function(){
            // ok
          }).catch(function(){
            // fallback execCommand
            try { document.execCommand('copy'); } catch(e){}
          });
        } else {
          try { document.execCommand('copy'); } catch(e){}
        }
    }

    function cancellaFile() {
        if(confirm("Vuoi davvero eliminare questo file?")) {
            var checkbox = ELEMENTO_CORRENTE.querySelector('input[type="checkbox"]');
            if(checkbox) checkbox.checked = true;

            ELEMENTO_CORRENTE.style.display = 'none';
            ELEMENTO_CORRENTE.classList.add('deleted');

            chiudiPopup();
        }
    }

    function svuotaTutto(tipo) {
        if(confirm("ELIMINARE TUTTI I FILES DI QUESTO TIPO?")) {
            var items = document.querySelectorAll('.del-chk-' + tipo);
            items.forEach(function(chk) {
                chk.checked = true;
                chk.parentElement.style.display = 'none';
            });
        }
    }

    // --- 4. AVVIO AUTOMATICO + FIX SUBMIT (salva pos_y reale invertita) ---
    window.onload = function() {
        applicaCropImmediato();
        gestisciAvvisoGiallo();

        document.getElementById('editForm').onsubmit = function() {
            // prima di inviare: mettiamo nel value del range Y il valore reale (invertito)
            var yReal = document.getElementById('inputY_new').dataset.realY;
            if (yReal !== undefined && yReal !== null) {
              document.getElementById('inputY_new').value = String(yReal);
            }

            document.getElementById('btnSalva').innerText = "‚è≥ SALVATAGGIO...";
        };
    };
  </script>
</body>
</html>
