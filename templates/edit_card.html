<script>
  let CURRENT_MEDIA = { url:"", type:"" };
  let currentItemElement = null;

  function makeMailto(subject, body){
    const b = (body || "").replace(/\n/g, "\r\n");
    return "mailto:?subject=" + encodeURIComponent(subject) +
           "&body=" + encodeURIComponent(b);
  }

  function previewCrop(input){
    if(input.files && input.files[0]){
      const r = new FileReader();
      r.onload = function(e){
        document.getElementById('cropImg').src = e.target.result;
        // dopo preview aggiorno anche posizione/zoom
        requestAnimationFrame(updateCrop);
      };
      r.readAsDataURL(input.files[0]);
    }
  }

  function simplePreview(input, id){
    if(input.files && input.files[0]){
      const r = new FileReader();
      r.onload = function(e){ document.getElementById(id).src = e.target.result; };
      r.readAsDataURL(input.files[0]);
    }
  }

  // ✅ CROP FIX ROBUSTO (su/giù sempre funzionante)
  function updateCrop(){
    const xEl = document.getElementsByName('pos_x')[0];
    const yEl = document.getElementsByName('pos_y')[0];
    const zEl = document.getElementsByName('zoom')[0];

    const x = parseInt((xEl && xEl.value) ? xEl.value : "50", 10);
    const y = parseInt((yEl && yEl.value) ? yEl.value : "50", 10);
    const z = parseFloat((zEl && zEl.value) ? zEl.value : "1");

    const img = document.getElementById('cropImg');
    if(!img) return;

    img.style.objectPosition = x + "% " + y + "%";
    img.style.transform = "scale(" + z + ")";
  }

  function bindCrop(){
    const xEl = document.getElementsByName('pos_x')[0];
    const yEl = document.getElementsByName('pos_y')[0];
    const zEl = document.getElementsByName('zoom')[0];

    [xEl,yEl,zEl].forEach(el=>{
      if(!el) return;
      el.addEventListener("input", updateCrop, {passive:true});
      el.addEventListener("change", updateCrop, {passive:true});
      el.addEventListener("touchend", ()=>requestAnimationFrame(updateCrop), {passive:true});
    });

    requestAnimationFrame(updateCrop);
  }

  function toggleRotateAgentWarning(){
    const chk = document.getElementsByName('fx_rotate_agent')[0];
    const warn = document.getElementById('warnRotateAgent');
    const coins = document.querySelectorAll('.fxCoin');
    if(chk && chk.checked){
      if(warn) warn.style.display = 'block';
      coins.forEach(r => r.disabled = true);
    }else{
      if(warn) warn.style.display = 'none';
      coins.forEach(r => r.disabled = false);
    }
  }

  function openPreview(url, type, element){
    if(element.classList.contains('deleted')) return;
    currentItemElement = element;

    CURRENT_MEDIA.url = url;
    CURRENT_MEDIA.type = type;

    const modal = document.getElementById('dashModal');
    const box = document.getElementById('dashMediaBox');

    if(type === 'img') box.innerHTML = '<img src="'+url+'" class="dash-modal-content">';
    else if(type === 'vid') box.innerHTML = '<video src="'+url+'" controls autoplay class="dash-modal-content"></video>';
    else if(type === 'pdf') box.innerHTML = '<iframe src="'+url+'" class="dash-modal-content" style="background:white; width:95vw; height:80vh;"></iframe>';

    modal.style.display = 'flex';
  }

  function sendMediaWA(){
    const fullUrl = window.location.origin + CURRENT_MEDIA.url;
    const txt = "Pay4You - File\n\nEcco il file:\n" + fullUrl + "\n\n— Pay4You";
    window.open("https://wa.me/?text=" + encodeURIComponent(txt), "_blank");
  }

  // ✅ TESTO EMAIL COMPLETO (foto/video/pdf)
  function sendMediaEmail(){
    const fullUrl = window.location.origin + CURRENT_MEDIA.url;

    let tipo = "File";
    if(CURRENT_MEDIA.type === "img") tipo = "Foto";
    if(CURRENT_MEDIA.type === "vid") tipo = "Video";
    if(CURRENT_MEDIA.type === "pdf") tipo = "PDF";

    const subject = "Pay4You - " + tipo;
    const body =
      "Ciao!\n\n" +
      "Ti invio questo contenuto Pay4You (" + tipo + "):\n" +
      fullUrl + "\n\n" +
      "Se apri da iPhone: tocca il link per visualizzarlo.\n\n" +
      "— Pay4You";

    window.location.href = makeMailto(subject, body);
  }

  function closeDashModal(){
    document.getElementById('dashModal').style.display = 'none';
    document.getElementById('dashMediaBox').innerHTML = "";
    CURRENT_MEDIA = { url:"", type:"" };
  }

  function deleteCurrentItem(){
    if(confirm("ELIMINARE?")){
      const chk = currentItemElement.querySelector('input[type="checkbox"]');
      if(chk) chk.checked = true;
      currentItemElement.style.display = 'none';
      closeDashModal();
    }
  }

  function deleteAll(type){
    if(confirm("ELIMINARE TUTTO?")){
      const items = document.querySelectorAll('.del-chk-' + type);
      items.forEach(chk => { chk.checked = true; chk.parentElement.style.display = 'none'; });
    }
  }

  document.getElementById('editForm').onsubmit = function(){
    document.getElementById('btnSave').innerText = "⏳ SALVATAGGIO...";
  }

  // init
  bindCrop();
  toggleRotateAgentWarning();
</script>
