<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Modifica Card</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico?v=2">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .edit-container { max-width:900px; margin:20px auto; padding-bottom:100px; }
        .edit-box { background:#111; padding:25px; border-radius:15px; border:1px solid #333; margin-bottom:20px; }
        .box-title { color:#00ffc8; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px; font-size:14px; text-transform:uppercase; }
        .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
        .full-width { grid-column: span 2; }
        label { display:block; color:#aaa; margin-bottom:5px; font-size:12px; font-weight:bold; }
        input[type="text"], textarea { width:100%; padding:12px; background:#222; border:1px solid #444; color:white; border-radius:6px; box-sizing:border-box; }
        .btn-save { position:fixed; bottom:20px; right:20px; background:linear-gradient(90deg, #0088cc, #00ffc8); color:#000; padding:15px 50px; border-radius:40px; border:none; font-weight:bold; font-size:16px; cursor:pointer; z-index:999; box-shadow:0 10px 30px rgba(0,255,200,0.3); }
        
        /* CROP VISUALIZER */
        .crop-container { text-align:center; background:#1a1a1a; padding:15px; border-radius:10px; }
        .crop-circle { 
            width:150px; height:150px; border-radius:50%; border:3px solid #00ffc8; 
            overflow:hidden; margin:0 auto 10px auto; position:relative; background:#000;
        }
        .crop-circle img { width:100%; height:100%; object-fit:cover; }
    </style>
</head>
<body style="background:#050505; color:white; font-family:sans-serif;">

    <div class="dash-head"><a href="/area" style="color:white;">â† Torna Indietro</a> <span style="color:#00ffc8;">MODIFICA P{{ p_id }}</span></div>

    <form method="POST" enctype="multipart/form-data" class="edit-container" id="editForm">
        
        <div class="edit-box">
            <h3 class="box-title">ğŸ‘¤ Dati & Business</h3>
            <div class="form-grid">
                <div class="full-width"><label>Nome e Cognome</label><input type="text" name="name" value="{{ p.name }}"></div>
                <div><label>Ruolo</label><input type="text" name="role" value="{{ p.role }}"></div>
                <div><label>Azienda</label><input type="text" name="company" value="{{ p.company }}"></div>
                <div><label>P. IVA</label><input type="text" name="piva" value="{{ p.piva }}"></div>
                <div><label>Codice SDI</label><input type="text" name="cod_sdi" value="{{ p.cod_sdi }}"></div>
                <div class="full-width"><label>PEC</label><input type="text" name="pec" value="{{ p.pec }}"></div>
                <div class="full-width"><label>Bio</label><textarea name="bio" rows="3">{{ p.bio }}</textarea></div>
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">ğŸ“ Contatti</h3>
            <div class="form-grid">
                <div><label>Cellulare 1</label><input type="text" name="mobile1" value="{{ p.mobiles[0] if p.mobiles|length > 0 else '' }}"></div>
                <div><label>Cellulare 2</label><input type="text" name="mobile2" value="{{ p.mobiles[1] if p.mobiles|length > 1 else '' }}"></div>
                <div class="full-width"><label>Telefono Ufficio (Fisso)</label><input type="text" name="office_phone" value="{{ p.office_phone }}"></div>
                <div><label>Email 1</label><input type="text" name="email1" value="{{ p.emails[0] if p.emails|length > 0 else '' }}"></div>
                <div><label>Email 2</label><input type="text" name="email2" value="{{ p.emails[1] if p.emails|length > 1 else '' }}"></div>
                <div class="full-width"><label>Sito Web</label><input type="text" name="website" value="{{ p.websites[0] if p.websites|length > 0 else '' }}"></div>
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">ğŸ“¸ Foto & Crop</h3>
            <div class="form-grid">
                <div class="crop-container">
                    <label>Foto Agente (Anteprima Cerchio)</label>
                    <div class="crop-circle"><img id="prevA" src="{{ p.foto if p.foto else 'https://via.placeholder.com/150' }}"></div>
                    <input type="file" name="foto" accept="image/*" onchange="preview(this, 'prevA')">
                    <small style="color:#666;">Il sistema taglia automaticamente al centro.</small>
                    <label style="margin-top:10px;">Rotazione?</label><input type="checkbox" name="fx_rotate_agent" {% if p.fx_rotate_agent=='on' %}checked{% endif %}>
                </div>

                <div class="crop-container">
                    <label>Logo Aziendale</label>
                    <img id="prevL" src="{{ p.logo if p.logo else 'https://via.placeholder.com/150' }}" style="height:100px; object-fit:contain;">
                    <input type="file" name="logo" accept="image/*" onchange="preview(this, 'prevL')">
                    <label style="margin-top:10px;">Rotazione?</label><input type="checkbox" name="fx_rotate_logo" {% if p.fx_rotate_logo=='on' %}checked{% endif %}>
                </div>
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">ğŸ“± Social</h3>
            {% set soc_map = {} %}{% for s in p.socials %}{% do soc_map.update({s.label: s.url}) %}{% endfor %}
            <div class="form-grid">
                {% for sn in ['Facebook','Instagram','Linkedin','TikTok','Spotify','Telegram','YouTube'] %}
                <div>
                    <label>{{ sn }}</label>
                    <input type="text" name="{{ sn|lower }}" value="{{ soc_map.get(sn,'') }}">
                    <div style="font-size:10px; color:#666;">Es: https://{{ sn|lower }}.com/tuonome</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">ğŸ“‚ Gallerie</h3>
            <label>Foto</label><input type="file" name="gallery_img" multiple accept="image/*">
            <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:15px;">
                {% for img in p.gallery_img %}
                <div style="position:relative;"><img src="{{ img }}" style="width:50px; height:50px; object-fit:cover;">
                <input type="checkbox" name="delete_media" value="{{ img }}" style="position:absolute; top:0;"></div>
                {% endfor %}
            </div>
            <label>Video</label><input type="file" name="gallery_vid" multiple accept="video/*">
            <label>PDF</label><input type="file" name="gallery_pdf" multiple accept=".pdf">
        </div>

        <div class="edit-box">
            <h3 class="box-title">ğŸŒ Traduzioni</h3>
            <div class="form-grid">
                <div><label>ğŸ‡¬ğŸ‡§ Ruolo</label><input type="text" name="role_en" value="{{ p.trans.en.role }}"></div>
                <div><label>ğŸ‡¬ğŸ‡§ Bio</label><textarea name="bio_en" rows="2">{{ p.trans.en.bio }}</textarea></div>
                <div><label>ğŸ‡«ğŸ‡· Ruolo</label><input type="text" name="role_fr" value="{{ p.trans.fr.role }}"></div>
                <div><label>ğŸ‡«ğŸ‡· Bio</label><textarea name="bio_fr" rows="2">{{ p.trans.fr.bio }}</textarea></div>
                <div><label>ğŸ‡ªğŸ‡¸ Ruolo</label><input type="text" name="role_es" value="{{ p.trans.es.role }}"></div>
                <div><label>ğŸ‡ªğŸ‡¸ Bio</label><textarea name="bio_es" rows="2">{{ p.trans.es.bio }}</textarea></div>
                <div><label>ğŸ‡©ğŸ‡ª Ruolo</label><input type="text" name="role_de" value="{{ p.trans.de.role }}"></div>
                <div><label>ğŸ‡©ğŸ‡ª Bio</label><textarea name="bio_de" rows="2">{{ p.trans.de.bio }}</textarea></div>
            </div>
        </div>

        <button type="submit" class="btn-save" id="btnSave">ğŸ’¾ SALVA TUTTO</button>
    </form>

    <script>
        function preview(input, id) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) { document.getElementById(id).src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }
        document.getElementById('editForm').onsubmit = function() {
            var btn = document.getElementById('btnSave');
            btn.innerText = "â³ CARICAMENTO..."; btn.style.opacity = "0.7";
        }
    </script>
</body>
</html>
