<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Modifica Profilo P{{ p_id }} | Pay4You</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .crop-wrap{ display:flex; gap:16px; flex-wrap:wrap; }
    .crop-preview{
      width:220px; height:220px; border-radius:20px; overflow:hidden;
      background:#000; border:1px solid rgba(255,255,255,.12);
    }
    .crop-preview img{ width:100%; height:100%; object-fit:cover; }
    .crop-tools{
      flex:1; min-width:260px;
      background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:12px;
    }
    .tool-row{ display:flex; gap:10px; flex-wrap:wrap; margin:8px 0; }
    .mini-btn{
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); color:#fff;
    }
    .mini-btn:active{ transform:scale(.98); }
    .range{ width:100%; }
    .hint{ color:#aaa; font-size:12px; }
    .section-title{ font-weight:900; letter-spacing:.06em; color:#00ffc8; margin:12px 0 6px; }
    input[type="text"], textarea{ width:100%; }
  </style>
</head>
<body>

  <div class="page-wrap" style="max-width:980px; margin:0 auto; padding:18px;">
    <h2 style="margin:0 0 10px;">MODIFICA PROFILO P{{ p_id }}</h2>

    <form method="POST" enctype="multipart/form-data">

      <div class="section-title">Dati</div>
      <div class="tool-row">
        <div style="flex:1; min-width:220px;">
          <label>Nome</label>
          <input type="text" name="name" value="{{ p.name }}">
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Ruolo</label>
          <input type="text" name="role" value="{{ p.role }}">
        </div>
      </div>

      <div class="tool-row">
        <div style="flex:1; min-width:220px;">
          <label>Azienda</label>
          <input type="text" name="company" value="{{ p.company }}">
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Telefono ufficio</label>
          <input type="text" name="office_phone" value="{{ p.office_phone }}">
        </div>
      </div>

      <label>Bio</label>
      <textarea name="bio" rows="3">{{ p.bio }}</textarea>

      <div class="section-title">Foto / Logo</div>
      <div class="tool-row">
        <div style="flex:1; min-width:220px;">
          <label>Foto agente</label>
          <input type="file" name="foto" accept="image/*">
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Logo</label>
          <input type="file" name="logo" accept="image/*">
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Foto retro (personale)</label>
          <input type="file" name="personal_foto" accept="image/*">
        </div>
      </div>

      <div class="section-title">Crop (posizione / zoom)</div>

      <div class="crop-wrap">
        <div class="crop-preview">
          {% if p.foto %}
            <img id="prevImg" src="{{ p.foto }}"
                 style="object-position: {{ p.pos_x|default(50) }}% {{ p.pos_y|default(50) }}%;
                        transform: scale({{ p.zoom|default(1.0) }}); transform-origin:center center;">
          {% else %}
            <img id="prevImg" src="https://dummyimage.com/600x600/222/aaa&text=FOTO" style="object-fit:cover;">
          {% endif %}
        </div>

        <div class="crop-tools">
          <div class="hint">Usa ‚Üë ‚Üì ‚Üê ‚Üí per spostare. Zoom + / - per ingrandire.</div>

          <div class="tool-row">
            <div class="mini-btn" onclick="move(0,-2);return false;">‚¨ÜÔ∏è SU</div>
            <div class="mini-btn" onclick="move(0, 2);return false;">‚¨áÔ∏è GI√ô</div>
            <div class="mini-btn" onclick="move(-2,0);return false;">‚¨ÖÔ∏è SX</div>
            <div class="mini-btn" onclick="move( 2,0);return false;">‚û°Ô∏è DX</div>
          </div>

          <div class="tool-row">
            <div class="mini-btn" onclick="zoomBy(0.05);return false;">‚ûï ZOOM</div>
            <div class="mini-btn" onclick="zoomBy(-0.05);return false;">‚ûñ ZOOM</div>
            <div class="mini-btn" onclick="resetCrop();return false;">üîÑ RESET</div>
          </div>

          <div class="tool-row">
            <div style="flex:1;">
              <label>X (sinistra/destra)</label>
              <input class="range" type="range" min="0" max="100" step="1" id="rx" value="{{ p.pos_x|default(50) }}" oninput="setX(this.value)">
            </div>
          </div>

          <div class="tool-row">
            <div style="flex:1;">
              <label>Y (su/gi√π)</label>
              <input class="range" type="range" min="0" max="100" step="1" id="ry" value="{{ p.pos_y|default(50) }}" oninput="setY(this.value)">
            </div>
          </div>

          <div class="tool-row">
            <div style="flex:1;">
              <label>Zoom</label>
              <input class="range" type="range" min="1" max="2.2" step="0.01" id="rz" value="{{ p.zoom|default(1.0) }}" oninput="setZ(this.value)">
            </div>
          </div>

          <!-- ‚úÖ questi sono quelli che il backend salva -->
          <input type="hidden" name="pos_x" id="pos_x" value="{{ p.pos_x|default(50) }}">
          <input type="hidden" name="pos_y" id="pos_y" value="{{ p.pos_y|default(50) }}">
          <input type="hidden" name="zoom" id="zoom" value="{{ p.zoom|default(1.0) }}">
        </div>
      </div>

      <div class="section-title">Effetti</div>
      <div class="tool-row">
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="fx_rotate_logo" {% if p.fx_rotate_logo=='on' %}checked{% endif %}>
          Gira logo (orario)
        </label>
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="fx_rotate_agent" {% if p.fx_rotate_agent=='on' %}checked{% endif %}>
          Gira foto agente (NO moneta)
        </label>
      </div>

      <div class="tool-row">
        <div style="flex:1; min-width:240px;">
          <label>Interazione</label>
          <select name="fx_interaction">
            <option value="tap" {% if p.fx_interaction=='tap' %}selected{% endif %}>Tap (gira al click)</option>
            <option value="mirror" {% if p.fx_interaction=='mirror' %}selected{% endif %}>Specchio (gira sempre)</option>
          </select>
        </div>

        <div style="flex:1; min-width:240px;">
          <label>Retro</label>
          <select name="fx_back_content">
            <option value="logo" {% if p.fx_back_content=='logo' %}selected{% endif %}>Logo</option>
            <option value="personal" {% if p.fx_back_content=='personal' %}selected{% endif %}>Foto personale</option>
          </select>
        </div>
      </div>

      <div class="tool-row" style="margin-top:14px;">
        <button class="mini-btn" type="submit" style="background:linear-gradient(90deg,#0088cc,#00ffc8); color:#000;">
          SALVA MODIFICHE
        </button>
      </div>

    </form>
  </div>

  <script>
    let x = parseInt(document.getElementById('pos_x').value || "50", 10);
    let y = parseInt(document.getElementById('pos_y').value || "50", 10);
    let z = parseFloat(document.getElementById('zoom').value || "1.0");

    const img = document.getElementById('prevImg');
    const rx = document.getElementById('rx');
    const ry = document.getElementById('ry');
    const rz = document.getElementById('rz');

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function apply(){
      if(!img) return;
      img.style.objectPosition = x + "% " + y + "%";
      img.style.transform = "scale(" + z.toFixed(2) + ")";
      document.getElementById('pos_x').value = x;
      document.getElementById('pos_y').value = y;
      document.getElementById('zoom').value = z.toFixed(2);
      if(rx) rx.value = x;
      if(ry) ry.value = y;
      if(rz) rz.value = z.toFixed(2);
    }

    // ‚úÖ bottoni
    function move(dx, dy){
      x = clamp(x + dx, 0, 100);
      y = clamp(y + dy, 0, 100);
      apply();
    }
    function zoomBy(dz){
      z = clamp(z + dz, 1.0, 2.2);
      apply();
    }
    function resetCrop(){
      x = 50; y = 50; z = 1.0;
      apply();
    }

    // ‚úÖ slider
    function setX(v){ x = clamp(parseInt(v,10), 0, 100); apply(); }
    function setY(v){ y = clamp(parseInt(v,10), 0, 100); apply(); }
    function setZ(v){ z = clamp(parseFloat(v), 1.0, 2.2); apply(); }

    // init
    apply();
  </script>
</body>
</html>
