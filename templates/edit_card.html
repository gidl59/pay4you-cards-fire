<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Modifica Card</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .edit-container { max-width:900px; margin:20px auto; padding-bottom:100px; }
        .edit-box { background:#111; padding:25px; border-radius:15px; border:1px solid #333; margin-bottom:20px; }
        .box-title { color:#00ffc8; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px; font-size:14px; text-transform:uppercase; }
        .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
        .full-width { grid-column: span 2; }
        label { display:block; color:#aaa; margin-bottom:5px; font-size:12px; font-weight:bold; }
        input[type="text"], textarea { width:100%; padding:12px; background:#222; border:1px solid #444; color:white; border-radius:6px; box-sizing:border-box; }
        .btn-save { position:fixed; bottom:20px; right:20px; background:linear-gradient(90deg, #0088cc, #00ffc8); color:#000; padding:15px 50px; border-radius:40px; border:none; font-weight:bold; font-size:16px; cursor:pointer; z-index:999; box-shadow:0 10px 30px rgba(0,255,200,0.3); }
        
        /* CROP SLIDERS */
        .crop-controls { margin-top:15px; padding:10px; background:#222; border-radius:8px; }
        .range-slider { width:100%; margin-bottom:10px; cursor:pointer; }
        .crop-circle { 
            width:160px; height:160px; border-radius:50%; border:3px solid #00ffc8; 
            overflow:hidden; margin:0 auto; background:#000; position:relative;
        }
        .crop-circle img { width:100%; height:100%; object-fit:cover; transition: none; }
        
        /* GALLERIE BIG */
        .gal-big-grid { display:flex; flex-wrap:wrap; gap:10px; }
        .gal-big-item { width:100px; height:100px; object-fit:cover; border-radius:8px; border:1px solid #444; }
    </style>
</head>
<body style="background:#050505; color:white; font-family:sans-serif;">

    <div class="dash-head"><a href="/area" style="color:white;">‚Üê Indietro</a> <span style="color:#00ffc8;">MODIFICA P{{ p_id }}</span></div>

    <form method="POST" enctype="multipart/form-data" class="edit-container" id="editForm">
        
        <div class="edit-box">
            <h3 class="box-title">üë§ Dati & Business</h3>
            <div class="form-grid">
                <div class="full-width"><label>Nome e Cognome</label><input type="text" name="name" value="{{ p.name }}"></div>
                <div><label>Ruolo</label><input type="text" name="role" value="{{ p.role }}"></div>
                <div><label>Azienda</label><input type="text" name="company" value="{{ p.company }}"></div>
                <div><label>P. IVA</label><input type="text" name="piva" value="{{ p.piva }}"></div>
                <div><label>Codice SDI</label><input type="text" name="cod_sdi" value="{{ p.cod_sdi }}"></div>
                <div class="full-width"><label>PEC</label><input type="text" name="pec" value="{{ p.pec }}"></div>
                <div class="full-width"><label>Bio</label><textarea name="bio" rows="3">{{ p.bio }}</textarea></div>
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">üìû Contatti</h3>
            <div class="form-grid">
                <div><label>Cellulare 1</label><input type="text" name="mobile1" value="{{ p.mobiles[0] if p.mobiles|length > 0 else '' }}"></div>
                <div><label>Cellulare 2</label><input type="text" name="mobile2" value="{{ p.mobiles[1] if p.mobiles|length > 1 else '' }}"></div>
                <div class="full-width"><label>Telefono Ufficio</label><input type="text" name="office_phone" value="{{ p.office_phone }}"></div>
                <div><label>Email 1</label><input type="text" name="email1" value="{{ p.emails[0] if p.emails|length > 0 else '' }}"></div>
                <div><label>Email 2</label><input type="text" name="email2" value="{{ p.emails[1] if p.emails|length > 1 else '' }}"></div>
                <div class="full-width"><label>Sito Web</label><input type="text" name="website" value="{{ p.websites[0] if p.websites|length > 0 else '' }}"></div>
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">üì∏ Foto & Crop</h3>
            <div class="form-grid">
                <div style="text-align:center;">
                    <label style="color:#00ffc8;">FOTO AGENTE</label>
                    <div class="crop-circle">
                        <img id="cropImg" src="{{ p.foto if p.foto else 'https://via.placeholder.com/150' }}"
                             style="object-position: {{ p.pos_x }}% {{ p.pos_y }}%; transform: scale({{ p.zoom }});">
                    </div>
                    <input type="file" name="foto" accept="image/*" onchange="previewCrop(this)">
                    
                    <div class="crop-controls">
                        <label>‚ÜîÔ∏è Sposta Orizzontale</label>
                        <input type="range" name="pos_x" class="range-slider" min="0" max="100" value="{{ p.pos_x }}" oninput="updateCrop()">
                        
                        <label>‚ÜïÔ∏è Sposta Verticale</label>
                        <input type="range" name="pos_y" class="range-slider" min="0" max="100" value="{{ p.pos_y }}" oninput="updateCrop()">
                        
                        <label>üîç Zoom</label>
                        <input type="range" name="zoom" class="range-slider" min="1" max="3" step="0.1" value="{{ p.zoom }}" oninput="updateCrop()">
                    </div>
                    <label>Rotazione?</label><input type="checkbox" name="fx_rotate_agent" {% if p.fx_rotate_agent=='on' %}checked{% endif %}>
                </div>

                <div style="text-align:center;">
                    <label>LOGO AZIENDA</label>
                    <img id="prevLogo" src="{{ p.logo if p.logo else 'https://via.placeholder.com/150' }}" style="height:100px; object-fit:contain; margin-bottom:10px;">
                    <input type="file" name="logo" accept="image/*" onchange="simplePreview(this, 'prevLogo')">
                    <label>Rotazione?</label><input type="checkbox" name="fx_rotate_logo" {% if p.fx_rotate_logo=='on' %}checked{% endif %}>
                    
                    <hr style="border-color:#333; margin:20px 0;">
                    <label>FOTO RETRO (Optional)</label>
                    <input type="file" name="personal_foto" accept="image/*">
                </div>
            </div>
            
            <div style="margin-top:20px; background:#222; padding:15px; border-radius:10px;">
                <label>Effetto Movimento:</label>
                <input type="radio" name="fx_interaction" value="tap" {% if p.fx_interaction=='tap' %}checked{% endif %}> TAP 
                <input type="radio" name="fx_interaction" value="mirror" {% if p.fx_interaction=='mirror' %}checked{% endif %}> SPECCHIO
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">üì± Social Network</h3>
            {% set soc_map = {} %}{% for s in p.socials %}{% do soc_map.update({s.label: s.url}) %}{% endfor %}
            <div class="form-grid">
                {% for sn in ['Facebook','Instagram','Linkedin','TikTok','Spotify','Telegram','YouTube'] %}
                <div><label>{{ sn }}</label><input type="text" name="{{ sn|lower }}" value="{{ soc_map.get(sn,'') }}"></div>
                {% endfor %}
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">üìÇ Gallerie</h3>
            
            <label style="color:#00ffc8;">FOTO (Max 30)</label>
            <input type="file" name="gallery_img" multiple accept="image/*">
            <div class="gal-big-grid">
                {% for img in p.gallery_img %}
                <div style="position:relative;">
                    <img src="{{ img }}" class="gal-big-item">
                    <input type="checkbox" name="delete_media" value="{{ img }}" style="position:absolute; top:0; left:0; width:20px; height:20px;">
                </div>
                {% endfor %}
            </div>
            
            <hr style="border-color:#333;">
            <label style="color:#00ffc8;">VIDEO (Max 10)</label>
            <input type="file" name="gallery_vid" multiple accept="video/*">
            <div class="gal-big-grid">
                {% for vid in p.gallery_vid %}
                <div style="position:relative; width:100px; height:100px; background:#000;">
                    <video src="{{ vid }}" style="width:100%; height:100%; object-fit:cover;"></video>
                    <input type="checkbox" name="delete_media" value="{{ vid }}" style="position:absolute; top:0; left:0; width:20px; height:20px; z-index:9;">
                </div>
                {% endfor %}
            </div>

            <hr style="border-color:#333;">
            <label style="color:#00ffc8;">PDF (Max 12)</label>
            <input type="file" name="gallery_pdf" multiple accept=".pdf">
            <div style="font-size:12px; margin-top:5px;">
                {% for pdf in p.gallery_pdf %}
                <div>üìÑ {{ pdf.name }} <input type="checkbox" name="delete_media" value="{{ pdf.path }}"> Elimina</div>
                {% endfor %}
            </div>
        </div>

        <div class="edit-box">
            <h3 class="box-title">üåç Traduzioni</h3>
            <div class="form-grid">
                <div><label>üá¨üáß Role</label><input type="text" name="role_en" value="{{ p.trans.en.role }}"></div>
                <div><label>üá¨üáß Bio</label><textarea name="bio_en" rows="2">{{ p.trans.en.bio }}</textarea></div>
                </div>
        </div>

        <button type="submit" class="btn-save" id="btnSave">üíæ SALVA TUTTO</button>
    </form>

    <script>
        function simplePreview(input, id) {
            if(input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e){ document.getElementById(id).src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function previewCrop(input) {
            if(input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e){ document.getElementById('cropImg').src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateCrop() {
            var x = document.getElementsByName('pos_x')[0].value;
            var y = document.getElementsByName('pos_y')[0].value;
            var z = document.getElementsByName('zoom')[0].value;
            var img = document.getElementById('cropImg');
            img.style.objectPosition = x + "% " + y + "%";
            img.style.transform = "scale(" + z + ")";
        }

        document.getElementById('editForm').onsubmit = function() {
            document.getElementById('btnSave').innerText = "‚è≥ CARICAMENTO...";
        }
    </script>
</body>
</html>
