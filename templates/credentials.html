{% extends "base.html" %}
{% block title %}Credenziali | Pay4You{% endblock %}

{% block content %}
<div class="form-wrap">
  <div class="form-head">
    <div>
      <h1 class="form-title">Credenziali Card</h1>
      <div class="form-sub">Dati di accesso e invio credenziali al cliente.</div>
    </div>
    <div class="form-actions" style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn-mini ghost" href="{{ url_for('master_login') }}">‚Üê Master</a>
      <a class="btn-mini ghost" href="/card/{{ slug }}" target="_blank">Apri Card</a>
      <a class="btn-mini ghost" href="{{ login_url }}" target="_blank">Apri Login</a>
    </div>
  </div>

  <div class="section-box">
    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px;">
      <div class="field">
        <label>Slug</label>
        <input value="{{ slug }}" readonly>
      </div>
      <div class="field">
        <label>Username</label>
        <input value="{{ username }}" readonly>
      </div>
      <div class="field">
        <label>Password</label>
        <input value="{{ password }}" readonly>
      </div>
      <div class="field">
        <label>Email destinatario</label>
        <input value="{{ recipient_email }}" readonly>
      </div>
      <div class="field">
        <label>WhatsApp destinatario</label>
        <input value="{{ recipient_whatsapp }}" readonly>
      </div>
      <div class="field">
        <label>Link login</label>
        <input value="{{ login_url }}" readonly>
      </div>
      <div class="field" style="grid-column:1/-1;">
        <label>Link pubblico card</label>
        <input value="{{ public_url }}" readonly>
      </div>
    </div>

    <div class="mini-help" style="margin-top:12px;">
      Lo slug viene creato all'inizio e resta fisso. Le credenziali qui sotto sono quelle inviate al cliente.
    </div>
  </div>

  <div class="section-box" style="margin-top:14px;">
    <div style="text-align:center; font-weight:950; letter-spacing:.08em; color:#00ffc8; margin-bottom:14px;">
      AZIONI RAPIDE
    </div>

    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:14px;">
      <a class="btn primary" href="{{ url_for('master_send_credentials_email', id=user.id) }}"
         onclick="return confirm('Inviare le credenziali via email a {{ recipient_email }}?')">
         ‚úâÔ∏è INVIA EMAIL DAL SERVER
      </a>

      <a class="btn primary" href="{{ url_for('master_send_credentials_whatsapp', id=user.id) }}"
         onclick="return confirm('Inviare le credenziali via WhatsApp a {{ recipient_whatsapp }}?')">
         üì± INVIA WHATSAPP DA TWILIO
      </a>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:14px;">
      <button type="button" class="btn" onclick="copyEmailText()">üìã COPIA TESTO EMAIL</button>
      <button type="button" class="btn" onclick="copyWhatsAppText()">üìã COPIA TESTO WHATSAPP</button>
      <button type="button" class="btn" onclick="openGmail()">‚úâÔ∏è APRI GMAIL</button>
      <button type="button" class="btn" onclick="openWhatsAppWeb()">üí¨ APRI WHATSAPP WEB</button>
    </div>

    <div class="mini-help" style="margin-top:12px;">
      I pulsanti sopra ti permettono sia l‚Äôinvio reale dal server sia la copia/apertura manuale come backup.
    </div>
  </div>

  <div class="section-box" style="margin-top:14px;">
    <div style="font-weight:900; color:#00ffc8; margin-bottom:10px;">Anteprima testo email</div>
    <textarea id="emailTextBox" readonly style="width:100%; min-height:240px; border-radius:14px; padding:14px; background:#0f0f0f; color:#fff; border:1px solid rgba(255,255,255,.12); resize:vertical;">{{ email_text }}</textarea>
  </div>

  <div class="section-box" style="margin-top:14px;">
    <div style="font-weight:900; color:#00ffc8; margin-bottom:10px;">Anteprima testo WhatsApp</div>
    <textarea id="waTextBox" readonly style="width:100%; min-height:220px; border-radius:14px; padding:14px; background:#0f0f0f; color:#fff; border:1px solid rgba(255,255,255,.12); resize:vertical;">{{ whatsapp_text }}</textarea>
  </div>

  <div class="footer">¬© 2026 Pay4You ‚Äî Giuseppe Di Lisio</div>
</div>

<script>
  const RECIPIENT_EMAIL = {{ recipient_email|tojson }};
  const RECIPIENT_WHATSAPP = {{ recipient_whatsapp|tojson }};
  const EMAIL_SUBJECT = {{ email_subject|tojson }};

  function getEmailBody() {
    return document.getElementById("emailTextBox").value || "";
  }

  function getWhatsAppBody() {
    return document.getElementById("waTextBox").value || "";
  }

  async function copyEmailText() {
    const txt = "OGGETTO: " + EMAIL_SUBJECT + "\n\n" + getEmailBody();
    try {
      await navigator.clipboard.writeText(txt);
      alert("Testo email copiato ‚úÖ");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Testo email copiato ‚úÖ");
    }
  }

  async function copyWhatsAppText() {
    const txt = getWhatsAppBody();
    try {
      await navigator.clipboard.writeText(txt);
      alert("Testo WhatsApp copiato ‚úÖ");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Testo WhatsApp copiato ‚úÖ");
    }
  }

  function openGmail() {
    const su = encodeURIComponent(EMAIL_SUBJECT || "");
    const bd = encodeURIComponent(getEmailBody() || "");
    const to = encodeURIComponent(RECIPIENT_EMAIL || "");
    const url = "https://mail.google.com/mail/?view=cm&fs=1&to=" + to + "&su=" + su + "&body=" + bd;
    window.open(url, "_blank");
  }

  function openWhatsAppWeb() {
    let phone = (RECIPIENT_WHATSAPP || "").replace(/[^\d+]/g, "");
    phone = phone.replace(/\+/g, "");
    const txt = encodeURIComponent(getWhatsAppBody() || "");
    if (!phone) {
      alert("Numero WhatsApp mancante");
      return;
    }
    window.open("https://wa.me/" + phone + "?text=" + txt, "_blank");
  }
</script>
{% endblock %}
