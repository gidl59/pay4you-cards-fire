{% extends "base.html" %}
{% block title %}Credenziali | Pay4You{% endblock %}

{% block content %}
<div class="form-wrap">
  <div class="form-head">
    <div>
      <h1 class="form-title">Credenziali</h1>
      <div class="form-sub">Dati di accesso per la dashboard.</div>
    </div>
    <div class="form-actions">
      <a class="btn-mini ghost" href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>
    </div>
  </div>

  <div class="section-box">
    <div class="grid-2">
      <div class="field">
        <label>Username</label>
        <input value="{{ ag.username }}" readonly>
      </div>
      <div class="field">
        <label>Password</label>
        <input value="{{ ag.password }}" readonly>
      </div>
    </div>
    <div class="mini-help">Consiglio: al primo accesso l‚Äôagente pu√≤ cambiare password (se vuoi lo aggiungiamo dopo).</div>
  </div>

  {# ‚úÖ AGGIUNTA: IMPOSTAZIONE CARTA / QR + INVIO #}
  <div class="section-box" style="margin-top:14px;">
    <div style="text-align:center; font-weight:950; letter-spacing:.08em; color:#00ffc8; margin-bottom:12px;">
      IMPOSTAZIONE CARTA / QR
    </div>

    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:14px;">
      <button type="button" class="btn-mini ghost" id="btnP1" onclick="setQrMode('p1')">PROFILO 1</button>
      <button type="button" class="btn-mini ghost" id="btnP2" onclick="setQrMode('p2')">PROFILO 2</button>
      <button type="button" class="btn-mini ghost" id="btnMENU" onclick="setQrMode('menu')">üìÑ MODALIT√Ä MENU</button>
    </div>

    <div style="display:flex; justify-content:center; margin:10px 0 18px;">
      <div style="background:white; padding:16px; border-radius:22px; border:1px solid rgba(255,255,255,.12);">
        <img id="qrImg" src="" alt="QR" style="width:260px; height:260px; display:block;">
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px; align-items:stretch;">
      <button type="button" class="btn primary" onclick="sendQrWA()">üì± INVIA SU WHATSAPP</button>
      <button type="button" class="btn primary" onclick="sendQrEmail()">‚úâÔ∏è INVIA PER EMAIL</button>
      <button type="button" class="btn" onclick="copyEmailText()">üìã COPIA TESTO EMAIL</button>
    </div>

    <div class="mini-help" style="margin-top:12px;">
      L‚Äôimpostazione carta serve per definire quale profilo viene aperto per primo quando qualcuno usa NFC/QR.
      In base al profilo selezionato, quello sar√† il primo che la persona vede.
    </div>
  </div>

  <div class="footer">¬© 2026 Pay4You ‚Äî Giuseppe Di Lisio</div>
</div>

<script>
  // ====== CONFIG (non tocco backend: uso slug gi√† disponibile) ======
  const SLUG = "{{ ag.slug }}";
  const BASE = window.location.origin;

  // modalit√† selezionata: p1 / p2 / menu
  let QR_MODE = "p1";

  function activeBtn(id){
    // senza cambiare CSS globale: uso un piccolo "evidenziato" inline
    ["btnP1","btnP2","btnMENU"].forEach(x=>{
      const b = document.getElementById(x);
      if(!b) return;
      b.style.borderColor = "rgba(255,255,255,.18)";
      b.style.opacity = "0.85";
      b.style.transform = "scale(1)";
    });
    const a = document.getElementById(id);
    if(a){
      a.style.borderColor = "#00ffc8";
      a.style.opacity = "1";
      a.style.transform = "scale(1.03)";
    }
  }

  function cardUrlForMode(mode){
    // P1: /slug
    // P2: /slug?p=p2
    // MENU: /slug?menu=1  (se nel tuo progetto √® diverso dimmelo e lo cambio senza toccare altro)
    let url = BASE + "/" + SLUG;
    if(mode === "p2") url += "?p=p2";
    if(mode === "menu") url += "?menu=1";
    return url;
  }

  function qrImgUrl(dataUrl){
    return "https://api.qrserver.com/v1/create-qr-code/?size=600x600&data=" + encodeURIComponent(dataUrl);
  }

  function refreshQr(){
    const u = cardUrlForMode(QR_MODE);
    const img = document.getElementById("qrImg");
    if(img) img.src = qrImgUrl(u);
  }

  function setQrMode(mode){
    QR_MODE = mode || "p1";
    if(QR_MODE === "p1") activeBtn("btnP1");
    if(QR_MODE === "p2") activeBtn("btnP2");
    if(QR_MODE === "menu") activeBtn("btnMENU");
    refreshQr();
  }

  // ====== WhatsApp ======
  function sendQrWA(){
    const u = cardUrlForMode(QR_MODE);
    const qr = qrImgUrl(u);
    const txt =
      "Pay4You - QR (" + QR_MODE.toUpperCase() + ")\n\n" +
      "Link: " + u + "\n" +
      "QR immagine: " + qr + "\n\n" +
      "Credenziali dashboard:\n" +
      "User: {{ ag.username }}\n" +
      "Pass: {{ ag.password }}";
    window.open("https://wa.me/?text=" + encodeURIComponent(txt), "_blank");
  }

  // ====== Email ======
  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return "https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=" + su + "&body=" + bd;
  }

  function makeMailto(subject, body){
    const b = (body || "").replace(/\n/g, "\r\n");
    return "mailto:?subject=" + encodeURIComponent(subject || "") + "&body=" + encodeURIComponent(b);
  }

  function emailPayload(){
    const u = cardUrlForMode(QR_MODE);
    const qr = qrImgUrl(u);

    const subject = "Pay4You - QR e Credenziali (" + QR_MODE.toUpperCase() + ")";
    const body =
      "Ciao!\n\n" +
      "Ecco QR + link della tua Card Pay4You (" + QR_MODE.toUpperCase() + "):\n\n" +
      "LINK CARD:\n" + u + "\n\n" +
      "IMMAGINE QR (apri e stampa):\n" + qr + "\n\n" +
      "CREDENZIALI DASHBOARD:\n" +
      "LOGIN: " + (BASE + "/area/login") + "\n" +
      "USER: {{ ag.username }}\n" +
      "PASSWORD: {{ ag.password }}\n\n" +
      "‚Äî Pay4You";
    return { subject, body };
  }

  function sendQrEmail(){
    const p = emailPayload();

    // su PC: Gmail con testo completo
    const w = window.open(gmailCompose(p.subject, p.body), "_blank");

    // fallback: client locale (Thunderbird/Outlook/Apple Mail/Aruba se configurato)
    if(!w){
      window.location.href = makeMailto(p.subject, p.body);
    }
  }

  async function copyEmailText(){
    const p = emailPayload();
    const text = "OGGETTO:\n" + p.subject + "\n\nTESTO:\n" + p.body;

    try{
      await navigator.clipboard.writeText(text);
      alert("Testo email copiato ‚úÖ");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Testo email copiato ‚úÖ");
    }
  }

  // init
  document.addEventListener("DOMContentLoaded", () => {
    setQrMode("p1");
  });
</script>
{% endblock %}
