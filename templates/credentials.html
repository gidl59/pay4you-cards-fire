{% extends "base.html" %}
{% block title %}Credenziali | Pay4You{% endblock %}

{% block content %}
<style>
  body{
    background:#050505;
    color:#fff;
    font-family:Arial, Helvetica, sans-serif;
    margin:0;
    padding:20px;
  }

  .wrap{
    max-width:1150px;
    margin:0 auto;
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:22px;
  }

  .title{
    margin:0;
    font-size:38px;
    line-height:1;
    font-weight:900;
    color:#fff;
  }

  .subtitle{
    color:#b7b7b7;
    margin-top:8px;
    font-size:16px;
  }

  .top-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .btn-top, .btn-action{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:11px 16px;
    border-radius:12px;
    text-decoration:none;
    border:1px solid rgba(255,255,255,.12);
    background:#111;
    color:#fff;
    font-weight:700;
    cursor:pointer;
  }

  .btn-action.primary{
    background:#00ffc8;
    color:#000;
    border-color:#00ffc8;
  }

  .btn-action.dark{
    background:#141414;
    color:#fff;
  }

  .box{
    background:#0d0d0d;
    border:1px solid #222;
    border-radius:18px;
    padding:18px;
    margin-bottom:18px;
  }

  .box-title{
    margin:0 0 14px 0;
    color:#00ffc8;
    font-size:24px;
    font-weight:900;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:14px;
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:7px;
  }

  .field.full{
    grid-column:1 / -1;
  }

  .field label{
    color:#b9b9b9;
    font-size:13px;
    font-weight:800;
    text-transform:uppercase;
    letter-spacing:.04em;
  }

  .field input, .field textarea{
    width:100%;
    box-sizing:border-box;
    background:#181818;
    color:#fff;
    border:1px solid #333;
    border-radius:12px;
    padding:12px 14px;
    font-size:16px;
  }

  .field textarea{
    min-height:220px;
    resize:vertical;
    line-height:1.6;
  }

  .help{
    margin-top:10px;
    color:#a3a3a3;
    font-size:14px;
    line-height:1.5;
  }

  .actions{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:8px;
    margin-bottom:8px;
  }

  .footer{
    text-align:center;
    color:#8f8f8f;
    padding:10px 0 30px;
    font-size:14px;
  }

  @media (max-width: 860px){
    .grid{
      grid-template-columns:1fr;
    }
    .title{
      font-size:30px;
    }
  }
</style>

<div class="wrap">
  <div class="topbar">
    <div>
      <h1 class="title">Credenziali Card</h1>
      <div class="subtitle">Dati di accesso e invio credenziali al cliente.</div>
    </div>

    <div class="top-actions">
      <a class="btn-top" href="{{ url_for('master_login') }}">‚Üê Master</a>
      <a class="btn-top" href="/card/{{ slug }}" target="_blank">Apri Card</a>
      <a class="btn-top" href="{{ login_url }}" target="_blank">Apri Login</a>
    </div>
  </div>

  <div class="box">
    <h2 class="box-title">Dati Card</h2>

    <div class="grid">
      <div class="field">
        <label>Slug</label>
        <input value="{{ slug }}" readonly>
      </div>

      <div class="field">
        <label>Username</label>
        <input value="{{ username }}" readonly>
      </div>

      <div class="field">
        <label>Password</label>
        <input value="{{ password }}" readonly>
      </div>

      <div class="field">
        <label>Email destinatario</label>
        <input value="{{ recipient_email }}" readonly>
      </div>

      <div class="field">
        <label>WhatsApp destinatario</label>
        <input value="{{ recipient_whatsapp }}" readonly>
      </div>

      <div class="field">
        <label>Link login</label>
        <input value="{{ login_url }}" readonly>
      </div>

      <div class="field full">
        <label>Link pubblico card</label>
        <input value="{{ public_url }}" readonly>
      </div>
    </div>

    <div class="help">
      Lo slug viene creato all'inizio e resta fisso. Le credenziali qui sotto sono quelle inviate al cliente.
    </div>
  </div>

  <div class="box">
    <h2 class="box-title" style="text-align:center;">Azioni rapide</h2>

    <div class="actions">
      <a class="btn-action primary" href="{{ url_for('master_send_credentials_email', id=user.id) }}"
         onclick="return confirm('Inviare le credenziali via email a {{ recipient_email }}?')">
         ‚úâÔ∏è Invia email dal server
      </a>

      <a class="btn-action primary" href="{{ url_for('master_send_credentials_whatsapp', id=user.id) }}"
         onclick="return confirm('Inviare le credenziali via WhatsApp a {{ recipient_whatsapp }}?')">
         üì± Invia WhatsApp da Twilio
      </a>
    </div>

    <div class="actions">
      <button type="button" class="btn-action dark" onclick="copyEmailText()">üìã Copia testo email</button>
      <button type="button" class="btn-action dark" onclick="copyWhatsAppText()">üìã Copia testo WhatsApp</button>
      <button type="button" class="btn-action dark" onclick="openGmail()">‚úâÔ∏è Apri Gmail</button>
      <button type="button" class="btn-action dark" onclick="openWhatsAppWeb()">üí¨ Apri WhatsApp Web</button>
    </div>

    <div class="help" style="text-align:center;">
      I pulsanti sopra ti permettono sia l‚Äôinvio reale dal server sia la copia/apertura manuale come backup.
    </div>
  </div>

  <div class="box">
    <h2 class="box-title">Anteprima testo email</h2>
    <div class="field">
      <textarea id="emailTextBox" readonly>{{ email_text }}</textarea>
    </div>
  </div>

  <div class="box">
    <h2 class="box-title">Anteprima testo WhatsApp</h2>
    <div class="field">
      <textarea id="waTextBox" readonly>{{ whatsapp_text }}</textarea>
    </div>
  </div>

  <div class="footer">¬© 2026 Pay4You ‚Äî Giuseppe Di Lisio</div>
</div>

<script>
  const RECIPIENT_EMAIL = {{ recipient_email|tojson }};
  const RECIPIENT_WHATSAPP = {{ recipient_whatsapp|tojson }};
  const EMAIL_SUBJECT = {{ email_subject|tojson }};

  function getEmailBody() {
    return document.getElementById("emailTextBox").value || "";
  }

  function getWhatsAppBody() {
    return document.getElementById("waTextBox").value || "";
  }

  async function copyEmailText() {
    const txt = "OGGETTO: " + EMAIL_SUBJECT + "\n\n" + getEmailBody();
    try {
      await navigator.clipboard.writeText(txt);
      alert("Testo email copiato ‚úÖ");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Testo email copiato ‚úÖ");
    }
  }

  async function copyWhatsAppText() {
    const txt = getWhatsAppBody();
    try {
      await navigator.clipboard.writeText(txt);
      alert("Testo WhatsApp copiato ‚úÖ");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Testo WhatsApp copiato ‚úÖ");
    }
  }

  function openGmail() {
    const su = encodeURIComponent(EMAIL_SUBJECT || "");
    const bd = encodeURIComponent(getEmailBody() || "");
    const to = encodeURIComponent(RECIPIENT_EMAIL || "");
    const url = "https://mail.google.com/mail/?view=cm&fs=1&to=" + to + "&su=" + su + "&body=" + bd;
    window.open(url, "_blank");
  }

  function openWhatsAppWeb() {
    let phone = (RECIPIENT_WHATSAPP || "").replace(/[^\d+]/g, "");
    phone = phone.replace(/\+/g, "");
    const txt = encodeURIComponent(getWhatsAppBody() || "");
    if (!phone) {
      alert("Numero WhatsApp mancante");
      return;
    }
    window.open("https://wa.me/" + phone + "?text=" + txt, "_blank");
  }
</script>
{% endblock %}
