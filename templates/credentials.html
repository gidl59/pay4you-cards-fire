{% extends "base.html" %}
{% block title %}Credenziali | Pay4You{% endblock %}

{% block content %}
<div class="page-main">
  <div class="panel panel-wide">

    <div class="panel-head">
      <div>
        <h1 class="page-title">Codici accesso cliente</h1>
        <div class="hint">Copia oppure invia direttamente via WhatsApp / Email.</div>
      </div>

      <div class="toolbar">
        <a class="btn-mini ghost" href="{{ url_for('dashboard') }}">‚¨Ö Torna alla lista</a>
      </div>
    </div>

    <div class="panel-body">

      <div class="grid-2">

        <!-- LOGIN URL -->
        <div class="section" style="margin-top:0;">
          <div class="h3">Link login</div>
          <div class="row" style="margin-top:10px;">
            <span class="row-tag tag-web">URL</span>
            <div class="right-stack">
              <div class="stack-item mono big" style="word-break:break-all;">{{ login_url }}</div>
              <div class="btn-row">
                <button class="btn-mini" type="button" onclick="copyText('{{ login_url|e }}')">Copia</button>
                <a class="btn-mini ghost" href="{{ login_url }}" target="_blank" rel="noopener">Apri</a>
              </div>
            </div>
          </div>
        </div>

        <!-- CARD URL -->
        <div class="section" style="margin-top:0;">
          <div class="h3">Card pubblica</div>

          <div class="row" style="margin-top:10px;">
            <span class="row-tag tag-data">P1</span>
            <div class="right-stack">
              <div class="stack-item mono big" style="word-break:break-all;">{{ card_url }}</div>
              <div class="btn-row">
                <button class="btn-mini" type="button" onclick="copyText('{{ card_url|e }}')">Copia</button>
                <a class="btn-mini ghost" href="{{ card_url }}" target="_blank" rel="noopener">Apri</a>
              </div>
            </div>
          </div>

          {% if (p2_enabled or 0)|int == 1 %}
          <div class="row" style="margin-top:10px;">
            <span class="row-tag tag-data">P2</span>
            <div class="right-stack">
              <div class="stack-item mono big" style="word-break:break-all;">{{ card_url }}?p=p2</div>
              <div class="btn-row">
                <button class="btn-mini" type="button" onclick="copyText('{{ (card_url ~ '?p=p2')|e }}')">Copia</button>
                <a class="btn-mini ghost" href="{{ card_url }}?p=p2" target="_blank" rel="noopener">Apri</a>
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- USERNAME -->
        <div class="section">
          <div class="h3">Username</div>
          <div class="row" style="margin-top:10px;">
            <span class="row-tag tag-email">User</span>
            <div class="right-stack">
              <div class="stack-item mono big">{{ username }}</div>
              <button class="btn-mini" type="button" onclick="copyText('{{ username|e }}')">Copia</button>
            </div>
          </div>
        </div>

        <!-- PASSWORD -->
        <div class="section">
          <div class="h3">Password</div>
          <div class="row" style="margin-top:10px;">
            <span class="row-tag tag-phone">Pass</span>
            <div class="right-stack">
              <div class="stack-item mono big">{{ password }}</div>
              <button class="btn-mini" type="button" onclick="copyText('{{ password|e }}')">Copia</button>
            </div>
          </div>
        </div>

        <!-- MESSAGGIO + INVIA -->
        <div class="section" style="grid-column:1 / -1;">
          <div class="panel-head" style="margin-bottom:10px;">
            <div>
              <div class="h3" style="margin:0;">Messaggio pronto</div>
              <div class="hint">Usa i pulsanti ‚ÄúInvia‚Äù oppure copia e incolla.</div>
            </div>
            <div class="btn-row">
              <button class="btn-mini warn" type="button" onclick="copyMessage()">üìã Copia</button>
              <button class="btn-mini" type="button" onclick="sendWhatsApp()">üì≤ Invia WhatsApp</button>
              <button class="btn-mini ghost" type="button" onclick="sendEmail()">‚úâÔ∏è Invia Email</button>
            </div>
          </div>

          <textarea id="msgBox" class="mono" style="min-height:190px; width:100%; padding:12px 12px; border-radius:14px;">Ciao! Ecco i codici per gestire la tua Pay4You Card:

‚úÖ Link accesso: {{ login_url }}
üë§ Username: {{ username }}
üîë Password: {{ password }}

üåê La tua card pubblica (P1): {{ card_url }}
{% if (p2_enabled or 0)|int == 1 %}üåê La tua card pubblica (P2): {{ card_url }}?p=p2{% endif %}

Al primo accesso ti consigliamo di cambiare la password.</textarea>

          <div class="hint" id="copyOk" style="margin-top:10px; display:none;">Copiato ‚úÖ</div>

          <div class="sep" style="margin:14px 0;"></div>

          <div class="hint">
            Se vuoi inviare WhatsApp a un numero specifico, apri WhatsApp e incolla il messaggio,
            oppure modifica qui sotto la funzione (domani) per inserire un ‚Äúnumero cliente‚Äù.
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<script>
  function showCopied(){
    const el = document.getElementById('copyOk');
    if(!el) return;
    el.style.display = 'block';
    clearTimeout(window.__copyTimer);
    window.__copyTimer = setTimeout(()=>{ el.style.display='none'; }, 1200);
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      showCopied();
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showCopied();
    }
  }

  function copyMessage(){
    const box = document.getElementById('msgBox');
    if(!box) return;
    copyText(box.value);
  }

  function sendWhatsApp(){
    const box = document.getElementById('msgBox');
    if(!box) return;
    const text = encodeURIComponent(box.value);
    // NOTA: senza numero => apre WhatsApp e ti fa scegliere chat
    window.open("https://wa.me/?text=" + text, "_blank");
  }

  function sendEmail(){
    const box = document.getElementById('msgBox');
    if(!box) return;
    const subject = encodeURIComponent("Credenziali Pay4You Card");
    const body = encodeURIComponent(box.value);
    window.location.href = "mailto:?subject=" + subject + "&body=" + body;
  }
</script>
{% endblock %}
