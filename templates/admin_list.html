<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard | Pay4You</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>

<header class="topbar">
  <div class="topbar-left">
    <div class="branddot"></div>
    <div class="brandtxt">
      <div class="brand1">Pay4You Cards</div>
      <div class="brand2">{{ "Admin" if is_admin else "Agente" }}</div>
    </div>
  </div>

  <div class="topbar-right">
    {% if is_admin %}
      <a class="btn btn-primary" href="/area/new">+ Nuova Card</a>
    {% else %}
      <a class="btn" href="/area/me/p1">Modifica P1</a>
      {% if agent and agent.p2_enabled == 1 %}
        <a class="btn" href="/area/me/p2">Modifica P2</a>
      {% endif %}
    {% endif %}
    <a class="btn btn-ghost" href="/area/logout">Logout</a>
  </div>
</header>

<main class="wrap">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-wrap">
        {% for cat,msg in messages %}
          <div class="flash {{cat}}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="page-head">
    <div>
      <h1 class="h1">Dashboard</h1>
      <div class="sub">
        {% if is_admin %}
          Gestione clienti / agenti
        {% else %}
          Gestisci la tua card
        {% endif %}
      </div>
    </div>

    {% if is_admin %}
      <div class="searchbox">
        <input id="search" type="text" placeholder="Cerca per nome / azienda / slug..." oninput="filterCards()">
      </div>
    {% endif %}
  </div>

  <div id="grid" class="grid">
    {% for a in agents %}
      <article class="agent-card" data-name="{{ (a.name or '')|lower }}" data-company="{{ (a.company or '')|lower }}" data-slug="{{ (a.slug or '')|lower }}">

        <div class="agent-top">
          <div class="avatar">
            {% if a.photo_url %}
              <img src="{{ a.photo_url }}" alt="foto" onerror="this.remove(); this.parentElement.classList.add('ph')">
            {% endif %}
            <span class="ph-icon">ðŸ‘¤</span>
          </div>

          <div class="agent-meta">
            <div class="agent-name">{{ a.name or a.slug }}</div>
            <div class="agent-company">{{ a.company or "â€”" }}</div>
            <div class="agent-slug">Slug: <span class="mono">{{ a.slug }}</span></div>
          </div>

          <div class="agent-badges">
            {% if a.p2_enabled == 1 %}
              <span class="badge ok">P2 attivo</span>
            {% else %}
              <span class="badge">P2 non attivo</span>
            {% endif %}
          </div>
        </div>

        <div class="agent-actions">

          <div class="row">
            <div class="row-title">QR</div>
            <div class="row-actions">
              <button class="btn btn-sm" type="button" onclick="openQrModal('/qr/{{ a.slug }}')">QRP1</button>
              {% if a.p2_enabled == 1 %}
                <button class="btn btn-sm" type="button" onclick="openQrModal('/qr/{{ a.slug }}?p=p2')">QRP2</button>
              {% else %}
                <button class="btn btn-sm btn-disabled" type="button" disabled>QRP2</button>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="row-title">Card</div>
            <div class="row-actions">
              <a class="btn btn-sm btn-primary" target="_blank" href="/{{ a.slug }}">Apri P1</a>
              {% if a.p2_enabled == 1 %}
                <a class="btn btn-sm btn-primary" target="_blank" href="/{{ a.slug }}?p=p2">Apri P2</a>
              {% else %}
                <button class="btn btn-sm btn-disabled" type="button" disabled>Apri P2</button>
              {% endif %}
              <a class="btn btn-sm" target="_blank" href="/{{ a.slug }}.vcf">VCF P1</a>
              {% if a.p2_enabled == 1 %}
                <a class="btn btn-sm" target="_blank" href="/{{ a.slug }}.vcf?p=p2">VCF P2</a>
              {% else %}
                <button class="btn btn-sm btn-disabled" type="button" disabled>VCF P2</button>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="row-title">Modifica</div>
            <div class="row-actions">
              {% if is_admin %}
                <a class="btn btn-sm" href="/area/edit/{{ a.slug }}/p1">Modifica P1</a>
                {% if a.p2_enabled == 1 %}
                  <a class="btn btn-sm" href="/area/edit/{{ a.slug }}/p2">Modifica P2</a>
                {% else %}
                  <button class="btn btn-sm btn-disabled" type="button" disabled>Modifica P2</button>
                {% endif %}
              {% else %}
                <a class="btn btn-sm" href="/area/me/p1">Modifica P1</a>
                {% if agent and agent.p2_enabled == 1 %}
                  <a class="btn btn-sm" href="/area/me/p2">Modifica P2</a>
                {% endif %}
              {% endif %}
            </div>
          </div>

          {% if is_admin %}
            <div class="row">
              <div class="row-title">P2</div>
              <div class="row-actions">
                {% if a.p2_enabled == 1 %}
                  <form class="inline" method="post" action="/area/admin/{{ a.slug }}/deactivate-p2">
                    <button class="btn btn-sm btn-danger" type="submit" onclick="return confirm2('Disattivare P2?')">Disattiva P2</button>
                  </form>
                {% else %}
                  <form class="inline" method="post" action="/area/admin/{{ a.slug }}/activate-p2">
                    <button class="btn btn-sm" type="submit" onclick="return confirm2('Attivare P2? (sarÃ  vuoto)')">Attiva P2 (vuoto)</button>
                  </form>
                {% endif %}
              </div>
            </div>

            <div class="row">
              <div class="row-title">Sicurezza</div>
              <div class="row-actions">
                <form class="inline" method="post" action="/area/admin/{{ a.slug }}/regen-pass">
                  <button class="btn btn-sm" type="submit" onclick="return confirm2('Rigenerare password?')">Rigenera password</button>
                </form>
                <button class="btn btn-sm" type="button" onclick="openCredModal('{{ a.slug }}','{{ a.username }}','{{ (a.name or a.slug)|e }}')">Invia credenziali</button>
              </div>
            </div>

            <div class="row danger-row">
              <div class="row-title">Pericolo</div>
              <div class="row-actions">
                <form class="inline" method="post" action="/area/admin/{{ a.slug }}/delete">
                  <button class="btn btn-sm btn-danger" type="submit" onclick="return confirm2('Eliminare DEFINITIVAMENTE questa card?')">Elimina</button>
                </form>
              </div>
            </div>

          {% else %}
            <div class="row">
              <div class="row-title">P2</div>
              <div class="row-actions">
                {% if agent and agent.p2_enabled != 1 %}
                  <form method="post" action="/area/me/activate-p2" class="inline">
                    <button class="btn btn-sm" type="submit" onclick="return confirm2('Attivare P2? (sarÃ  vuoto)')">Attiva P2 (vuoto)</button>
                  </form>
                {% else %}
                  <form method="post" action="/area/me/deactivate-p2" class="inline">
                    <button class="btn btn-sm btn-danger" type="submit" onclick="return confirm2('Disattivare P2?')">Disattiva P2</button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% endif %}

        </div>

      </article>
    {% endfor %}
  </div>

</main>

<!-- QR MODAL -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <button class="modal-x" type="button" onclick="closeQrModal()">âœ•</button>
    <div class="modal-title">QR Code</div>
    <img id="qr-img" src="" alt="QR" class="qr-img">
    <div class="modal-actions">
      <button class="btn" type="button" onclick="shareQrWhatsApp()">Invia via WhatsApp</button>
      <button class="btn" type="button" onclick="shareQrEmail()">Invia via Email</button>
      <button class="btn btn-danger" type="button" onclick="closeQrModal()">Chiudi</button>
    </div>
  </div>
</div>

<!-- CRED MODAL -->
<div id="cred-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <button class="modal-x" type="button" onclick="closeCredModal()">âœ•</button>
    <div class="modal-title">Credenziali</div>
    <div id="cred-text" class="cred-text"></div>
    <div class="modal-actions">
      <button class="btn" type="button" onclick="shareCredWhatsApp()">Invia via WhatsApp</button>
      <button class="btn" type="button" onclick="shareCredEmail()">Invia via Email</button>
      <button class="btn btn-danger" type="button" onclick="closeCredModal()">Chiudi</button>
    </div>
  </div>
</div>

<script>
  let __QR_URL = "";
  let __CRED_TEXT = "";

  function confirm2(msg){
    if(!confirm(msg)) return false;
    return confirm("Confermi? (azione non reversibile)");
  }

  // search filter (admin only)
  function filterCards(){
    const q = (document.getElementById("search")?.value || "").trim().toLowerCase();
    const cards = document.querySelectorAll(".agent-card");
    cards.forEach(c=>{
      const hay = (c.dataset.name + " " + c.dataset.company + " " + c.dataset.slug).toLowerCase();
      c.style.display = (!q || hay.includes(q)) ? "" : "none";
    });
  }

  // QR modal
  function openQrModal(qrEndpoint){
    __QR_URL = window.location.origin + qrEndpoint.replace(/^\//,'/');
    document.getElementById('qr-img').src = qrEndpoint;
    document.getElementById('qr-modal').style.display = 'flex';
  }
  function closeQrModal(){
    document.getElementById('qr-img').src = '';
    document.getElementById('qr-modal').style.display = 'none';
    __QR_URL = "";
  }
  function shareQrWhatsApp(){
    if(!__QR_URL) return;
    const text = "Ecco il QR della tua Pay4You Card:\n" + __QR_URL;
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  }
  function shareQrEmail(){
    if(!__QR_URL) return;
    const subject = "QR Pay4You Card";
    const body = "Ciao!\n\nEcco il QR della tua Pay4You Card:\n" + __QR_URL + "\n";
    window.location.href = "mailto:?subject=" + encodeURIComponent(subject) + "&body=" + encodeURIComponent(body);
  }

  // Cred modal
  function openCredModal(slug, username, displayName){
    const login = window.location.origin + "/area/login";
    __CRED_TEXT =
`Ciao ${displayName}!\n
Ti ho attivato la tua Pay4You Card.\n
Login: ${login}\nUsername: ${username}\n
Link Card P1: ${window.location.origin}/${slug}\nLink Card P2: ${window.location.origin}/${slug}?p=p2\n`;
    document.getElementById("cred-text").textContent = __CRED_TEXT;
    document.getElementById("cred-modal").style.display = "flex";
  }
  function closeCredModal(){
    document.getElementById("cred-modal").style.display = "none";
    document.getElementById("cred-text").textContent = "";
    __CRED_TEXT = "";
  }
  function shareCredWhatsApp(){
    if(!__CRED_TEXT) return;
    window.open("https://wa.me/?text=" + encodeURIComponent(__CRED_TEXT), "_blank");
  }
  function shareCredEmail(){
    if(!__CRED_TEXT) return;
    const subject = "Credenziali Pay4You Card";
    window.location.href = "mailto:?subject=" + encodeURIComponent(subject) + "&body=" + encodeURIComponent(__CRED_TEXT);
  }

  // close modal clicking overlay
  document.getElementById('qr-modal')?.addEventListener('click', function(e){ if(e.target===this) closeQrModal(); });
  document.getElementById('cred-modal')?.addEventListener('click', function(e){ if(e.target===this) closeCredModal(); });
</script>

</body>
</html>
