{% extends "base.html" %}
{% block title %}Dashboard | Pay4You{% endblock %}

{% block content %}
<div class="page-main">
  <div class="admin-wrap">

    <div class="admin-head">
      <div>
        <div class="admin-title">Dashboard</div>
        <div class="admin-sub">
          {% if is_admin %}Gestione completa{% else %}Gestione della tua card{% endif %}
        </div>
      </div>

      <div class="admin-actions">
        {% if is_admin %}
          <a class="btn-pill" href="{{ url_for('new_agent') }}">➕ Nuova card</a>
        {% endif %}
      </div>
    </div>

    <div class="table-card">
      <div class="table-row table-head">
        <div>Nome</div>
        <div>Slug</div>
        <div>Azioni</div>
      </div>

      {% for a in agents %}
      <div class="table-row">
        <div class="name-cell">{{ a.name }}</div>
        <div class="slug-cell">{{ a.slug }}</div>

        <div class="actions-cell">
          <a class="btn-mini" href="/{{ a.slug }}" target="_blank" rel="noopener">Apri P1</a>

          {% if (a.p2_enabled or 0)|int == 1 %}
            <a class="btn-mini" href="/{{ a.slug }}?p=p2" target="_blank" rel="noopener">Apri P2</a>

            {% if is_admin %}
              <form method="post" action="{{ url_for('admin_deactivate_p2', slug=a.slug) }}" style="display:inline;">
                <button class="btn-mini ghost" type="submit">Disattiva P2</button>
              </form>
            {% else %}
              <form method="post" action="{{ url_for('me_deactivate_p2') }}" style="display:inline;">
                <button class="btn-mini ghost" type="submit">Disattiva P2</button>
              </form>
            {% endif %}

          {% else %}
            {% if is_admin %}
              <form method="post" action="{{ url_for('admin_activate_p2', slug=a.slug) }}" style="display:inline;">
                <button class="btn-mini warn" type="submit">Attiva P2</button>
              </form>
            {% else %}
              <form method="post" action="{{ url_for('me_activate_p2') }}" style="display:inline;">
                <button class="btn-mini warn" type="submit">Attiva P2</button>
              </form>
            {% endif %}
          {% endif %}

          {% if is_admin %}
            <a class="btn-mini ghost" href="{{ url_for('edit_agent', slug=a.slug) }}">Modifica P1</a>
            <a class="btn-mini ghost" href="{{ url_for('admin_credentials_html', slug=a.slug) }}">Invia codici</a>
          {% else %}
            <a class="btn-mini ghost" href="{{ url_for('me_edit') }}">Modifica P1</a>
          {% endif %}

          {% if (a.p2_enabled or 0)|int == 1 %}
            {% if is_admin %}
              <a class="btn-mini ghost" href="{{ url_for('admin_profile2', slug=a.slug) }}">Modifica P2</a>
            {% else %}
              <a class="btn-mini ghost" href="{{ url_for('me_profile2') }}">Modifica P2</a>
            {% endif %}
          {% endif %}

          <button class="btn-mini" type="button" onclick="openQrModal('/{{ a.slug }}/qr.png')">QR</button>

          {% if is_admin %}
            <form method="post" action="{{ url_for('delete_agent', slug=a.slug) }}" onsubmit="return confirm('Eliminare?')" style="display:inline;">
              <button class="btn-mini danger" type="submit">Elimina</button>
            </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="footer">
      Realizzato © Pay4You da Giuseppe Di Lisio 2026
    </div>
  </div>
</div>

<!-- QR modal -->
<div id="qr-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <button class="modal-x" type="button" onclick="closeQrModal()">✕</button>
    <img id="qr-img" src="" alt="QR" style="width:100%;max-width:520px;display:block;margin:8px auto;border-radius:14px;">
    <button class="modal-close" type="button" onclick="closeQrModal()">Chiudi</button>
  </div>
</div>

<script>
  function openQrModal(src){
    const m = document.getElementById('qr-modal');
    const img = document.getElementById('qr-img');
    img.src = src;
    m.style.display = 'flex';
  }
  function closeQrModal(){
    const m = document.getElementById('qr-modal');
    const img = document.getElementById('qr-img');
    img.src = '';
    m.style.display = 'none';
  }
</script>
{% endblock %}
