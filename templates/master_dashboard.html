<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Master Control | Pay4You</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background:#050505; color:white; font-family:sans-serif; padding:20px; }
        .head { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px; }
        .box { background:#111; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #333; }
        
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        td, th { padding:12px; border-bottom:1px solid #222; text-align:left; vertical-align:middle; }
        th { color:#888; font-size:12px; text-transform:uppercase; }
        
        /* BOTTONI AZIONE STILE "PILLOLA" */
        .row-btns { display:flex; gap:5px; flex-wrap:wrap; }
        .pill {
            display:inline-flex; align-items:center; justify-content:center;
            width:36px; height:36px; border-radius:10px; font-weight:bold; font-size:18px;
            border:1px solid rgba(255,255,255,.1); cursor:pointer; user-select:none;
            transition: transform 0.2s;
        }
        .pill:hover { transform: scale(1.1); }
        
        .wa { background:#25D366; color:#000; }
        .gm { background:#ffffff; color:#c71610; }
        .em { background:#444; color:#fff; }
        .cp { background:#00ffc8; color:#000; }
        .qr { background:#f5a300; color:#000; }
        
        .btn-gest { background:#0088cc; color:#fff; font-size:13px; padding:0 10px; width:auto; text-decoration:none; }
        .btn-del { background:#330000; color:#ff4444; border:1px solid #550000; font-size:16px; }

        .credenziali { font-family:monospace; color:#00ffc8; background:rgba(0,255,200,0.1); padding:5px 8px; border-radius:5px; font-size:13px; }
        
        /* NUOVO FORM CREAZIONE AUTOMATICA */
        .form-row { display:flex; gap:15px; flex-wrap:wrap; align-items: flex-end; }
        .input-group { display:flex; flex-direction:column; flex:1; min-width: 200px; }
        .input-group label { font-size:12px; color:#aaa; margin-bottom:5px; font-weight:bold; }
        input { background:#222; border:1px solid #444; color:white; padding:10px; border-radius:5px; width:100%; box-sizing: border-box; }
        input:focus { border-color:#00ffc8; outline:none; }
        
        .btn-crea { background:#00ffc8; color:black; border:none; padding:10px 25px; font-weight:bold; border-radius:5px; cursor:pointer; height: 38px; }

        /* MODALE QR */
        .qr-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:999; justify-content:center; align-items:center; flex-direction:column; }
        .qr-box { background:white; padding:20px; border-radius:15px; text-align:center; }
        .close-qr { margin-top:15px; color:white; cursor:pointer; font-weight:bold; font-size:18px; }
        
        /* TOAST */
        .toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:rgba(0,0,0,.8); border:1px solid #444; color:#fff; padding:10px 20px; border-radius:20px; display:none; z-index:10000; }

        /* FLASH MESSAGES */
        .flashes { list-style:none; padding:0; margin-bottom:20px; }
        .flash { padding:15px; border-radius:10px; margin-bottom:10px; font-weight:bold; }
        .flash.success { background:rgba(0,255,200,0.2); border:1px solid #00ffc8; color:#00ffc8; }
    </style>
</head>
<body>
    <div class="head">
        <h1>MASTER CONTROL üéõÔ∏è</h1>
        <a href="/master/logout" style="color:#ff4444; text-decoration:none; border:1px solid #ff4444; padding:8px 15px; border-radius:5px;">ESCI DAL PORTALE</a>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
        {% for category, message in messages %}
          <li class="flash {{ category }}">{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="box" style="border-color:#00ffc8;">
        <h3 style="color:#00ffc8; margin-top:0;">‚ûï Crea Nuova Card (Automatico)</h3>
        <p style="color:#aaa; font-size:13px; margin-bottom:15px;">Inserisci i dati per le credenziali. La password verr√† generata automaticamente e la card sar√† creata vuota.</p>
        <form action="/master/add" method="POST" class="form-row">
            
            <div class="input-group">
                <label>SLUG / LINK (es. mario-rossi)</label>
                <input type="text" name="slug" placeholder="es. card-cliente" required style="color:#00ffc8; font-weight:bold; border-color:#555;">
            </div>
            
            <div class="input-group">
                <label>EMAIL (Per invio credenziali)</label>
                <input type="email" name="admin_email" placeholder="email@cliente.com" required>
            </div>

            <div class="input-group">
                <label>WHATSAPP (Per invio credenziali)</label>
                <input type="text" name="admin_whatsapp" placeholder="+39 333..." required>
            </div>
            
            <div class="input-group" style="flex:0;">
                <label>&nbsp;</label>
                <button class="btn-crea">CREA AUTO üöÄ</button>
            </div>
        </form>
    </div>

    <div class="box">
        <h3>Lista Clienti ({{ clienti|length }})</h3>
        <table>
            <tr>
                <th>Cliente / Link</th>
                <th>Credenziali & Contatti Admin</th>
                <th>Invia Dati (Privato)</th>
                <th style="text-align:right;">Azioni</th>
            </tr>
            {% for c in clienti %}
            <tr>
                <td>
                    <strong style="font-size:16px;">{{ c.p1.name if c.p1.name else 'Card Vuota (' + c.slug + ')' }}</strong><br>
                    <a href="/card/{{ c.slug }}" target="_blank" style="color:#666; font-size:12px; text-decoration:none;">/card/{{ c.slug }}</a>
                </td>
                <td>
                    <div class="credenziali">
                        U: {{ c.username }}<br>
                        P: {{ c.password }}
                    </div>
                    <div style="font-size:11px; color:#888; margin-top:5px;">
                        ‚úâÔ∏è {{ c.admin_contact.email }}<br>
                        üì± {{ c.admin_contact.whatsapp }}
                    </div>
                </td>
                <td>
                    <div class="row-btns">
                        <div class="pill wa" onclick="sendWA('{{c.admin_contact.whatsapp}}', '{{c.username}}', '{{c.password}}', '{{c.slug}}')" title="WhatsApp a {{c.admin_contact.whatsapp}}">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="pill gm" onclick="sendGmail('{{c.admin_contact.email}}', '{{c.username}}', '{{c.password}}', '{{c.slug}}')" title="Gmail a {{c.admin_contact.email}}">
                            ‚úâÔ∏è
                        </div>
                        <div class="pill em" onclick="sendEmailApp('{{c.admin_contact.email}}', '{{c.username}}', '{{c.password}}', '{{c.slug}}')" title="Email App a {{c.admin_contact.email}}">
                            üì®
                        </div>
                        <div class="pill cp" onclick="copyCred('{{c.username}}', '{{c.password}}', '{{c.slug}}')" title="Copia Testo">
                            üìã
                        </div>
                        <div class="pill qr" onclick="mostraQR('{{c.slug}}')" title="QR Link">
                            <i class="fas fa-qrcode"></i>
                        </div>
                    </div>
                </td>
                <td style="text-align:right;">
                    <div class="row-btns" style="justify-content: flex-end;">
                        <a href="/master/impersonate/{{c.id}}" class="pill btn-gest">Gestisci</a>
                        <a href="/master/delete/{{c.id}}" class="pill btn-del" onclick="return confirm('Sei sicuro di voler eliminare {{c.slug}}?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <div id="boxQR" class="qr-modal">
        <div class="qr-box">
            <img id="imgQR" src="" width="250" height="250">
            <div style="color:black; margin-top:10px; font-weight:bold;">LINK CARD</div>
        </div>
        <div class="close-qr" onclick="chiudiQR()">CHIUDI X</div>
    </div>

    <div id="toast" class="toast">Testo Copiato! ‚úÖ</div>

    <script>
        var baseUrl = window.location.origin;

        // --- FUNZIONI DI COSTRUZIONE TESTO ---
        function getCredSubject() { return "Pay4You - Credenziali Accesso"; }
        
        function getCredBody(user, pass, slug) {
            var linkLogin = baseUrl + "/area/login";
            var linkCard = baseUrl + "/card/" + slug;
            
            return "Ciao!\n\n" +
                   "Ecco le tue credenziali per gestire la tua nuova Card Digitale Pay4You.\n\n" +
                   "Ti preghiamo di accedere e compilare i tuoi dati.\n\n" +
                   "LOGIN (Per modificare):\n" + linkLogin + "\n" +
                   "USER: " + user + "\n" +
                   "PASSWORD: " + pass + "\n\n" +
                   "IL TUO LINK PUBBLICO:\n" + linkCard + "\n\n" +
                   "Consiglio: salva questi dati e cambia la password al primo accesso.";
        }

        // 1. WHATSAPP (Apre la chat con il numero salvato)
        function sendWA(phone, user, pass, slug) {
            // Pulisce il numero da spazi o caratteri extra
            var cleanPhone = phone.replace(/[^0-9]/g, '');
            var txt = getCredBody(user, pass, slug);
            window.open("https://wa.me/" + cleanPhone + "?text=" + encodeURIComponent(txt), '_blank');
        }

        // 2. GMAIL (Web, con destinatario salvato)
        function sendGmail(email, user, pass, slug) {
            var sub = getCredSubject();
            var body = getCredBody(user, pass, slug);
            var url = "https://mail.google.com/mail/?view=cm&fs=1&to=" + email + "&su=" + encodeURIComponent(sub) + "&body=" + encodeURIComponent(body);
            window.open(url, '_blank');
        }

        // 3. EMAIL APP (Con destinatario salvato)
        function sendEmailApp(email, user, pass, slug) {
            var sub = getCredSubject();
            var body = getCredBody(user, pass, slug);
            window.location.href = "mailto:" + email + "?subject=" + encodeURIComponent(sub) + "&body=" + encodeURIComponent(body);
        }

        // 4. COPIA TESTO
        async function copyCred(user, pass, slug) {
            var txt = "OGGETTO: " + getCredSubject() + "\n\n" + getCredBody(user, pass, slug);
            try {
                await navigator.clipboard.writeText(txt);
                showToast();
            } catch (err) {
                var ta = document.createElement("textarea");
                ta.value = txt;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand("copy");
                document.body.removeChild(ta);
                showToast();
            }
        }

        function showToast() {
            var t = document.getElementById("toast");
            t.style.display = "block";
            setTimeout(function(){ t.style.display = "none"; }, 2000);
        }

        // 5. QR CODE
        function mostraQR(slug) {
            var linkCard = baseUrl + "/card/" + slug;
            var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(linkCard);
            document.getElementById('imgQR').src = qrUrl;
            document.getElementById('boxQR').style.display = 'flex';
        }

        function chiudiQR() {
            document.getElementById('boxQR').style.display = 'none';
        }
    </script>
</body>
</html>
