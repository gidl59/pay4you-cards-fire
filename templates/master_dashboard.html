<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Master Admin | Pay4You</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .box{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px;
      margin-bottom:14px;
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .title{ font-weight:900; letter-spacing:.06em; color:#00ffc8; margin:0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:14px;
      font-weight:900; cursor:pointer; text-decoration:none;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:#fff;
    }
    .btn-primary{ background:linear-gradient(90deg,#0088cc,#00ffc8); color:#000; border:none; }
    .btn-danger{ background:#c70000; border:none; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:12px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:middle; }
    th{ color:#aaa; font-size:12px; letter-spacing:.08em; text-transform:uppercase; }
    .small{ color:#aaa; font-size:12px; margin-top:6px; }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:36px;
      border-radius:12px; font-weight:900;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
    }
    .wa{ background:#25D366; color:#000; border:none; }
    .em{ background:#fff; color:#000; border:none; }
    .qr{ background:#f5a300; color:#000; border:none; }

    .modal-overlay{
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.70);
      backdrop-filter: blur(10px);
      z-index:9999;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:14px;
      padding:18px;
    }
    .modal-card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      max-width:520px;
      width:92vw;
      text-align:center;
    }
    .modal-actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .act{ width:54px; height:54px; border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; user-select:none; }
    .act-wa{ background:#25D366; color:#000; }
    .act-em{ background:#fff; color:#000; }
    .act-app{ background:#444; color:#fff; }
    .act-copy{ background:#00ffc8; color:#00120e; }
    .act-cl{ background:#0088cc; color:#000; }

    /* mini toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      display:none;
      z-index:10000;
      backdrop-filter: blur(8px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="box">
      <div class="topbar">
        <h2 class="title">‚ûï Nuovo Cliente</h2>
        <a class="btn btn-danger" href="/master/logout">Esci</a>
      </div>

      <form class="row" method="POST" action="/master/add" style="margin-top:12px;">
        <input class="input-rect" name="slug" placeholder="Slug (es. mario)" style="flex:1; min-width:220px;">
        <input class="input-rect" name="username" placeholder="User" style="flex:1; min-width:180px;">
        <input class="input-rect" name="password" placeholder="Pass (vuoto=auto)" style="flex:1; min-width:200px;">
        <input class="input-rect" name="nome" placeholder="Nome" style="flex:1; min-width:200px;">
        <button class="btn btn-primary" type="submit">CREA</button>
      </form>
    </div>

    <div class="box">
      <h3 class="title" style="margin:0 0 10px;">Clienti</h3>

      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Credenziali</th>
            <th>Invia</th>
            <th style="text-align:right;">Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clienti %}
          <tr>
            <td>
              <div style="font-weight:900; font-size:16px;">{{ c.nome }}</div>
              <div style="color:#00ffc8; font-weight:900;">
                <a href="/card/{{ c.slug }}" target="_blank" style="color:#00ffc8; text-decoration:none;">/card/{{ c.slug }}</a>
              </div>
              <div class="small">slug: {{ c.slug }}</div>
            </td>

            <td>
              <div style="font-weight:900;">u: <span style="color:#fff;">{{ c.username }}</span></div>
              <div style="font-weight:900;">p: <span style="color:#fff;">{{ c.password }}</span></div>
            </td>

            <td>
              <div class="row">
                <div class="pill wa" onclick="sendWA('{{ c.username|e }}','{{ c.password|e }}','{{ c.slug|e }}')">WA</div>

                <!-- EMAIL come quello che ti funziona (Gmail compose) -->
                <div class="pill em" onclick="sendEmailCred('{{ c.username|e }}','{{ c.password|e }}','{{ c.slug|e }}')">@</div>

                <div class="pill qr" onclick="openQR('{{ c.slug|e }}','{{ c.username|e }}','{{ c.password|e }}')">QR</div>

                <!-- Copia testo credenziali -->
                <div class="pill" onclick="copyCred('{{ c.username|e }}','{{ c.password|e }}','{{ c.slug|e }}')" title="Copia testo">üìã</div>
              </div>
              <div class="small">‚úÖ Gmail + Copia testo + Email(APP)</div>
            </td>

            <td style="text-align:right;">
              <a class="btn" href="/master/impersonate/{{ c.id }}">Gestisci</a>
              <a class="btn btn-danger" href="/master/delete/{{ c.id }}" onclick="return confirm('Confermi ELIMINA questo cliente?')">ELIMINA</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="qrModal" class="modal-overlay">
    <div class="modal-card">
      <div style="font-weight:900; color:#00ffc8; letter-spacing:.06em;">QR + INVIO CREDENZIALI</div>
      <div id="qrBox" style="margin-top:12px;"></div>
      <div class="small" id="qrInfo"></div>
    </div>

    <div class="modal-actions">
      <div class="act act-wa" onclick="modalWA()" title="WhatsApp">üü¢</div>

      <!-- Gmail web compose (come nella dashboard file) -->
      <div class="act act-em" onclick="modalEmail()" title="Gmail">‚úâÔ∏è</div>

      <!-- Mailto per Thunderbird/Outlook/Apple Mail -->
      <div class="act act-app" onclick="modalEmailApp()" title="Email (APP)">üì®</div>

      <!-- Copia testo credenziali -->
      <div class="act act-copy" onclick="modalCopy()" title="Copia testo">üìã</div>

      <div class="act act-cl" onclick="closeQR()" title="Chiudi">‚úñ</div>
    </div>
  </div>

  <div id="toast" class="toast">Copiato ‚úÖ</div>

  <script>
    let MOD_SLUG="", MOD_U="", MOD_P="";

    // ===== helper base =====
    function baseUrls(slug){
      const base  = window.location.origin;
      const login = base + "/area/login";
      const card  = base + "/card/" + slug;
      return { base, login, card };
    }

    function credSubject(){
      return "Pay4You - Credenziali Accesso";
    }

    function credBody(u,p,slug){
      const { login, card } = baseUrls(slug);
      return (
        "Ciao!\n\n" +
        "Ecco le tue credenziali Pay4You per gestire la Card:\n\n" +
        "LOGIN: " + login + "\n" +
        "USER: " + u + "\n" +
        "PASSWORD: " + p + "\n\n" +
        "La tua Card:\n" + card + "\n\n" +
        "Consiglio: al primo accesso salva questi dati.\n\n" +
        "‚Äî Pay4You"
      );
    }

    function showToast(msg){
      const t = document.getElementById("toast");
      if(!t) return;
      t.textContent = msg || "Copiato ‚úÖ";
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ t.style.display="none"; }, 1600);
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copiato ‚úÖ");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try{
          document.execCommand("copy");
          showToast("Copiato ‚úÖ");
        }catch(err){
          alert("Non riesco a copiare automaticamente. Copia manualmente:\n\n" + text);
        }
        document.body.removeChild(ta);
      }
    }

    // ===== EMAIL: stessi comportamenti del file dashboard =====
    function sendEmailCred(u,p,slug){
      // Gmail web compose (risolve il problema: in Gmail c'√® solo oggetto se usi mailto)
      const subject = credSubject();
      const body = credBody(u,p,slug);

      const gmailUrl = "https://mail.google.com/mail/?view=cm&fs=1" +
                       "&su=" + encodeURIComponent(subject) +
                       "&body=" + encodeURIComponent(body);

      window.open(gmailUrl, "_blank");
    }

    function sendEmailApp(u,p,slug){
      // per Thunderbird/Outlook/Apple Mail
      const subject = credSubject();
      const body = credBody(u,p,slug).replace(/\n/g, "\r\n");
      const mailto = "mailto:?subject=" + encodeURIComponent(subject) +
                     "&body=" + encodeURIComponent(body);
      window.location.href = mailto;
    }

    function copyCred(u,p,slug){
      const subject = credSubject();
      const body = credBody(u,p,slug);
      const text = "OGGETTO:\n" + subject + "\n\nTESTO:\n" + body;
      copyText(text);
    }

    // ===== WhatsApp (come prima) =====
    function sendWA(u,p,slug){
      const { login, card } = baseUrls(slug);
      const txt =
        "Pay4You - Credenziali\n\n" +
        "Login: " + login + "\n" +
        "User: " + u + "\n" +
        "Pass: " + p + "\n\n" +
        "Card: " + card;

      window.open("https://wa.me/?text=" + encodeURIComponent(txt), "_blank");
    }

    // ===== QR MODAL =====
    function openQR(slug,u,p){
      MOD_SLUG=slug; MOD_U=u; MOD_P=p;

      const url = window.location.origin + "/card/" + slug;
      document.getElementById("qrBox").innerHTML =
        '<img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(url) +
        '" style="background:white; padding:14px; border-radius:18px; width:260px; height:260px;">';

      document.getElementById("qrInfo").innerText =
        "User: " + u + "  |  Pass: " + p;

      document.getElementById("qrModal").style.display="flex";
    }

    function closeQR(){
      document.getElementById("qrModal").style.display="none";
      document.getElementById("qrBox").innerHTML="";
      MOD_SLUG=""; MOD_U=""; MOD_P="";
    }

    function modalWA(){ sendWA(MOD_U, MOD_P, MOD_SLUG); }
    function modalEmail(){ sendEmailCred(MOD_U, MOD_P, MOD_SLUG); }
    function modalEmailApp(){ sendEmailApp(MOD_U, MOD_P, MOD_SLUG); }
    function modalCopy(){ copyCred(MOD_U, MOD_P, MOD_SLUG); }
  </script>
</body>
</html>
