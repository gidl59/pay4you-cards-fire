<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Master Control</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { background:#050505; color:white; font-family:sans-serif; padding:20px; }
        .head { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .box { background:#111; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #333; }
        table { width:100%; border-collapse:collapse; }
        td, th { padding:10px; border-bottom:1px solid #222; text-align:left; }
        .btn { padding:5px 10px; border-radius:5px; text-decoration:none; cursor:pointer; font-size:12px; border:none; color:white; margin-right:5px; }
        .btn-wa { background:#25D366; } .btn-mail { background:#fff; color:black; }
        .btn-qr { background:#FF9800; color:black; }
        .btn-del { background:#cc0000; } .btn-view { background:#0088cc; }
        .btn-out { background:transparent; border:1px solid #666; color:#ccc; }
        input { background:#222; border:1px solid #444; color:white; padding:8px; border-radius:5px; }
        
        /* MODAL */
        .m-over { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99; justify-content:center; align-items:center; }
        .m-box { background:#222; padding:20px; border-radius:10px; text-align:center; max-width:300px; border:1px solid #444; }
        .m-acts { display:flex; gap:10px; margin-top:15px; justify-content:center; }
    </style>
</head>
<body>
    <div class="head">
        <h1>MASTER CONTROL</h1>
        <a href="/master/logout" class="btn btn-out">ESCI</a>
    </div>
    
    <div class="box">
        <h3>âž• Nuovo Cliente</h3>
        <form action="/master/add" method="POST">
            <input type="text" name="slug" placeholder="Slug (es. mario)" required>
            <input type="text" name="username" placeholder="User">
            <input type="text" name="password" placeholder="Pass (vuoto=auto)">
            <input type="text" name="nome" placeholder="Nome">
            <button class="btn btn-wa" style="font-size:14px;">CREA</button>
        </form>
    </div>

    <div class="box">
        <table>
            <tr><th>Cliente</th><th>Credenziali</th><th>Invia</th><th>Azioni</th></tr>
            {% for c in clienti %}
            <tr>
                <td>{{ c.nome }}<br><small style="color:#00ffc8;">/card/{{ c.slug }}</small></td>
                <td style="font-family:monospace;">U: {{ c.username }}<br>P: {{ c.password }}</td>
                <td>
                    <button onclick="sendWa('{{c.username}}','{{c.password}}')" class="btn btn-wa">WA</button>
                    <button onclick="sendMail('{{c.username}}','{{c.password}}')" class="btn btn-mail">@</button>
                    <button onclick="openQr('{{c.slug}}')" class="btn btn-qr">QR</button>
                </td>
                <td>
                    <a href="/master/impersonate/{{c.id}}" target="_blank" class="btn btn-view">Gestisci</a>
                    <a href="/master/delete/{{c.id}}" class="btn btn-del" onclick="return confirm('Eliminare?')">X</a>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <div id="qrModal" class="m-over">
        <div class="m-box">
            <h3 style="margin-top:0;">QR Code</h3>
            <div id="qrImg"></div>
            <div class="m-acts">
                <button onclick="sendQrWa()" class="btn btn-wa">WA</button>
                <button onclick="sendQrMail()" class="btn btn-mail">@</button>
                <button onclick="closeQr()" class="btn btn-del">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        var currentSlug = "";
        function sendWa(u, p) {
            var txt = "Credenziali Pay4You:\nUser: " + u + "\nPass: " + p + "\nLogin: https://pay4you-cards-fire.onrender.com/area/login";
            window.open("https://wa.me/?text=" + encodeURIComponent(txt));
        }
        function sendMail(u, p) {
            var sub = "Credenziali Pay4You";
            var body = "Ecco le tue credenziali:\n\nUser: " + u + "\nPassword: " + p + "\n\nLogin: https://pay4you-cards-fire.onrender.com/area/login";
            window.location.href = "mailto:?subject=" + encodeURIComponent(sub) + "&body=" + encodeURIComponent(body);
        }
        
        function openQr(slug) {
            currentSlug = slug;
            var url = "https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://pay4you-cards-fire.onrender.com/card/" + slug;
            document.getElementById('qrImg').innerHTML = '<img src="' + url + '" style="background:white; padding:10px; border-radius:10px;">';
            document.getElementById('qrModal').style.display = 'flex';
        }
        function closeQr() { document.getElementById('qrModal').style.display = 'none'; }
        
        function sendQrWa() {
            var link = "https://pay4you-cards-fire.onrender.com/card/" + currentSlug;
            window.open("https://wa.me/?text=" + encodeURIComponent("Ecco la tua Card: " + link));
        }
        function sendQrMail() {
            var link = "https://pay4you-cards-fire.onrender.com/card/" + currentSlug;
            window.location.href = "mailto:?subject=La tua Card&body=" + encodeURIComponent("Ecco il link: " + link);
        }
    </script>
</body>
</html>
