<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">{{ "Admin" if is_admin else "Cliente" }}</div>
      </div>
    </a>

    <div class="toolbar">
      {% if is_admin %}
        <a class="btn primary" href="/area/new">+ Nuova Card</a>

        <form class="inline" method="post" action="/area/admin/clean_pdf_db"
              onsubmit="return confirm('Pulire il DB dei PDF (rimuove duplicati e link sporchi) senza cancellare file?');">
          <button class="btn" type="submit">PULISCI PDF (solo DB)</button>
        </form>

        <form class="inline" method="post" action="/area/admin/purge_pdfs"
              onsubmit="return confirm('ATTENZIONE: elimina TUTTI i PDF (file + DB) per TUTTI gli agenti. Continuare?');">
          <button class="btn danger" type="submit">PURGE PDF (totale)</button>
        </form>
      {% endif %}
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="dash-grid">
      {% for a in agents %}
      <section class="dash-card" data-slug="{{ a.slug }}">
        <div class="dash-head">
          <div class="dash-left">
            <div class="dash-avatar">
              {% if a.photo_url %}
                <img src="{{ a.photo_url }}" alt="foto">
              {% else %}
                <div class="dash-ph">ðŸ‘¤</div>
              {% endif %}
            </div>
            <div>
              <div class="dash-name">{{ a.name or a.slug }}</div>
              <div class="dash-sub">{{ a.company or "â€”" }}</div>

              <!-- âœ… SOLO ADMIN vede lo slug -->
              {% if is_admin %}
                <div class="dash-sub2">Slug: <span class="slug-badge">{{ a.slug }}</span></div>
              {% endif %}
            </div>
          </div>

          <div class="dash-actions">
            <a class="btn-mini" target="_blank" href="/{{ a.slug }}">Apri P1</a>
            {% if a.p2_enabled == 1 %}
              <a class="btn-mini" target="_blank" href="/{{ a.slug }}?p=p2">Apri P2</a>
            {% endif %}
            {% if a.p3_enabled == 1 %}
              <a class="btn-mini" target="_blank" href="/{{ a.slug }}?p=p3">Apri P3</a>
            {% endif %}

            <a class="btn-mini ghost" href="/vcf/{{ a.slug }}">VCF</a>

            <button class="btn-mini ghost" type="button" onclick="openQrModal('{{ a.slug }}','p1')">QR P1</button>
            {% if a.p2_enabled == 1 %}
              <button class="btn-mini ghost" type="button" onclick="openQrModal('{{ a.slug }}','p2')">QR P2</button>
            {% endif %}
            {% if a.p3_enabled == 1 %}
              <button class="btn-mini ghost" type="button" onclick="openQrModal('{{ a.slug }}','p3')">QR P3</button>
            {% endif %}

            {% if is_admin %}
              <a class="btn-mini warn" href="/area/edit/{{ a.slug }}/p1">Modifica P1</a>
              {% if a.p2_enabled == 1 %}
                <a class="btn-mini warn" href="/area/edit/{{ a.slug }}/p2">Modifica P2</a>
              {% endif %}
              {% if a.p3_enabled == 1 %}
                <a class="btn-mini warn" href="/area/edit/{{ a.slug }}/p3">Modifica P3</a>
              {% endif %}

              {% if a.p2_enabled == 1 %}
                <form class="inline" method="post" action="/area/admin/deactivate/{{ a.slug }}/p2"
                      onsubmit="return confirm('Disattivare P2? VerrÃ  svuotato.');">
                  <button class="btn-mini danger" type="submit">Disattiva P2</button>
                </form>
              {% else %}
                <form class="inline" method="post" action="/area/admin/activate/{{ a.slug }}/p2"
                      onsubmit="return confirm('Attivare P2 vuoto?');">
                  <button class="btn-mini" type="submit">Attiva P2</button>
                </form>
              {% endif %}

              {% if a.p3_enabled == 1 %}
                <form class="inline" method="post" action="/area/admin/deactivate/{{ a.slug }}/p3"
                      onsubmit="return confirm('Disattivare P3? VerrÃ  svuotato.');">
                  <button class="btn-mini danger" type="submit">Disattiva P3</button>
                </form>
              {% else %}
                <form class="inline" method="post" action="/area/admin/activate/{{ a.slug }}/p3"
                      onsubmit="return confirm('Attivare P3 vuoto?');">
                  <button class="btn-mini" type="submit">Attiva P3</button>
                </form>
              {% endif %}
            {% else %}
              <a class="btn-mini warn" href="/area/me/edit">Modifica P1</a>
              {% if a.p2_enabled == 1 %}
                <a class="btn-mini warn" href="/area/me/p2">Modifica P2</a>
              {% endif %}
              {% if a.p3_enabled == 1 %}
                <a class="btn-mini warn" href="/area/me/p3">Modifica P3</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="dash-preview">
          <div class="dash-preview-col">
            <div class="dash-preview-title">Foto</div>
            <div class="dash-mini-grid">
              {% set imgs = (a.gallery_urls or "").split("|") %}
              {% set imgs2 = [] %}
              {% for x in imgs %}
                {% if x and x.strip() %}
                  {% set _ = imgs2.append(x) %}
                {% endif %}
              {% endfor %}

              <!-- âœ… CLIENTE: piÃ¹ foto (12). ADMIN: come prima (6) -->
              {% set img_limit = 6 if is_admin else 12 %}
              {% for g in imgs2[:img_limit] %}
                <img class="dash-mini" src="{{ g }}" alt="">
              {% endfor %}

              {% if imgs2|length == 0 %}
                <div class="dash-mini-empty">â€”</div>
              {% endif %}
            </div>
          </div>

          <div class="dash-preview-col">
            <div class="dash-preview-title">Video</div>
            <div class="dash-mini-grid">
              {% set vids = (a.video_urls or "").split("|") %}
              {% set vids2 = [] %}
              {% for x in vids %}
                {% if x and x.strip() %}
                  {% set _ = vids2.append(x) %}
                {% endif %}
              {% endfor %}

              <!-- âœ… CLIENTE: piÃ¹ video (8). ADMIN: come prima (4) -->
              {% set vid_limit = 4 if is_admin else 8 %}
              {% for v in vids2[:vid_limit] %}
                <video class="dash-mini vthumb" muted playsinline preload="metadata" data-src="{{ v }}"></video>
              {% endfor %}

              {% if vids2|length == 0 %}
                <div class="dash-mini-empty">â€”</div>
              {% endif %}
            </div>
          </div>

          <div class="dash-preview-col">
            <div class="dash-preview-title">PDF</div>
            <div class="dash-pdf-list">
              {% set pdfs = (a.pdf1_url or "").split("|") %}
              {% set pdfs2 = [] %}
              {% for x in pdfs %}
                {% if x and x.strip() %}
                  {% set _ = pdfs2.append(x) %}
                {% endif %}
              {% endfor %}

              <!-- âœ… CLIENTE: piÃ¹ pdf (12). ADMIN: come prima (6) -->
              {% set pdf_limit = 6 if is_admin else 12 %}
              {% for p in pdfs2[:pdf_limit] %}
                {% if "||" in p %}
                  {% set nm = p.split("||")[0] %}
                  {% set u = p.split("||")[1] %}
                {% else %}
                  {% set nm = p %}
                  {% set u = p %}
                {% endif %}

                <button type="button"
                        class="dash-pdf-pill"
                        title="{{ nm }}"
                        onclick="openPdfModal('{{ a.slug }}','p1','{{ u|e }}','{{ nm|e }}')">
                  {{ nm }}
                </button>
              {% endfor %}

              {% if pdfs2|length == 0 %}
                <div class="dash-mini-empty">â€”</div>
              {% endif %}
            </div>
          </div>
        </div>

      </section>
      {% endfor %}
    </div>

    <div class="footer">Pay4You.store</div>

  </main>

</div>

<!-- âœ… MODAL QR/PDF (senza X) -->
<div id="shareModal" class="modal-overlay" style="display:none" onclick="overlayCloseShare(event)">
  <div class="modal-box" onclick="event.stopPropagation()" style="max-width:820px;">
    <div class="modal-title" id="smTitle">Anteprima</div>

    <div id="smBody" style="margin-top:12px;"></div>

    <div class="modal-actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
      <button class="btn" type="button" onclick="shareCurrent('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareCurrent('email')">Invia Email</button>

      {% if is_admin %}
        <button class="btn danger" type="button" onclick="deleteCurrent()">Elimina</button>
      {% endif %}

      <button class="btn ghost" type="button" onclick="closeShareModal()">Chiudi</button>
    </div>

    <input type="hidden" id="smKind" value="">
    <input type="hidden" id="smSlug" value="">
    <input type="hidden" id="smProfile" value="">
    <input type="hidden" id="smUrl" value="">
    <input type="hidden" id="smDeleteHref" value="">
  </div>
</div>

<script>
  // video thumb: lazy load + seek 0.1
  (function(){
    const vids = Array.from(document.querySelectorAll('video.vthumb[data-src]'));
    if(!vids.length) return;

    function loadThumb(v){
      if(v.dataset.loaded === "1") return;
      v.dataset.loaded = "1";
      const src = v.getAttribute('data-src');
      if(!src) return;
      v.src = src + "#t=0.1";
      v.load();
      const onLoaded = () => {
        try { v.currentTime = 0.1; v.pause(); } catch(e){}
        v.removeEventListener('loadeddata', onLoaded);
      };
      v.addEventListener('loadeddata', onLoaded);
    }

    const io = new IntersectionObserver((entries) => {
      entries.forEach(en => {
        if(en.isIntersecting){
          loadThumb(en.target);
          io.unobserve(en.target);
        }
      });
    }, { rootMargin: "150px" });

    vids.forEach(v => io.observe(v));
  })();

  // URL assoluto robusto
  function absUrl(u){
    if(!u) return '';
    u = (u + '').trim();
    if(/^https?:\/\//i.test(u)) return u;

    if(u.startsWith('uploads/')) u = '/' + u;
    if(u.startsWith('/uploads/')) {
      // ok
    } else if(u.startsWith('pdf/') || u.startsWith('images/') || u.startsWith('videos/')) {
      u = '/uploads/' + u;
    } else if(u.startsWith('/pdf/') || u.startsWith('/images/') || u.startsWith('/videos/')) {
      u = '/uploads' + u;
    }

    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  function gmailCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=${su}&body=${bd}`;
  }
  function outlookCompose(subject, body){
    const su = encodeURIComponent(subject || "");
    const bd = encodeURIComponent(body || "");
    return `https://outlook.office.com/mail/deeplink/compose?subject=${su}&body=${bd}`;
  }

  function overlayCloseShare(e){
    if(e.target && e.target.id === "shareModal") closeShareModal();
  }
  function closeShareModal(){
    const m = document.getElementById('shareModal');
    if(m) m.style.display = 'none';
    const body = document.getElementById('smBody');
    if(body) body.innerHTML = '';
  }

  function openQrModal(slug, p){
    const url = (p && p !== 'p1') ? `/qr/${slug}.png?p=${p}` : `/qr/${slug}.png`;
    document.getElementById('smKind').value = 'qr';
    document.getElementById('smSlug').value = slug;
    document.getElementById('smProfile').value = p || 'p1';
    document.getElementById('smUrl').value = url;

    document.getElementById('smTitle').textContent = `QR ${slug.toUpperCase()} (${(p||'p1').toUpperCase()})`;
    document.getElementById('smBody').innerHTML =
      `<img src="${absUrl(url)}" alt="qr" style="width:100%; max-height:70vh; object-fit:contain; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.15);">`;

    {% if is_admin %}
      // QR non si elimina (solo file immagine generato)
      document.getElementById('smDeleteHref').value = '';
    {% endif %}

    document.getElementById('shareModal').style.display = 'flex';
  }

  function openPdfModal(slug, profile, url, name){
    document.getElementById('smKind').value = 'pdf';
    document.getElementById('smSlug').value = slug;
    document.getElementById('smProfile').value = profile || 'p1';
    document.getElementById('smUrl').value = url;

    document.getElementById('smTitle').textContent = `PDF: ${name || 'Documento'}`;
    document.getElementById('smBody').innerHTML =
      `<iframe src="${absUrl(url)}" style="width:100%; height:70vh; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:white;"></iframe>`;

    {% if is_admin %}
      const del = `/area/media/delete/${slug}/${profile}?kind=pdf&url=` + encodeURIComponent(url);
      document.getElementById('smDeleteHref').value = del;
    {% endif %}

    document.getElementById('shareModal').style.display = 'flex';
  }

  function shareCurrent(channel){
    const kind = document.getElementById('smKind').value;
    const url = document.getElementById('smUrl').value;
    const media = absUrl(url);

    const msg = [
      `Pay4You ${kind === 'qr' ? 'QR Code' : 'PDF'}`,
      `Link: ${media}`
    ].join("\r\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = `Pay4You ${kind === 'qr' ? 'QR Code' : 'PDF'}`;
    const g = gmailCompose(subject, msg);
    const w = window.open(g, '_blank');
    if(!w){
      window.open(outlookCompose(subject, msg), '_blank');
    }
  }

  function deleteCurrent(){
    const href = document.getElementById('smDeleteHref').value;
    if(!href){
      alert("Questo elemento non puÃ² essere eliminato da qui.");
      return;
    }
    if(!confirm("Sei sicuro di eliminare questo file?")) return;
    if(!confirm("Conferma eliminazione DEFINITIVA.")) return;
    window.location.href = href;
  }
</script>

</body>
</html>
