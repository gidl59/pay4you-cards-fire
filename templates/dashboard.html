<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard | Pay4You</title>
  <link rel="icon" href="/static/logo.png">
  <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-dot"></div>
      <div>
        <div class="t1">Pay4You Cards</div>
        <div class="t2">{{ "Admin" if is_admin else "Agente" }}</div>
      </div>
    </div>
    <div class="topbar-right">
      {% if is_admin %}
        <a class="btn" href="/area/new">+ Nuova Card</a>
      {% else %}
        <a class="btn" href="/area/me/edit">Modifica P1</a>
        {% if agent and agent.p2_enabled == 1 %}
          <a class="btn" href="/area/me/p2">Modifica P2</a>
        {% endif %}
      {% endif %}
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash {{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="grid">
      {% for a in agents %}
        <div class="card">
          <div class="card-head">
            <div class="avatar">
              {% if a.photo_url %}
                <img src="{{ a.photo_url }}" alt="foto">
              {% else %}
                <div class="ph">ðŸ‘¤</div>
              {% endif %}
            </div>
            <div class="meta">
              <div class="name">{{ a.name or a.slug }}</div>
              <div class="sub">{{ a.company or "â€”" }}</div>
              <div class="sub small">Slug: <code>{{ a.slug }}</code></div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="button" onclick="openQr('{{ a.slug }}','p1')">QR P1</button>
            {% if a.p2_enabled == 1 %}
              <button class="btn" type="button" onclick="openQr('{{ a.slug }}','p2')">QR P2</button>
            {% else %}
              {% if is_admin %}
                <span class="pill">P2 non attivo</span>
              {% endif %}
            {% endif %}
            <a class="btn" target="_blank" href="/vcf/{{ a.slug }}">VCF</a>
          </div>

          {% if is_admin %}
            <div class="actions">
              <a class="btn primary" href="/area/edit/{{ a.slug }}">Modifica P1</a>

              {% if a.p2_enabled == 1 %}
                <a class="btn primary" href="/area/edit/{{ a.slug }}/p2">Modifica P2</a>
                <form method="post" action="/area/admin/deactivate-p2/{{ a.slug }}" class="inline">
                  <button class="btn" type="submit">Disattiva P2</button>
                </form>
              {% else %}
                <form method="post" action="/area/admin/activate-p2/{{ a.slug }}" class="inline">
                  <button class="btn" type="submit">Attiva P2 (vuoto)</button>
                </form>
              {% endif %}
            </div>

            <div class="actions">
              <form method="post" action="/area/admin/credentials/{{ a.slug }}" class="inline">
                <button class="btn" type="submit">Invia credenziali</button>
              </form>

              <button class="btn danger" type="button" onclick="confirmDeleteCard('{{ a.slug }}')">Elimina</button>
            </div>

          {% else %}
            {% if agent and agent.p2_enabled != 1 %}
              <form method="post" action="/area/me/activate-p2" class="inline">
                <button class="btn" type="submit">Attiva P2 (vuoto)</button>
              </form>
            {% endif %}
          {% endif %}

          {% if is_admin and session.get('last_credentials') and session.get('last_credentials').get('slug') == a.slug %}
            <div class="panel mini">
              <div style="font-weight:800">Credenziali generate</div>
              <div style="opacity:.85; font-size:13px; margin-top:6px">
                Username: <code>{{ session.get('last_credentials').get('username') }}</code><br>
                Password: <code>{{ session.get('last_credentials').get('password') }}</code>
              </div>
              <div class="hint" style="margin-top:8px">
                (Invio Email/WhatsApp lo attiviamo dopo con SMTP + WhatsApp.)
              </div>
            </div>
          {% endif %}

        </div>
      {% endfor %}
    </div>
  </main>

  <!-- QR MODAL -->
  <div id="qrModal" class="modal-overlay" style="display:none" onclick="closeQrByOverlay(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <button class="modal-x" type="button" onclick="closeQr()">âœ•</button>
      <div style="font-weight:900; margin:6px 0 10px 0">QR Code</div>
      <img id="qrImg" style="width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.12)" src="" alt="QR">

      <div class="modal-actions" style="margin-top:12px">
        <a id="qrWa" class="btn" target="_blank" href="#">Invia per WhatsApp</a>
        <a id="qrMail" class="btn" href="#">Invia per Email</a>
        <button class="btn danger" type="button" onclick="closeQr()">Chiudi</button>
      </div>
    </div>
  </div>

  <form id="delCardForm" method="post" style="display:none"></form>

  <script>
    function absUrl(u){
      if(!u) return '';
      if(u.startsWith('http://') || u.startsWith('https://')) return u;
      return window.location.origin + u;
    }

    function openQr(slug, p){
      const img = document.getElementById('qrImg');
      const modal = document.getElementById('qrModal');
      const wa = document.getElementById('qrWa');
      const mail = document.getElementById('qrMail');

      // QR image
      const qrSrc = `/qr/${slug}.png${p==='p2' ? '?p=p2' : ''}`;
      img.src = qrSrc;

      // link card (testo completo)
      const cardUrl = absUrl(`/${slug}${p==='p2' ? '?p=p2' : ''}`);
      const msg = `Pay4You - QR ${p.toUpperCase()}\n${cardUrl}`;

      wa.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      mail.href = `mailto:?subject=${encodeURIComponent("Pay4You - QR")}&body=${encodeURIComponent(msg)}`;

      modal.style.display = 'flex';
    }

    function closeQr(){
      document.getElementById('qrModal').style.display = 'none';
    }
    function closeQrByOverlay(e){
      if(e.target && e.target.id === 'qrModal') closeQr();
    }

    function confirmDeleteCard(slug){
      if(!confirm('Vuoi eliminare questa card?')) return;
      if(!confirm('Conferma definitiva: una volta eliminata NON sarÃ  ripristinabile.')) return;
      const si = prompt('Scrivi SI per eliminare definitivamente:');
      if(!si || si.trim().toLowerCase() !== 'si') return;

      const f = document.getElementById('delCardForm');
      f.action = `/area/admin/delete/${slug}`;
      f.innerHTML = `<input type="hidden" name="confirm" value="si">`;
      f.submit();
    }
  </script>
</body>
</html>
