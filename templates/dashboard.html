<!doctype html>
<html lang="{{ lang }}">
<head>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico?v=2">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ ag.name }} | Pay4You</title>
  <link rel="stylesheet" href="/static/card.css">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  
  <style>
    /* Stile per la finestra QR Code che mancava */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; }
    .modal-box { background: var(--bg-card, #fff); padding: 20px; border-radius: 15px; text-align: center; max-width: 300px; }
    .btn-close { margin-top: 15px; padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body data-theme="auto">
  <div class="card-wrap">
    
    <div class="hero" style="background-image: url('{{ ag.cover_url }}'); background-size: cover; background-position: center;"></div>
    
    <div class="avatar-wrap">
      <div class="avatar">
        {% if ag.photo_url %}
          <img src="{{ ag.photo_url }}" style="object-position: {{ ag.photo_pos_x }}% {{ ag.photo_pos_y }}%; transform: scale({{ ag.photo_zoom }});">
        {% else %}
          <div style="font-size:50px; text-align:center; padding-top:30px;">üë§</div>
        {% endif %}
      </div>
    </div>

    <div class="title">
      <h1>{{ ag.name }}</h1>
      {% if ag.role %}<div class="sub">{{ ag.role }}</div>{% endif %}
      {% if ag.company %}<div class="sub" style="color:#0088cc; font-weight:bold;">{{ ag.company }}</div>{% endif %}
    </div>

    {% if ag.bio %}<div class="bio">{{ ag.bio }}</div>{% endif %}

    {% if socials %}
      <div class="social-row">
        {% for s in socials %}
          <a class="social" href="{{ s.url }}" target="_blank">
            <span>{{ s.label[:1] }}</span>
          </a>
        {% endfor %}
      </div>
    {% endif %}

    <div class="actions">
      <a class="btn primary" href="#">{{ t_func('save_contact') }}</a>
      <button class="btn-qr" onclick="openShareModal()">QR</button>
    </div>

    <div class="content">
      {% for m in mobiles %}<div class="row"><div class="v">üìû <a href="tel:{{ m }}">{{ m }}</a></div></div>{% endfor %}
      {% for e in emails %}<div class="row"><div class="v">‚úâÔ∏è <a href="mailto:{{ e }}">{{ e }}</a></div></div>{% endfor %}
      {% for w in websites %}<div class="row"><div class="v">üåê <a href="{{ w }}" target="_blank">{{ w }}</a></div></div>{% endfor %}
    </div>

    <div class="switch-row">
      <div style="margin-bottom:10px">
        <a class="ps-btn {% if profile=='p1' %}active{% endif %}" href="?p=p1">P1</a>
        {% if p2_enabled == 1 %}<a class="ps-btn {% if profile=='p2' %}active{% endif %}" href="?p=p2">P2</a>{% endif %}
        {% if p3_enabled == 1 %}<a class="ps-btn {% if profile=='p3' %}active{% endif %}" href="?p=p3">P3</a>{% endif %}
      </div>
      <div>
        <button class="ts" data-theme="light">‚òÄÔ∏è</button>
        <button class="ts" data-theme="dark">üåô</button>
        <button class="ts" data-theme="auto">‚öôÔ∏è</button>
      </div>
    </div>

    <footer class="foot">
      Pay4You Card 2026
    </footer>
  </div>

  <div id="qrModal" class="modal-overlay">
      <div class="modal-box">
          <h3>Scansiona QR</h3>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={{ ag.slug }}" alt="QR" style="width:100%;">
          <button class="btn-close" onclick="closeShareModal()">Chiudi</button>
      </div>
  </div>

  <script>
    const root = document.body;
    function applyTheme(th) {
      if (th === 'auto') {
        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        root.setAttribute('data-theme', isDark ? 'dark' : 'light');
      } else {
        root.setAttribute('data-theme', th);
      }
      document.querySelectorAll('.ts').forEach(b => b.classList.toggle('active', b.dataset.theme === th));
      localStorage.setItem('p4y_theme', th);
    }
    
    const saved = localStorage.getItem('p4y_theme') || 'auto';
    applyTheme(saved);

    document.querySelectorAll('.ts').forEach(btn => {
      btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
    });

    // Funzioni per aprire il QR
    function openShareModal() { document.getElementById('qrModal').style.display = 'flex'; }
    function closeShareModal() { document.getElementById('qrModal').style.display = 'none'; }
  </script>
</body>
</html>
