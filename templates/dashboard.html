<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Cliente</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background:#050505; color:white; font-family:sans-serif; margin:0; padding:20px; }
    .dash-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid #333; padding-bottom:20px; }
    .dash-title { color:#00ffc8; margin:0; font-size:24px; text-transform:uppercase; letter-spacing:1px; }
    .btn-logout { color:#ff4444; text-decoration:none; border:1px solid #ff4444; padding:8px 20px; border-radius:30px; font-weight:bold; transition:0.3s; }
    .btn-logout:hover { background:#330000; }

    /* --- MODIFICA LAYOUT ORIZZONTALE --- */
    /* Usiamo Flexbox per forzare la riga orizzontale su schermi larghi */
    .profile-grid {
        display: flex;
        flex-wrap: wrap; /* Va a capo solo se lo schermo √® troppo stretto (mobile) */
        gap: 25px;
        justify-content: flex-start;
    }
    
    /* BOX PROFILO ESPANSO */
    .profile-card { 
        background:#111; border:1px solid #333; border-radius:15px; padding:20px; 
        position:relative; transition:0.3s; display:flex; flex-direction:column;
        /* Le card ora cercano di occupare circa 1/3 dello spazio ciascuna, ma con una larghezza minima */
        flex: 1 1 30%; 
        min-width: 340px; /* Larghezza minima per garantire spazio alle immagini */
    }
    .profile-card:hover { border-color:#555; transform:translateY(-5px); }
    .profile-card.active { border:2px solid #00ffc8; box-shadow:0 0 15px rgba(0,255,200,0.1); }
    .profile-card.inactive { opacity:0.6; filter:grayscale(100%); }

    /* INTESTAZIONE PROFILO CON FOTO */
    .pc-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:10px; }
    .pc-info { display:flex; align-items:center; gap:10px; }
    .pc-avatar { width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #444; background:#000; }
    .pc-title { font-size:18px; font-weight:bold; color:white; margin:0; }
    .pc-status { font-size:12px; padding:4px 8px; border-radius:4px; font-weight:bold; text-transform:uppercase; }
    .st-on { background:#004400; color:#00ffc8; }
    .st-off { background:#330000; color:#ff4444; }

    /* ANTEPRIMA MEDIA - Ora la striscia √® pi√π larga grazie al nuovo layout */
    .media-preview { margin-top:15px; background:#000; padding:10px; border-radius:8px; border:1px solid #222; flex-grow: 1; }
    .media-label { font-size:11px; color:#888; text-transform:uppercase; margin-bottom:5px; display:block; }
    .media-strip { display:flex; gap:8px; overflow-x:auto; padding-bottom:5px; }
    /* Miniature leggermente pi√π grandi */
    .media-thumb { width:50px; height:50px; object-fit:cover; border-radius:4px; border:1px solid #333; flex-shrink:0; }
    .media-count { font-size:11px; color:#666; margin-left:5px; align-self: center; }
    .pdf-list { font-size:11px; color:#aaa; margin-top:8px; }
    .pdf-icon { color:#ff4444; margin-right:4px; }

    /* AZIONI */
    .pc-actions { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px; padding-top:15px; border-top:1px solid #222; }
    .btn { display:block; text-align:center; padding:10px; border-radius:8px; text-decoration:none; font-weight:bold; font-size:14px; transition:0.2s; }
    .btn-edit { background:#333; color:white; border:1px solid #555; }
    .btn-edit:hover { background:#444; border-color:white; }
    .btn-view { background:linear-gradient(90deg, #0088cc, #00ffc8); color:black; border:none; grid-column: span 2; }
    .btn-view:hover { opacity:0.9; }
    
    /* QR CODE FISSO IN ALTO */
    .main-qr { background:white; padding:15px; border-radius:15px; width:fit-content; margin:0 auto 30px auto; text-align:center; }
    .main-qr img { width:150px; height:150px; display:block; }
    .qr-link { color:black; font-weight:bold; margin-top:5px; display:block; text-decoration:none; font-size:12px; }

    /* TOAST */
    .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,255,200,0.9); color:black; padding:10px 20px; border-radius:30px; font-weight:bold; display:none; z-index:9999; }
  </style>
</head>
<body>

  <div id="toast" class="toast">Azione completata!</div>

  <div class="dash-header">
    <h1 class="dash-title">Benvenuto, {{ user.nome }}</h1>
    <a href="/area/logout" class="btn-logout">ESCI</a>
  </div>

  <div class="main-qr">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data={{ request.url_root }}card/{{ user.slug }}" alt="QR Code">
    <a href="/card/{{ user.slug }}" target="_blank" class="qr-link">/card/{{ user.slug }} <i class="fas fa-external-link-alt"></i></a>
  </div>

  <div class="profile-grid">
    
    {% for pid in ['1', '2', '3'] %}
      {% set p_key = 'p' + pid %}
      {% set p_data = user[p_key] %}
      {% set is_active = p_data.active %}
      {% set is_default = (user.default_profile == p_key) %}
      
      <div class="profile-card {% if is_active %}active{% else %}inactive{% endif %}">
        
        <div class="pc-head">
          <div class="pc-info">
            {% if p_data.foto %}
              <img src="{{ p_data.foto }}" class="pc-avatar">
            {% else %}
              <div class="pc-avatar" style="display:flex; justify-content:center; align-items:center; color:#555;"><i class="fas fa-user"></i></div>
            {% endif %}
            <div>
              <h3 class="pc-title">Profilo P{{ pid }}</h3>
              {% if is_default %}<span style="color:#00ffc8; font-size:10px;">‚òÖ DEFAULT</span>{% endif %}
            </div>
          </div>
          <span class="pc-status {% if is_active %}st-on{% else %}st-off{% endif %}">
            {{ "ATTIVO" if is_active else "SPENTO" }}
          </span>
        </div>

        <div style="font-size:13px; color:#aaa; margin-bottom:10px;">
          <div><i class="fas fa-briefcase"></i> {{ p_data.role if p_data.role else '---' }}</div>
          <div><i class="fas fa-building"></i> {{ p_data.company if p_data.company else '---' }}</div>
        </div>

        <div class="media-preview">
          
          {% if p_data.gallery_img|length > 0 %}
            <label class="media-label">üì∏ Foto ({{ p_data.gallery_img|length }})</label>
            <div class="media-strip">
              {# Mostriamo fino a 5 foto dato che il box √® pi√π largo #}
              {% for img in p_data.gallery_img[:5] %}
                <img src="{{ img }}" class="media-thumb">
              {% endfor %}
              {% if p_data.gallery_img|length > 5 %}<span class="media-count">+{{ p_data.gallery_img|length - 5 }}</span>{% endif %}
            </div>
          {% endif %}

          {% if p_data.gallery_vid|length > 0 %}
            <label class="media-label" style="margin-top:8px;">üé¨ Video ({{ p_data.gallery_vid|length }})</label>
            <div class="media-strip">
              {% for vid in p_data.gallery_vid[:4] %}
                <video src="{{ vid }}#t=1.0" class="media-thumb"></video>
              {% endfor %}
              {% if p_data.gallery_vid|length > 4 %}<span class="media-count">+{{ p_data.gallery_vid|length - 4 }}</span>{% endif %}
            </div>
          {% endif %}

          {% if p_data.gallery_pdf|length > 0 %}
            <div class="pdf-list">
              <i class="fas fa-file-pdf pdf-icon"></i> {{ p_data.gallery_pdf|length }} Documenti PDF caricati
            </div>
          {% else %}
            {% if p_data.gallery_img|length == 0 and p_data.gallery_vid|length == 0 %}
                 <div class="pdf-list" style="font-style:italic; opacity:0.5;">Nessun media caricato</div>
            {% endif %}
          {% endif %}

        </div>

        <div class="pc-actions">
          <a href="/area/edit/{{ pid }}" class="btn btn-edit">‚úèÔ∏è MODIFICA</a>
          
          {% if is_active %}
            {% if not is_default %}
              <a href="/area/set_default/p{{ pid }}" class="btn btn-edit" style="background:#222; color:#aaa; font-size:12px;">USA COME PRINCIPALE</a>
            {% endif %}
            <a href="/area/deactivate/{{ pid }}" class="btn btn-edit" style="color:#ff4444; border-color:#ff4444;" onclick="return confirm('Disattivare questo profilo?')">DISATTIVA</a>
          {% else %}
            <a href="/area/activate/{{ pid }}" class="btn btn-edit" style="color:#00ffc8; border-color:#00ffc8;">ACCENDI</a>
          {% endif %}

          <a href="/card/{{ user.slug }}?p=p{{ pid }}" target="_blank" class="btn btn-view">üëÅÔ∏è APRI CARD P{{ pid }}</a>
        </div>

      </div>
    {% endfor %}

  </div>

  <div style="margin-top:50px; border-top:1px solid #333; padding-top:30px; text-align:center; max-width: 800px; margin-left: auto; margin-right: auto;">
    <h3 style="color:white;">Opzione "Menu di Scelta"</h3>
    <p style="color:#aaa; font-size:14px; margin:0 auto 20px auto;">
      Se attivi questa opzione come "Principale", chi visita il tuo link pubblico vedr√† una pagina intermedia dove potr√† scegliere quale dei profili attivi visitare, invece di andare direttamente su P1.
    </p>
    {% if user.default_profile == 'menu' %}
      <span style="color:#00ffc8; font-weight:bold; border:2px solid #00ffc8; padding:10px 25px; border-radius:30px; display:inline-block;">‚úÖ MENU ATTIVO COME PRINCIPALE</span>
    {% else %}
      <a href="/area/set_default/menu" class="btn btn-edit" style="display:inline-block; width:auto; padding:12px 40px; font-size:16px; background: linear-gradient(45deg, #333, #444);">IMPOSTA MENU COME PRINCIPALE</a>
    {% endif %}
  </div>

  <script>
    // Semplice effetto per i bottoni
    const btns = document.querySelectorAll('.btn');
    btns.forEach(btn => {
      btn.addEventListener('click', function() {
        // Non mostrare caricamento per i tasti di cancellazione/disattivazione per evitare confusione col confirm
        if(!this.href.includes('delete') && !this.getAttribute('onclick')) {
           this.innerHTML = "‚è≥ Caricamento...";
        }
      });
    });
  </script>

</body>
</html>
