<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard | Pay4You</title>

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app-shell">

  <header class="app-header">
    <a class="brand" href="/area">
      <div class="logo-dot"></div>
      <div>
        <div class="brand-title">Pay4You Cards</div>
        <div class="hint">{{ "Admin" if is_admin else "Cliente" }}</div>
      </div>
    </a>

    <div class="toolbar">
      {% if is_admin %}
        <a class="btn primary" href="/area/new">+ Nuova Card</a>
      {% endif %}
      <a class="btn danger" href="/area/logout">Logout</a>
    </div>
  </header>

  <main class="app-main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for cat,msg in messages %}
            <div class="flash flash-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="dash-grid">
      {% for a in agents %}
      <section class="dash-card" data-slug="{{ a.slug }}">
        <div class="dash-head">
          <div class="dash-left">
            <div class="dash-avatar">
              {% if a.photo_url %}
                <img src="{{ a.photo_url }}" alt="foto">
              {% else %}
                <div class="dash-ph">ðŸ‘¤</div>
              {% endif %}
            </div>
            <div>
              <div class="dash-name">{{ a.name or a.slug }}</div>
              <div class="dash-sub">{{ a.company or "â€”" }}</div>
              <div class="dash-sub2">Slug: <span class="slug-badge">{{ a.slug }}</span></div>
            </div>
          </div>

          <div class="dash-actions">
            <!-- APRI -->
            <a class="btn-mini" target="_blank" href="/{{ a.slug }}">Apri P1</a>
            {% if a.p2_enabled == 1 %}
              <a class="btn-mini" target="_blank" href="/{{ a.slug }}?p=p2">Apri P2</a>
            {% endif %}
            {% if a.p3_enabled == 1 %}
              <a class="btn-mini" target="_blank" href="/{{ a.slug }}?p=p3">Apri P3</a>
            {% endif %}

            <a class="btn-mini ghost" href="/vcf/{{ a.slug }}">VCF</a>

            <!-- QR -->
            <button class="btn-mini ghost" type="button" onclick="openQr('{{ a.slug }}','p1')">QR1</button>
            {% if a.p2_enabled == 1 %}
              <button class="btn-mini ghost" type="button" onclick="openQr('{{ a.slug }}','p2')">QR2</button>
            {% endif %}
            {% if a.p3_enabled == 1 %}
              <button class="btn-mini ghost" type="button" onclick="openQr('{{ a.slug }}','p3')">QR3</button>
            {% endif %}

            <!-- MODIFICA -->
            {% if is_admin %}
              <a class="btn-mini warn" href="/area/edit/{{ a.slug }}">Modifica P1</a>
              {% if a.p2_enabled == 1 %}<a class="btn-mini warn" href="/area/edit/{{ a.slug }}/p2">Modifica P2</a>{% endif %}
              {% if a.p3_enabled == 1 %}<a class="btn-mini warn" href="/area/edit/{{ a.slug }}/p3">Modifica P3</a>{% endif %}
            {% else %}
              <a class="btn-mini warn" href="/area/me/edit">Modifica P1</a>
              {% if a.p2_enabled == 1 %}<a class="btn-mini warn" href="/area/me/p2">Modifica P2</a>{% endif %}
              {% if a.p3_enabled == 1 %}<a class="btn-mini warn" href="/area/me/p3">Modifica P3</a>{% endif %}
            {% endif %}

            <!-- ATTIVA/DISATTIVA/ELIMINA (reset) -->
            {% if is_admin %}
              <form class="inline" method="post" action="/area/admin/reset/{{ a.slug }}/p1"
                    onsubmit="return confirm('ELIMINA P1 = reset totale (svuota tutto e disattiva P2/P3). Confermi?');">
                <button class="btn-mini danger" type="submit">Elimina P1</button>
              </form>

              {% if a.p2_enabled == 1 %}
                <form class="inline" method="post" action="/area/admin/deactivate/{{ a.slug }}/p2"
                      onsubmit="return confirm('Disattiva P2? (verrÃ  svuotato)');">
                  <button class="btn-mini danger" type="submit">Disattiva P2</button>
                </form>
                <form class="inline" method="post" action="/area/admin/reset/{{ a.slug }}/p2"
                      onsubmit="return confirm('Elimina P2 (svuota e disattiva). Confermi?');">
                  <button class="btn-mini danger" type="submit">Elimina P2</button>
                </form>
              {% else %}
                <form class="inline" method="post" action="/area/admin/activate/{{ a.slug }}/p2"
                      onsubmit="return confirm('Attiva P2 vuoto?');">
                  <button class="btn-mini" type="submit">Attiva P2</button>
                </form>
              {% endif %}

              {% if a.p3_enabled == 1 %}
                <form class="inline" method="post" action="/area/admin/deactivate/{{ a.slug }}/p3"
                      onsubmit="return confirm('Disattiva P3? (verrÃ  svuotato)');">
                  <button class="btn-mini danger" type="submit">Disattiva P3</button>
                </form>
                <form class="inline" method="post" action="/area/admin/reset/{{ a.slug }}/p3"
                      onsubmit="return confirm('Elimina P3 (svuota e disattiva). Confermi?');">
                  <button class="btn-mini danger" type="submit">Elimina P3</button>
                </form>
              {% else %}
                <form class="inline" method="post" action="/area/admin/activate/{{ a.slug }}/p3"
                      onsubmit="return confirm('Attiva P3 vuoto?');">
                  <button class="btn-mini" type="submit">Attiva P3</button>
                </form>
              {% endif %}

              <form class="inline" method="post" action="/area/admin/credentials/{{ a.slug }}"
                    onsubmit="return confirm('Generare una nuova password per questo cliente?');">
                <button class="btn-mini" type="submit">Invia credenziali</button>
              </form>
            {% else %}
              {% if a.p2_enabled == 1 %}
                <form class="inline" method="post" action="/area/me/deactivate/p2"
                      onsubmit="return confirm('Disattiva P2? (verrÃ  svuotato)');">
                  <button class="btn-mini danger" type="submit">Disattiva P2</button>
                </form>
              {% else %}
                <form class="inline" method="post" action="/area/me/activate/p2"
                      onsubmit="return confirm('Attiva P2 vuoto?');">
                  <button class="btn-mini" type="submit">Attiva P2</button>
                </form>
              {% endif %}

              {% if a.p3_enabled == 1 %}
                <form class="inline" method="post" action="/area/me/deactivate/p3"
                      onsubmit="return confirm('Disattiva P3? (verrÃ  svuotato)');">
                  <button class="btn-mini danger" type="submit">Disattiva P3</button>
                </form>
              {% else %}
                <form class="inline" method="post" action="/area/me/activate/p3"
                      onsubmit="return confirm('Attiva P3 vuoto?');">
                  <button class="btn-mini" type="submit">Attiva P3</button>
                </form>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="dash-preview">
          <div class="dash-preview-col">
            <div class="dash-preview-title">Foto</div>
            <div class="dash-mini-grid">
              {% set imgs = (a.gallery_urls or "").split("|") %}
              {% set imgs2 = [] %}
              {% for x in imgs %}
                {% if x and x.strip() %}{% set _ = imgs2.append(x) %}{% endif %}
              {% endfor %}
              {% for g in imgs2[:6] %}
                <img class="dash-mini" src="{{ g }}" alt="">
              {% endfor %}
              {% if imgs2|length == 0 %}
                <div class="dash-mini-empty">â€”</div>
              {% endif %}
            </div>
          </div>

          <div class="dash-preview-col">
            <div class="dash-preview-title">Video</div>
            <div class="dash-mini-grid">
              {% set vids = (a.video_urls or "").split("|") %}
              {% set vids2 = [] %}
              {% for x in vids %}
                {% if x and x.strip() %}{% set _ = vids2.append(x) %}{% endif %}
              {% endfor %}
              {% for v in vids2[:4] %}
                <video class="dash-mini" muted playsinline preload="metadata" src="{{ v }}#t=0.1"></video>
              {% endfor %}
              {% if vids2|length == 0 %}
                <div class="dash-mini-empty">â€”</div>
              {% endif %}
            </div>
          </div>

          <div class="dash-preview-col">
            <div class="dash-preview-title">PDF</div>
            <div class="dash-pdf-list">
              {% set pdfs = (a.pdf1_url or "").split("|") %}
              {% set pdfs2 = [] %}
              {% for x in pdfs %}
                {% if x and x.strip() %}{% set _ = pdfs2.append(x) %}{% endif %}
              {% endfor %}
              {% for p in pdfs2[:6] %}
                {% if "||" in p %}{% set nm = p.split("||")[0] %}{% else %}{% set nm = p %}{% endif %}
                <div class="dash-pdf-pill" title="{{ nm }}">{{ nm }}</div>
              {% endfor %}
              {% if pdfs2|length == 0 %}
                <div class="dash-mini-empty">â€”</div>
              {% endif %}
            </div>
          </div>
        </div>

      </section>
      {% endfor %}
    </div>

    <div class="footer">Pay4You.store</div>
  </main>
</div>

<!-- QR MODAL -->
<div id="qrModal" class="modal-overlay" style="display:none" onclick="overlayClose(event,'qrModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <button class="modal-x" type="button" onclick="closeModal('qrModal')">âœ•</button>
    <div class="modal-title" id="qrTitle">QR</div>

    <div class="qr-wrap">
      <img id="qrImg" src="" alt="QR">
    </div>

    <div class="modal-actions">
      <input type="hidden" id="qrSlug" value="">
      <input type="hidden" id="qrProfile" value="p1">
      <button class="btn" type="button" onclick="shareQr('whatsapp')">Invia WhatsApp</button>
      <button class="btn" type="button" onclick="shareQr('email')">Invia Email</button>
      <button class="btn ghost" type="button" onclick="closeModal('qrModal')">Chiudi</button>
    </div>
  </div>
</div>

<!-- CREDENTIALS MODAL (come prima) -->
<div id="credModal" class="modal-overlay" style="display:none" onclick="overlayClose(event,'credModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <button class="modal-x" type="button" onclick="closeCred()">âœ•</button>
    <div class="modal-title">Credenziali (mostrate una sola volta)</div>

    <div class="cred-box">
      <div class="cred-row"><span>Username</span><code id="cUser"></code></div>
      <div class="cred-row"><span>Password</span><code id="cPass"></code></div>
      <div class="sep" style="margin:12px 0"></div>

      <div class="cred-links">
        <div class="cred-row"><span>Link Login</span><a id="cLogin" target="_blank" href="">Apri</a></div>
        <div class="cred-row"><span>Link Card P1</span><a id="cCard1" target="_blank" href="">Apri</a></div>
        <div class="cred-row" id="cCard2Row" style="display:none"><span>Link Card P2</span><a id="cCard2" target="_blank" href="">Apri</a></div>
        <div class="cred-row" id="cCard3Row" style="display:none"><span>Link Card P3</span><a id="cCard3" target="_blank" href="">Apri</a></div>
      </div>

      <div class="hint" style="margin-top:10px">
        Invio via Email/WhatsApp lo attiviamo dopo (SMTP + WhatsApp).
      </div>
    </div>

    <form method="post" action="/area/admin/send_credentials" class="modal-actions">
      <input type="hidden" name="slug" id="cSlug" value="">
      <button class="btn" type="submit" name="channel" value="whatsapp">Invia WhatsApp</button>
      <button class="btn" type="submit" name="channel" value="email">Invia Email</button>
      <button class="btn ghost" type="button" onclick="closeCred()">Chiudi</button>
    </form>
  </div>
</div>

<script>
  function overlayClose(e, id){
    if(e.target && e.target.id === id){
      closeModal(id);
    }
  }
  function closeModal(id){
    const el = document.getElementById(id);
    if(el) el.style.display = 'none';
  }

  function absUrl(u){
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;
    const base = window.location.origin;
    if(u.startsWith('/')) return base + u;
    return base + '/' + u;
  }

  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(e){ return false; }
  }

  function mailtoOpen(subject, body){
    const s = encodeURIComponent(subject || "");
    const b = encodeURIComponent(body || "");
    window.location.href = `mailto:?subject=${s}&body=${b}`;
  }

  function openQr(slug, profile){
    const modal = document.getElementById('qrModal');
    const img = document.getElementById('qrImg');
    const title = document.getElementById('qrTitle');

    document.getElementById('qrSlug').value = slug;
    document.getElementById('qrProfile').value = profile;

    const url = (profile === 'p2') ? `/qr/${slug}.png?p=p2`
              : (profile === 'p3') ? `/qr/${slug}.png?p=p3`
              : `/qr/${slug}.png`;

    title.textContent = `QR ${slug.toUpperCase()} â€¢ ${profile.toUpperCase()}`;
    img.src = url;

    modal.style.display = 'flex';
  }

  async function shareQr(channel){
    const slug = document.getElementById('qrSlug').value;
    const profile = document.getElementById('qrProfile').value || 'p1';

    const cardUrl = absUrl(profile === 'p2' ? `/${slug}?p=p2` : (profile === 'p3' ? `/${slug}?p=p3` : `/${slug}`));
    const qrPngUrl = absUrl(profile === 'p2' ? `/qr/${slug}.png?p=p2` : (profile === 'p3' ? `/qr/${slug}.png?p=p3` : `/qr/${slug}.png`));

    const msg = [
      `Pay4You Card (${profile.toUpperCase()})`,
      `Link: ${cardUrl}`,
      `QR: ${qrPngUrl}`
    ].join("\n");

    if(channel === 'whatsapp'){
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }

    const subject = `Pay4You QR ${slug.toUpperCase()} ${profile.toUpperCase()}`;
    mailtoOpen(subject, msg);

    const copied = await copyToClipboard(msg);
    if(!copied){
      window.prompt("Copia questo testo e incollalo nella mail:", msg);
    }
  }

  function openCred(slug, username, password, p2Enabled, p3Enabled){
    document.getElementById('cSlug').value = slug;
    document.getElementById('cUser').textContent = username;
    document.getElementById('cPass').textContent = password;

    const base = window.location.origin;
    document.getElementById('cLogin').href = base + "/area/login";
    document.getElementById('cCard1').href = base + "/" + slug;

    const row2 = document.getElementById('cCard2Row');
    const row3 = document.getElementById('cCard3Row');
    if(p2Enabled){
      row2.style.display = '';
      document.getElementById('cCard2').href = base + "/" + slug + "?p=p2";
    }else{
      row2.style.display = 'none';
    }
    if(p3Enabled){
      row3.style.display = '';
      document.getElementById('cCard3').href = base + "/" + slug + "?p=p3";
    }else{
      row3.style.display = 'none';
    }

    document.getElementById('credModal').style.display = 'flex';
  }
  function closeCred(){ closeModal('credModal'); }

  (function(){
    const creds = {{ (session.get("last_credentials") or {}) | tojson }};
    if(creds && creds.slug){
      openCred(creds.slug, creds.username, creds.password, !!creds.p2_enabled, !!creds.p3_enabled);
    }
  })();
</script>

</body>
</html>
